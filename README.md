# Vueå“åº”å¼çš„è®¾è®¡ä¸å®ç°
[toc]

Vueçš„æœ€å¤§ç‰¹ç‚¹ï¼šå®ƒèƒ½å¤Ÿå®ç°è§†å›¾å’Œæ•°æ®çš„å…³è”

ç›®æ ‡1ï¼šå®ç°è§†å›¾å’Œæ•°æ®çš„å…³è”

è§†å›¾ï¼šè™šæ‹Ÿdom

ç›®æ ‡2ï¼šå®ç° ã€åˆ›å»ºè§†å›¾çš„è¿‡ç¨‹ã€‘å’Œã€æ•°æ®ã€‘çš„å…³è”

ç›®æ ‡3ï¼šå®ç°ã€å‡½æ•°ã€‘å’Œã€æ•°æ®ã€‘çš„å…³è”

ç›®æ ‡4ï¼šå®ç°ã€å‡½æ•°ã€‘å’Œã€å‡½æ•°è¿è¡Œä¸­ç”¨åˆ°çš„æ•°æ®ã€‘çš„å…³è”

ä»è®¾è®¡çš„è§’åº¦çœ‹ï¼Œè¦å…³è”å“ªäº›æ•°æ®è¦äº¤ç»™ç”¨æˆ·å†³å®šï¼›é—®é¢˜æ˜¯å¦‚ä½•æä¾›ä¸€ç§æœºåˆ¶è®©ç”¨æˆ·æ¥å‘Šè¯‰æˆ‘ä»¬å“ªäº›æ•°æ®è¦å…³è”

ç›®æ ‡5ï¼šå®ç°ã€å‡½æ•°ã€‘å’Œã€å‡½æ•°è¿è¡Œä¸­ç”¨åˆ°çš„**æ ‡è®°**æ•°æ®ã€‘çš„å…³è”

å¦‚ä½•å…³è”ï¼Ÿå»ºç«‹å¯¹åº”å…³ç³»ã€‚

å¦‚ä½•å»ºç«‹ï¼Ÿ

1. ç›‘å¬æ•°æ®çš„è¯»å–å’Œä¿®æ”¹
2. æ‰¾åˆ°æ•°æ®å¯¹åº”çš„å‡½æ•°

è¯­è¨€å±‚é¢ï¼ŒJSå¦‚ä½•å®ç°ï¼š

1. ç›‘å¬æ•°æ®çš„è¯»å–å’Œä¿®æ”¹ï¼ˆVueä¸­å« reactiveï¼‰

   - **defineProperty: Vue2ï¼Œåªèƒ½ç›‘å¬å·²æœ‰å±æ€§çš„è¯»å–å’Œèµ‹å€¼ï¼Œä½†æ˜¯å…¼å®¹æ€§æ›´å¥½**
   - **Proxy: Vue3, ç›‘å¬èŒƒå›´æ›´å¹¿ï¼Œåªèƒ½å…¼å®¹æ”¯æŒES6çš„æµè§ˆå™¨**

   JSåªèƒ½é€šè¿‡ä¸Šè¿°ä¸¤ç§æ–¹æ³•ç›‘å¬å¯¹è±¡ï¼Œæ‰€ä»¥è¦ç›‘å¬çš„æ•°æ®åªèƒ½æ˜¯å¯¹è±¡ï¼Œvue3ä¸­å°†è¯¥ç›‘å¬å¯¹è±¡å‘½åä¸ºreactiveï¼Œå³å“åº”å¼æ•°æ®ï¼ˆæœ¬è´¨æ˜¯Proxyå¯¹è±¡ï¼‰

2. æ‰¾åˆ°æ•°æ®å¯¹åº”çš„å‡½æ•° å’Œ æ‰§è¡Œï¼ˆVueä¸­å«ä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ï¼ˆeffectï¼‰



vueçš„å“åº”å¼ç³»ç»Ÿï¼šreactive + effect

## ç›‘å¬æ•°æ®çš„è¯»å–å’Œä¿®æ”¹

åˆ†è§£æˆä¸‹é¢ä¸‰ä¸ªç›®æ ‡

### 1ã€ç›‘å¬

å¯¹è±¡ --> ä»£ç†

WeakMapç¼“å­˜ä»£ç†è¿‡çš„å¯¹è±¡

### 2ã€è¯»

è¯»åˆ°å¯¹è±¡çš„ä¿¡æ¯, å¦‚ä¸‹è¡¨

| è¯»ä»€ä¹ˆä¿¡æ¯       | Proxyæ‹¦æˆª \| åå°„çš„æ–¹æ³• |
| ---------------- | ----------------------- |
| è¯»å±æ€§å€¼         | get                     |
| åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨ | has                     |
| è¿­ä»£å±æ€§         | ownKeys                 |

**ä¾èµ–æ”¶é›†**ï¼šå»ºç«‹å¯¹è±¡çš„å±æ€§å’Œå‡½æ•°çš„å¯¹åº”å…³ç³»

### 3ã€å†™

æ›´æ”¹äº†å¯¹è±¡çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹è¡¨

| æ€ä¹ˆæ”¹å˜çš„ | Proxyæ‹¦æˆª \| åå°„çš„æ–¹æ³•                       |
| ---------- | --------------------------------------------- |
| è®¾ç½®å±æ€§å€¼ | setï¼ˆéœ€åˆ¤æ–­å€¼æœ‰æ²¡æœ‰æ”¹å˜ï¼Œæ”¹å˜æ‰è§¦å‘ï¼‰         |
| æ·»åŠ å±æ€§   | set (éœ€åˆ¤æ–­å­˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å³ä¸ºæ·»åŠ ï¼‰         |
| åˆ é™¤å±æ€§   | deleteProperty (éœ€åˆ¤æ–­å­˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¸è§¦å‘) |

**æ´¾å‘æ›´æ–°**ï¼šæ”¹äº†å“ªä¸ªå¯¹è±¡çš„å“ªä¸ªå±æ€§ï¼ŒæŠŠå±æ€§å¯¹åº”çš„å‡½æ•°æ‰§è¡Œä¸€é

# é¢è¯•é¢˜

# Vue3æ•´ä½“å˜åŒ–

> é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue3 ç›¸æ¯” Vue2 æœ‰ä»€ä¹ˆæ–°çš„å˜åŒ–ï¼Ÿ

ä¸»è¦æœ‰è¿™ä¹ˆå‡ ç±»å˜åŒ–ï¼š

1. æºç ä¸Šçš„å˜åŒ–
2. æ€§èƒ½çš„å˜åŒ–
3. è¯­æ³•APIçš„å˜åŒ–
4. å¼•å…¥RFC



## æºç ä¼˜åŒ–

**1. Monorepo**

Vue2 çš„æºç æ˜¯æ‰˜ç®¡åœ¨ src ç›®å½•ä¸‹é¢çš„ï¼Œç„¶åä¾æ®åŠŸèƒ½æ‹†åˆ†å‡ºäº†ï¼š

- compilerï¼šç¼–è¯‘å™¨
- coreï¼šå’Œå¹³å°æ— å…³çš„é€šç”¨è¿è¡Œæ—¶ä»£ç 
- platformsï¼šå¹³å°ä¸“æœ‰ä»£ç 
- serverï¼šæœåŠ¡ç«¯æ¸²æŸ“ç›¸å…³ä»£ç 
- sfcï¼šå•æ–‡ä»¶ç»„ä»¶è§£æç›¸å…³ä»£ç 
- sharedï¼šå…±äº«å·¥å…·åº“ä»£ç 

ä½†æ˜¯å„ä¸ªæ¨¡å—**æ— æ³•å•ç‹¬æŠ½ç¦»**å‡ºæ¥ä¸‹è½½å®‰è£…ï¼Œä¹Ÿæ— æ³•é’ˆå¯¹å•ä¸ªæ¨¡å—è¿›è¡Œå‘å¸ƒã€‚

Vue3 æºç å·¥ç¨‹çš„æ­å»ºæ”¹ä¸ºäº† Monorepo çš„å½¢å¼ï¼Œå°†æ¨¡å—æ‹†åˆ†åˆ°äº†ä¸åŒçš„åŒ…é‡Œé¢ï¼Œæ¯ä¸ªåŒ…æœ‰å„è‡ªçš„ APIã€ç±»å‹å®šä¹‰ä»¥åŠæµ‹è¯•ã€‚è¿™æ ·ä¸€ç±»ç²’åº¦æ›´ç»†ï¼Œè´£ä»»åˆ’åˆ†æ›´åŠ æ˜ç¡®ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-21-073731.png" alt="image-20240821153730971" style="zoom:50%;" />

**2. Typescript**

- Vue1.xï¼šçº¯ JS å¼€å‘ï¼Œæ— ç±»å‹ç³»ç»Ÿ
- Vue2.xï¼šFlow.jsï¼Œè¿™æ˜¯ Facebook æ¨å‡ºçš„ç±»å‹ç³»ç»Ÿ
- Vue3.xï¼šTypeScript

## æ€§èƒ½ä¼˜åŒ–

**1. æºç ä½“ç§¯ç¼©å°**

- ç§»é™¤å†·é—¨åŠŸèƒ½ï¼šfilterã€inline-template è¿™äº›ç‰¹æ€§è¢«å»é™¤æ‰äº†
- ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ rollup è¿›è¡Œæ„å»ºï¼Œåˆ©ç”¨ tree-shaking å‡å°‘ç”¨æˆ·ä»£ç æ‰“åŒ…çš„ä½“ç§¯

**2. æ•°æ®åŠ«æŒä¼˜åŒ–**

- Vue2.xï¼šObject.defineProperty
- Vue3.xï¼šProxy

**3. ç¼–è¯‘ä¼˜åŒ–**

æ¨¡æ¿æœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–ï¼Œæœ€ç»ˆä¼šè¢«ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ã€‚

1. é™æ€æå‡
2. é¢„å­—ç¬¦ä¸²åŒ–
3. ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
4. Block Tree
5. PatchFlag

**4. diffç®—æ³•ä¼˜åŒ–**

- Vue2.x: åŒç«¯ diff ç®—æ³•
- Vue3.x: å¿«é€Ÿ diff ç®—æ³•

## è¯­æ³•APIä¼˜åŒ–

**1. ä¼˜åŒ–é€»è¾‘ç»„ç»‡**

- Vue2.x: OptionsAPIï¼Œé€»è¾‘ä»£ç æŒ‰ç…§ dataã€methodsã€computedã€props è¿›è¡Œåˆ†ç±»
- Vue3.x: OptionsAPI + CompositionAPIï¼ˆæ¨èï¼‰
  - CompositionAPIä¼˜ç‚¹ï¼šæŸ¥çœ‹ä¸€ä¸ªåŠŸèƒ½çš„å®ç°æ—¶å€™ï¼Œä¸éœ€è¦åœ¨æ–‡ä»¶è·³æ¥è·³å»ï¼›å¹¶ä¸”è¿™ç§é£æ ¼ä»£ç å¯å¤ç”¨çš„ç²’åº¦æ›´ç»†


<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-26-033538.jpg" alt="16028271652994" style="zoom:50%;" />

**2. ä¼˜åŒ–é€»è¾‘å¤ç”¨**

Vue2.x: å¤ç”¨é€»è¾‘ä½¿ç”¨ mixinï¼Œä½†æ˜¯ mixin æœ¬èº«æœ‰ä¸€äº›ç¼ºç‚¹ï¼š

- ä¸æ¸…æ™°çš„æ•°æ®æ¥æº
- å‘½åç©ºé—´å†²çª
- éšå¼çš„è·¨mixinäº¤æµ

å‚é˜…Vueè¯¾ç¨‹ã€Šç»†èŠ‚è¡¥å…… - ç»„åˆå¼å‡½æ•°ã€‹

**3. å…¶ä»–å˜åŒ–**

Vue2

```js
import App from './App.vue'
// é€šè¿‡å®ä¾‹åŒ– Vue æ¥åˆ›å»ºåº”ç”¨
new Vue({
  el: '#app',
  components: { App },
  template: '<App/>'
})
// or
new Vue({
  render: h => h(App),
}).$mount('#app')
```

æ€è€ƒğŸ¤”ï¼šè¿™ç§æ–¹å¼å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ç­”æ¡ˆï¼šè¿™ç§æ–¹å¼ç¼ºç‚¹åœ¨äºä¸€ä¸ªé¡µé¢å¦‚æœå­˜åœ¨å¤šä¸ª Vue åº”ç”¨ï¼Œéƒ¨åˆ†é…ç½®ä¼šå½±å“æ‰€æœ‰çš„ Vue åº”ç”¨

```vue
<!-- vue2 -->
<div id="app1"></div>
<div id="app2"></div>
<script>
  Vue.use(...); // æ­¤ä»£ç ä¼šå½±å“æ‰€æœ‰çš„vueåº”ç”¨
  Vue.mixin(...); // æ­¤ä»£ç ä¼šå½±å“æ‰€æœ‰çš„vueåº”ç”¨
  Vue.component(...); // æ­¤ä»£ç ä¼šå½±å“æ‰€æœ‰çš„vueåº”ç”¨
                
	new Vue({
    // é…ç½®
  }).$mount("#app1")
  
  new Vue({
    // é…ç½®
  }).$mount("#app2")
</script>
```

Vue3

```js
import { createApp } from 'vue';
import App from './App.vue'

createApp(App).mount('#app');
```

è¿™ç§æ–¹å¼å°±èƒ½å¾ˆå¥½çš„è§„é¿ä¸Šé¢çš„é—®é¢˜ï¼š

```vue
<!-- vue3 -->
<div id="app1"></div>
<div id="app2"></div>
<script>  
	createApp(æ ¹ç»„ä»¶).use(...).mixin(...).component(...).mount("#app1")
  createApp(æ ¹ç»„ä»¶).mount("#app2")
</script>
```

> é¢è¯•é¢˜ï¼šä¸ºä»€ä¹ˆ Vue3 ä¸­å»æ‰äº† Vue æ„é€ å‡½æ•°ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> Vue2 çš„å…¨å±€æ„é€ å‡½æ•°å¸¦æ¥äº†è¯¸å¤šé—®é¢˜ï¼š
>
> 1. è°ƒç”¨æ„é€ å‡½æ•°çš„é™æ€æ–¹æ³•ä¼šå¯¹æ‰€æœ‰vueåº”ç”¨ç”Ÿæ•ˆï¼Œä¸åˆ©äºéš”ç¦»ä¸åŒåº”ç”¨
> 2. Vue2 çš„æ„é€ å‡½æ•°é›†æˆäº†å¤ªå¤šåŠŸèƒ½ï¼Œä¸åˆ©äº tree shakingï¼ŒVue3 æŠŠè¿™äº›åŠŸèƒ½ä½¿ç”¨æ™®é€šå‡½æ•°å¯¼å‡ºï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ tree shaking ä¼˜åŒ–æ‰“åŒ…ä½“ç§¯
> 3. Vue2 æ²¡æœ‰æŠŠç»„ä»¶å®ä¾‹å’Œ Vue åº”ç”¨ä¸¤ä¸ªæ¦‚å¿µåŒºåˆ†å¼€ï¼Œåœ¨ Vue2 ä¸­ï¼Œé€šè¿‡ new Vue åˆ›å»ºçš„å¯¹è±¡ï¼Œæ—¢æ˜¯ä¸€ä¸ª Vue åº”ç”¨ï¼ŒåŒæ—¶åˆæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Vue ç»„ä»¶ã€‚Vue3 ä¸­ï¼ŒæŠŠä¸¤ä¸ªæ¦‚å¿µåŒºåˆ«å¼€æ¥ï¼Œé€šè¿‡ createApp åˆ›å»ºçš„å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ª Vue åº”ç”¨ï¼Œå®ƒå†…éƒ¨æä¾›çš„æ–¹æ³•æ˜¯é’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„ï¼Œè€Œä¸å†æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»„ä»¶ã€‚

## å¼•å…¥RFC

RFC å…¨ç§°æ˜¯ Request For Comments. è¿™æ˜¯ä¸€ç§åœ¨è½¯ä»¶å¼€å‘å’Œå¼€æºé¡¹ç›®ä¸­å¸¸ç”¨çš„ææ¡ˆæµç¨‹ï¼Œç”¨äºæ”¶é›†ç¤¾åŒºå¯¹æŸä¸ªæ–°åŠŸèƒ½ã€æ”¹åŠ¨æˆ–æ ‡å‡†çš„æ„è§å’Œå»ºè®®ã€‚

RFC æ˜¯ä¸€ç§æ–‡æ¡£æ ¼å¼ï¼Œå®ƒè¯¦ç»†æè¿°äº†æŸä¸ªç‰¹æ€§æˆ–æ›´æ”¹çš„æè®®ï¼Œè®¨è®ºå…¶åŠ¨æœºã€è®¾è®¡é€‰æ‹©ã€å®ç°ç»†èŠ‚ä»¥åŠæ½œåœ¨çš„å½±å“ã€‚åœ¨é€šè¿‡è®¨è®ºå’Œåé¦ˆè¾¾æˆå…±è¯†åï¼ŒRFC ä¼šè¢«é‡‡çº³æˆ–æ‹’ç»ã€‚ä¸€ä»½ RFC ä¸»è¦çš„ç»„æˆéƒ¨åˆ†æœ‰ï¼š

1. æ ‡é¢˜ï¼šç®€çŸ­æè¿°ææ¡ˆçš„ç›®çš„ã€‚
2. æ‘˜è¦ï¼šç®€è¦è¯´æ˜ææ¡ˆçš„å†…å®¹å’ŒåŠ¨æœºã€‚
3. åŠ¨æœºï¼šè§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªææ¡ˆï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚
4. è¯¦ç»†è®¾è®¡ï¼šæ·±å…¥æè¿°ææ¡ˆçš„è®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚
5. æ½œåœ¨é—®é¢˜å’Œæ›¿ä»£æ–¹æ¡ˆï¼šè®¨è®ºå¯èƒ½å­˜åœ¨çš„é—®é¢˜å’Œå¯ä»¥è€ƒè™‘çš„æ›¿ä»£æ–¹æ¡ˆã€‚
6. ä¸å…¼å®¹çš„å˜æ›´ï¼šæè¿°ææ¡ˆæ˜¯å¦ä¼šå¼•å…¥ä¸å…¼å®¹çš„å˜æ›´ï¼Œä»¥åŠè¿™äº›å˜æ›´çš„å½±å“ã€‚

é€šè¿‡ RFCï¼ŒVue æ ¸å¿ƒå›¢é˜Ÿèƒ½å¤Ÿæ›´å¥½åœ°å€¾å¬ç”¨æˆ·çš„éœ€æ±‚å’Œå»ºè®®ï¼Œä»è€Œå¼€å‘å‡ºæ›´åŠ ç¬¦åˆç¤¾åŒºæœŸå¾…çš„åŠŸèƒ½å’Œç‰¹æ€§ã€‚

> é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue3 ç›¸æ¯” Vue2 æœ‰ä»€ä¹ˆæ–°çš„å˜åŒ–ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> Vue3 ç›¸æ¯” Vue2 çš„æ•´ä½“å˜åŒ–ï¼Œå¯ä»¥åˆ†ä¸ºå¥½å‡ å¤§ç±»ï¼š
>
> 1. æºç ä¼˜åŒ–
> 2. æ€§èƒ½ä¼˜åŒ–
> 3. è¯­æ³• API ä¼˜åŒ–
> 4. å¼•å…¥ RFC
>
> **æºç ä¼˜åŒ–**ä½“ç°åœ¨ä½¿ç”¨ typescript é‡æ„æ•´ä¸ª Vue æºç ï¼Œå¯¹å†·é—¨çš„åŠŸèƒ½è¿›è¡Œäº†åˆ é™¤ï¼Œå¹¶ä¸”æ•´ä¸ªæºç çš„ç»“æ„å˜ä¸ºäº†ä½¿ç”¨ Monorepo è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·ç²’åº¦æ›´ç»†ï¼Œä¸åŒçš„åŒ…å¯ä»¥ç‹¬ç«‹æµ‹è¯•å‘å¸ƒã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥å•ç‹¬å¼•å…¥æŸä¸€ä¸ªåŒ…ä½¿ç”¨ï¼Œè€Œä¸ç”¨å¿…é¡»å¼•å…¥ Vue.
>
> **æ€§èƒ½ä¸Šçš„ä¼˜åŒ–**æ˜¯æ•´ä¸ª Vue3 æœ€æ ¸å¿ƒçš„å˜åŒ–ï¼Œé€šè¿‡ä¼˜åŒ–å“åº”å¼ã€diffç®—æ³•ã€æ¨¡æ¿ç¼–è¯‘ï¼ŒVue3 çš„æ€§èƒ½ç›¸æ¯” Vue2 æœ‰è´¨çš„é£è·ƒï¼ŒåŸºæœ¬ä¸Šå°†æ€§èƒ½è¿™ä¸€å—å„¿åšåˆ°äº†æè‡´ã€‚æ‰€ä»¥ Vue çš„æ–°é¡¹ç›®å»ºè®®éƒ½ä½¿ç”¨ Vue3 æ¥æ­å»ºã€‚
>
> ä¸è¿‡æ€§èƒ½å±‚é¢çš„ä¼˜åŒ–ï¼Œå¼€å‘è€…æ— æ³•ç›´æ¥çš„æ„ŸçŸ¥ï¼Œå¼€å‘è€…èƒ½å¤Ÿç›´æ¥æ„ŸçŸ¥çš„ï¼Œæ˜¯**è¯­æ³•ä¸Šçš„ä¼˜åŒ–**ï¼Œä¾‹å¦‚ Vue3 æå‡ºçš„ CompositionAPIï¼Œç”¨äºæ›¿ä»£ Vue2 æ—¶æœŸçš„ OptionsAPI. è¿™æ ·èƒ½å¤Ÿè®©åŠŸèƒ½é€»è¾‘æ›´åŠ é›†ä¸­ï¼Œæ— è®ºæ˜¯åœ¨é˜…è¯»è¿˜æ˜¯ä¿®æ”¹éƒ½æ›´åŠ æ–¹ä¾¿ã€‚å¦å¤– CompositionAPI è®©ä»£ç å¤ç”¨çš„ç²’åº¦ä¸Šæ›´ç»†ï¼Œä¸éœ€è¦å†åƒä»¥å‰ä¸€æ ·ä½¿ç”¨ mixin å¤ç”¨é€»è¾‘ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨ç»„åˆå¼å‡½æ•°æ¥å¤ç”¨é€»è¾‘ã€‚
>
> ä¸è¿‡ Vue3 ä¹Ÿä¸æ˜¯å®Œå…¨åºŸå¼ƒäº† OptionsAPIï¼Œåœ¨ Vue3 ä¸­ï¼ŒOptionsAPI æˆä¸ºäº†ä¸€ç§ç¼–ç é£æ ¼ã€‚
>
> æœ€åå°±æ˜¯å¼•å…¥ RFCï¼Œå°¤é›¨æºªå’Œæ ¸å¿ƒå›¢é˜Ÿå¹¿æ³›é‡‡ç”¨äº† RFC çš„æµç¨‹æ¥å¤„ç†æ–°åŠŸèƒ½å’Œé‡å¤§æ›´æ”¹ã€‚

---

# Vue2å“åº”å¼å›é¡¾

>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´ Vue3 å“åº”å¼ç›¸è¾ƒäº Vue2 æ˜¯å¦æœ‰æ”¹å˜ï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹å…·ä½“æœ‰å“ªäº›æ”¹å˜ï¼Ÿ

**è§‚å¯Ÿè€…æ¨¡å¼**

ç”Ÿæ´»ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼š

å‡è®¾é¡¾å®¢å¯¹æ–°å‹å·çš„æ‰‹æœºæ„Ÿå…´è¶£ï¼Œä½†æ˜¯ç›®å‰å•†åº—è¿˜æ²¡åˆ°è´§ï¼Œé‚£ä¹ˆé¡¾å®¢åŠæ—¶å¦‚ä½•ä¹°åˆ°æ–°å‹å·çš„æ‰‹æœºï¼Ÿ

1. é¡¾å®¢æ¯å¤©å»ä¸€è¶Ÿå•†åœº ğŸ™…
2. å•†å“åˆ°è´§åæ²¡æ‰€æœ‰é¡¾å®¢å‘å‡ºé€šçŸ¥ ğŸ™…

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-03-22-074632.png" alt="image-20240322154631735" style="zoom:50%;" />

æˆ‘ä»¬ä¼¼ä¹é‡åˆ°äº†ä¸€ä¸ªçŸ›ç›¾ï¼šè¦ä¹ˆè®©é¡¾å®¢æµªè´¹æ—¶é—´æ£€æŸ¥äº§å“æ˜¯å¦åˆ°è´§ï¼Œè¦ä¹ˆè®©å•†åº—æµªè´¹èµ„æºå»é€šçŸ¥æ²¡æœ‰éœ€æ±‚çš„é¡¾å®¢ã€‚

è§£å†³æ–¹æ¡ˆï¼šå…¶å®å¾ˆç®€å•ï¼Œè®©æœ‰éœ€æ±‚çš„é¡¾å®¢ï¼ˆwatcherï¼‰ä¸»åŠ¨è®¢é˜…å³å¯ï¼Œä¹‹åå•†åº—ï¼ˆdepï¼‰åªéœ€è¦ç»™è®¢é˜…äº†ç”¨æˆ·å‘é€é€šçŸ¥ã€‚



**Vue2å“åº”å¼å·¥ä½œæœºåˆ¶**

1. data ä¸­çš„æ•°æ®ä¼šè¢« Vue éå†ç”Ÿæˆ getter å’Œ setterï¼Œè¿™æ ·ä¸€æ¥å½“è®¿é—®æˆ–è®¾ç½®å±æ€§æ—¶ï¼ŒVue å°±æœ‰æœºä¼šåšä¸€äº›åˆ«çš„äº‹æƒ…ã€‚
2. æ¯ä¸ªç»„ä»¶å®ä¾‹éƒ½å¯¹åº”ä¸€ä¸ª watcher å®ä¾‹ï¼Œå®ƒä¼šåœ¨ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­æŠŠâ€œæ¥è§¦â€è¿‡çš„æ•°æ® property è®°å½•ä¸ºä¾èµ–ã€‚ä¹‹åå½“ä¾èµ–é¡¹çš„ setter è§¦å‘æ—¶ï¼Œä¼šé€šçŸ¥ watcherï¼Œä»è€Œä½¿å®ƒå…³è”çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-074111.png" alt="image-20240901154111493" style="zoom:40%;" />



å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ï¼š

1. åŠ«æŒæ•°æ®ï¼šé€šè¿‡ Object.defineProperty æ–¹æ³•æ¥åšæ•°æ®åŠ«æŒï¼Œç”Ÿæˆ getter å’Œ setter ä»è€Œè®©è·å–/è®¾ç½®å€¼çš„æ—¶å€™å¯ä»¥åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚
2. å‘å¸ƒè€…ï¼šè®°å½•ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å’Œ watcher ä¹‹é—´çš„æ˜ å°„å…³ç³»
3. è§‚å¯Ÿè€…ï¼šwatcher ä¼šè¢«å‘å¸ƒè€…è®°å½•ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå‘å¸ƒè€…ä¼šä¼šé€šçŸ¥ watcherï¼Œä¹‹å watcher æ‰§è¡Œç›¸åº”çš„å¤„ç†



**åŠ«æŒæ•°æ®**

åŠ«æŒæ•°æ®å¯¹è±¡ï¼Œæ˜¯ Observer çš„å·¥ä½œï¼Œå®ƒçš„ç›®æ ‡å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªæ™®é€šçš„å¯¹è±¡è½¬æ¢ä¸ºå“åº”å¼çš„å¯¹è±¡

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼ŒObserver æŠŠå¯¹è±¡çš„æ¯ä¸ªå±æ€§é€šè¿‡ Object.defineProperty è½¬æ¢ä¸ºå¸¦æœ‰ getter å’Œ setter çš„å±æ€§ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“è®¿é—®æˆ–è®¾ç½®å±æ€§æ—¶ï¼ŒVue å°±æœ‰æœºä¼šåšä¸€äº›åˆ«çš„äº‹æƒ…ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-052809.png" alt="20210226153448" style="zoom:67%;" />

Observer æ˜¯ Vue å†…éƒ¨çš„æ„é€ å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Vue æä¾›çš„é™æ€æ–¹æ³• Vue.observable( object ) é—´æ¥çš„ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚

åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä»¶äº‹å‘ç”Ÿåœ¨ beforeCreate ä¹‹åï¼Œcreated ä¹‹å‰ã€‚

å…·ä½“å®ç°ä¸Šï¼Œ**å®ƒä¼šé€’å½’éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä»¥å®Œæˆæ·±åº¦çš„å±æ€§è½¬æ¢**ã€‚ç”±äºéå†æ—¶åªèƒ½éå†åˆ°å¯¹è±¡çš„å½“å‰å±æ€§ï¼Œå› æ­¤æ— æ³•ç›‘æµ‹åˆ°å°†æ¥åŠ¨æ€å¢åŠ æˆ–åˆ é™¤çš„å±æ€§ï¼Œå› æ­¤ Vue æä¾›äº† $set å’Œ $delete ä¸¤ä¸ªå®ä¾‹æ–¹æ³•ï¼Œè®©å¼€å‘è€…é€šè¿‡è¿™ä¸¤ä¸ªå®ä¾‹æ–¹æ³•å¯¹å·²æœ‰å“åº”å¼å¯¹è±¡æ·»åŠ æˆ–åˆ é™¤å±æ€§ã€‚å¯¹äºæ•°ç»„ï¼ŒVue ä¼šæ›´æ”¹å®ƒçš„éšå¼åŸå‹ï¼Œä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸º Vue éœ€è¦ç›‘å¬é‚£äº›å¯èƒ½æ”¹å˜æ•°ç»„å†…å®¹çš„æ–¹æ³•ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-052949.png" alt="20210226154624" style="zoom:67%;" />

æ€»ä¹‹ï¼ŒObserver çš„ç›®æ ‡ï¼Œå°±æ˜¯è¦è®©ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå±æ€§çš„è¯»å–ã€èµ‹å€¼ï¼Œå†…éƒ¨æ•°ç»„çš„å˜åŒ–éƒ½è¦èƒ½å¤Ÿè¢« Vue æ„ŸçŸ¥åˆ°ã€‚



**å‘å¸ƒè€…(å•†åº—)**

å‘å¸ƒè€…ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºä¾èµ–ç®¡ç†å™¨ï¼Œå¯¹åº”è‹±æ–‡ Dependencyï¼Œç®€ç§° Dep.

å…¶ä¸­æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªåŠŸèƒ½ï¼š

- èƒ½å¤Ÿæ·»åŠ è§‚å¯Ÿè€…ï¼šå½“è¯»å–å“åº”å¼å¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶ï¼Œå®ƒä¼šè¿›è¡Œä¾èµ–æ”¶é›†
- èƒ½å¤Ÿé€šçŸ¥è§‚å¯Ÿè€…ï¼šå½“æ”¹å˜æŸä¸ªå±æ€§æ—¶ï¼ˆå•†å“å‘å”®äº†ï¼‰ï¼Œå®ƒä¼šæ´¾å‘æ›´æ–°ï¼ˆé€šçŸ¥æ‰€æœ‰é¡¾å®¢ï¼‰

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-053233.png" alt="20210226155852" style="zoom:67%;" />



**è§‚å¯Ÿè€…**

å½“ä¾èµ–çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…ä¼šé€šçŸ¥æ¯ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œè€Œè§‚å¯Ÿè€…éœ€è¦è°ƒç”¨ update æ¥æ›´æ–°æ•°æ®ã€‚



**scheduler**

Vue2 å†…éƒ¨å®ç°ä¸­ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª Schedulerï¼Œå› ä¸ºDep é€šçŸ¥ watcher ä¹‹åï¼Œå¦‚æœ watcher æ‰§è¡Œé‡è¿è¡Œå¯¹åº”çš„å‡½æ•°ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å‡½æ•°é¢‘ç¹è¿è¡Œï¼Œä»è€Œå¯¼è‡´æ•ˆç‡ä½ä¸‹

è¯•æƒ³ï¼Œå¦‚æœä¸€ä¸ªäº¤ç»™ watcher çš„å‡½æ•°ï¼Œå®ƒé‡Œé¢ç”¨åˆ°äº†å±æ€§ aã€bã€cã€dï¼Œé‚£ä¹ˆ aã€bã€cã€d å±æ€§éƒ½ä¼šè®°å½•ä¾èµ–ï¼Œäºæ˜¯ä¸‹é¢çš„ä»£ç å°†è§¦å‘ 4 æ¬¡æ›´æ–°ï¼š

```js
state.a = "new data";
state.b = "new data";
state.c = "new data";
state.d = "new data";
```

è¿™æ ·æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œå› æ­¤ï¼Œwatcher æ”¶åˆ°æ´¾å‘æ›´æ–°çš„é€šçŸ¥åï¼Œå®é™…ä¸Šä¸æ˜¯ç«‹å³æ‰§è¡Œå¯¹åº”å‡½æ•°ï¼Œè€Œæ˜¯æŠŠè‡ªå·±äº¤ç»™ä¸€ä¸ªå«è°ƒåº¦å™¨çš„ä¸œè¥¿

è°ƒåº¦å™¨ç»´æŠ¤ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—ï¼Œè¯¥**é˜Ÿåˆ—åŒä¸€ä¸ª watcher ä»…ä¼šå­˜åœ¨ä¸€æ¬¡ï¼Œé˜Ÿåˆ—ä¸­çš„ watcher ä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œå®ƒä¼šé€šè¿‡ä¸€ä¸ªå«åš nextTick çš„å·¥å…·æ–¹æ³•ï¼ŒæŠŠè¿™äº›éœ€è¦æ‰§è¡Œçš„ watcher æ”¾å…¥åˆ°äº‹ä»¶å¾ªç¯çš„å¾®é˜Ÿåˆ—ä¸­**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œrender å‡½æ•°çš„æ‰§è¡Œæ˜¯**å¼‚æ­¥**çš„ï¼Œå¹¶ä¸”åœ¨**å¾®é˜Ÿåˆ—**ä¸­ã€‚



**Vue2å“åº”å¼æ•´ä½“æµç¨‹**

![20210226163936](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-053804.png)

å‡ ä¸ªæ ¸å¿ƒéƒ¨ä»¶ï¼š

1. Observerï¼šç”¨äºåŠ«æŒæ•°æ®å¯¹è±¡ï¼ŒæŠŠå¯¹è±¡çš„æ¯ä¸ªå±æ€§é€šè¿‡ Object.defineProperty è½¬æ¢ä¸ºå¸¦æœ‰ getter å’Œ setter çš„å±æ€§
2. Dep(å•†åº—)ï¼šå‘å¸ƒè€…ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºä¾èµ–ç®¡ç†å™¨
   - èƒ½å¤Ÿæ·»åŠ è§‚å¯Ÿè€…ï¼šå½“è¯»å–å“åº”å¼å¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶ï¼Œå®ƒä¼šè¿›è¡Œä¾èµ–æ”¶é›†
   - èƒ½å¤Ÿé€šçŸ¥è§‚å¯Ÿè€…ï¼šå½“æ”¹å˜æŸä¸ªå±æ€§æ—¶ï¼Œå®ƒä¼šæ´¾å‘æ›´æ–°
3. Watcherï¼ˆé¡¾å®¢ï¼‰ï¼šè´Ÿè´£å…·ä½“çš„æ›´æ–°æ“ä½œï¼ˆå¯ä»¥ç†è§£ä¸ºç”¨æˆ·æ”¶åˆ°å•†åœºçš„é‚®ä»¶åï¼Œè‡ªèº«è¦åšä»€ä¹ˆäº‹æƒ…ï¼‰
4. Schedulerï¼šè´Ÿè´£è°ƒåº¦ã€‚

---

-EOF-

# Vue3å“åº”å¼å˜åŒ–

>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´ Vue3 å“åº”å¼ç›¸è¾ƒäº Vue2 æ˜¯å¦æœ‰æ”¹å˜ï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹å…·ä½“æœ‰å“ªäº›æ”¹å˜ï¼Ÿ

**1. å˜åŒ–ä¸€**

é¦–å½“å…¶å†²çš„å°±æ˜¯æ•°æ®æ‹¦æˆªçš„å˜åŒ–ï¼š

- Vue2: ä½¿ç”¨ Object.defineProperty è¿›è¡Œæ‹¦æˆª
- Vue3: ä½¿ç”¨ Proxy + Object.defineProperty è¿›è¡Œæ‹¦æˆª

**ä¸¤è€…çš„å…±åŒç‚¹**

- éƒ½å¯ä»¥é’ˆå¯¹å¯¹è±¡æˆå‘˜æ‹¦æˆª
- éƒ½å¯ä»¥å®ç°æ·±åº¦æ‹¦æˆª

**ä¸¤è€…çš„å·®å¼‚ç‚¹**

- æ‹¦æˆªçš„å¹¿åº¦
  - Object.defineProperty æ˜¯é’ˆå¯¹å¯¹è±¡ç‰¹å®š**å±æ€§**çš„**è¯»å†™**æ“ä½œè¿›è¡Œæ‹¦æˆªï¼Œè¿™æ„å‘³ç€ä¹‹åæ–°å¢åŠ /åˆ é™¤çš„å±æ€§æ˜¯ä¾¦æµ‹ä¸åˆ°çš„
  - Proxy åˆ™æ˜¯é’ˆå¯¹**ä¸€æ•´ä¸ªå¯¹è±¡**çš„å¤šç§æ“ä½œï¼ŒåŒ…æ‹¬å±æ€§çš„è¯»å–ã€èµ‹å€¼ã€å±æ€§çš„åˆ é™¤ã€å±æ€§æè¿°ç¬¦çš„è·å–å’Œè®¾ç½®ã€åŸå‹çš„æŸ¥çœ‹ã€å‡½æ•°è°ƒç”¨ç­‰è¡Œä¸ºèƒ½å¤Ÿè¿›è¡Œæ‹¦æˆªã€‚
- æ€§èƒ½ä¸Šçš„åŒºåˆ«ï¼šåœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼ŒProxy æ¯” Object.defineProperty æ•ˆç‡æ›´é«˜ï¼Œæ‹¦æˆªæ–¹å¼æ›´åŠ çµæ´»ã€‚



**2. å˜åŒ–äºŒ**

åˆ›å»ºå“åº”å¼æ•°æ®ä¸Šé¢çš„å˜åŒ–ï¼š

- Vue2: é€šè¿‡ data æ¥åˆ›å»ºå“åº”å¼æ•°æ®
- Vue3: é€šè¿‡ refã€reactvie ç­‰æ–¹æ³•æ¥åˆ›å»ºå“åº”å¼æ•°æ®
  - refï¼šä½¿ç”¨ Object.defineProperty + Proxy æ–¹å¼
  - reactiveï¼šä½¿ç”¨ Proxy æ–¹å¼

**å¯¹åº”æºç **

```js
class RefImpl<T> {
  private _value: T
  private _rawValue: T

  public dep?: Dep = undefined
  public readonly __v_isRef = true

  constructor(
    value: T,
    public readonly __v_isShallow: boolean,
  ) {
    this._rawValue = __v_isShallow ? value : toRaw(value)
    // æœ‰å¯èƒ½æ˜¯åŸå§‹å€¼ï¼Œæœ‰å¯èƒ½æ˜¯ reactive è¿”å›çš„ proxy
    this._value = __v_isShallow ? value : toReactive(value)
  }

  get value() {
    // æ”¶é›†ä¾èµ– ç•¥
    return this._value
  }

  set value(newVal) {
    // ç•¥
  }
}

// åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œæ˜¯å¯¹è±¡å°±ç”¨ reactive æ¥å¤„ç†ï¼Œå¦åˆ™è¿”å›åŸå§‹å€¼
export const toReactive = <T extends unknown>(value: T): T =>
  isObject(value) ? reactive(value) : value
```

```js
function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>,
  proxyMap: WeakMap<Target, any>,
) {
  // ...
    
  // åˆ›å»º Proxy ä»£ç†å¯¹è±¡
  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers,
  )
  proxyMap.set(target, proxy)
  return proxy
}

export function reactive(target: object) {
  // ...
  
  return createReactiveObject(
    target,
    false,
    mutableHandlers,
    mutableCollectionHandlers,
    reactiveMap,
  )
}
```



**3. å˜åŒ–ä¸‰**

ä¾èµ–æ”¶é›†ä¸Šé¢çš„å˜åŒ–ï¼š

- Vue2ï¼šWatcher + Dep
  - æ¯ä¸ªå“åº”å¼å±æ€§éƒ½æœ‰ä¸€ä¸ª Dep å®ä¾‹ï¼Œç”¨äºåšä¾èµ–æ”¶é›†ï¼Œå†…éƒ¨åŒ…å«äº†ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨ä¾èµ–è¿™ä¸ªå±æ€§çš„æ‰€æœ‰ watcher
  - å½“å±æ€§å€¼å‘ç”Ÿå˜åŒ–ï¼Œdep å°±ä¼šé€šçŸ¥æ‰€æœ‰çš„ watcher å»åšæ›´æ–°æ“ä½œ

- Vue3ï¼šWeakMap + Map + Set
  - Vue3 çš„ä¾èµ–æ”¶é›†ç²’åº¦æ›´ç»†
  - WeakMap é”®å¯¹åº”çš„æ˜¯å“åº”å¼å¯¹è±¡ï¼Œå€¼æ˜¯ä¸€ä¸ª Mapï¼Œè¿™ä¸ª Map çš„é”®æ˜¯è¯¥å¯¹è±¡çš„å±æ€§ï¼Œå€¼æ˜¯ä¸€ä¸ª Setï¼ŒSet é‡Œé¢å­˜å‚¨äº†æ‰€æœ‰ä¾èµ–äºè¿™ä¸ªå±æ€§çš„ effect å‡½æ•°


æ€»ç»“èµ·æ¥ï¼ŒVue3ç›¸æ¯”Vue2çš„ä¾èµ–è¿½è¸ªç²’åº¦æ›´ç»†ï¼ŒVue2ä¾èµ–æ”¶é›†æ”¶é›†çš„æ˜¯å…·ä½“çš„Watcherï¼ˆç»„ä»¶ï¼‰ï¼ŒVue3ä¾èµ–æ”¶é›†æ”¶é›†çš„æ˜¯å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚

> é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´ Vue3 å“åº”å¼ç›¸è¾ƒäº Vue2 æ˜¯å¦æœ‰æ”¹å˜ï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹å…·ä½“æœ‰å“ªäº›æ”¹å˜ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> ç›¸æ¯”è¾ƒ Vue2ï¼ŒVue3 åœ¨å“åº”å¼çš„å®ç°æ–¹é¢æœ‰è¿™ä¹ˆä¸€äº›æ–¹é¢çš„æ”¹å˜ï¼š
>
> 1. æ•°æ®æ‹¦æˆªä» Object.defineProperty æ”¹ä¸ºäº† Proxy + Object.defineProperty çš„æ‹¦æˆªæ–¹å¼ï¼Œå…¶ä¸­
>    - refï¼šä½¿ç”¨ ObjectdefineProperty + Proxy æ–¹å¼
>    - reactiveï¼šä½¿ç”¨ Proxy æ–¹å¼
> 2. åˆ›å»ºå“åº”å¼æ•°æ®åœ¨è¯­æ³•å±‚é¢æœ‰äº†å˜åŒ–ï¼š
>    - Vue2: é€šè¿‡ data æ¥åˆ›å»ºå“åº”å¼æ•°æ®
>    - Vue3: é€šè¿‡ refã€reactvie ç­‰æ–¹æ³•æ¥åˆ›å»ºå“åº”å¼æ•°æ®
> 3. ä¾èµ–æ”¶é›†ä¸Šé¢çš„å˜åŒ–
>    - Vue2ï¼šWatcher + Dep
>    - Vue3ï¼šWeakMap + Map + Set
>    - è¿™ç§å®ç°æ–¹å¼å¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„ä¾èµ–è¿½è¸ªå’Œæ›´æ–°æ§åˆ¶

---

-EOF-

# nextTickå®ç°åŸç†

>é¢è¯•é¢˜ï¼šVue çš„ nextTick æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

```vue
<template>
  <div>
    <p>{{ count }}</p>
    <button @click="increment">å¢åŠ è®¡æ•°</button>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const count = ref(0)

const increment = () => {
  for (let i = 1; i <= 1000; i++) {
    count.value = i
  }
}
</script>
```

æ€è€ƒğŸ¤”ï¼šç‚¹å‡»æŒ‰é’®åï¼Œé¡µé¢ä¼šæ¸²æŸ“å‡ æ¬¡ï¼Ÿ

ç­”æ¡ˆï¼šåªä¼šæ¸²æŸ“ä¸€æ¬¡ï¼ŒåŒæ­¥ä»£ç ä¸­å¤šæ¬¡å¯¹å“åº”å¼æ•°æ®åšäº†ä¿®æ”¹ï¼Œå¤šæ¬¡ä¿®æ”¹ä¼šè¢«**åˆå¹¶**ä¸ºä¸€æ¬¡ï¼Œä¹‹åæ ¹æ®æœ€ç»ˆçš„ä¿®æ”¹ç»“æœ**å¼‚æ­¥**çš„å»æ›´æ–° DOM.

æ€è€ƒğŸ¤”ï¼šå€˜è‹¥ä¸åˆå¹¶ï¼Œå¹¶ä¸”åŒæ­¥çš„å»ä¿®æ”¹DOMï¼Œä¼šæœ‰ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Ÿ

ç­”æ¡ˆï¼šå¦‚æœä¸è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”æ•°æ®ä¸€å˜å°±åŒæ­¥æ›´æ–°DOMï¼Œä¼šå¯¼è‡´é¢‘ç¹çš„é‡ç»˜å’Œé‡æ’ï¼Œè¿™éå¸¸è€—è´¹æ€§èƒ½ã€‚

æ€è€ƒğŸ¤”ï¼šå¼‚æ­¥æ›´æ–°ä¼šå¸¦æ¥é—®é¢˜

ç­”æ¡ˆï¼šæ— æ³•åŠæ—¶è·å–åˆ°æ›´æ–°åçš„DOMå€¼

åŸå› ï¼šå› ä¸ºè·å–DOMæ•°æ®æ˜¯åŒæ­¥ä»£ç ï¼ŒDOMçš„æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼ŒåŒæ­¥ä»£ç ä¼šå…ˆäºå¼‚æ­¥ä»£ç æ‰§è¡Œã€‚

è§£å†³æ–¹æ¡ˆï¼šå°†è·å–DOMæ•°æ®çš„åŒæ­¥ä»»åŠ¡åŒ…è£…æˆä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œæµè§ˆå™¨åœ¨å®Œæˆä¸€æ¬¡æ¸²æŸ“åï¼Œå°±ä¼šç«‹å³æ‰§è¡Œå¾®ä»»åŠ¡ã€‚



å½“å‰æˆ‘ä»¬è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼š

```js
const increment = () => {
  count.value++

  Promise.resolve().then(() => {
    console.log('æœ€æ–°çš„æ•°æ®ï¼š', count.value)
    console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', counterRef.value.textContent)
    console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', document.getElementById('counter').textContent)
    console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', counterRef.value.innerHTML)
    console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', document.getElementById('counter').innerHTML)
  })
}
```

nextTick å¸®æˆ‘ä»¬åšçš„å°±æ˜¯ä¸Šé¢çš„äº‹æƒ…ï¼Œå°†ä¸€ä¸ªä»»åŠ¡åŒ…è£…æˆä¸€ä¸ªå¾®ä»»åŠ¡ã€‚

```js
const increment = () => {
  count.value++

  nextTick(() => {
    console.log('æœ€æ–°çš„æ•°æ®ï¼š', count.value)
    console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', counterRef.value.textContent)
    console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', document.getElementById('counter').textContent)
    console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', counterRef.value.innerHTML)
    console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', document.getElementById('counter').innerHTML)
  })
}
```

nextTick è¿”å›çš„æ˜¯ä¸€ä¸ª Promise

```js
const increment = async () => {
  count.value++

  await nextTick()
  console.log('æœ€æ–°çš„æ•°æ®ï¼š', count.value)
  console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', counterRef.value.textContent)
  console.log('é€šè¿‡DOMæ‹¿textContentæ•°æ®ï¼š', document.getElementById('counter').textContent)
  console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', counterRef.value.innerHTML)
  console.log('é€šè¿‡DOMæ‹¿innerHTMLæ•°æ®ï¼š', document.getElementById('counter').innerHTML)
}
```

$nextTickï¼Œé¦–å…ˆè¿™æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ Vue ç»„ä»¶å®ä¾‹çš„æ–¹æ³•ï¼Œç”¨äº OptionsAPI é£æ ¼çš„ã€‚

```js
export default {
  data() {
    return {
      count: 1,
      counterRef: null
    }
  },
  methods: {
    increment() {
      this.count++
      this.$nextTick(() => {
        // åœ¨ä¸‹ä¸€ä¸ª DOM æ›´æ–°å¾ªç¯åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
        console.log('æœ€æ–°æ•°æ®ä¸º:', this.count)
        console.log('æ‹¿åˆ°çš„DOM:', document.getElementById('counter'))
        console.log('æ‹¿åˆ°çš„DOM:', this.$refs.counterRef)
        console.log('é€šè¿‡DOMæ‹¿æ•°æ®:', document.getElementById('counter').textContent)
        console.log('é€šè¿‡DOMæ‹¿æ•°æ®:', document.getElementById('counter').innerHTML)
        console.log('é€šè¿‡DOMæ‹¿æ•°æ®:', this.$refs.counterRef.textContent)
        console.log('é€šè¿‡DOMæ‹¿æ•°æ®:', this.$refs.counterRef.innerHTML)
      })
    }
  }
}
```



[nextTickæºç ](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/scheduler.ts)

```js
// åˆ›å»ºä¸€ä¸ªå·²ç»è§£æçš„ Promise å¯¹è±¡ï¼Œè¿™ä¸ª Promise ä¼šç«‹å³è¢«è§£å†³ï¼Œ
// ç”¨äºåˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰ã€‚
const resolvedPromise = /*#__PURE__*/ Promise.resolve() as Promise<any>

// ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºè·Ÿè¸ªå½“å‰çš„åˆ·æ–° Promiseã€‚
// åˆå§‹çŠ¶æ€ä¸º nullï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰åˆ·æ–°ä»»åŠ¡ã€‚
let currentFlushPromise: Promise<void> | null = null

// queueFlush å‡½æ•°è´Ÿè´£å°†åˆ·æ–°ä»»åŠ¡ï¼ˆflushJobsï¼‰æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
// è¿™æ˜¯ Vue çš„å¼‚æ­¥æ›´æ–°æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½ã€‚
function queueFlush() {
  // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨åˆ·æ–°ï¼ˆisFlushingï¼‰æˆ–è€…åˆ·æ–°ä»»åŠ¡æ˜¯å¦å·²è¢«æŒ‚èµ·ï¼ˆisFlushPendingï¼‰ã€‚
  if (!isFlushing && !isFlushPending) {
    // è®¾ç½® isFlushPending ä¸º trueï¼Œè¡¨ç¤ºåˆ·æ–°ä»»åŠ¡å·²è¢«æŒ‚èµ·ï¼Œæ­£åœ¨ç­‰å¾…æ‰§è¡Œã€‚
    isFlushPending = true
    // å°† currentFlushPromise è®¾ç½®ä¸º resolvedPromise.then(flushJobs)
    // è¿™å°†åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œå½“ resolvedPromise è¢«è§£å†³æ—¶ï¼Œæ‰§è¡Œ flushJobs å‡½æ•°ã€‚
    currentFlushPromise = resolvedPromise.then(flushJobs)
  }
}

// nextTick å‡½æ•°ç”¨äºåœ¨ä¸‹ä¸€ä¸ª DOM æ›´æ–°å¾ªç¯ä¹‹åæ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚
// å®ƒè¿”å›ä¸€ä¸ª Promiseï¼Œè¿™ä¸ª Promise ä¼šåœ¨ DOM æ›´æ–°å®Œæˆåè§£å†³ã€‚
export function nextTick<T = void, R = void>(
  this: T,
  fn?: (this: T) => R,  // å¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œåœ¨ DOM æ›´æ–°ä¹‹åæ‰§è¡Œ
): Promise<Awaited<R>> {
  // å¦‚æœ currentFlushPromise ä¸ä¸º nullï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨ resolvedPromiseã€‚
  // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ DOM æ›´æ–°ä¹‹åå†æ‰§è¡Œå›è°ƒã€‚
  const p = currentFlushPromise || resolvedPromise
  
  // å¦‚æœä¼ å…¥äº†å›è°ƒå‡½æ•° fnï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œåœ¨ p è§£å†³ä¹‹åæ‰§è¡Œ fnã€‚
  // ä½¿ç”¨ this ç»‘å®šæ¥ç¡®ä¿å›è°ƒå‡½æ•°çš„ä¸Šä¸‹æ–‡æ­£ç¡®ã€‚
  return fn ? p.then(this ? fn.bind(this) : fn) : p
  // å¦‚æœæ²¡æœ‰ä¼ å…¥å›è°ƒå‡½æ•° fnï¼Œç›´æ¥è¿”å› Promise pï¼Œè¿™æ ·å¤–éƒ¨ä»£ç å¯ä»¥ä½¿ç”¨ await ç­‰å¾… DOM æ›´æ–°å®Œæˆã€‚
}
```



>é¢è¯•é¢˜ï¼šVue çš„ nextTick æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>nextTick çš„æœ¬è´¨å°†å›è°ƒå‡½æ•°åŒ…è£…ä¸ºä¸€ä¸ªå¾®ä»»åŠ¡æ”¾å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™æ ·æµè§ˆå™¨åœ¨å®Œæˆæ¸²æŸ“ä»»åŠ¡åä¼šä¼˜å…ˆæ‰§è¡Œå¾®ä»»åŠ¡ã€‚
>
>nextTick åœ¨ Vue2 å’Œ Vue3 é‡Œçš„å®ç°æœ‰ä¸€äº›ä¸åŒï¼š
>
>1. Vue2 ä¸ºäº†å…¼å®¹æ—§æµè§ˆå™¨ï¼Œä¼šæ ¹æ®ä¸åŒçš„ç¯å¢ƒé€‰æ‹©ä¸åŒåŒ…è£…ç­–ç•¥ï¼š
>
>  - ä¼˜å…ˆä½¿ç”¨ Promiseï¼Œå› ä¸ºå®ƒæ˜¯ç°ä»£æµè§ˆå™¨ä¸­æœ€æœ‰æ•ˆçš„å¾®ä»»åŠ¡å®ç°ã€‚
>
>  - å¦‚æœä¸æ”¯æŒ Promiseï¼Œåˆ™ä½¿ç”¨ MutationObserverï¼Œè¿™æ˜¯å¦ä¸€ç§å¾®ä»»åŠ¡æœºåˆ¶ã€‚
>
>  - åœ¨ IE ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ setImmediateï¼Œè¿™æ˜¯ä¸€ç§è¡¨ç°æ¥è¿‘å¾®ä»»åŠ¡çš„å®ä»»åŠ¡ã€‚
>
>  - æœ€åæ˜¯ setTimeout(fn, 0) ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œè¿™æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œä½†ä¼šåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­å°½å¿«æ‰§è¡Œã€‚
>
>
>2. Vue3 åˆ™æ˜¯åªè€ƒè™‘ç°ä»£æµè§ˆå™¨ç¯å¢ƒï¼Œç›´æ¥ä½¿ç”¨ Promise æ¥å®ç°å¾®ä»»åŠ¡çš„åŒ…è£…ï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºä»£ç æ›´åŠ ç®€æ´ï¼Œæ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºä¸éœ€è¦å¤„ç†å¤šç§ç¯å¢ƒçš„å…¼å®¹æ€§é—®é¢˜ã€‚
>
>æ•´ä½“æ¥è®²ï¼ŒVue3 çš„ nextTick å®ç°æ›´åŠ ç®€æ´å’Œé«˜æ•ˆï¼Œæ˜¯åŸºäºç°ä»£æµè§ˆå™¨ç¯å¢ƒçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œè€Œ Vue2 åˆ™ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘ï¼Œå®ç°å±‚é¢å­˜åœ¨æ›´å¤šçš„å…¼å®¹æ€§ä»£ç ã€‚

# ä¸¤é“ä»£ç é¢˜

é¢è¯•é¢˜1

å®Œæˆ Component ç±»ä»£ç çš„ä¹¦å†™ï¼Œè¦æ±‚ï¼š

1. ä¿®æ”¹æ•°æ®æ—¶èƒ½å¤Ÿè§¦å‘ render æ–¹æ³•çš„æ‰§è¡Œ
2. åŒæ­¥å˜æ›´æ—¶éœ€è¦åˆå¹¶ï¼Œä»…è§¦å‘ä¸€æ¬¡ render æ–¹æ³•

```js
class Component {
  data = {
    name: "",
  };
  constructor() {
  }
  render() {
    console.log(`render - name: ${this.data.name}`);
  }
}

const com = new Component();
// è¦æ±‚ä»¥ä¸‹ä»£ç éœ€è¦è§¦å‘ render æ–¹æ³•ï¼Œå¹¶ä¸”åŒæ­¥å˜æ›´éœ€è¦åˆå¹¶
com.data.name = "å¼ ä¸‰";
com.data.name = "æå››";
com.data.name = "ç‹äº”";

setTimeout(() => {
  com.data.name = "æ¸¡ä¸€";
}, 0);
```



é¢è¯•é¢˜2

ä»¥ä¸‹ä¸¤æ®µä»£ç åœ¨ Vue ä¸­åˆ†åˆ«æ¸²æŸ“å‡ æ¬¡ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

ä»£ç ä¸€ï¼š

```vue
<template>
	<div>{{rCount}}</div>
</template>
<script setup>
import { ref } from 'vue';
const count = 0;
const rCount = ref(count);
for(let i = 1; i <= 5; ++i){
	rCount.value = i;
}
</script>
```

ä»£ç äºŒï¼š

```vue
<template>
	<div>{{rCount}}</div>
</template>
<script setup>
import { ref } from 'vue';
const count = 0;
const rCount = ref(count);
for(let i = 1; i <= 5; ++i){
 setTimeout(()=>{
   rCount.value = i;
 }, 0);
}
</script>
```

- ä»£ç ä¸€ï¼š2æ¬¡ï¼Œåˆå§‹åŒ–æ¸²æŸ“1æ¬¡ï¼Œä¹‹åè™½ç„¶åœ¨ for å¾ªç¯ä¸­ä¿®æ”¹äº† 5 æ¬¡å“åº”å¼æ•°æ®ï¼Œä½†æ˜¯ä¼šè¢«åˆå¹¶ï¼Œå› æ­¤ä¹‹ååªä¼šæ¸²æŸ“ 1æ¬¡ã€‚
- ä»£ç äºŒï¼š6æ¬¡ï¼Œåˆå§‹åŒ–æ¸²æŸ“1æ¬¡ï¼Œä¹‹åæ¯ä¸€ä¸ª setTimeout ä¸­ä¿®æ”¹ä¸€æ¬¡å“åº”å¼æ•°æ®å°±ä¼šæ¸²æŸ“1æ¬¡ã€‚

>å‚è€ƒç­”æ¡ˆï¼š
>
>**ä»£ç ä¸€ï¼ˆåŒæ­¥èµ‹å€¼ï¼‰**
>
>ä¼šæ¸²æŸ“ä¸¤æ¬¡ï¼š
>
>1. åˆå§‹åŒ–æ¸²æŸ“ä¸€æ¬¡ï¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶ï¼ŒVue ä¼šè¿›è¡Œä¸€æ¬¡åˆå§‹æ¸²æŸ“ï¼Œå°† rCount çš„åˆå§‹å€¼ 0 æ¸²æŸ“åˆ° DOM ä¸­ã€‚
>
>2. å“åº”å¼æ•°æ®æ›´æ–°å’Œæ‰¹å¤„ç†ï¼š
>
>  - åœ¨ for å¾ªç¯ä¸­ï¼ŒrCount.value è¢«ä¾æ¬¡èµ‹å€¼ä¸º 1, 2, 3, 4, 5.  æ¯æ¬¡èµ‹å€¼æ—¶ï¼ŒVue çš„å“åº”å¼ç³»ç»Ÿä¼šæ£€æµ‹åˆ°æ•°æ®çš„å˜åŒ–ã€‚
>  - ç„¶è€Œï¼Œè¿™äº›å˜åŒ–å‘ç”Ÿåœ¨åŒä¸€ä¸ªåŒæ­¥ä»£ç å—å†…ï¼ŒVue ä¼šå°†è¿™äº›å˜åŒ–æ¨å…¥å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ä¸­ã€‚å› ä¸ºè¿™äº›èµ‹å€¼æ“ä½œæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼ŒVue ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸæ—¶å¯¹è¿™äº›å˜åŒ–è¿›è¡Œæ‰¹å¤„ç†ï¼ˆbatchingï¼‰
>  - Vue çš„æ‰¹å¤„ç†æœºåˆ¶ä¼šå°†è¿™äº›åŒæ­¥çš„æ›´æ”¹**åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°**ï¼Œå› æ­¤ï¼Œæ— è®ºæœ‰å¤šå°‘æ¬¡å¯¹ rCount.value çš„èµ‹å€¼ï¼Œæœ€ç»ˆåªä¼šåœ¨å¼‚æ­¥é˜Ÿåˆ—ä¸­è§¦å‘ä¸€æ¬¡æ¸²æŸ“æ›´æ–°ã€‚
>
>3. æœ€ç»ˆæ¸²æŸ“ä¸€æ¬¡ï¼šç”±äº Vue çš„æ‰¹å¤„ç†æœºåˆ¶ï¼Œè¿™æ®µä»£ç æœ€ç»ˆåªä¼šè§¦å‘ ä¸€æ¬¡ DOM æ›´æ–°ï¼Œæ¸²æŸ“å‡º rCount çš„æœ€ç»ˆå€¼ 5.
>
>æ€»è®¡æ¸²æŸ“æ¬¡æ•°ï¼š2 æ¬¡ï¼ˆåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ + æ‰¹å¤„ç†æ¸²æŸ“ 1 æ¬¡ï¼‰
>
>**ä»£ç äºŒï¼ˆå¼‚æ­¥èµ‹å€¼ï¼‰**
>
>ä¼šæ¸²æŸ“å…­æ¬¡ï¼š
>
>1. åˆå§‹åŒ–æ¸²æŸ“ä¸€æ¬¡ï¼šåŒæ ·ï¼Œç»„ä»¶æŒ‚è½½æ—¶ä¼šè¿›è¡Œä¸€æ¬¡åˆå§‹æ¸²æŸ“ï¼Œå°† rCount çš„åˆå§‹å€¼ 0 æ¸²æŸ“åˆ° DOM ä¸­ã€‚
>
>2. å¼‚æ­¥æ›´æ–°æ¸²æŸ“ï¼š
>
>  - åœ¨ for å¾ªç¯ä¸­ï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šåˆ›å»ºä¸€ä¸ª setTimeoutï¼Œæ¯ä¸ª setTimeout ä¼šåœ¨ 0 æ¯«ç§’åå¼‚æ­¥æ‰§è¡Œã€‚åœ¨æ¯ä¸ª setTimeout çš„å›è°ƒä¸­ï¼ŒrCount.value è¢«ä¾æ¬¡èµ‹å€¼ä¸º 1, 2, 3, 4, 5
>  - ç”±äºæ¯æ¬¡èµ‹å€¼éƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥å›è°ƒä¸­ï¼ŒVue çš„å“åº”å¼ç³»ç»Ÿä¼šåœ¨æ¯ä¸ªå¼‚æ­¥å›è°ƒæ‰§è¡Œåï¼Œç«‹å³è§¦å‘ç›¸åº”çš„æ›´æ–°æµç¨‹ã€‚æ¯æ¬¡ setTimeout å›è°ƒéƒ½ä¼šä½¿ rCount.value å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤æ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡æ¸²æŸ“æ›´æ–°ã€‚
>
>3. æ¯ä¸ªå¼‚æ­¥å›è°ƒå¯¼è‡´ä¸€æ¬¡æ¸²æŸ“ï¼šå› æ­¤ï¼Œè¿™æ®µä»£ç ä¼šè§¦å‘ 5 æ¬¡ DOM æ›´æ–°ï¼Œæ¯æ¬¡å°† rCount æ¸²æŸ“ä¸º 1 åˆ° 5.
>
>æ€»è®¡æ¸²æŸ“æ¬¡æ•°ï¼š6 æ¬¡ï¼ˆåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ + 5 æ¬¡å¼‚æ­¥æ›´æ–°æ¸²æŸ“ï¼‰

---

-EOF-

# Vueè¿è¡Œæœºåˆ¶

>é¢è¯•é¢˜ï¼šä»‹ç»ä¸€ä¸‹ Vue3 å†…éƒ¨çš„è¿è¡Œæœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ

Vue3 æ•´ä½“å¯ä»¥åˆ†ä¸ºå‡ å¤§æ ¸å¿ƒæ¨¡å—ï¼š

- å“åº”å¼ç³»ç»Ÿ
- ç¼–è¯‘å™¨
- æ¸²æŸ“å™¨



**å¦‚ä½•æè¿°UI**

æ€è€ƒğŸ¤”ï¼šUIæ¶‰åŠåˆ°çš„ä¿¡æ¯æœ‰å“ªäº›ï¼Ÿ

1. DOMå…ƒç´ 
2. å±æ€§
3. äº‹ä»¶
4. å…ƒç´ çš„å±‚æ¬¡ç»“æ„

æ€è€ƒğŸ¤”ï¼šå¦‚ä½•åœ¨ JS ä¸­æè¿°è¿™äº›ä¿¡æ¯ï¼Ÿ

è€ƒè™‘ä½¿ç”¨å¯¹è±¡æ¥æè¿°ä¸Šé¢çš„ä¿¡æ¯

```html
<h1 id='title' @click=handler><span>hello</span></h1>
```

```js
const obj = {
  tag: 'h1',
  props: {
    id: 'title',
    onClick: handler
  },
  children: [
    {
      tag: 'span',
      children: 'hello'
    }
  ]
}
```

è™½ç„¶è¿™ç§æ–¹å¼èƒ½å¤Ÿæè¿°å‡ºæ¥ UIï¼Œä½†æ˜¯éå¸¸éº»çƒ¦ï¼Œå› æ­¤ Vue æä¾›äº†æ¨¡æ¿çš„æ–¹å¼ã€‚

ç”¨æˆ·ä¹¦å†™æ¨¡æ¿----> ç¼–è¯‘å™¨ ----> æ¸²æŸ“å‡½æ•° ----> æ¸²æŸ“å‡½æ•°æ‰§è¡Œå¾—åˆ°ä¸Šé¢çš„ JS å¯¹è±¡ï¼ˆè™šæ‹ŸDOMï¼‰

è™½ç„¶å¤§å¤šæ•°æ—¶å€™ï¼Œæ¨¡æ¿æ¯” JS å¯¹è±¡æ›´åŠ ç›´è§‚ï¼Œä½†æ˜¯å¶å°”æœ‰ä¸€äº›åœºæ™¯ï¼ŒJS çš„æ–¹å¼æ›´åŠ çµæ´»

```vue
<h1 v-if="level === 1"></h1>
<h2 v-else-if="level === 2"></h2>
<h3 v-else-if="level === 3"></h3>
<h4 v-else-if="level === 4"></h4>
<h5 v-else-if="level === 5"></h5>
<h6 v-else-if="level === 6"></h6>
```

```js
let level = 1;
const title = {
  tag: `h${level}`
}
```



**ç¼–è¯‘å™¨**

ä¸»è¦è´Ÿè´£å°†å¼€å‘è€…æ‰€ä¹¦å†™çš„**æ¨¡æ¿è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°**ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘åçš„ç»“æœä¸ºï¼š

```js
function render(){
  return h('div', [
    h('h1', {id: someId}, 'Hello')
  ])
}
```

æ‰§è¡Œæ¸²æŸ“å‡½æ•°ï¼Œå°±ä¼šå¾—åˆ° JS å¯¹è±¡å½¢å¼çš„ UI è¡¨è¾¾ã€‚

æ•´ä½“æ¥è®²ï¼Œæ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20231113095532166](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘å™¨çš„å†…éƒ¨ï¼Œå®é™…ä¸Šåˆåˆ†ä¸ºäº†ï¼š

- è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºå¯¹åº”çš„æ¨¡æ¿ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰
- è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ASTè½¬æ¢ä¸º JS AST
- ç”Ÿæˆå™¨ï¼šå°† JS AST ç”Ÿæˆå¯¹åº”çš„ JS ä»£ç ï¼ˆæ¸²æŸ“å‡½æ•°ï¼‰

Vue3 çš„ç¼–è¯‘å™¨ï¼Œé™¤äº†æœ€åŸºæœ¬çš„ç¼–è¯‘ä»¥å¤–ï¼Œè¿˜åšäº†å¾ˆå¤šçš„ä¼˜åŒ–ï¼š

1. é™æ€æå‡
2. é¢„å­—ç¬¦ä¸²åŒ–
3. ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
4. Block Tree
5. PatchFlag



**æ¸²æŸ“å™¨**

æ‰§è¡Œæ¸²æŸ“å‡½æ•°å¾—åˆ°çš„å°±æ˜¯è™šæ‹Ÿ DOMï¼Œä¹Ÿå°±æ˜¯åƒè¿™æ ·çš„ JS å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«ç€ UI çš„æè¿°ä¿¡æ¯

```html
<div>ç‚¹å‡»</div>
```

```js
const vnode = {
  tag: 'div',
  props: {
    onClick: ()=> alert('hello')
  },
  children: 'ç‚¹å‡»'
}
```

æ¸²æŸ“å™¨æ‹¿åˆ°è¿™ä¸ªè™šæ‹Ÿ DOM åï¼Œå°±ä¼šå°†å…¶è½¬æ¢ä¸ºçœŸå®çš„ DOM

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-01-094219.png" alt="image-20240901174218998" style="zoom:50%;" />

ä¸€ä¸ªç®€æ˜“ç‰ˆæ¸²æŸ“å™¨çš„å®ç°æ€è·¯ï¼š

1. åˆ›å»ºå…ƒç´ 
2. ä¸ºå…ƒç´ æ·»åŠ å±æ€§å’Œäº‹ä»¶
3. å¤„ç†children

```js
function renderer(vnode, container){
  // 1. åˆ›å»ºå…ƒç´ 
	const el = document.createElement(vnode.tag);
  // 2. éå† propsï¼Œä¸ºå…ƒç´ æ·»åŠ å±æ€§
  for (const key in vnode.props) {
    if (/^on/.test(key)) {
      // å¦‚æœ key ä»¥ on å¼€å¤´ï¼Œè¯´æ˜å®ƒæ˜¯äº‹ä»¶
      el.addEventListener(
        key.substr(2).toLowerCase(), // äº‹ä»¶åç§° onClick --->click
        vnode.props[key] // äº‹ä»¶å¤„ç†å‡½æ•°
      );
    }
  }
  // 3. å¤„ç†children
  if(typeof vnode.children === 'string'){
    el.appendChild(document.createTextNode(vnode.children))
  } else if(Array.isArray(vnode.children)) {
    // é€’å½’çš„è°ƒç”¨ renderer
    vnode.children.forEach(child => renderer(child, el))
  }
  
  container.appendChild(el)
}
```



**ç»„ä»¶çš„æœ¬è´¨**

ç»„ä»¶æœ¬è´¨å°±æ˜¯**ä¸€ç»„ DOM å…ƒç´ **çš„å°è£…ã€‚

å‡è®¾å‡½æ•°ä»£è¡¨ä¸€ä¸ªç»„ä»¶ï¼š

```js
// è¿™ä¸ªå‡½æ•°å°±å¯ä»¥å½“ä½œæ˜¯ä¸€ä¸ªç»„ä»¶
const MyComponent = function () {
  return {
    tag: "div",
    props: {
      onClick: () => alert("hello"),
    },
    children: "click me",
  };
};
```

vnode çš„ tag å°±ä¸å†å±€é™äº html å…ƒç´ ï¼Œè€Œæ˜¯å¯ä»¥å†™ä½œè¿™ä¸ªå‡½æ•°åï¼š

```js
const vnode = {
  tag: MyComponent
}
```

æ¸²æŸ“å™¨éœ€è¦æ–°å¢é’ˆå¯¹è¿™ç§ tag ç±»å‹çš„å¤„ç†ï¼š

```js
function renderer(vnode, container) {
  if (typeof vnode.tag === "string") {
    // è¯´æ˜ vnode æè¿°çš„æ˜¯æ ‡ç­¾å…ƒç´ 
    mountElement(vnode, container);
  } else if (typeof vnode.tag === "function") {
    // è¯´æ˜ vnode æè¿°çš„æ˜¯ç»„ä»¶
    mountComponent(vnode, container);
  }
}
```

ç»„ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹è±¡çš„å½¢å¼ï¼š

```js
const MyComponent = {
  render(){
    return {
      tag: "div",
      props: {
        onClick: () => alert("hello"),
      },
      children: "click me",
  	};
  }
}
```

```js
function renderer(vnode, container) {
  if (typeof vnode.tag === "string") {
    // è¯´æ˜ vnode æè¿°çš„æ˜¯æ ‡ç­¾å…ƒç´ 
    mountElement(vnode, container);
  } else if (typeof vnode.tag === "object") {
    // è¯´æ˜ vnode æè¿°çš„æ˜¯ç»„ä»¶
    mountComponent(vnode, container);
  }
}
```



**å“åº”å¼ç³»ç»Ÿ**

æ€»ç»“ï¼šå½“æ¨¡æ¿ç¼–è¯‘æˆçš„æ¸²æŸ“å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæ¸²æŸ“å‡½æ•°å†…éƒ¨ç”¨åˆ°çš„å“åº”å¼æ•°æ®ä¼šå’Œæ¸²æŸ“å‡½æ•°æœ¬èº«æ„æˆä¾èµ–å…³ç³»ï¼Œä¹‹ååªè¦å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ¸²æŸ“å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œã€‚



> é¢è¯•é¢˜ï¼šä»‹ç»ä¸€ä¸‹ Vue3 å†…éƒ¨çš„è¿è¡Œæœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> Vue3 æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„æ¡†æ¶ã€‚å£°æ˜å¼çš„å¥½å¤„åœ¨äºï¼Œå®ƒç›´æ¥æè¿°ç»“æœï¼Œç”¨æˆ·ä¸éœ€è¦å…³æ³¨è¿‡ç¨‹ã€‚Vue.js é‡‡ç”¨æ¨¡æ¿çš„æ–¹å¼æ¥æè¿° UIï¼Œä½†å®ƒåŒæ ·æ”¯æŒä½¿ç”¨è™šæ‹Ÿ DOM æ¥æè¿° UIã€‚**è™šæ‹Ÿ DOM è¦æ¯”æ¨¡æ¿æ›´åŠ çµæ´»ï¼Œä½†æ¨¡æ¿è¦æ¯”è™šæ‹Ÿ DOM æ›´åŠ ç›´è§‚**ã€‚
>
> å½“ç”¨æˆ·ä½¿ç”¨æ¨¡æ¿æ¥æè¿° UI çš„æ—¶å€™ï¼Œå†…éƒ¨çš„ **ç¼–è¯‘å™¨** ä¼šå°†å…¶ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“å‡½æ•°æ‰§è¡Œåèƒ½å¤Ÿç¡®å®šå“åº”å¼æ•°æ®å’Œæ¸²æŸ“å‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¹‹åå“åº”å¼æ•°æ®ä¸€å˜åŒ–ï¼Œæ¸²æŸ“å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œã€‚
>
> æ¸²æŸ“å‡½æ•°æ‰§è¡Œçš„ç»“æœæ˜¯å¾—åˆ°è™šæ‹Ÿ DOMï¼Œä¹‹åå°±éœ€è¦ **æ¸²æŸ“å™¨** æ¥å°†è™šæ‹Ÿ DOM å¯¹è±¡æ¸²æŸ“ä¸ºçœŸå® DOM å…ƒç´ ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼Œé€’å½’åœ°éå†è™šæ‹Ÿ DOM å¯¹è±¡ï¼Œå¹¶è°ƒç”¨åŸç”Ÿ DOM API æ¥å®ŒæˆçœŸå® DOM çš„åˆ›å»ºã€‚æ¸²æŸ“å™¨çš„ç²¾é«“åœ¨äºåç»­çš„æ›´æ–°ï¼Œå®ƒä¼šé€šè¿‡ Diff ç®—æ³•æ‰¾å‡ºå˜æ›´ç‚¹ï¼Œå¹¶ä¸”åªä¼šæ›´æ–°éœ€è¦æ›´æ–°çš„å†…å®¹ã€‚
>
> ç¼–è¯‘å™¨ã€æ¸²æŸ“å™¨ã€å“åº”å¼ç³»ç»Ÿéƒ½æ˜¯ Vue å†…éƒ¨çš„æ ¸å¿ƒæ¨¡å—ï¼Œå®ƒä»¬å…±åŒæ„æˆä¸€ä¸ªæœ‰æœºçš„æ•´ä½“ï¼Œä¸åŒæ¨¡å—ä¹‹é—´äº’ç›¸é…åˆï¼Œè¿›ä¸€æ­¥æå‡æ¡†æ¶æ€§èƒ½ã€‚

---

-EOF-

# æ¸²æŸ“å™¨æ ¸å¿ƒåŠŸèƒ½

>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜¯æ ¹æ®æ‹¿åˆ°çš„ vnodeï¼Œè¿›è¡ŒèŠ‚ç‚¹çš„**æŒ‚è½½**ä¸**æ›´æ–°**ã€‚



**æŒ‚è½½å±æ€§**

vnodeï¼š

```js
const vnode = {
  type: 'div',
  // props å¯¹åº”çš„å°±æ˜¯èŠ‚ç‚¹çš„å±æ€§
  props: {
    id: 'foo'
  },
  children: [
    type: 'p',
    children: 'hello'
  ]
}
```

æ¸²æŸ“å™¨å†…éƒ¨æœ‰ä¸€ä¸ª mountElement æ–¹æ³•ï¼š

```js
function mountElement(vnode, container){
  // æ ¹æ®èŠ‚ç‚¹ç±»å‹åˆ›å»ºå¯¹åº”çš„DOMèŠ‚ç‚¹
  const el = document.createElement(vnode.type);
  
  // çœç•¥childrençš„å¤„ç†
  
  // å¯¹å±æ€§çš„å¤„ç†
  if(vnode.props){
    for(const key in vnode.props){
      el.setAttribute(key, vnode.props[key])
    }
  }
  
  insert(el, container);
}
```

é™¤äº†ä½¿ç”¨setAttributeæ–¹æ³•æ¥è®¾ç½®å±æ€§ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DOMå¯¹è±¡çš„æ–¹å¼ï¼š

```js
if(vnode.props){
  for(const key in vnode.props){
    // el.setAttribute(key, vnode.props[key])
    el[key] = vnode.props[key];
  }
}
```

æ€è€ƒğŸ¤”ï¼šå“ªç§è®¾ç½®æ–¹æ³•å¥½ï¼Ÿä¸¤ç§è®¾ç½®æ–¹æ³•æœ‰åŒºåˆ«å—ï¼Ÿåº”è¯¥ä½¿ç”¨å“ªç§æ¥è®¾ç½®ï¼Ÿ



**HTML Attributes**

Attributes æ˜¯å…ƒç´ çš„**åˆå§‹**å±æ€§å€¼ï¼Œåœ¨ HTML æ ‡ç­¾ä¸­å®šä¹‰ï¼Œç”¨äº**æè¿°å…ƒç´ çš„åˆå§‹çŠ¶æ€**ã€‚

- åœ¨å…ƒç´ è¢«è§£æçš„æ—¶å€™ï¼Œåªä¼šåˆå§‹åŒ–ä¸€æ¬¡
- åªèƒ½æ˜¯å­—ç¬¦ä¸²å€¼ï¼Œè€Œä¸”è¿™ä¸ªå€¼ä»…ä»£è¡¨åˆå§‹çš„çŠ¶æ€ï¼Œæ— æ³•ååº”è¿è¡Œæ—¶çš„å˜åŒ–

```vue
<input type="text" id="username" value="John">
```

**DOM Properties**

Properties æ˜¯ JavaScript å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œä»£è¡¨äº† DOM å…ƒç´ åœ¨ **å†…å­˜ä¸­** çš„å®é™…çŠ¶æ€ã€‚

- ååº”çš„æ˜¯ DOM å…ƒç´ çš„å½“å‰çŠ¶æ€
- å±æ€§ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€å¯¹è±¡ä¹‹ç±»çš„

å¾ˆå¤š HTML attributes åœ¨ DOM å¯¹è±¡ä¸Šæœ‰ä¸ä¹‹ç›¸åŒçš„ DOM Propertiesï¼Œä¾‹å¦‚ï¼š

| HTML attributes | DOM properties |
| --------------- | -------------- |
| id="username"   | el.id          |
| type="text"     | el.type        |
| value="John"    | el.value       |

ä½†æ˜¯ï¼Œä¸¤è€…å¹¶ä¸æ€»æ˜¯ç›¸ç­‰çš„ï¼Œä¾‹å¦‚ï¼š

| HTML attributes | DOM properties |
| --------------- | -------------- |
| class="foo"     | el.className   |

è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æƒ…å†µï¼š

- HTML attributes æœ‰ä½†æ˜¯ DOM properties æ²¡æœ‰çš„å±æ€§ï¼šä¾‹å¦‚ aria-* ä¹‹ç±»çš„HTML Attributes
- DOM properties æœ‰ä½†æ˜¯ HTML attributes æ²¡æœ‰çš„å±æ€§ï¼šä¾‹å¦‚ el.textContent
- ä¸€ä¸ª HTML attributes å…³è”å¤šä¸ª DOM properties çš„æƒ…å†µ:ä¾‹å¦‚ value="xxx" å’Œ el.value ä»¥åŠ el.defaultValue éƒ½æœ‰å…³è”

å¦å¤–ï¼Œåœ¨è®¾ç½®çš„æ—¶å€™ï¼Œä¸æ˜¯å•çº¯çš„ç”¨æŸä¸€ç§æ–¹å¼ï¼Œè€Œæ˜¯ä¸¤ç§æ–¹å¼ç»“åˆä½¿ç”¨ã€‚å› ä¸ºéœ€è¦è€ƒè™‘å¾ˆå¤šç‰¹æ®Šæƒ…å†µï¼š

1. disabled
2. åªè¯»å±æ€§

**1. disabled**

æ¨¡æ¿ï¼šæˆ‘ä»¬æƒ³è¦æ¸²æŸ“çš„æŒ‰é’®æ˜¯éç¦ç”¨çŠ¶æ€

```vue
<button :disabled="false">Button</button>
```

vnode:

```js
const vnode = {
  type: 'button',
  props: {
    disable: false
  }
}
```

é€šè¿‡ el.setAttribute æ–¹æ³•æ¥è¿›è¡Œè®¾ç½®ä¼šé‡åˆ°çš„é—®é¢˜ï¼šæœ€ç»ˆæ¸²æŸ“å‡ºæ¥çš„æŒ‰é’®å°±æ˜¯ç¦ç”¨çŠ¶æ€

```js
 el.setAttribute('disabled', 'false')
```

è§£å†³æ–¹æ¡ˆï¼šä¼˜å…ˆè®¾ç½® DOM Properties

é‡åˆ°æ–°çš„é—®é¢˜ï¼šæœ¬æ„æ˜¯è¦ç¦ç”¨æŒ‰é’®

```vue
<button disabled>Button</button>
```

```js
const vnode = {
  type: 'button',
  props: {
    disable: ''
  }
}
```

```js
el.disabled = ''
```

åœ¨å¯¹ DOM çš„ disabled å±æ€§è®¾ç½®å€¼çš„æ—¶å€™ï¼Œä»»ä½•éå¸ƒå°”ç±»å‹çš„å€¼éƒ½ä¼šè¢«è½¬ä¸ºå¸ƒå°”ç±»å‹ï¼š

```js
el.disabled = false
```

æœ€ç»ˆæ¸²æŸ“å‡ºæ¥çš„æŒ‰é’®æ˜¯éç¦ç”¨çŠ¶æ€ã€‚



**æ¸²æŸ“å™¨å†…éƒ¨çš„å®ç°ï¼Œä¸æ˜¯å•ç‹¬ç”¨ HTML Attribute æˆ–è€… DOM Propertiesï¼Œè€Œæ˜¯ä¸¤è€…ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”è¿˜ä¼šè€ƒè™‘å¾ˆå¤šçš„ç»†èŠ‚ä»¥åŠç‰¹æ®Šæƒ…å†µï¼Œé’ˆå¯¹ç‰¹æ®Šæƒ…å†µåšç‰¹æ®Šå¤„ç†**ã€‚

```js
function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      // ç”¨ in æ“ä½œç¬¦åˆ¤æ–­ key æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ DOM Properties
      if (key in el) {
        // è·å–è¯¥ DOM Properties çš„ç±»å‹
        const type = typeof el[key];
        const value = vnode.props[key];
        // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸” value æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
        if (type === "boolean" && value === "") {
          el[key] = true;
        } else {
          el[key] = value;
        }
      } else {
        // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
        el.setAttribute(key, vnode.props[key]);
      }
    }
  }
  insert(el, container);
}
```

**2. åªè¯»å±æ€§**

```vue
<input form="form1"/>
```

ä¾‹å¦‚ el.formï¼Œä½†æ˜¯è¿™ä¸ªå±æ€§æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µï¼Œåˆåªèƒ½ä½¿ç”¨ setAttribute æ–¹æ³•æ¥è®¾ç½®

```js
function shouldSetAsProps(el, key, value) {
  // ç‰¹æ®Šå¤„ç†
  // é‡åˆ°å…¶ä»–ç‰¹æ®Šæƒ…å†µå†è¿›è¡Œé‡æ„
  if (key === "form" && el.tagName === "INPUT") return false;
  // å…œåº•
  return key in el;
}

function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      const value = vnode.props[key];

      if (shouldSetAsProps(el, key, value)) {
        const type = typeof el[key];
        if (type === "boolean" && value === "") {
          el[key] = true;
        } else {
          el[key] = value;
        }
      } else {
        el.setAttribute(key, value);
      }
    }
  }
  insert(el, container);
}
```

shouldSetAsProps è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”±å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ä½¿ç”¨ DOM Properties æ¥è®¾ç½®ã€‚

è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå°†å±æ€§çš„è®¾ç½®æå–å‡ºæ¥ï¼š

```js
function shouldSetAsProps(el, key, value) {
  // ç‰¹æ®Šå¤„ç†
  if (key === "form" && el.tagName === "INPUT") return false;
  // å…œåº•
  return key in el;
}

/**
 *
 * @param {*} el å…ƒç´ 
 * @param {*} key å±æ€§
 * @param {*} prevValue æ—§å€¼
 * @param {*} nextValue æ–°å€¼
 */
function patchProps(el, key, prevValue, nextValue) {
  if (shouldSetAsProps(el, key, nextValue)) {
    const type = typeof el[key];
    if (type === "boolean" && nextValue === "") {
      el[key] = true;
    } else {
      el[key] = nextValue;
    }
  } else {
    el.setAttribute(key, nextValue);
  }
}

function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      // è°ƒç”¨ patchProps å‡½æ•°å³å¯
      patchProps(el, key, null, vnode.props[key]);
    }
  }
  insert(el, container);
}
```



**classå¤„ç†**

class æœ¬è´¨ä¸Šä¹Ÿæ˜¯å±æ€§çš„ä¸€ç§ï¼Œä½†æ˜¯åœ¨ Vue ä¸­é’ˆå¯¹ class åšäº†å¢å¼ºï¼Œå› æ­¤ Vue æ¨¡æ¿ä¸­çš„ class çš„å€¼å¯èƒ½ä¼šæœ‰è¿™ä¹ˆä¸€äº›æƒ…å†µï¼š

æƒ…å†µä¸€ï¼šå­—ç¬¦ä¸²å€¼

```vue
<template>
	<p class="foo bar"></p>
</template>
```

```js
const vnode = {
  type: "p",
  props: {
    class: "foo bar",
  },
};
```

æƒ…å†µäºŒï¼šå¯¹è±¡å€¼

```vue
<template>
	<p :class="cls"></p>
</template>
<script setup>
import { ref } from 'vue'
const cls = ref({
  foo: true,
  bar: false
})
</script>
```

```js
const vnode = {
  type: "p",
  props: {
    class: { foo: true, bar: false },
  },
};
```

æƒ…å†µä¸‰ï¼šæ•°ç»„å€¼

```vue
<template>
	<p :class="arr"></p>
</template>
<script setup>
import { ref } from 'vue'
const arr = ref([
  'foo bar',
  {
    baz: true
  }
])
</script>
```

```js
const vnode = {
  type: "p",
  props: {
    class: ["foo bar", { baz: true }],
  },
};
```

è¿™é‡Œé¦–å…ˆç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦åšå‚æ•°å½’ä¸€åŒ–ï¼Œç»Ÿä¸€æˆå­—ç¬¦ä¸²ç±»å‹ã€‚Vueå†…éƒ¨æœ‰ä¸€ä¸ªæ–¹æ³• normalizeClass å°±æ˜¯åš class çš„å‚æ•°å½’ä¸€åŒ–çš„ã€‚

```js
function isString(value) {
  return typeof value === "string";
}

function isArray(value) {
  return Array.isArray(value);
}

function isObject(value) {
  return value !== null && typeof value === "object";
}

function normalizeClass(value) {
  let res = "";
  if (isString(value)) {
    res = value;
  } else if (isArray(value)) {
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œé€’å½’è°ƒç”¨ normalizeClass
    for (let i = 0; i < value.length; i++) {
      const normalized = normalizeClass(value[i]);
      if (normalized) {
        res += (res ? " " : "") + normalized;
      }
    }
  } else if (isObject(value)) {
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™æ£€æŸ¥æ¯ä¸ª key æ˜¯å¦ä¸ºçœŸå€¼
    for (const name in value) {
      if (value[name]) {
        res += (res ? " " : "") + name;
      }
    }
  }
  return res;
}

console.log(normalizeClass("foo")); // 'foo'
console.log(normalizeClass(["foo", "bar"])); // 'foo bar'
console.log(normalizeClass({ foo: true, bar: false })); // 'foo'
console.log(normalizeClass(["foo", { bar: true }])); // 'foo bar'
console.log(normalizeClass(["foo", ["bar", "baz"]])); // 'foo bar baz'
```

```js
const vnode = {
  type: "p",
  props: {
    class: normalizeClass(["foo bar", { baz: true }]),
  },
};
```

```js
const vnode = {
  type: "p",
  props: {
    class: 'foo bar baz',
  },
};
```

è®¾ç½®classçš„æ—¶å€™ï¼Œè®¾ç½®æ–¹æ³•ä¹Ÿæœ‰å¤šç§ï¼š

1. setAttribute
2. el.classNameï¼šè¿™ç§æ–¹å¼æ•ˆç‡æ˜¯æœ€é«˜çš„
3. el.classList

```js
function patchProps(el, key, prevValue, nextValue) {
  // å¯¹ class è¿›è¡Œç‰¹æ®Šå¤„ç†
  if (key === "class") {
    el.className = nextValue || "";
  } else if (shouldSetAsProps(el, key, nextValue)) {
    const type = typeof el[key];
    if (type === "boolean" && nextValue === "") {
      el[key] = true;
    } else {
      el[key] = nextValue;
    }
  } else {
    el.setAttribute(key, nextValue);
  }
}
```



**å­èŠ‚ç‚¹çš„æŒ‚è½½**

é™¤äº†å¯¹è‡ªèº«èŠ‚ç‚¹çš„å¤„ç†ï¼Œè¿˜éœ€è¦å¯¹å­èŠ‚ç‚¹è¿›è¡Œå¤„ç†ï¼Œä¸è¿‡å¤„ç†å­èŠ‚ç‚¹æ—¶æ¶‰åŠåˆ° diff è®¡ç®—ã€‚

```js
function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  
  // é’ˆå¯¹å­èŠ‚ç‚¹è¿›è¡Œå¤„ç†
  if (typeof vnode.children === "string") {
    // å¦‚æœ children æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥å°†å­—ç¬¦ä¸²æ’å…¥åˆ°å…ƒç´ ä¸­
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœ children æ˜¯æ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
    vnode.children.forEach((child) => {
      patch(null, child, el);
    });
  }
  insert(el, container);
}
```



>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>æ¸²æŸ“å™¨æœ€æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯å¤„ç†ä»è™šæ‹Ÿ DOM åˆ°çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«å‡ ä¸ªé˜¶æ®µï¼š
>
>1. æŒ‚è½½ï¼šåˆæ¬¡æ¸²æŸ“æ—¶ï¼Œæ¸²æŸ“å™¨ä¼šå°†è™šæ‹Ÿ DOM è½¬åŒ–ä¸ºçœŸå® DOM å¹¶æ’å…¥é¡µé¢ã€‚å®ƒä¼šæ ¹æ®è™šæ‹ŸèŠ‚ç‚¹æ ‘é€’å½’åˆ›å»º DOM å…ƒç´ å¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚
>2. æ›´æ–°ï¼šå½“ç»„ä»¶çš„çŠ¶æ€æˆ–å±æ€§å˜åŒ–æ—¶ï¼Œæ¸²æŸ“å™¨ä¼šè®¡ç®—æ–°æ—§è™šæ‹Ÿ DOM çš„å·®å¼‚ï¼Œå¹¶é€šè¿‡ Patch è¿‡ç¨‹æœ€å°åŒ–æ›´æ–°çœŸå® DOMã€‚
>3. å¸è½½ï¼šå½“ç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œæ¸²æŸ“å™¨éœ€è¦å°†å…¶ä» DOM ä¸­ç§»é™¤ï¼Œå¹¶è¿›è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚
>
>æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æœ‰å¤§é‡éœ€è¦è€ƒè™‘çš„ç»†èŠ‚ï¼Œå°±æ‹¿æŒ‚è½½æ¥è®²ï¼Œå…‰æ˜¯å¤„ç†å…ƒç´ å±æ€§å¦‚ä½•æŒ‚è½½å°±æœ‰å¾ˆå¤šéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
>
>1. æœ€ç»ˆè®¾ç½®å±æ€§çš„æ—¶å€™æ˜¯ç”¨ setAttribute æ–¹æ³•æ¥è®¾ç½®ï¼Œè¿˜æ˜¯ç”¨ç»™ DOM å¯¹è±¡å±æ€§èµ‹å€¼çš„æ–¹å¼æ¥è®¾ç½®
>2. é‡åˆ°åƒ disabled è¿™æ ·çš„ç‰¹æ®Šå±æ€§è¯¥å¦‚ä½•å¤„ç†
>3. classã€style è¿™æ ·çš„å¤šå€¼ç±»å‹ï¼Œè¯¥å¦‚ä½•åšå‚æ•°çš„å½’ä¸€åŒ–ï¼Œå½’ä¸€ä¸ºå“ªç§å½¢å¼
>4. åƒ class è¿™æ ·çš„å±æ€§ï¼Œè®¾ç½®çš„æ–¹å¼æœ‰å“ªç§ï¼Œå“ªä¸€ç§æ•ˆç‡é«˜
>
>å¦å¤–ï¼Œæ¸²æŸ“å™¨å’Œå“åº”å¼ç³»ç»Ÿæ˜¯ç´§å¯†ç»“åˆåœ¨ä¸€æ¬¡çš„ï¼Œå½“ç»„ä»¶é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œç»„ä»¶é‡Œé¢çš„å“åº”å¼æ•°æ®ä¼šå’Œæ¸²æŸ“å‡½æ•°å»ºç«‹ä¾èµ–å…³ç³»ï¼Œå½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæ¸²æŸ“å‡½æ•°ä¼šé‡æ–°æ‰§è¡Œï¼Œç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOM æ ‘ï¼Œæ¸²æŸ“å™¨éšå³è¿›å…¥æ›´æ–°é˜¶æ®µï¼Œæ ¹æ®æ–°æ—§ä¸¤é¢—è™šæ‹Ÿ DOM æ ‘å¯¹æ¯”æ¥æœ€å°åŒ–æ›´æ–°çœŸå® DOMï¼Œè¿™æ¶‰åŠåˆ°äº† Vue ä¸­çš„ diff ç®—æ³•ã€‚diff ç®—æ³•è¿™ä¸€å—å„¿ï¼ŒVue2 é‡‡ç”¨çš„æ˜¯åŒç«¯ diffï¼ŒVue3 åˆ™æ˜¯åšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œé‡‡ç”¨çš„æ˜¯å¿«é€Ÿ diff ç®—æ³•ã€‚diff è¿™ä¸€å—å„¿éœ€è¦æˆ‘å±•å¼€è¯´ä¸€ä¸‹ä¹ˆï¼Ÿ

---

-EOF-

# äº‹ä»¶ç»‘å®šä¸æ›´æ–°

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue å†…éƒ¨æ˜¯å¦‚ä½•ç»‘å®šå’Œæ›´æ–°äº‹ä»¶çš„ï¼Ÿ

```vue
<p @click="clickHandler">text</p>
```

å¯¹åº”çš„ vnode å¦‚ä¸‹ï¼š

```js
const vnode = {
  type: 'p',
  props: {
    // äº‹ä»¶å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„å±æ€§ï¼Œæ”¾ç½®äºpropsé‡Œé¢
    onClick: ()=>{ 
      // ...
    }
  },
  children: 'text'
}
```

æ‰€ä»¥åœ¨æ¸²æŸ“å™¨å†…éƒ¨å¯ä»¥æ£€æµ‹ä»¥ on å¼€å¤´çš„å±æ€§ï¼Œè¯´æ˜å°±æ˜¯äº‹ä»¶ï¼Œä¾‹å¦‚ï¼š

```js
function renderer(vnode, container) {
  // ä½¿ç”¨ vnode.tag ä½œä¸ºæ ‡ç­¾åç§°åˆ›å»º DOM å…ƒç´ 
  const el = document.createElement(vnode.tag);
  // éå† vnode.propsï¼Œå°†å±æ€§ã€äº‹ä»¶æ·»åŠ åˆ° DOM å…ƒç´ 
  for (const key in vnode.props) {
    if(/^on/.test(key)){
      // è¯´æ˜æ˜¯äº‹ä»¶
      el.addEventListenser(
      	key.substr(2).toLowerCase(), // äº‹ä»¶åç§° onClick --> click
        vnode.props[key]
      )
    }
  }

  // å¤„ç† children
  if (typeof vnode.children === "string") {
    // å¦‚æœ children æ˜¯å­—ç¬¦ä¸²ï¼Œè¯´æ˜å®ƒæ˜¯å…ƒç´ çš„æ–‡æœ¬å­èŠ‚ç‚¹
    el.appendChild(document.createTextNode(vnode.children));
  } else if (Array.isArray(vnode.children)) {
    // é€’å½’åœ°è°ƒç”¨ renderer å‡½æ•°æ¸²æŸ“å­èŠ‚ç‚¹ï¼Œä½¿ç”¨å½“å‰å…ƒç´  el ä½œä¸ºæŒ‚è½½ç‚¹
    vnode.children.forEach((child) => renderer(child, el));
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°æŒ‚è½½ç‚¹ä¸‹
  container.appendChild(el);
}
```

ä¸è¿‡åœ¨ Vue æºç ä¸­ï¼Œæ¸²æŸ“å™¨å†…éƒ¨å…¶å®æœ‰ä¸€ä¸ª patchProps æ–¹æ³•:

```js
function patchProps(el, key, prevValue, nextValue){
  if(/^on/.test{key}){
   	// è¯´æ˜æ˜¯äº‹ä»¶ï¼Œåšäº‹ä»¶çš„ç»‘å®šæ“ä½œ
    const name = key.substr(2).toLowerCase(); // äº‹ä»¶åç§° onClick --> click
   	el.addEventListenser(name, vnode.props[key])
  } else if(key === 'class'){
    // ...
  } else if( 
    //... 
  ){
    // ...
  }
}
```

å¦‚æœæ¶‰åŠåˆ°äº‹ä»¶çš„æ›´æ–°ï¼Œåˆ™éœ€è¦å…ˆæŠŠä¸Šä¸€æ¬¡çš„**äº‹ä»¶å¸è½½**æ‰ï¼Œç„¶åç»‘å®šæ–°çš„äº‹ä»¶ï¼š

```js
function patchProps(el, key, prevValue, nextValue){
  if(/^on/.test{key}){
    // è¯´æ˜æ˜¯äº‹ä»¶ï¼Œåšäº‹ä»¶çš„ç»‘å®šæ“ä½œ
    const name = key.substr(2).toLowerCase(); // äº‹ä»¶åç§° onClick --> click
    // ç§»é™¤ä¸Šä¸€æ¬¡ç»‘å®šçš„äº‹ä»¶
    prevValue && el.removeEventListenser(name, prevValue);
    // å†æ¥ç»‘å®šæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
   	el.addEventListenser(name, vnode.props[key])
  } else if(key === 'class'){
    // ...
  } else if( 
    //... 
  ){
    // ...
  }
}
```

ä¸Šé¢çš„æ–¹å¼è™½ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯ä¼šæ¶‰åŠåˆ°åå¤çš„ç»‘å®šå’Œå¸è½½äº‹ä»¶ã€‚

ä¸€ç§æ›´åŠ ä¼˜é›…çš„æ–¹å¼æ˜¯å°†äº‹ä»¶å¤„ç†å™¨ä½œä¸ºä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œä¹‹ååªè¦æ›´æ–°è¯¥å¯¹è±¡çš„å±æ€§å³å¯ã€‚

```js
function patchProps(el, key, prevValue, nextValue){
  if(/^on/.test{key}){
    // è¯´æ˜æ˜¯äº‹ä»¶ï¼Œåšäº‹ä»¶çš„ç»‘å®šæ“ä½œ
    const name = key.substr(2).toLowerCase(); // äº‹ä»¶åç§° onClick --> click
    // è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å±æ€§ï¼Œå›å¤´ä¼šè¢«èµ‹å€¼ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
    let invoker = el._eventHandler; 
    if(nextValue){
      // è¯´æ˜æœ‰æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
      // è¿™é‡Œåˆæœ‰ä¸¤ç§æƒ…å†µï¼š1. ç¬¬ä¸€æ¬¡ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶çš„åˆå§‹åŒ–ï¼‰2.éç¬¬ä¸€æ¬¡ï¼ˆäº‹ä»¶çš„æ›´æ–°ï¼‰
      if(!invoker){
        // äº‹ä»¶çš„åˆå§‹åŒ–
        invoker = el._eventHandler = (e)=>{
          // æ‰§è¡ŒçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°
          invoker.value(e)
        }
        // å°†æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°æŒ‚è½½ invoker çš„ value å±æ€§ä¸Šé¢
        invoker.value = nextValue;
        // å› æ­¤æ˜¯ç¬¬ä¸€æ¬¡ï¼Œéœ€è¦åšäº‹ä»¶çš„æŒ‚è½½
        el.addEventListenser(name, invoker)
      } else {
        // äº‹ä»¶çš„æ›´æ–°
        // æ›´æ–°çš„æ—¶å€™ä¸éœ€è¦å†åƒä¹‹å‰ä¸€æ ·å…ˆå¸è½½äº‹ä»¶ï¼Œç›´æ¥æ›´æ–°invokerçš„valueå±æ€§å€¼å³å¯
        invoker.value = nextValue;
      }
    } else {
      // æ–°çš„äº‹ä»¶å¤„ç†å™¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±éœ€è¦å¸è½½æ—§çš„äº‹ä»¶å¤„ç†å™¨
      el.removeEventListenser(name, invoker);
    }
  } else if(key === 'class'){
    // ...
  } else if( 
    //... 
  ){
    // ...
  }
}
```

ä¸è¿‡ç›®å‰ä»ç„¶æœ‰é—®é¢˜ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½ç¼“å­˜ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè€Œä¸€ä¸ªå…ƒç´ å…¶å®æ˜¯å¯ä»¥ç»‘å®šå¤šç§äº‹ä»¶çš„ï¼Œä¾‹å¦‚ï¼š

```js
const vnode = {
  type: 'p',
  props: {
    onClick: ()=>{ 
      // ...
    },
    onContextmenu: ()=>{
      // ...
    }
  },
  children: 'text'
}
```

æŠŠ el._eventHandler ç”±å¯¹åº”çš„ä¸€ä¸ªå‡½æ•°æ”¹ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„é”®å°±æ˜¯äº‹ä»¶çš„åç§°ï¼Œå¯¹è±¡çš„å€¼åˆ™æ˜¯å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼š

```js
function patchProps(el, key, prevValue, nextValue){
  if(/^on/.test{key}){
    // è¯´æ˜æ˜¯äº‹ä»¶ï¼Œåšäº‹ä»¶çš„ç»‘å®šæ“ä½œ
    const name = key.substr(2).toLowerCase(); // äº‹ä»¶åç§° onClick --> click
    // è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å±æ€§ï¼Œå›å¤´ä¼šè¢«èµ‹å€¼ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
    const invokers = el._eventHandler || (el._eventHandler = {})
    let invoker = invokers[key]; 
    if(nextValue){
      // è¯´æ˜æœ‰æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
      // è¿™é‡Œåˆæœ‰ä¸¤ç§æƒ…å†µï¼š1. ç¬¬ä¸€æ¬¡ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶çš„åˆå§‹åŒ–ï¼‰2.éç¬¬ä¸€æ¬¡ï¼ˆäº‹ä»¶çš„æ›´æ–°ï¼‰
      if(!invoker){
        // äº‹ä»¶çš„åˆå§‹åŒ–
        invoker = el._eventHandler[key] = (e)=>{
          // æ‰§è¡ŒçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°
          invoker.value(e)
        }
        // å°†æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°æŒ‚è½½ invoker çš„ value å±æ€§ä¸Šé¢
        invoker.value = nextValue;
        // å› æ­¤æ˜¯ç¬¬ä¸€æ¬¡ï¼Œéœ€è¦åšäº‹ä»¶çš„æŒ‚è½½
        el.addEventListenser(name, invoker)
      } else {
        // äº‹ä»¶çš„æ›´æ–°
        // æ›´æ–°çš„æ—¶å€™ä¸éœ€è¦å†åƒä¹‹å‰ä¸€æ ·å…ˆå¸è½½äº‹ä»¶ï¼Œç›´æ¥æ›´æ–°invokerçš„valueå±æ€§å€¼å³å¯
        invoker.value = nextValue;
      }
    } else {
      // æ–°çš„äº‹ä»¶å¤„ç†å™¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±éœ€è¦å¸è½½æ—§çš„äº‹ä»¶å¤„ç†å™¨
      el.removeEventListenser(name, invoker);
    }
  } else if(key === 'class'){
    // ...
  } else if( 
    //... 
  ){
    // ...
  }
}
```

å¦å¤–è¿˜æœ‰ä¸€ç§æƒ…å†µæˆ‘ä»¬éœ€è¦è§£å†³ï¼Œé‚£å°±æ˜¯åŒç§äº‹ä»¶ç±»å‹ç»‘å®šå¤šä¸ªäº‹ä»¶å¤„ç†å‡½æ•°çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š

```js
el.addEventListener('click', fn1);
el.addEventListener('click', fn2);
```

```js
// å¯¹åº”çš„ vnode ç»“æ„
const vnode = {
  type: 'p',
  props: {
     // äº‹ä»¶å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„å±æ€§ï¼Œæ”¾ç½®äºpropsé‡Œé¢
    onClick: [
      ()=>{},
      ()=>{}
    ]
  },
  children: 'text'
}
```

```js
function patchProps(el, key, prevValue, nextValue){
  if(/^on/.test{key}){
    // è¯´æ˜æ˜¯äº‹ä»¶ï¼Œåšäº‹ä»¶çš„ç»‘å®šæ“ä½œ
    const name = key.substr(2).toLowerCase(); // äº‹ä»¶åç§° onClick --> click
    // è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å±æ€§ï¼Œå›å¤´ä¼šè¢«èµ‹å€¼ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
    const invokers = el._eventHandler || (el._eventHandler = {})
    let invoker = invokers[key]; 
    if(nextValue){
      // è¯´æ˜æœ‰æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
      // è¿™é‡Œåˆæœ‰ä¸¤ç§æƒ…å†µï¼š1. ç¬¬ä¸€æ¬¡ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶çš„åˆå§‹åŒ–ï¼‰2.éç¬¬ä¸€æ¬¡ï¼ˆäº‹ä»¶çš„æ›´æ–°ï¼‰
      if(!invoker){
        // äº‹ä»¶çš„åˆå§‹åŒ–
        invoker = el._eventHandler[key] = (e)=>{
          // è¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œè¯´æ˜æœ‰å¤šä¸ªäº‹ä»¶å¤„ç†å‡½æ•°
          if(Array.isArray(invoker.value)){
            invoker.value.forEach(fn=>fn(e))
          } else {
            // æ‰§è¡ŒçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°
          	invoker.value(e)
          }
        }
        // å°†æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°æŒ‚è½½ invoker çš„ value å±æ€§ä¸Šé¢
        invoker.value = nextValue;
        // å› æ­¤æ˜¯ç¬¬ä¸€æ¬¡ï¼Œéœ€è¦åšäº‹ä»¶çš„æŒ‚è½½
        el.addEventListenser(name, invoker)
      } else {
        // äº‹ä»¶çš„æ›´æ–°
        // æ›´æ–°çš„æ—¶å€™ä¸éœ€è¦å†åƒä¹‹å‰ä¸€æ ·å…ˆå¸è½½äº‹ä»¶ï¼Œç›´æ¥æ›´æ–°invokerçš„valueå±æ€§å€¼å³å¯
        invoker.value = nextValue;
      }
    } else {
      // æ–°çš„äº‹ä»¶å¤„ç†å™¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±éœ€è¦å¸è½½æ—§çš„äº‹ä»¶å¤„ç†å™¨
      el.removeEventListenser(name, invoker);
    }
  } else if(key === 'class'){
    // ...
  } else if( 
    //... 
  ){
    // ...
  }
}
```



>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue å†…éƒ¨æ˜¯å¦‚ä½•ç»‘å®šå’Œæ›´æ–°äº‹ä»¶çš„ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>å¼€å‘è€…åœ¨æ¨¡æ¿ä¸­ä¹¦å†™äº‹ä»¶ç»‘å®šï¼š
>
>```vue
><p @click='clickHandler'>text</p>
>```
>
>æ¨¡æ¿è¢«ç¼–è¯‘å™¨ç¼–è¯‘åä¼šç”Ÿæˆæ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“å‡½æ•°çš„æ‰§è¡Œå¾—åˆ°çš„æ˜¯è™šæ‹Ÿ DOM.
>
>äº‹ä»¶åœ¨è™šæ‹Ÿ DOM ä¸­å…¶å®å°±æ˜¯ä»¥ Props çš„å½¢å¼å­˜åœ¨çš„ã€‚åœ¨æ¸²æŸ“å™¨å†…éƒ¨ï¼Œä¼šæœ‰ä¸€ä¸ªä¸“é—¨é’ˆå¯¹ Props è¿›è¡Œå¤„ç†çš„æ–¹æ³•ï¼Œå½“é‡åˆ°ä»¥ on å¼€å¤´çš„ Prop æ—¶å€™ï¼Œä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼Œä»è€Œè¿›è¡Œäº‹ä»¶çš„ç»‘å®šæ“ä½œã€‚
>
>ä¸ºäº†é¿å…äº‹ä»¶æ›´æ–°æ—¶é¢‘ç¹çš„å¸è½½æ—§äº‹ä»¶ï¼Œç»‘å®šæ–°äº‹ä»¶æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼ŒVue å†…éƒ¨å°†äº‹ä»¶ä½œä¸ºä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œæ›´æ–°äº‹ä»¶çš„æ—¶å€™åªéœ€è¦æ›´æ–°å¯¹è±¡çš„å±æ€§å€¼å³å¯ã€‚è¯¥å¯¹è±¡çš„ç»“æ„å¤§è‡´ä¸ºï¼š
>
>```js
>{
> onClick: [
>     ()=>{},
>     ()=>{},
> ],
> onContextmenu: ()=>{}
> // ...
>}
>```
>
>è¿™ç§ç»“æ„èƒ½åšåˆ°ï¼š
>
>1. ä¸€ä¸ªå…ƒç´ ç»‘å®šå¤šç§äº‹ä»¶
>2. æ”¯æŒåŒç§äº‹ä»¶ç±»å‹ç»‘å®šå¤šä¸ªäº‹ä»¶å¤„ç†å‡½æ•°

---

-EOF-

# computedé¢è¯•é¢˜

>é¢è¯•é¢˜ï¼šè°ˆè°ˆ computed çš„æœºåˆ¶ï¼Œç¼“å­˜äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ computed ä¸æ”¯æŒå¼‚æ­¥ï¼Ÿ

å“åº”å¼ç³»ç»Ÿï¼š

- trackï¼šè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå»ºç«‹æ•°æ®å’Œå‡½æ•°çš„æ˜ å°„å…³ç³»
- triggerï¼šè§¦å‘æ›´æ–°ï¼Œé‡æ–°æ‰§è¡Œæ•°æ®æ‰€æ˜ å°„çš„æ‰€æœ‰å‡½æ•°

computedå¼€å‘è€…ä½¿ç”¨ï¼š

```js
const state = reactive({
  a: 1,
  b: 2
})

const sum = computed(() => {
  return state.a + state.b
})
```

```js
const firstName = ref('John')
const lastName = ref('Doe')

const fullName = computed({
  get() {
    return firstName.value + ' ' + lastName.value
  },
  set(newValue) {
    ;[firstName.value, lastName.value] = newValue.split(' ')
  }
})
```

computedæ ¸å¿ƒå®ç°ï¼š

1. å‚æ•°å½’ä¸€åŒ–ï¼Œç»Ÿä¸€æˆå¯¹è±¡çš„å½¢å¼
2. è¿”å›ä¸€ä¸ªå­˜å–å™¨å¯¹è±¡

```js
import { effect } from "./effect/effect.js";
import track from "./effect/track.js";
import trigger from "./effect/trigger.js";
import { TriggerOpTypes, TrackOpTypes } from "./utils.js";

// å‚æ•°å½’ä¸€åŒ–
function normalizeParameter(getterOrOptions) {
  // ä»£ç ç•¥
}

/**
 *
 * @param {*} getterOrOptions å¯èƒ½æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹è±¡
 */
export function computed(getterOrOptions) {
  // 1. å‚æ•°å½’ä¸€åŒ–
  const {getter, setter} = normalizeParameter(getterOrOptions);
  
  // value ç”¨äºå­˜å‚¨è®¡ç®—ç»“æœï¼Œ dirty è´Ÿè´£æ§åˆ¶ä»ç¼“å­˜ä¸­è·å–å€¼è¿˜æ˜¯é‡æ–°è®¡ç®—æ–°çš„å€¼ï¼Œdirtyä¸ºtrueå°±ä»£è¡¨è¦é‡æ–°è®¡ç®—
  let value, dirty = true;
  
  // è®©getterå†…éƒ¨çš„å“åº”å¼æ•°æ®å’Œgetterå»ºç«‹æ˜ å°„å…³ç³»
  // å›å¤´getterå†…éƒ¨çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œé‡æ–°æ‰§è¡Œgetter
  const effectFn = effect(getter, {
    lazy: true,
    scheduler(){
      dirty = true;
      trigger(obj, TriggerOpTypes.SET, "value")
    }
  })
  
  
  // 2. è¿”å›ä¸€ä¸ªå­˜å–å™¨å¯¹è±¡
  const obj = {
    get value(){
      // éœ€è¦å°† value å’Œæ¸²æŸ“å‡½æ•°å»ºç«‹æ˜ å°„å…³ç³»
      track(obj, TrackOpTypes.GET, "value")
      if(dirty){
        value = effectFn()
        dirty = false;
      }
      return value;
    },
    set value(newValue){
      setter(newValue)
    }
  }
  return obj;
}
```



> é¢è¯•é¢˜ï¼šè°ˆè°ˆ computed çš„æœºåˆ¶ï¼Œç¼“å­˜äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ computed ä¸æ”¯æŒå¼‚æ­¥ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> **è°ˆè°ˆ computed çš„æœºåˆ¶ï¼Œç¼“å­˜äº†ä»€ä¹ˆï¼Ÿ**
>
> ç¼“å­˜çš„æ˜¯ä¸Šä¸€æ¬¡ getter è®¡ç®—å‡ºæ¥çš„å€¼ã€‚
>
> **ä¸ºä»€ä¹ˆ computed ä¸æ”¯æŒå¼‚æ­¥ï¼Ÿ**
>
> computed å±æ€§åœ¨ Vue ä¸­ä¸æ”¯æŒå¼‚æ­¥æ“ä½œçš„ä¸»è¦åŸå› æ˜¯è®¾è®¡ä¸Šçš„ç†å¿µå’Œä½¿ç”¨åœºæ™¯çš„è€ƒè™‘ã€‚**computed å±æ€§çš„åˆè¡·æ˜¯ç”¨äºè®¡ç®—å¹¶ç¼“å­˜ä¸€ä¸ªåŸºäºå“åº”å¼ä¾èµ–çš„åŒæ­¥è®¡ç®—ç»“æœ**ï¼Œå½“å…¶ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒVue ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®— computed çš„å€¼ï¼Œå¹¶å°†å…¶ç¼“å­˜ï¼Œä»¥æé«˜æ€§èƒ½ã€‚
>
> computed ä¸æ”¯æŒå¼‚æ­¥çš„å‡ ä¸ªå…·ä½“åŸå› ï¼š
>
> 1. ç¼“å­˜æœºåˆ¶ä¸åŒæ­¥è®¡ç®—ï¼šcomputed å±æ€§çš„ä¸€ä¸ªæ ¸å¿ƒç‰¹æ€§æ˜¯ç¼“å­˜ã€‚å½“ä¾èµ–çš„å“åº”å¼æ•°æ®æ²¡æœ‰å˜åŒ–æ—¶ï¼Œcomputed çš„è®¡ç®—ç»“æœä¼šè¢«ç¼“å­˜å¹¶ç›´æ¥è¿”å›ï¼Œè€Œä¸ä¼šé‡æ–°æ‰§è¡Œè®¡ç®—ã€‚è¿™ç§ç¼“å­˜æœºåˆ¶æ˜¯åŸºäºåŒæ­¥è®¡ç®—çš„ï¼Œå‡å¦‚å…è®¸å¼‚æ­¥è®¡ç®—ï¼Œé‚£ä¹ˆåœ¨å¼‚æ­¥æ“ä½œå®Œæˆä¹‹å‰ï¼Œcomputed å±æ€§æ— æ³•æä¾›æœ‰æ•ˆçš„è¿”å›å€¼ï¼Œè¿™ä¸å®ƒçš„åŒæ­¥ç¼“å­˜ç†å¿µç›¸è¿èƒŒã€‚
> 2. æ•°æ®ä¸€è‡´æ€§ï¼šcomputed å±æ€§é€šå¸¸ç”¨äºæ¨¡æ¿ä¸­çš„ç»‘å®šï¼Œå®ƒçš„è®¡ç®—ç»“æœéœ€è¦åœ¨æ¸²æŸ“æœŸé—´æ˜¯ç¨³å®šä¸”å¯ç”¨çš„ã€‚å¦‚æœ computed æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œæ¸²æŸ“è¿‡ç¨‹ä¸­çš„æ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´æ¨¡æ¿æ¸²æŸ“æ—¶æ— æ³•ç¡®å®šä½¿ç”¨ä»€ä¹ˆæ•°æ®ï¼Œä»è€Œå¯èƒ½é€ æˆè§†å›¾çš„é—ªçƒæˆ–æ•°æ®é”™è¯¯ã€‚
> 3. è°ƒè¯•ä¸ä¾èµ–è¿½è¸ªå›°éš¾ï¼šå¦‚æœ computed å±æ€§æ˜¯å¼‚æ­¥çš„ï¼Œé‚£ä¹ˆåœ¨è°ƒè¯•å’Œä¾èµ–è¿½è¸ªæ—¶å°±ä¼šå˜å¾—éå¸¸å¤æ‚ã€‚å¼‚æ­¥æ“ä½œçš„å®Œæˆæ—¶é—´ä¸ç¡®å®šï¼Œä¼šä½¿å¾—ä¾èµ–è¿½è¸ªçš„è¿‡ç¨‹å˜å¾—ä¸ç›´è§‚ï¼Œä¹Ÿéš¾ä»¥é¢„æœŸã€‚
>
> å¦‚æœéœ€è¦è¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œé€šå¸¸æ¨èä½¿ç”¨ watch æ¥å®ç°ã€‚

---

-EOF-

# watché¢è¯•é¢˜

>é¢è¯•é¢˜ï¼šwatch å’Œ computed çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿè¯´ä¸€è¯´å„è‡ªçš„ä½¿ç”¨åœºæ™¯ï¼Ÿ

watchçš„ä½¿ç”¨

```js
const count = ref('');
watch(count, async (newVal, oldVal)=>{})

watch(()=>{
  count...
}, (newVal, oldVal)=>{
  // ...
})
```

watchæ ¸å¿ƒå®ç°

```js
import { effect, cleanup } from "./effect/effect.js";

// éå†å¯¹è±¡
function traverse(value, seen = new Set()) {
  // ...
}

/**
 * @param {*} source 
 * @param {*} cb è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
 * @param {*} options é€‰é¡¹å¯¹è±¡
 * @returns
 */
export function watch(source, cb, options = {}) {
  // 1. å‚æ•°å½’ä¸€åŒ–ï¼Œç»Ÿä¸€æˆä¸€ä¸ªå‡½æ•°
  let getter;
  if(typeof source === 'function'){
    getter = source;
  } else {
    getter = () => traverse(source)
  }
  
  // 2. ä¿å­˜æ–°å€¼å’Œæ—§å€¼
  let oldValue, newValue;
  
  const effectFn = effect(()=>getter(), {
    lazy: true,
    scheduler: ()=>{
      newValue = effectFn();
      cb(newValue, oldValue)
      oldValue = newValue
    }
  })
  
  oldValue = effectFn()
  
  return ()=>{
    cleanup(effectFn)
  }
}
```



> é¢è¯•é¢˜ï¼šwatch å’Œ computed çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿè¯´ä¸€è¯´å„è‡ªçš„ä½¿ç”¨åœºæ™¯ï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> **computed**
>
> - ä½œç”¨ï¼šç”¨äºåˆ›å»ºè®¡ç®—å±æ€§ï¼Œä¾èµ–äº Vue çš„å“åº”å¼ç³»ç»Ÿæ¥åšæ•°æ®è¿½è¸ªã€‚å½“ä¾èµ–çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ã€‚
> - æ— å‰¯ä½œç”¨ï¼šè®¡ç®—å±æ€§å†…éƒ¨çš„è®¡ç®—åº”å½“æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…ä»…åŸºäºæ•°æ®åšäºŒæ¬¡è®¡ç®—ã€‚
> - ç¼“å­˜ï¼šè®¡ç®—å±æ€§å…·å¤‡ç¼“å­˜æœºåˆ¶ï¼Œå¦‚æœå“åº”å¼æ•°æ®æ²¡å˜ï¼Œæ¯æ¬¡è·å–è®¡ç®—å±æ€§æ—¶ï¼Œå†…éƒ¨ç›´æ¥è¿”å›çš„æ˜¯ä¸Šä¸€æ¬¡è®¡ç®—å€¼ã€‚
> - ç”¨å¤„ï¼šé€šå¸¸ç”¨äºæ¨¡æ¿å½“ä¸­ï¼Œä»¥ä¾¿åœ¨æ¨¡æ¿ä¸­æ˜¾ç¤ºäºŒæ¬¡è®¡ç®—åçš„ç»“æ„ã€‚
> - åŒæ­¥ï¼šè®¡ç®—å±æ€§çš„ä¸€ä¸ªæ ¸å¿ƒç‰¹æ€§æ˜¯ç¼“å­˜ï¼Œè€Œè¿™ç§ç¼“å­˜æœºåˆ¶æ˜¯åŸºäºåŒæ­¥è®¡ç®—çš„ï¼Œå‡å¦‚å…è®¸å¼‚æ­¥è®¡ç®—ï¼Œé‚£ä¹ˆåœ¨å¼‚æ­¥æ“ä½œå®Œæˆä¹‹å‰ï¼Œè®¡ç®—å±æ€§æ— æ³•æä¾›æœ‰æ•ˆçš„è¿”å›å€¼ï¼Œè¿™ä¸å®ƒçš„ç¼“å­˜è®¾è®¡ç†å¿µç›¸è¿èƒŒã€‚
>
> **watch**
>
> - ä½œç”¨ï¼šç”¨äºç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œå¯ä»¥ç›‘å¬ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ•°æ®ï¼Œå½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰§è¡Œä¸€äº›ç”¨æˆ·æŒ‡å®šçš„æ“ä½œã€‚
> - å‰¯ä½œç”¨ï¼šç›‘å¬å™¨ä¸­çš„å›è°ƒå‡½æ•°å¯ä»¥æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œï¼Œä¾‹å¦‚å‘é€ç½‘ç»œè¯·æ±‚ã€æ‰‹åŠ¨æ“ä½œ DOM ç­‰ã€‚
> - æ— ç¼“å­˜ï¼šç›‘å¬å™¨ä¸­çš„å›è°ƒå‡½æ•°æ‰§è¡Œç»“æœä¸ä¼šè¢«ç¼“å­˜ï¼Œä¹Ÿæ²¡åŠæ³•ç¼“å­˜ï¼Œå› ä¸ºä¸çŸ¥é“ç”¨æˆ·ç©¶ç«Ÿè¦æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Œæœ‰å¯èƒ½æ˜¯åŒ…å«å‰¯ä½œç”¨çš„æ“ä½œï¼Œæœ‰å¯èƒ½æ˜¯ä¸åŒ…å«å‰¯ä½œç”¨çš„æ“ä½œã€‚
> - ç”¨å¤„ï¼šå¸¸ç”¨äºå“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œé‡æ–°å‘é€ç½‘ç»œè¯·æ±‚ï¼Œæˆ–è€…ä¿®æ”¹ DOM å…ƒç´ ç­‰åœºæ™¯ã€‚
> - æ”¯æŒå¼‚æ­¥ï¼šåœ¨ç›‘å¬åˆ°å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œå¯ä»¥è¿›è¡ŒåŒæ­¥æˆ–è€…å¼‚æ­¥çš„æ“ä½œã€‚

---

-EOF-

# å›¾è§£åŒç«¯diff

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue3 ä¸­çš„ diff ç›¸è¾ƒäº Vue2 æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ

- Vue2: åŒç«¯diff
- Vue3: å¿«é€Ÿdiff

**1. diffçš„æ¦‚å¿µ**

diff ç®—æ³•æ˜¯ç”¨äºæ¯”è¾ƒä¸¤æ£µè™šæ‹Ÿ DOM æ ‘çš„ç®—æ³•ï¼Œç›®çš„æ˜¯æ‰¾åˆ°å®ƒä»¬ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶æ ¹æ®è¿™äº›å·®å¼‚é«˜æ•ˆåœ°æ›´æ–°çœŸå® DOMï¼Œä»è€Œä¿è¯é¡µé¢åœ¨æ•°æ®å˜åŒ–æ—¶åªè¿›è¡Œ**æœ€å°ç¨‹åº¦**çš„ DOM æ“ä½œã€‚

æ€è€ƒğŸ¤”ï¼šä¸ºä»€ä¹ˆéœ€è¦è¿›è¡Œdiffï¼Œä¸æ˜¯å·²ç»æœ‰å“åº”å¼äº†ä¹ˆï¼Ÿ

ç­”æ¡ˆï¼šå“åº”å¼è™½ç„¶èƒ½å¤Ÿä¾¦æµ‹åˆ°å“åº”å¼æ•°æ®çš„å˜åŒ–ï¼Œä½†æ˜¯åªèƒ½å®šä½åˆ°ç»„ä»¶ï¼Œä»£è¡¨ç€æŸä¸€ä¸ªç»„ä»¶è¦é‡æ–°æ¸²æŸ“ã€‚ç»„ä»¶çš„é‡æ–°æ¸²æŸ“å°±æ˜¯é‡æ–°æ‰§è¡Œå¯¹åº”çš„æ¸²æŸ“å‡½æ•°ï¼Œæ­¤æ—¶å°±ä¼šç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOM æ ‘ã€‚ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ–°æ ‘å’Œæ—§æ ‘å…·ä½“å“ªä¸€ä¸ªèŠ‚ç‚¹æœ‰åŒºåˆ«ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦diffç®—æ³•æ¥æ‰¾åˆ°ä¸¤æ£µæ ‘çš„åŒºåˆ«ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-06-013616.png" alt="20210301193804" style="zoom: 60%;" />

**2. diffç®—æ³•çš„ç‰¹ç‚¹**

1. åˆ†å±‚å¯¹æ¯”ï¼šå®ƒä¼šé€å±‚å¯¹æ¯”æ¯ä¸ªèŠ‚ç‚¹å’Œå®ƒçš„å­èŠ‚ç‚¹ï¼Œé¿å…å…¨æ ‘å¯¹æ¯”ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚
2. ç›¸åŒå±‚çº§èŠ‚ç‚¹å¯¹æ¯”ï¼šåœ¨è¿›è¡Œ diff å¯¹æ¯”çš„æ—¶å€™ï¼ŒVueä¼šå‡è®¾å¯¹æ¯”çš„èŠ‚ç‚¹æ˜¯åŒå±‚çº§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šåšè·¨å±‚çš„æ¯”è¾ƒã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-06-013054.png" alt="20210301203350" style="zoom:65%;" />

**3. diffç®—æ³•è¯¦ç»†æµç¨‹**

1. ä»æ ¹èŠ‚ç‚¹å¼€å§‹æ¯”è¾ƒï¼Œçœ‹æ˜¯å¦**ç›¸åŒ**ã€‚æ‰€è°“ç›¸åŒï¼Œæ˜¯æŒ‡ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„**æ ‡ç­¾ç±»å‹**ã€**key å€¼**å‡ç›¸åŒï¼Œä½† **input å…ƒç´ è¿˜è¦çœ‹ type å±æ€§**

   1. ç›¸åŒ
      - ç›¸åŒå°±è¯´æ˜èƒ½å¤Ÿå¤ç”¨ï¼Œæ­¤æ—¶å°±ä¼šå°†æ—§è™šæ‹ŸDOMèŠ‚ç‚¹å¯¹åº”çš„çœŸå®DOMèµ‹å€¼ç»™æ–°è™šæ‹ŸDOMèŠ‚ç‚¹
      - å¯¹æ¯”æ–°èŠ‚ç‚¹å’Œæ—§èŠ‚ç‚¹çš„å±æ€§ï¼Œå¦‚æœå±æ€§æœ‰å˜åŒ–æ›´æ–°åˆ°çœŸå®DOM. è¿™è¯´æ˜äº†å³ä¾¿æ˜¯å¯¹ DOM è¿›è¡Œå¤ç”¨ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨ä¸å¤„ç†ï¼Œè¿˜æ˜¯ä¼šæœ‰ä¸€äº›é’ˆå¯¹å±æ€§å˜åŒ–çš„å¤„ç†
      - è¿›å…¥ã€å¯¹æ¯”å­èŠ‚ç‚¹ã€‘
   2. ä¸ç›¸åŒ
      - å¦‚æœä¸åŒï¼Œè¯¥èŠ‚ç‚¹ä»¥åŠå¾€ä¸‹çš„å­èŠ‚ç‚¹æ²¡æœ‰æ„ä¹‰äº†ï¼Œå…¨éƒ¨å¸è½½
        - ç›´æ¥æ ¹æ®æ–°è™šæ‹ŸDOMèŠ‚ç‚¹é€’å½’åˆ›å»ºçœŸå®DOMï¼ŒåŒæ—¶æŒ‚è½½åˆ°æ–°è™šæ‹ŸDOMèŠ‚ç‚¹
        - é”€æ¯æ—§è™šæ‹ŸDOMå¯¹åº”çš„çœŸå®DOMï¼ŒèƒŒåè°ƒç”¨çš„æ˜¯ vnode.elm.remove( ) æ–¹æ³•

2. å¯¹æ¯”å­èŠ‚ç‚¹ï¼š

   1. ä»ç„¶æ˜¯åŒå±‚åšå¯¹æ¯”
   2. æ·±åº¦ä¼˜å…ˆ
   3. åŒå±‚æ¯”è¾ƒæ—¶é‡‡ç”¨çš„æ˜¯åŒç«¯å¯¹æ¯”

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-06-021144.png" alt="image-20240906101143754" style="zoom:70%;" />



**4. åŒç«¯å¯¹æ¯”**

ä¹‹æ‰€ä»¥è¢«ç§°ä¹‹ä¸ºåŒç«¯ï¼Œæ˜¯å› ä¸ºæœ‰**ä¸¤ä¸ª**æŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªæŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-13-145148.png" alt="image-20240913225147579" style="zoom:50%;" />

æ— è®ºæ˜¯æ—§çš„è™šæ‹Ÿ DOM åˆ—è¡¨ï¼Œè¿˜æ˜¯æ–°çš„è™šæ‹Ÿ DOM åˆ—è¡¨ï¼Œéƒ½æ˜¯ä¸€å¤´ä¸€å°¾ä¸¤ä¸ªæŒ‡é’ˆã€‚

æ¥ä¸‹æ¥è¿›å…¥æ¯”è¾ƒç¯èŠ‚ï¼Œæ•´ä½“çš„æµç¨‹ä¸ºï¼š

1. æ­¥éª¤ä¸€ï¼šæ–°å¤´å’Œæ—§å¤´æ¯”è¾ƒ

   - ç›¸åŒï¼š

     - å¤ç”¨ DOM èŠ‚ç‚¹

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021542.png" alt="image-20240914101542039" style="zoom:50%;" />

     - æ–°æ—§å¤´ç´¢å¼•è‡ªå¢

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021629.png" alt="image-20240914101629244" style="zoom:50%;" />

     - é‡æ–°å¼€å§‹æ­¥éª¤ä¸€

   - ä¸ç›¸åŒï¼šè¿›å…¥æ­¥éª¤äºŒ

2. æ­¥éª¤äºŒï¼šæ–°å°¾å’Œæ—§å°¾æ¯”è¾ƒ

   - ç›¸åŒï¼š

     - å¤ç”¨ DOM èŠ‚ç‚¹

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021834.png" alt="image-20240914101834010" style="zoom:50%;" />

     - æ–°æ—§å°¾ç´¢å¼•è‡ªå‡

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021914.png" alt="image-20240914101913347" style="zoom:50%;" />

     - é‡æ–°å¼€å§‹æ­¥éª¤ä¸€

   - ä¸ç›¸åŒï¼Œè¿›å…¥æ­¥éª¤ä¸‰

3. æ­¥éª¤ä¸‰ï¼šæ—§å¤´å’Œæ–°å°¾æ¯”è¾ƒ

   - ç›¸åŒï¼š

     - è¯´æ˜å¯ä»¥å¤ç”¨ï¼Œå¹¶ä¸”è¯´æ˜èŠ‚ç‚¹ä»å¤´éƒ¨ç§»åŠ¨åˆ°äº†å°¾éƒ¨ï¼Œæ¶‰åŠåˆ°ç§»åŠ¨æ“ä½œï¼Œéœ€è¦å°†æ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹ç§»åŠ¨åˆ°æ—§å°¾å¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹‹å

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021232.png" alt="image-20240914101231300" style="zoom:50%;" />

     - æ—§å¤´ç´¢å¼•è‡ªå¢ï¼Œæ–°å°¾ç´¢å¼•è‡ªå‡

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-021401.png" alt="image-20240914101400686" style="zoom:50%;" />

     - é‡æ–°å¼€å§‹æ­¥éª¤ä¸€

   - ä¸ç›¸åŒï¼Œè¿›å…¥æ­¥éª¤å››

4. æ­¥éª¤å››ï¼šæ–°å¤´å’Œæ—§å°¾æ¯”è¾ƒ

   - ç›¸åŒï¼š

     - è¯´æ˜å¯ä»¥å¤ç”¨ï¼Œå¹¶ä¸”è¯´æ˜èŠ‚ç‚¹ä»å°¾éƒ¨ç§»åŠ¨åˆ°äº†å¤´éƒ¨ï¼Œä»ç„¶æ¶‰åŠåˆ°ç§»åŠ¨æ“ä½œï¼Œéœ€è¦å°†æ—§å°¾å¯¹åº”çš„ DOM å…ƒç´ ç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹‹å‰

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-025559.png" alt="image-20240914105559210" style="zoom:50%;" />

     - æ–°å¤´ç´¢å¼•è‡ªå¢ï¼Œæ—§å°¾ç´¢å¼•è‡ªå‡

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-025649.png" alt="image-20240914105649208" style="zoom:50%;" />

     - é‡æ–°å¼€å§‹æ­¥éª¤ä¸€

   - ä¸ç›¸åŒï¼šè¿›å…¥æ­¥éª¤äº”

5. æš´åŠ›æ¯”è¾ƒï¼šä¸Šé¢ 4 ä¸ªæ­¥éª¤éƒ½æ²¡æ‰¾åˆ°ç›¸åŒçš„ï¼Œåˆ™é‡‡å–æš´åŠ›æ¯”è¾ƒã€‚åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­å¯»æ‰¾æ˜¯å¦æœ‰å’Œæ–°èŠ‚ç‚¹ç›¸åŒçš„èŠ‚ç‚¹ï¼Œ

   - æ‰¾åˆ°

     - è¯´æ˜æ˜¯ä¸€ä¸ªéœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹ï¼Œå°†å…¶å¯¹åº”çš„ DOM èŠ‚ç‚¹ç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹‹å‰

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-030013.png" alt="image-20240914110012627" style="zoom:50%;" />

     - æ–°å¤´ç´¢å¼•è‡ªå¢

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-030048.png" alt="image-20240914110048026" style="zoom:50%;" />

     - å›åˆ°æ­¥éª¤ä¸€

   - æ²¡æ‰¾åˆ°

     - è¯´æ˜æ˜¯ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°çš„ DOM èŠ‚ç‚¹ï¼Œæ’å…¥åˆ°æ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹‹å‰

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-030333.png" alt="image-20240914110332605" style="zoom:50%;" />

     - æ–°å¤´ç´¢å¼•è‡ªå¢

       <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-030401.png" alt="image-20240914110401233" style="zoom:50%;" />

     - å›åˆ°æ­¥éª¤ä¸€

æ–°æ—§èŠ‚ç‚¹åˆ—è¡¨ä»»æ„ä¸€ä¸ªéå†ç»“æŸï¼Œä¹Ÿå°±æ˜¯ oldStart > OldEnd æˆ–è€… newStart > newEnd çš„æ—¶å€™ï¼Œdiff æ¯”è¾ƒç»“æŸã€‚

- æ—§èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼ˆnewStart > newEndï¼‰ï¼šå¯¹åº”çš„æ—§ DOM èŠ‚ç‚¹å…¨éƒ¨åˆ é™¤æ‰
- æ–°èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼ˆoldStart > OldEndï¼‰ï¼šå°†æ–°èŠ‚ç‚¹åˆ—è¡¨ä¸­å‰©ä½™çš„èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„ DOMï¼Œæ”¾ç½®äºæ–°å¤´èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹åé¢



**ç»¼åˆç¤ºä¾‹**

å½“å‰æ—§ Vnode å’Œæ–° VNode å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-031038.png" alt="image-20240914111038061" style="zoom:50%;" />

1. å¤´å¤´å¯¹æ¯”ï¼Œèƒ½å¤Ÿå¤ç”¨ï¼Œæ–°æ—§å¤´æŒ‡é’ˆå³ç§»

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-031750.png" alt="image-20240914111750328" style="zoom:50%;" />

2. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ç›¸åŒï¼Œèƒ½å¤Ÿå¤ç”¨ï¼Œå°¾å°¾æŒ‡é’ˆå·¦ç§»

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-031936.png" alt="image-20240914111936261" style="zoom:50%;" />

3. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ä¸åŒï¼Œæ—§å¤´æ–°å°¾ç›¸åŒï¼Œæ—§å¤´å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å°¾å¯¹åº”çš„çœŸå®DOMä¹‹åï¼Œæ—§å¤´ç´¢å¼•è‡ªå¢ï¼Œæ–°å°¾ç´¢å¼•è‡ªå‡

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-032233.png" alt="image-20240914112233100" style="zoom:50%;" />

4. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ä¸åŒï¼Œæ—§å¤´æ–°å°¾ä¸åŒï¼Œæ–°å¤´æ—§å°¾ç›¸åŒï¼Œæ—§å°¾å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„çœŸå®DOMä¹‹å‰ï¼Œæ–°å¤´ç´¢å¼•è‡ªå¢ï¼Œæ—§å°¾ç´¢å¼•è‡ªå‡

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-032710.png" alt="image-20240914112710405" style="zoom:50%;" />

5. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ä¸åŒï¼Œæ—§å¤´æ–°å°¾ä¸åŒï¼Œæ–°å¤´æ—§å°¾ä¸åŒï¼Œè¿›å…¥æš´åŠ›å¯¹æ¯”ï¼Œæ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹ï¼Œå°†å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„çœŸå®DOMä¹‹é—´ï¼Œæ–°å¤´ç´¢å¼•è‡ªå¢

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-033001.png" alt="image-20240914113000896" style="zoom:50%;" />

6. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ä¸åŒï¼Œæ—§å¤´æ–°å°¾ä¸åŒï¼Œæ–°å¤´æ—§å°¾ç›¸åŒï¼Œå°†æ—§å°¾å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„çœŸå®DOMä¹‹å‰ï¼Œæ–°å¤´ç´¢å¼•è‡ªå¢ï¼Œæ—§å°¾ç´¢å¼•è‡ªå‡

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-033248.png" alt="image-20240914113247844" style="zoom:50%;" />

7. å¤´å¤´ä¸åŒï¼Œå°¾å°¾ä¸åŒï¼Œæ—§å¤´æ–°å°¾ä¸åŒï¼Œæ–°å¤´æ—§å°¾ä¸åŒï¼Œæš´åŠ›å¯¹æ¯”å‘ç°ä¹Ÿæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªå…¨æ–°çš„èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°çš„DOMèŠ‚ç‚¹ï¼Œæ’å…¥åˆ°æ—§å¤´å¯¹åº”çš„DOMèŠ‚ç‚¹ä¹‹å‰ï¼Œæ–°å¤´ç´¢å¼•è‡ªå¢

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-033445.png" alt="image-20240914113444878" style="zoom:50%;" />

8. newEnd > newStartï¼Œdiff æ¯”å¯¹ç»“æŸï¼Œæ—§ VNode åˆ—è¡¨è¿˜æœ‰å‰©ä½™ï¼Œç›´æ¥åˆ é™¤å³å¯ã€‚

   <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-14-033722.png" alt="image-20240914113721337" style="zoom:50%;" />

---

-EOF-

# æœ€é•¿é€’å¢å­åºåˆ—

**åŸºæœ¬ä»‹ç»**

æœ€é•¿é€’å¢å­åºåˆ—ï¼ˆLongest Increasing Subsequenceï¼Œç®€ç§° LISï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ä¸€ä¸ªç»å…¸çš„ç®—æ³•é—®é¢˜ã€‚è¿™çœ‹ä¸Šå»æ˜¯å¾ˆéš¾çš„ä¸€ä¸ªè¯è¯­ï¼Œé‡åˆ°è¿™ç§è¯ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æ‹†è¯ï¼Œè¿™é‡Œå¯ä»¥æ‹†ä¸º 3 ä¸ªè¯ï¼š**æœ€é•¿**ã€**é€’å¢**ã€**å­åºåˆ—**ã€‚

1. å­åºåˆ—

   ```js
   [1, 2, 3, 4, 5]
   ```

   å­åºåˆ—æœ‰å¤šä¸ªï¼š

   ```js
   [1, 2, 3]
   [1, 3]
   [2, 4, 5]
   ```

2. é€’å¢

   ```js
   [2, 1, 5, 3, 6, 4, 8, 9, 7]
   ```

   è¿™ä¸ªå­åºåˆ—é‡Œé¢çš„å…ƒç´ å¿…é¡»æ˜¯é€’å¢çš„ï¼š

   ```js
   [1, 5] // å­åºåˆ—ï¼Œå¹¶ä¸”æ˜¯é€’å¢çš„
   [1, 3, 6] // å­åºåˆ—ï¼Œå¹¶ä¸”æ˜¯é€’å¢çš„
   [2, 1, 5] // å­åºåˆ—ï¼Œä½†æ˜¯ä¸æ˜¯é€’å¢çš„
   ```

3. æœ€é•¿

   ç›¸å½“äºåœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæœ‰å¢åŠ äº†ä¸€ä¸ªæ¡ä»¶ï¼Œéœ€è¦æ˜¯æœ€é•¿çš„ã€é€’å¢çš„å­åºåˆ—

   ```js
   [2, 1, 5, 3, 6, 4, 8, 9, 7]
   ```

   æœ€é•¿é€’å¢å­åºåˆ—ï¼š

   ```js
   [1, 3, 4, 8, 9]
   [1, 3, 6, 8, 9]
   [1, 5, 6, 8, 9]
   [2, 3, 4, 8, 9]
   [2, 3, 6, 8, 9]
   [2, 5, 6, 8, 9]
   ```

   å¯ä»¥çœ‹å‡ºï¼Œå³ä¾¿æ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼Œä»ç„¶æ˜¯å¯ä»¥æœ‰å¤šä¸ªçš„ã€‚åœ¨å¼€å‘ä¸­ï¼Œä¸åŒçš„ç®—æ³•å¯èƒ½æ‹¿åˆ°ä¸ä¸€æ ·çš„ç»“æœï¼Œä¸è¿‡ä¸€èˆ¬æ‹¿åˆ°å…¶ä¸­ä¸€ä¸ªæœ€é•¿é€’å¢å­åºåˆ—å³å¯ã€‚

å®é™…æ„ä¹‰

- è‚¡ç¥¨è¶‹åŠ¿åˆ†æ
- æ‰‹å†™è¯†åˆ«
- æ–‡æœ¬ç¼–è¾‘å’Œç‰ˆæœ¬æ§åˆ¶
- ....



**æš´åŠ›æ³•**

æš´åŠ›æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ‰¾åˆ°æ‰€æœ‰çš„é€’å¢å­åºåˆ—ï¼Œç„¶åä»ä¸­æ‰¾åˆ°é•¿åº¦æœ€é•¿çš„é‚£ä¸€ä¸ªã€‚

```js
function getSequence(arr) {
  let maxLength = 0; // è®°å½•æœ€é•¿é€’å¢å­åºåˆ—çš„é•¿åº¦
  let longetSeq = []; // è®°å½•æœ€é•¿é€’å¢å­åºåˆ—

  /**
   *
   * @param {*} index åˆ—è¡¨çš„ä¸‹æ ‡
   * @param {*} subSeq å½“å‰é€’å¢å­åºåˆ—
   */
  function findSubsequence(index, subSeq) {
    let currentNum = arr[index]; // å½“å‰å…ƒç´ 
    // å…ˆæŠŠä¹‹å‰çš„é€’å¢å­åºåˆ—å±•å¼€ï¼Œå†åŠ ä¸Šå½“å‰å…ƒç´ 
    let newSeq = [...subSeq, currentNum]; // æ–°çš„é€’å¢å­åºåˆ—

    // éå†ä¸‹æ ‡ä¹‹åçš„å†…å®¹
    for (let i = index + 1; i < arr.length; i++) {
      // éå†å½“å‰ä¸‹æ ‡ä¹‹åçš„å…ƒç´ æ—¶ï¼Œå‘ç°æœ‰æ¯”å½“å‰å…ƒç´ å¤§çš„å…ƒç´ 
      if (arr[i] > currentNum) {
        findSubsequence(i, newSeq);
      }
    }

    // æ¯ä¸€æ¬¡é€’å½’ç»“æŸåï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„é€’å¢å­åºåˆ—
    // ç›¸å½“äºæ‰¾åˆ°äº†æ‰€æœ‰çš„é€’å¢å­åºåˆ—
    // console.log("newSeq:", newSeq);

    if (newSeq.length > maxLength) {
      maxLength = newSeq.length;
      longetSeq = newSeq;
    }
  }

  for (let i = 0; i < arr.length; i++) {
    findSubsequence(i, []);
  }

  return longetSeq;
}

const list = [2, 1, 5, 3, 6, 4, 8, 9, 7];
const result = getSequence(list);
console.log(result); // [2, 5, 6, 8, 9]
```



**åŠ¨æ€è§„åˆ’**

åŠ¨æ€è§„åˆ’ï¼ˆDynamic Programmingï¼‰çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨é—®é¢˜çš„**æœ€ä¼˜å­ç»“æ„**å’Œ**é‡å å­é—®é¢˜**ç‰¹æ€§ï¼Œå°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºæ›´å°çš„å­é—®é¢˜ï¼Œå¹¶ä¸”åœ¨è§£å†³è¿™äº›å­é—®é¢˜çš„æ—¶å€™ä¼šä¿å­˜å­é—®é¢˜çš„è§£ï¼Œé¿å…é‡å¤è®¡ç®—ï¼Œä»è€Œé«˜æ•ˆåœ°æ±‚è§£åŸé—®é¢˜ã€‚

```js
function getSequence(arr) {
  let maxLength = 0; // è®°å½•æœ€é•¿é€’å¢å­åºåˆ—çš„é•¿åº¦
  let maxSeq = []; // è®°å½•æœ€é•¿é€’å¢å­åºåˆ—

  let sequences = new Array(arr.length).fill().map(() => []);

  //   console.log(sequences);

  // éå†æ•°ç»„
  for (let i = 0; i < arr.length; i++) {
    // åˆ›å»ºä¸€ä¸ªä»¥å½“å‰å…ƒç´ ä¸ºç»“å°¾çš„é€’å¢å­åºåˆ—
    let seq = [arr[i]];
    // éå†ä¹‹å‰çš„å…ƒç´ ï¼Œæ‰¾åˆ°æ¯”å½“å‰å…ƒç´ å°çš„å…ƒç´ ï¼Œä»è€Œæ„å»ºé€’å¢å­åºåˆ—
    for (let j = 0; j < i; j++) {
      if (arr[j] < arr[i]) {
        // æŠŠä¹‹å‰å­˜å‚¨çš„åºåˆ—å’Œå½“å‰å…ƒç´ æ‹¼æ¥èµ·æ¥
        seq = sequences[j].concat(arr[i]);
      }
    }

    // å°†å½“å‰é€’å¢å­åºåˆ—å­˜å‚¨èµ·æ¥
    sequences[i] = seq;

    // æ›´æ–°æœ€å¤§çš„åºåˆ—
    if (seq.length > maxLength) {
      maxLength = seq.length;
      maxSeq = seq;
    }
  }
  //   console.log(sequences);
  return maxSeq;
}

const list = [2, 1, 5, 3, 6, 4, 8, 9, 7];
const result = getSequence(list);
console.log(result); // [ 1, 3, 4, 8, 9 ]
```



**Vue3ä¸­çš„ç®—æ³•**

Vue3 ä¸­è·å–æœ€é•¿é€’å¢å­åºåˆ—ï¼Œç”¨åˆ°äº† **è´ªå¿ƒ** å’Œ **äºŒåˆ†** æŸ¥æ‰¾ã€‚

```js
function getSequence(arr) {
  // ç”¨äºè®°å½•æ¯ä¸ªä½ç½®çš„å‰é©±ç´¢å¼•ï¼Œä»¥ä¾¿æœ€åé‡å»ºåºåˆ—
  const p = arr.slice();
  // å­˜å‚¨å½“å‰æ‰¾åˆ°çš„æœ€é•¿é€’å¢å­åºåˆ—çš„ç´¢å¼•
  const result = [0];
  // å£°æ˜å¾ªç¯å˜é‡å’Œè¾…åŠ©å˜é‡
  let i, j, u, v, c;
  // è·å–è¾“å…¥æ•°ç»„çš„é•¿åº¦
  const len = arr.length;
  // éå†è¾“å…¥æ•°ç»„
  for (i = 0; i < len; i++) {
    const arrI = arr[i];
    // å¿½ç•¥å€¼ä¸º 0 çš„å…ƒç´ ï¼ˆVueæºç ä¸­çš„diffç®—æ³•å¯¹0æœ‰ç‰¹å®šå¤„ç†ï¼‰
    if (arrI !== 0) {
      // è·å–å½“å‰æœ€é•¿åºåˆ—ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•
      j = result[result.length - 1];
      // è´ªå¿ƒç®—æ³•éƒ¨åˆ†ï¼šå¦‚æœå½“å‰å…ƒç´ å¤§äºå½“å‰æœ€é•¿åºåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥æ·»åŠ 
      if (arr[j] < arrI) {
        // è®°å½•å½“å‰å…ƒç´ çš„å‰é©±ç´¢å¼•ä¸º j
        p[i] = j;
        // å°†å½“å‰å…ƒç´ çš„ç´¢å¼•æ·»åŠ åˆ° result ä¸­
        result.push(i);
        continue;
      }
      // äºŒåˆ†æŸ¥æ‰¾éƒ¨åˆ†ï¼šåœ¨ result ä¸­å¯»æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äº arrI çš„å…ƒç´ ä½ç½®
      u = 0;
      v = result.length - 1;
      while (u < v) {
        // å–ä¸­é—´ä½ç½®
        c = ((u + v) / 2) | 0;
        // æ¯”è¾ƒä¸­é—´ä½ç½®çš„å€¼ä¸å½“å‰å€¼
        if (arr[result[c]] < arrI) {
          // å¦‚æœä¸­é—´å€¼å°äºå½“å‰å€¼ï¼Œæœç´¢åŒºé—´ç¼©å°åˆ° [c + 1, v]
          u = c + 1;
        } else {
          // å¦åˆ™ï¼Œæœç´¢åŒºé—´ç¼©å°åˆ° [u, c]
          v = c;
        }
      }
      // å¦‚æœæ‰¾åˆ°çš„å€¼å¤§äºå½“å‰å€¼ï¼Œè¿›è¡Œæ›¿æ¢
      if (arrI < arr[result[u]]) {
        // å¦‚æœ u ä¸ä¸º 0ï¼Œè®°å½•å‰é©±ç´¢å¼•
        if (u > 0) {
          p[i] = result[u - 1];
        }
        // æ›´æ–° result ä¸­çš„ä½ç½® u ä¸ºå½“å‰ç´¢å¼• i
        result[u] = i;
      }
    }
  }
  // é‡å»ºæœ€é•¿é€’å¢å­åºåˆ—
  u = result.length;
  v = result[u - 1];
  while (u-- > 0) {
    // å°†ç´¢å¼•æ›¿æ¢ä¸ºå¯¹åº”çš„å‰é©±ç´¢å¼•
    result[u] = v;
    v = p[v];
  }
  // è¿”å›æœ€é•¿é€’å¢å­åºåˆ—çš„ç´¢å¼•æ•°ç»„
  return result;
}
```

è¿½è¸ªæµç¨‹ï¼š

1. åˆå§‹åŒ–ï¼š
   - `p = [2, 1, 5, 3, 6, 4, 8, 9, 7]` ç”¨äºè®°å½•æ¯ä¸ªå…ƒç´ çš„å‰é©±ç´¢å¼•ï¼Œåˆå§‹ä¸ºåŸæ•°ç»„çš„å‰¯æœ¬ã€‚
   - `result = [0]` åˆå§‹åŒ–ç»“æœæ•°ç»„ï¼Œå¼€å§‹æ—¶åªåŒ…å«ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼• 0ã€‚

2. éå†æ•°ç»„ï¼š
   - `i = 0, arrI = 2` ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç´¢å¼•å·²åœ¨ result ä¸­ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚

   - `i = 1, arrI = 1`
     - `arr[result[result.length - 1]] = arr[0] = 2`
     - `arrI (1) < 2`ï¼Œéœ€è¦äºŒåˆ†æŸ¥æ‰¾æ›¿æ¢ä½ç½®ã€‚
     - äºŒåˆ†æŸ¥æ‰¾ (u = 0, v = 0)ï¼š
       - `c = 0`
       - `arr[result[0]] = 2 > arrI (1)`
       - `v = c = 0`
     - `arrI (1) < arr[result[u]] (2)`ï¼Œæ›¿æ¢ ` result[0] = 1`
     - æ›´æ–° `result = [1]`

   - `i = 2, arrI = 5`
     - `arr[result[result.length - 1]] = arr[1] = 1`
     - `arrI (5) > 1`ï¼Œè´ªå¿ƒç®—æ³•ï¼šç›´æ¥æ·»åŠ åˆ° result
     - `p[2] = 1`
     - `result.push(2)`
     - æ›´æ–° `result = [1, 2]`

   - `i = 3, arrI = 3`
     - `arr[result[result.length - 1]] = arr[2] = 5`
     - `arrI (3) < 5`ï¼Œéœ€è¦äºŒåˆ†æŸ¥æ‰¾ã€‚
     - äºŒåˆ†æŸ¥æ‰¾ (u = 0, v = 1)ï¼š
       - `c = 0`
       - `arr[result[0]] = arr[1] = 1 < arrI (3)`
       - `u = c + 1 = 1`
       - `arr[result[1]] = arr[2] = 5 > arrI (3)`
       - `v = c = 1`
     - `arrI (3) < arr[result[u]] (5)`ï¼Œæ›¿æ¢ `result[1] = 3`
     - `p[3] = result[0] = 1`
     - æ›´æ–° `result = [1, 3]`

   - `i = 4, arrI = 6`
     - `arr[result[result.length - 1]] = arr[3] = 3`
     - `arrI (6) > 3`ï¼Œè´ªå¿ƒç®—æ³•ï¼šç›´æ¥æ·»åŠ åˆ° result
     - `p[4] = 3`
     - `result.push(4)`
     - æ›´æ–° `result = [1, 3, 4]`

   - `i = 5, arrI = 4`
     - `arr[result[result.length - 1]] = arr[4] = 6`
     - `arrI (4) < 6`ï¼Œéœ€è¦äºŒåˆ†æŸ¥æ‰¾ã€‚
     - äºŒåˆ†æŸ¥æ‰¾ (u = 0, v = 2) ï¼š
       - `c = 1`
       - `arr[result[1]] = arr[3] = 3 < arrI (4)`
       - `u = c + 1 = 2`
       - `arr[result[2]] = arr[4] = 6 > arrI (4)`
       - `v = c = 2`
     - `arrI (4) < arr[result[u]] (6)`ï¼Œæ›¿æ¢ `result[2] = 5`
     - `p[5] = result[1] = 3`
     - æ›´æ–° `result = [1, 3, 5]`

   - `i = 6, arrI = 8`
     - `arr[result[result.length - 1]] = arr[5] = 4`
     - `arrI (8) > 4`ï¼Œè´ªå¿ƒç®—æ³•ï¼šç›´æ¥æ·»åŠ åˆ° result
     - `p[6] = 5`
     - `result.push(6)`
     - æ›´æ–° `result = [1, 3, 5, 6]`

   - `i = 7, arrI = 9`
     - `arr[result[result.length - 1]] = arr[6] = 8`
     - `arrI (9) > 8`ï¼Œè´ªå¿ƒç®—æ³•ï¼šç›´æ¥æ·»åŠ åˆ° `result`
     - `p[7] = 6`
     - `result.push(7)`
     - æ›´æ–° `result = [1, 3, 5, 6, 7]`

   - `i = 8, arrI = 7`
     - `arr[result[result.length - 1]] = arr[7] = 9`
     - `arrI (7) < 9`ï¼Œéœ€è¦äºŒåˆ†æŸ¥æ‰¾ã€‚
     - äºŒåˆ†æŸ¥æ‰¾ (u = 0, v = 4) ï¼š
       - `c = 2`
       - `arr[result[2]] = arr[5] = 4 < arrI (7)`
       - `u = c + 1 = 3`
       - `c = 3`
       - `arr[result[3]] = arr[6] = 8 > arrI (7)`
       - `v = c = 3`
     - `arrI (7) < arr[result[u]] (8)`ï¼Œæ›¿æ¢ `result[3] = 8`
     - `p[8] = result[2] = 5`
     - æ›´æ–° `result = [1, 3, 5, 8, 7]`

3. é‡å»ºåºåˆ—ï¼š
   - `u = result.length = 5`
   - `v = result[u - 1] = result[4] = 7`
   - è¿­ä»£è¿‡ç¨‹ï¼š
     - `result[4] = v = 7`
     - `v = p[7] = 6`
     - `result[3] = v = 6`
     - `v = p[6] = 5`
     - `result[2] = v = 5`
     - `v = p[5] = 3`
     - `result[1] = v = 3`
     - `v = p[3] = 1`
     - `result[0] = v = 1`
     - `v = p[1]`ï¼ˆ`p[1]` åˆå§‹ä¸º 1ï¼‰
   - æœ€ç»ˆ `result = [1, 3, 5, 6, 7]`

4. æ˜ å°„å›åŸæ•°ç»„çš„å€¼ï¼š
   - `result.map(index => list[index])` å¾—åˆ° `[1, 3, 4, 8, 9]`
   - è¿™æ˜¯è¾“å…¥æ•°ç»„ä¸­çš„ä¸€ä¸ªæœ€é•¿é€’å¢å­åºåˆ—

---

-EOF-

# å›¾è§£å¿«é€Ÿdiff

>é¢è¯•é¢˜ï¼šè®²ä¸€è®² Vue3 çš„ diff ç®—æ³•åšäº†å“ªäº›æ”¹å˜ï¼Ÿ

**åŒç«¯å­˜åœ¨çš„é—®é¢˜**

åœ¨ Vue2 çš„åŒç«¯ diff ä¸­ï¼Œä¸»è¦çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ–°å¤´å’Œæ—§å¤´æ¯”è¾ƒ
2. æ–°å°¾å’Œæ—§å°¾æ¯”è¾ƒ
3. æ—§å¤´å’Œæ–°å°¾æ¯”è¾ƒ
4. æ–°å¤´å’Œæ—§å°¾æ¯”è¾ƒ
5. æš´åŠ›å¯¹æ¯”

è¿™ç§å¯¹æ¯”ç­–ç•¥å…¶å®ä¼šå­˜åœ¨**é¢å¤–çš„ç§»åŠ¨æ“ä½œ**ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-16-085545.png" alt="image-20240916165545724" style="zoom:50%;" />

- å¯¹äº e èŠ‚ç‚¹åŒ¹é…ä¸åˆ°ï¼Œæ–°å»º e èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹ï¼Œæ”¾ç½®äºæ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹çš„å‰é¢
- å¯¹äº b èŠ‚ç‚¹ï¼Œé€šè¿‡æš´åŠ›æ¯”å¯¹èƒ½å¤Ÿæ‰¾åˆ°ï¼Œå°† b èŠ‚ç‚¹ç§»åŠ¨åˆ°æ—§å¤´å¯¹åº”çš„ DOM èŠ‚ç‚¹çš„å‰é¢
- ä¾æ­¤ç±»æ¨ï¼Œc èŠ‚ç‚¹ã€d èŠ‚ç‚¹æ‰€å¯¹åº”çš„ DOM èŠ‚ç‚¹éƒ½ä¼šè¿›è¡Œç§»åŠ¨æ“ä½œ

é—®é¢˜ï¼šå…¶å®å®Œå…¨ä¸éœ€è¦ç§»åŠ¨ bcd èŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨æ–°æ—§åˆ—è¡¨é‡Œé¢ï¼Œè¿™å‡ ä¸ªèŠ‚ç‚¹çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚åªéœ€è¦å°† a èŠ‚ç‚¹å¯¹åº”çš„ DOM ç§»åŠ¨åˆ° d èŠ‚ç‚¹åå³å¯ã€‚



**Vue3å¿«é€Ÿdiff**

1. å¤´å¤´æ¯”å¯¹
2. å°¾å°¾æ¯”å¯¹
3. éå¤æ‚æƒ…å†µå¤„ç†
4. å¤æ‚æƒ…å†µå¤„ç†



**å’ŒåŒç«¯ç›¸åŒæ­¥éª¤**

1. å¤´å¤´æ¯”å¯¹
2. å°¾å°¾æ¯”å¯¹
3. éå¤æ‚æƒ…å†µï¼šæŒ‡çš„æ˜¯ç»å†äº†å¤´å¤´æ¯”å¯¹å’Œå°¾å°¾æ¯”å¯¹åï¼Œæ–°æ—§åˆ—è¡¨æœ‰ä»»æ„ä¸€æ–¹ç»“æŸï¼Œæ­¤æ—¶ä¼šå­˜åœ¨ä¸¤ç§æƒ…å†µï¼š
   - æ—§èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼šå¯¹åº”çš„æ—§ DOM èŠ‚ç‚¹å…¨éƒ¨åˆ é™¤
   - æ–°èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼šåˆ›å»ºå¯¹åº”çš„ DOM èŠ‚ç‚¹ï¼Œæ”¾ç½®äºæ–°å¤´èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹‹å



**å’ŒåŒç«¯ä¸åŒçš„æ­¥éª¤**

ç»å†äº†å¤´å¤´æ¯”å¯¹ï¼Œå°¾å°¾æ¯”å¯¹åï¼Œæ–°æ—§èŠ‚ç‚¹åˆ—è¡¨éƒ½æœ‰å‰©ä½™ï¼Œä¹‹åçš„æ­¥éª¤å°±å’ŒåŒç«¯ diff ä¸ä¸€æ ·ï¼š

1. åˆå§‹åŒ–keyToNewIndexMap
2. åˆå§‹åŒ–newIndexToOldIndexMap
3. æ›´æ–°newIndexToOldIndexMap
4. è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—
5. ç§»åŠ¨å’ŒæŒ‚è½½èŠ‚ç‚¹



**1. åˆå§‹åŒ–keyToNewIndexMap**

é¦–å…ˆï¼Œå®šä¹‰äº†ä¸€ä¸ªç”¨äºä¿å­˜æ–°èŠ‚ç‚¹ä¸‹æ ‡çš„å®¹å™¨ keyToNewIndexMapï¼Œå®ƒçš„å½¢å¼æ˜¯ key - indexï¼Œéå†è¿˜æœªå¤„ç†çš„æ–°èŠ‚ç‚¹ï¼Œå°†å®ƒä»¬çš„keyå’Œä¸‹æ ‡çš„æ˜ å°„å…³ç³»å­˜å‚¨åˆ° keyToNewIndexMap ä¸­ã€‚

```js
const keyToNewIndexMap = new Map();
for (let i = newStartIdx; i <= newEndIdx; i++) {
  const key = newChildren[i].key;
  keyToNewIndexMap.set(key, i);
}
```

ç¤ºæ„å›¾ï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-17-004920.png" alt="image-20240917084919424" style="zoom:50%;" />

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥ map å­˜å‚¨äº†æ‰€æœ‰æœªå¤„ç†çš„æ–°èŠ‚ç‚¹çš„ key å’Œ index çš„æ˜ å°„å…³ç³»ã€‚



**2. åˆå§‹åŒ–newIndexToOldIndexMap**

ç„¶åï¼Œå®šä¹‰äº†ä¸€ä¸ªå’Œæœªå¤„ç†æ–°èŠ‚ç‚¹ä¸ªæ•°åŒæ ·å¤§å°çš„æ•°ç»„**newIndexToOldIndexMap**ï¼Œé»˜è®¤æ¯ä¸€é¡¹å‡ä¸º 0

```js
const toBePatched = newEndIdx - newStartIdx + 1; // è®¡ç®—æ²¡æœ‰å¤„ç†çš„æ–°èŠ‚ç‚¹çš„ä¸ªæ•°
const newIndexToOldIndexMap = new Array(toBePatched).fill(0);
```

ç¤ºæ„å›¾ï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-17-064415.png" alt="image-20240917144414276" style="zoom:50%;" />

ä¹‹æ‰€ä»¥ä¸€å¼€å§‹åˆå§‹åŒ–ä¸º 0 ï¼Œå…¶å®æ˜¯ä¸ºäº†ä¸€å¼€å§‹å‡è®¾æ–°èŠ‚ç‚¹ä¸å­˜åœ¨äºæ—§èŠ‚ç‚¹åˆ—è¡¨ï¼Œä¹‹åå°±ä¼šå¯¹è¿™ä¸ªæ•°ç»„è¿›è¡Œæ›´æ–°ï¼Œå€˜è‹¥æ›´æ–°ä¹‹åå½“å‰æŸä¸ªä½ç½®è¿˜ä¸º 0 ï¼Œå°±ä»£è¡¨è¿™ä¸€ä½å¯¹åº”çš„æ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­ä¸å­˜åœ¨ã€‚



**3. æ›´æ–°newIndexToOldIndexMap**

éå†æœªå¤„ç†çš„**æ—§èŠ‚ç‚¹**ï¼ŒæŸ¥æ‰¾æ—§èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹ä¸­çš„ä½ç½®ï¼Œå†³å®šæ˜¯æ›´æ–°ã€åˆ é™¤è¿˜æ˜¯ç§»åŠ¨ã€‚

- éå†æœªå¤„ç†çš„æ—§èŠ‚ç‚¹ï¼ˆä» oldStartIdx åˆ° oldEndIdxï¼‰

- å¯¹äºæ¯ä¸ªæ—§èŠ‚ç‚¹ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

  - æŸ¥æ‰¾å¯¹åº”çš„æ–°èŠ‚ç‚¹ç´¢å¼• newIndexï¼š

    - å¦‚æœæ—§èŠ‚ç‚¹æœ‰ keyï¼Œé€šè¿‡ keyToNewIndexMap è·å– newIndex
    - å¦‚æœæ²¡æœ‰ keyï¼Œéœ€è¦éå†æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸æ—§èŠ‚ç‚¹ç›¸åŒçš„èŠ‚ç‚¹

  - åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ä¸æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼š

    - å¦‚æœ newIndex æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜æ—§èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œéœ€è¦å¸è½½

    - å¦‚æœ newIndex æ‰¾åˆ°ï¼Œè¯´æ˜èŠ‚ç‚¹éœ€è¦ä¿ç•™ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

      - æ›´æ–°èŠ‚ç‚¹ï¼šè°ƒç”¨ patch å‡½æ•°æ›´æ–°èŠ‚ç‚¹å†…å®¹

      - è®°å½•æ˜ å°„å…³ç³»ï¼šå°†æ—§èŠ‚ç‚¹çš„ç´¢å¼• +1 è®°å½•åˆ° `newIndexToOldIndexMap[newIndex - newStartIdx]` ä¸­

        >æ€è€ƒğŸ¤”ï¼šä¸ºä»€ä¹ˆè¦æŠŠæ—§èŠ‚ç‚¹çš„ç´¢å¼• +1 ç„¶åè¿›è¡Œå­˜å‚¨ï¼Ÿ
        >
        >ç­”æ¡ˆï¼šå› ä¸ºå‰é¢æˆ‘ä»¬åœ¨åˆå§‹åŒ–newIndexToOldIndexMapè¿™ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å€¼éƒ½åˆå§‹åŒ–ä¸ºäº†0ï¼Œä»£è¡¨æ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­ä¸å­˜åœ¨ã€‚å¦‚æœç›´æ¥å­˜å‚¨æ—§èŠ‚ç‚¹çš„ç´¢å¼•ï¼Œè€Œæ°å¥½è¿™ä¸ªæ—§èŠ‚ç‚¹çš„ç´¢å¼•åˆä¸º0ï¼Œé‚£ä¹ˆæ­¤æ—¶æ˜¯æ— æ³•åŒºåˆ†ç©¶ç«Ÿæ˜¯ç´¢å¼•å€¼è¿˜æ˜¯ä¸å­˜åœ¨ã€‚

      - æ ‡è®°èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ï¼šé€šè¿‡æ¯”è¾ƒå½“å‰çš„éå†é¡ºåºå’Œ newIndexï¼Œåˆæ­¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚

ç¤ºæ„ä»£ç ï¼š

```js
let moved = false;
let maxNewIndexSoFar = 0;
for (let i = oldStartIdx; i <= oldEndIdx; i++) {
  const oldNode = oldChildren[i];
  let newIndex;
  if (oldNode.key != null) {
    // æ—§èŠ‚ç‚¹å­˜åœ¨ keyï¼Œæ ¹æ® key æ‰¾åˆ°è¯¥èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢çš„ç´¢å¼•å€¼
    newIndex = keyToNewIndexMap.get(oldNode.key);
  } else {
    // éå†æ–°èŠ‚ç‚¹åˆ—è¡¨åŒ¹é…
  }
  if (newIndex === undefined) {
    // æ—§èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨ï¼Œå¸è½½
  } else {
    // æ›´æ–°èŠ‚ç‚¹
    patch(oldNode, newChildren[newIndex], container);
    // è®°å½•æ˜ å°„å…³ç³»ï¼Œæ³¨æ„è¿™é‡Œåœ¨è®°å½•çš„æ—¶å€™ï¼Œæ—§èŠ‚ç‚¹çš„ç´¢å¼•è¦åŠ 1
    newIndexToOldIndexMap[newIndex - newStartIdx] = i + 1;
    // åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨
    if (newIndex >= maxNewIndexSoFar) {
      maxNewIndexSoFar = newIndex;
    } else {
      moved = true;
    }
  }
}
```

è¯¦ç»†æ­¥éª¤ï¼š

- i = 0ï¼š`[0, 0, 0, 0, 1, 0]`
- i = 1ï¼š`[0, 2, 0, 0, 1, 0]`
- i = 2ï¼š`[0, 2, 3, 0, 1, 0]`
- i = 3ï¼šï¼š`[0, 2, 3, 4, 1, 0]`

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-09-17-065254.png" alt="image-20240917145254007" style="zoom:50%;" />

ç»è¿‡éå†æ—§èŠ‚ç‚¹åˆ—è¡¨è¿™ä¸€æ“ä½œä¹‹åï¼ŒnewIndexToOldIndexMap å°±è¢«æ›´æ–°ï¼Œé‡Œé¢å­˜å‚¨äº†æ¯ä¸ªæ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢çš„ä½ç½®ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œè¿™ä¸ªç´¢å¼•ä½ç½®æ˜¯ +1. æ›´æ–°åå¦‚æœæŸä¸€é¡¹ä»ç„¶æ˜¯ 0ï¼Œè¯´æ˜è¿™ä¸€ä¸ªèŠ‚ç‚¹ç¡®å®åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­ä¸å­˜åœ¨

```js
if (newIndex >= maxNewIndexSoFar) {
  maxNewIndexSoFar = newIndex;
} else {
  moved = true;
}
```

maxNewIndexSoFar ç”¨äºåˆ¤æ–­èŠ‚ç‚¹çš„ç›¸å¯¹é¡ºåºæ˜¯å¦ä¿æŒé€’å¢ï¼Œä»¥å†³å®šæ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ã€‚

- å¦‚æœå½“å‰çš„æ–°èŠ‚ç‚¹ç´¢å¼•å¤§äºç­‰äº maxNewIndexSoFarï¼Œæ›´æ–° maxNewIndexSoFarï¼ŒèŠ‚ç‚¹ç›¸å¯¹é¡ºåºæ­£ç¡®ï¼Œæ— éœ€æ ‡è®°ç§»åŠ¨
- å¦‚æœå°äºï¼Œè¯´æ˜èŠ‚ç‚¹ç›¸å¯¹é¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œæ ‡è®° moved = trueï¼Œåç»­éœ€è¦æ ¹æ® LIS å†³å®šæ˜¯å¦ç§»åŠ¨èŠ‚ç‚¹ã€‚

**4. è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—**

é€šè¿‡ LISï¼Œç¡®å®šå“ªäº›èŠ‚ç‚¹çš„ç›¸å¯¹é¡ºåºæœªå˜ï¼Œå‡å°‘éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ•°é‡ã€‚å¦‚æœåœ¨å‰é¢çš„æ­¥éª¤ä¸­æ ‡è®°äº† moved = trueï¼Œè¯´æ˜æœ‰èŠ‚ç‚¹éœ€è¦ç§»åŠ¨ã€‚ä½¿ç”¨ newIndexToOldIndexMap è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ— increasingNewIndexSequence. 

```js
const increasingNewIndexSequence = moved ? getSequence(newIndexToOldIndexMap) : [];
```

ä¸Šä¸€æ­¥æˆ‘ä»¬å¾—åˆ°çš„ newIndexToOldIndex ä¸º  `[0, 2, 3, 4, 1, 0]`ï¼Œä¹‹åå¾—åˆ°çš„æœ€é•¿é€’å¢å­åºåˆ—ä¸º `[1, 2, 3]`ï¼Œæ³¨æ„ï¼ŒVue3å†…éƒ¨åœ¨è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯å…ƒç´ å¯¹åº”çš„ç´¢å¼•å€¼ã€‚

æ€è€ƒğŸ¤”ï¼šæ³¨æ„è¿™é‡Œçš„æœ€é•¿é€’å¢å­åºåˆ—ä¸æ˜¯è®°å½•çš„å…·ä½“å…ƒç´ ï¼Œè€Œæ˜¯å…ƒç´ å¯¹åº”çš„ä¸‹æ ‡å€¼ã€‚è¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

ç­”æ¡ˆï¼šè¿™æ ·åˆšå¥½æŠµæ¶ˆäº†å‰é¢+1çš„æ“ä½œï¼Œé‡æ–°å˜å›äº†æ—§èŠ‚ç‚¹çš„ä¸‹æ ‡ã€‚

**5. ç§»åŠ¨å’ŒæŒ‚è½½èŠ‚ç‚¹**

æ ¹æ®è®¡ç®—ç»“æœï¼Œå¯¹éœ€è¦ç§»åŠ¨å’Œæ–°å»ºçš„èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚**å€’åºéå†**æœªå¤„ç†çš„æ–°èŠ‚ç‚¹ã€‚

æ€è€ƒğŸ¤”ï¼šä¸ºä»€ä¹ˆè¦å€’åºéå†ï¼Ÿ

ç­”æ¡ˆï¼šå› ä¸ºåç»­çš„èŠ‚ç‚¹ä½ç½®æ˜¯ç¡®å®šäº†çš„ï¼Œé€šè¿‡å€’åºçš„æ–¹å¼èƒ½å¤Ÿé¿å…é”šç‚¹å¼•ç”¨çš„æ—¶å€™ä¸ä¼šå‡ºé”™ã€‚

å…·ä½“æ­¥éª¤ï¼š

1. è®¡ç®—å½“å‰æ–°èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„ç´¢å¼• newIndex = newStartIdx + i

   - newStartIdx æ˜¯æœªå¤„ç†èŠ‚ç‚¹çš„èµ·å§‹ç´¢å¼•
   - i ä¸ºå€’åºéå†æ—¶çš„ç´¢å¼•å€¼

2. è·å–é”šç‚¹ DOMï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ä½œä¸ºèŠ‚ç‚¹ç§»åŠ¨çš„å‚ç…§ç‰©ï¼Œå½“æ¶‰åŠåˆ°ç§»åŠ¨æ“ä½œæ—¶ï¼Œéƒ½ç§»åŠ¨åˆ°é”šç‚¹ DOM çš„å‰é¢

   - è®¡ç®—æ–¹æ³•ä¸º  `newIndex + 1 < newChildren.length ? newChildren[newIndex + 1].el : null`
   - å¦‚æœè®¡ç®—å‡ºæ¥ä¸º nullï¼Œè¡¨ç¤ºæ²¡æœ‰å¯¹åº”çš„é”šç‚¹ DOM ï¼Œé‚£ä¹ˆå°±åˆ›å»ºå¹¶æŒ‚è½½åˆ°æœ€å

3. åˆ¤æ–­èŠ‚ç‚¹ç©¶ç«Ÿæ˜¯æ–°æŒ‚è½½è¿˜æ˜¯ç§»åŠ¨

   - **åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦æŒ‚è½½**ï¼šå¦‚æœ `newIndexToOldIndexMap[i] === 0`ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»ºå¹¶æ’å…¥åˆ°é”šç‚¹DOMä½ç½®ä¹‹å‰ã€‚

     ```js
     if (newIndexToOldIndexMap[i] === 0) {
       // åˆ›å»ºæ–°èŠ‚ç‚¹å¹¶æ’å…¥åˆ°é”šç‚¹DOMä½ç½®ä¹‹å‰
       patch(/*å‚æ•°ç•¥ */);
     }
     ```

   - **åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨**ï¼šå¦‚æœèŠ‚ç‚¹åœ¨ increasingNewIndexSequence ä¸­ï¼Œè¯´æ˜ä½ç½®æ­£ç¡®ï¼Œæ— éœ€ç§»åŠ¨ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ç§»åŠ¨èŠ‚ç‚¹åˆ°é”šç‚¹DOMä½ç½®ä¹‹å‰ã€‚

     ```js
     else if (moved) {
       if (!increasingNewIndexSequence.includes(i)) {
         // ç§»åŠ¨èŠ‚ç‚¹åˆ°é”šç‚¹DOMä¹‹å‰
         move(/*å‚æ•°ç•¥ */);
       }
     }
     ```

è¯¦ç»†æ­¥éª¤ï¼š

- i = 5
  - newIndex = 5
  - é”šç‚¹DOMï¼šnull
  - åˆ›å»º m å¯¹åº”çš„çœŸå® DOMï¼ŒæŒ‚è½½åˆ°æœ€å
- i = 4
  - newIndex = 4
  - é”šç‚¹DOMï¼šm --> çœŸå®DOM
  - `newIndexToOldIndexMap[4]` æ˜¯å¦ä¸º 0ï¼Œä¸æ˜¯è¯´æ˜åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢æ˜¯æœ‰çš„ï¼Œèƒ½å¤Ÿå¤ç”¨
  - æ¥ä¸‹æ¥çœ‹ i æ˜¯å¦åœ¨æœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢ï¼Œå‘ç°æ²¡æœ‰åœ¨æœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ¶‰åŠåˆ°ç§»åŠ¨ï¼Œç§»åŠ¨åˆ°é”šç‚¹DOMçš„å‰é¢ï¼Œä¹Ÿå°±æ˜¯ m å‰é¢
- i = 3
  - newIndex = 3
  - é”šç‚¹DOMï¼ša --> çœŸå®DOM
  - `newIndexToOldIndexMap[3]` ä¸ä¸º0ï¼Œè¯´æ˜æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢æ˜¯æœ‰çš„ï¼Œèƒ½å¤Ÿå¤ç”¨
  - æ¥ä¸‹æ¥éœ€è¦çœ‹ i æ˜¯å¦åœ¨æœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢ï¼Œå‘ç°å­˜åœ¨ï¼Œæ‰€ä»¥ä¸åšä»»ä½•æ“ä½œ
- i = 2
  - newIndex = 2
  - é”šç‚¹DOMï¼šd --> çœŸå®DOM
  - `newIndexToOldIndexMap[2]` ä¸ä¸º0ï¼Œè¯´æ˜æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢æ˜¯æœ‰çš„ï¼Œèƒ½å¤Ÿå¤ç”¨
  - æ¥ä¸‹æ¥éœ€è¦çœ‹ i æ˜¯å¦åœ¨æœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢ï¼Œå‘ç°å­˜åœ¨ï¼Œæ‰€ä»¥ä¸åšä»»ä½•æ“ä½œ
- i = 1
  - newIndex = 1
  - é”šç‚¹DOMï¼šc --> çœŸå®DOM
  - `newIndexToOldIndexMap[1]` ä¸ä¸º0ï¼Œè¯´æ˜æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢æ˜¯æœ‰çš„ï¼Œèƒ½å¤Ÿå¤ç”¨
  - æ¥ä¸‹æ¥éœ€è¦çœ‹ i æ˜¯å¦åœ¨æœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢ï¼Œå‘ç°å­˜åœ¨ï¼Œæ‰€ä»¥ä¸åšä»»ä½•æ“ä½œ
- i = 0
  - newIndex = 0
  - é”šç‚¹DOMï¼šb --> çœŸå®DOM
  - `newIndexToOldIndexMap[0]` ä¸º0ï¼Œè¯´æ˜æ—§èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢æ²¡æœ‰
  - åˆ›å»ºæ–°çš„ DOM èŠ‚ç‚¹ï¼Œæ’å…¥åˆ°é”šç‚¹ DOM èŠ‚ç‚¹ä¹‹å‰

æœ€ç»ˆç»è¿‡ä¸Šé¢çš„æ“ä½œï¼š

1. eï¼šæ–°å»ºå¹¶ä¸”æ’å…¥åˆ° b ä¹‹å‰
2. bï¼š ä½ç½®ä¸å˜ï¼Œæ²¡æœ‰åšç§»åŠ¨æ“ä½œ
3. cï¼šä½ç½®ä¸å˜ï¼Œæ²¡æœ‰åšç§»åŠ¨æ“ä½œ
4. dï¼šä½ç½®ä¸å˜ï¼Œæ²¡æœ‰åšç§»åŠ¨æ“ä½œ
5. aï¼šç§»åŠ¨åˆ° m ä¹‹å‰
6. mï¼šæ–°å»ºå¹¶ä¸”æ’å…¥åˆ°æœ«å°¾

æ•´ä¸ª diff ä¸‹æ¥ DOM æ“ä½œä»…ä»…æœ‰ 1 æ¬¡ç§»åŠ¨ï¼Œ2 æ¬¡æ–°å»ºã€‚åšåˆ°äº†æœ€æœ€æœ€å°åŒ– DOM æ“ä½œæ¬¡æ•°ï¼Œæ²¡æœ‰ä¸€æ¬¡ DOM æ“ä½œæ˜¯å¤šä½™çš„ã€‚

>é¢è¯•é¢˜ï¼šè®²ä¸€è®² Vue3 çš„ diff ç®—æ³•åšäº†å“ªäº›æ”¹å˜ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>Vue2 é‡‡ç”¨çš„æ˜¯åŒç«¯ diff ç®—æ³•ï¼Œè€Œ Vue3 é‡‡ç”¨çš„æ˜¯å¿«é€Ÿ diff. è¿™ä¸¤ç§ diff ç®—æ³•å‰é¢çš„æ­¥éª¤éƒ½æ˜¯ç›¸åŒçš„ï¼Œå…ˆæ˜¯æ–°æ—§åˆ—è¡¨çš„å¤´èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå½“å‘ç°æ— æ³•å¤ç”¨åˆ™è¿›è¡Œæ–°æ—§èŠ‚ç‚¹åˆ—è¡¨çš„å°¾èŠ‚ç‚¹æ¯”è¾ƒã€‚
>
>ä¸€å¤´ä¸€å°¾æ¯”è¾ƒå®Œåï¼Œå¦‚æœæ—§èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼Œå°±å°†å¯¹åº”çš„æ—§ DOM èŠ‚ç‚¹å…¨éƒ¨åˆ é™¤æ‰ï¼Œå¦‚æœæ–°èŠ‚ç‚¹åˆ—è¡¨æœ‰å‰©ä½™ï¼šå°†æ–°èŠ‚ç‚¹åˆ—è¡¨ä¸­å‰©ä½™çš„èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„ DOMï¼Œæ”¾ç½®äºæ–°å¤´èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹åé¢ã€‚
>
>ä¹‹åä¸¤ç§ diff ç®—æ³•å‘ˆç°å‡ºä¸åŒçš„æ“ä½œï¼ŒåŒç«¯ä¼šè¿›è¡Œæ—§å¤´æ–°å°¾æ¯”è¾ƒã€æ— æ³•å¤ç”¨åˆ™è¿›è¡Œæ—§å°¾æ–°å¤´æ¯”è¾ƒã€å†æ— æ³•å¤ç”¨è¿™æ˜¯æš´åŠ›æ¯”å¯¹ï¼Œè¿™æ ·çš„å¤„ç†ä¼šå­˜åœ¨å¤šä½™çš„ç§»åŠ¨æ“ä½œï¼Œå³ä¾¿ä¸€äº›æ–°èŠ‚ç‚¹çš„å‰åé¡ºåºå’Œæ—§èŠ‚ç‚¹æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šäº§ç”Ÿç§»åŠ¨æ“ä½œã€‚
>
>è€Œ Vue3 å¿«é€Ÿ diff åˆ™é‡‡ç”¨äº†å¦å¤–ä¸€ç§åšæ³•ï¼Œæ‰¾åˆ°æ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹ä¸­å¯¹åº”çš„ç´¢å¼•åˆ—è¡¨ï¼Œç„¶åæ±‚å‡ºæœ€é•¿é€’å¢å­åºåˆ—ï¼Œå‡¡æ˜¯ä½äºæœ€é•¿é€’å¢å­åºåˆ—é‡Œé¢çš„ç´¢å¼•æ‰€å¯¹åº”çš„å…ƒç´ ï¼Œæ˜¯ä¸éœ€è¦ç§»åŠ¨ä½ç½®çš„ï¼Œè¿™å°±åšåˆ°äº†åªç§»åŠ¨éœ€è¦ç§»åŠ¨çš„ DOM èŠ‚ç‚¹ï¼Œæœ€å°åŒ–äº† DOM çš„æ“ä½œæ¬¡æ•°ï¼Œæ²¡æœ‰ä»»ä½•æ— æ„ä¹‰çš„ç§»åŠ¨ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒVue3 çš„ diff å†ä¸€æ¬¡å°†æ€§èƒ½ä¼˜åŒ–åˆ°äº†æè‡´ï¼Œæ•´å¥—æ“ä½œä¸‹æ¥ï¼Œæ²¡æœ‰ä¸€æ¬¡ DOM æ“ä½œæ˜¯å¤šä½™çš„ï¼Œä»…ä»…æ‰§è¡Œäº†æœ€å¿…è¦çš„ DOM æ“ä½œã€‚

---

-EOF-

# æ¨¡æ¿ç¼–è¯‘å™¨

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue ä¸­ Compiler çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**Vueä¸­çš„ç¼–è¯‘å™¨**

Vue é‡Œé¢çš„ç¼–è¯‘å™¨ï¼Œä¸»è¦è´Ÿè´£å°†å¼€å‘è€…æ‰€ä¹¦å†™çš„æ¨¡æ¿è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘åçš„ç»“æœä¸ºï¼š

```js
function render(){
  return h('div', [
    h('h1', {id: someId}, 'Hello')
  ])
}
```

è¿™é‡Œæ•´ä¸ªè¿‡ç¨‹å¹¶éä¸€è§¦è€Œå°±çš„ï¼Œè€Œæ˜¯ç»å†ä¸€ä¸ªåˆä¸€ä¸ªæ­¥éª¤ä¸€ç‚¹ä¸€ç‚¹è½¬æ¢è€Œæ¥çš„ã€‚

æ•´ä½“æ¥è®²ï¼Œæ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20231113095532166](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘å™¨çš„å†…éƒ¨ï¼Œå®é™…ä¸Šåˆåˆ†ä¸ºäº†ï¼š

- è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„ AST
- è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript AST
- ç”Ÿæˆå™¨ï¼šæ ¹æ® JavaScript çš„ AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°



**è§£æå™¨**

è§£æå™¨çš„æ ¸å¿ƒä½œç”¨æ˜¯è´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„æ¨¡æ¿ ASTã€‚

é¦–å…ˆç”¨æˆ·æ‰€ä¹¦å†™çš„æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

å¯¹äºè§£æå™¨æ¥è®²ä»ç„¶å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²è€Œå·²ï¼Œç±»ä¼¼äºï¼š

```js
'<template><div><h1 :id="someId">Hello</h1></div></template>'
```

é‚£ä¹ˆè§£æå™¨æ˜¯å¦‚ä½•è¿›è¡Œè§£æçš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª <u>æœ‰é™çŠ¶æ€æœº</u> çš„æ¦‚å¿µã€‚

### FSM

FSMï¼Œè‹±è¯­å…¨ç§°ä¸º Finite State Machineï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯æœ‰é™çŠ¶æ€æœºï¼Œå®ƒé¦–å…ˆå®šä¹‰äº†**ä¸€ç»„çŠ¶æ€**ï¼Œç„¶åè¿˜å®šä¹‰äº†çŠ¶æ€ä¹‹é—´çš„è½¬ç§»ä»¥åŠè§¦å‘è¿™äº›è½¬ç§»çš„äº‹ä»¶ã€‚ç„¶åå°±ä¼šå»è§£æå­—ç¬¦ä¸²é‡Œé¢çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œæ ¹æ®å­—ç¬¦åšçŠ¶æ€çš„è½¬æ¢ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦è§£æçš„æ¨¡æ¿å†…å®¹ä¸ºï¼š

```js
'<p>Vue</p>'
```

é‚£ä¹ˆæ•´ä¸ªçŠ¶æ€çš„è¿ç§»è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. çŠ¶æ€æœºä¸€å¼€å§‹å¤„äº **åˆå§‹çŠ¶æ€**ã€‚
2. åœ¨ **åˆå§‹çŠ¶æ€** ä¸‹ï¼Œè¯»å–å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ < ï¼Œç„¶åçŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
3. æ¥ä¸‹æ¥ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼Œç”±äº p æ˜¯å­—æ¯ï¼Œæ‰€ä»¥çŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€**ã€‚
4. æ¥ä¸‹æ¥è¯»å–çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º >ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ä¼šå›åˆ° **åˆå§‹çŠ¶æ€**ï¼Œå¹¶ä¸”ä¼šè®°å½•åœ¨æ ‡ç­¾çŠ¶æ€ä¸‹äº§ç”Ÿçš„æ ‡ç­¾åç§° pã€‚
5. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ Vï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ–‡æœ¬çŠ¶æ€**ã€‚
6. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ uï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
7. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ eï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
8. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ <ï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
9. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ / ï¼ŒçŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾ç»“æŸçŠ¶æ€**ã€‚
10. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼ŒçŠ¶æ€æœºè¿›å…¥ **æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€**ã€‚
11. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ >ï¼ŒçŠ¶æ€æœºè¿›é‡æ–°å›åˆ° **åˆå§‹çŠ¶æ€**ã€‚

å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-060437.png" alt="image-20231113140436969" style="zoom:60%;" />

```js
let x = 10 + 5;
```

```
token:
let(å…³é”®å­—) x(æ ‡è¯†ç¬¦) =(è¿ç®—ç¬¦) 10(æ•°å­—) +(è¿ç®—ç¬¦) 5(æ•°å­—) ;(åˆ†å·)
```

å¯¹åº”ä»£ç ï¼š

```js
const template = '<p>Vue</p>';
// é¦–å…ˆå®šä¹‰ä¸€äº›çŠ¶æ€
const State = {
  initial: 1, // åˆå§‹çŠ¶æ€
  tagOpen: 2, // æ ‡ç­¾å¼€å§‹çŠ¶æ€
  tagName: 3, // æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€
  text: 4, // æ–‡æœ¬çŠ¶æ€
  tagEnd: 5, // æ ‡ç­¾ç»“æŸçŠ¶æ€
  tagEndName: 6 // æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€
}

// åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºå­—æ¯
function isAlpha(char) {
  return (char >= "a" && char <= "z") || (char >= "A" && char <= "Z");
}

// å°†å­—ç¬¦ä¸²è§£æä¸º token
function tokenize(str){
  // åˆå§‹åŒ–å½“å‰çŠ¶æ€
  let currentState = State.initial;
  // ç”¨äºç¼“å­˜å­—ç¬¦
  const chars = [];
  // å­˜å‚¨è§£æå‡ºæ¥çš„ token
  const tokens = [];
  
  while(str){
    const char = str[0]; // è·å–å­—ç¬¦ä¸²é‡Œé¢çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
    
    switch(currentState){
      case State.initial:{
        if(char === '<'){
          currentState = State.tagOpen;
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        } else if(isAlpha(char)){
          // åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯
          currentState = State.text;
          chars.push(char);
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        }
        break;
      }
      case State.tagOpen: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
      case State.tagName: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
    }
  }
  
  return tokens;
}
tokenize(template);
```

æœ€ç»ˆè§£æå‡ºæ¥çš„ token:

```js
[
  {type: 'tag', name: 'p'}, // å¼€å§‹æ ‡ç­¾
  {type: 'text', content: 'Vue'}, // æ–‡æœ¬èŠ‚ç‚¹
  {type: 'tagEnd', name: 'p'}, // ç»“æŸæ ‡ç­¾
]
```



**æ„é€ æ¨¡æ¿AST**

æ ¹æ® token åˆ—è¡¨åˆ›å»ºæ¨¡æ¿ AST çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å¯¹ token åˆ—è¡¨è¿›è¡Œæ‰«æçš„è¿‡ç¨‹ã€‚ä»åˆ—è¡¨çš„ç¬¬ä¸€ä¸ª token å¼€å§‹ï¼ŒæŒ‰ç…§é¡ºåºè¿›è¡Œæ‰«æï¼Œç›´åˆ°åˆ—è¡¨ä¸­æ‰€æœ‰çš„ token å¤„ç†å®Œæ¯•ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€**è¦ç»´æŠ¤ä¸€ä¸ªæ ˆ**ï¼Œè¿™ä¸ªæ ˆå°†ç”¨äºç»´æŠ¤å…ƒç´ é—´çš„çˆ¶å­å…³ç³»ã€‚æ¯é‡åˆ°ä¸€ä¸ªå¼€å§‹æ ‡ç­¾èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹å…¥æ ˆä¸­ã€‚

ç±»ä¼¼çš„ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªç»“æŸæ ‡ç­¾èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°±å°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡ºã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ¨¡æ¿å†…å®¹ï¼š

```vue
'<div><p>Vue</p><p>React</p></div>'
```

ç»è¿‡ä¸Šé¢çš„ tokenize åèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹çš„æ•°ç»„ï¼š

```js
[
  {"type": "tag","name": "div"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "Vue"},
  {"type": "tagEnd","name": "p"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "React"},
  {"type": "tagEnd","name": "p"},
  {"type": "tagEnd","name": "div"}
]
```

é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šéå†è¿™ä¸ªæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯æ‰«æ tokens åˆ—è¡¨ï¼‰

1. ä¸€å¼€å§‹æœ‰ä¸€ä¸ª elementStack æ ˆï¼Œåˆšå¼€å§‹æœ‰ä¸€ä¸ª Root èŠ‚ç‚¹ï¼Œ[ Root ]

2. é¦–å…ˆæ˜¯ä¸€ä¸ª **div tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`ï¼Œdiv ä¼šä½œä¸º Root çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070249.png" alt="image-20231113150248725" style="zoom:50%;" />

3. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼ŒåŒæ ·ä¼šå‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070335.png" alt="image-20231113150335866" style="zoom:50%;" />

4. æ¥ä¸‹æ¥æ˜¯ **Vue text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070356.png" alt="image-20231113150356416" style="zoom:50%;" />

5. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

6. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼ŒåŒæ ·åˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå‹æ ˆåæ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070442.png" alt="image-20231113150442450" style="zoom:50%;" />

7. æ¥ä¸‹æ¥æ˜¯ **React text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070537.png" alt="image-20231113150537351" style="zoom:50%;" />

8. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

9. æœ€åæ˜¯ **div tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œå°†å…¶å¼¹å‡ºï¼Œæ ˆåŒºé‡æ–°ä¸º `[ Root ]`ï¼Œè‡³æ­¤æ•´ä¸ª AST æ„å»ºå®Œæ¯•

è½åœ°åˆ°å…·ä½“çš„ä»£ç ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·çš„ï¼š

```js
// è§£æå™¨
function parse(str){
  const tokens = tokenize(str);
  
  // åˆ›å»ºRootæ ¹ASTèŠ‚ç‚¹
  const root = {
    type: 'Root',
    children: []
  }
  
  // åˆ›å»ºä¸€ä¸ªæ ˆ
  const elementStack = [root]
  
  while(tokens.length){
    // è·å–å½“å‰æ ˆé¡¶ç‚¹ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ ˆæ•°ç»„æœ€åä¸€é¡¹
    const parent = elementStack[elementStack.length - 1];
    // ä» tokens åˆ—è¡¨ä¸­ä¾æ¬¡å–å‡ºç¬¬ä¸€ä¸ª token
    const t = tokens[0];
    
    switch(t.type){
        // æ ¹æ®ä¸åŒçš„typeåšä¸åŒçš„å¤„ç†
      case 'tag':{
        // åˆ›å»ºä¸€ä¸ªElementç±»å‹çš„ASTèŠ‚ç‚¹
        const elementNode = {
          type: 'Element',
          tag: t.name,
          children: []
        }
        // å°†å…¶æ·»åŠ ä¸ºçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
        parent.children.push(elementNode)
        // å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆé‡Œé¢
        elementStack.push(elementNode)
        break;
      }
      case 'text':
        // åˆ›å»ºæ–‡æœ¬ç±»å‹çš„ AST èŠ‚ç‚¹
        const textNode = {
          type: 'Text',
          content: t.content
        }
        // å°†å…¶æ·»åŠ åˆ°çˆ¶çº§èŠ‚ç‚¹çš„ children ä¸­
        parent.children.push(textNode)
        break
      case 'tagEnd':
        // é‡åˆ°ç»“æŸæ ‡ç­¾ï¼Œå°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡º
        elementStack.pop()
        break
    }
    // å°†å¤„ç†è¿‡çš„ token å¼¹å‡ºå»
    tokens.shift();
  }
}
```

æœ€ç»ˆï¼Œç»è¿‡ä¸Šé¢çš„å¤„ç†ï¼Œå°±å¾—åˆ°äº†æ¨¡æ¿çš„æŠ½è±¡è¯­æ³•æ ‘ï¼š

```
{
  "type": "Root",
  "children": [
    {
      "type": "Element",
      "tag": "div",
      "children": [
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "Vue"
              }
          ]
        },
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "React"
              }
          ]
        }
      ]
    }
  ]
}
```

# æ¨¡æ¿ç¼–è¯‘å™¨

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue ä¸­ Compiler çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**Vueä¸­çš„ç¼–è¯‘å™¨**

Vue é‡Œé¢çš„ç¼–è¯‘å™¨ï¼Œä¸»è¦è´Ÿè´£å°†å¼€å‘è€…æ‰€ä¹¦å†™çš„æ¨¡æ¿è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘åçš„ç»“æœä¸ºï¼š

```js
function render(){
  return h('div', [
    h('h1', {id: someId}, 'Hello')
  ])
}
```

è¿™é‡Œæ•´ä¸ªè¿‡ç¨‹å¹¶éä¸€è§¦è€Œå°±çš„ï¼Œè€Œæ˜¯ç»å†ä¸€ä¸ªåˆä¸€ä¸ªæ­¥éª¤ä¸€ç‚¹ä¸€ç‚¹è½¬æ¢è€Œæ¥çš„ã€‚

æ•´ä½“æ¥è®²ï¼Œæ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20231113095532166](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘å™¨çš„å†…éƒ¨ï¼Œå®é™…ä¸Šåˆåˆ†ä¸ºäº†ï¼š

- è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„ AST
- è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript AST
- ç”Ÿæˆå™¨ï¼šæ ¹æ® JavaScript çš„ AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°



**è§£æå™¨**

è§£æå™¨çš„æ ¸å¿ƒä½œç”¨æ˜¯è´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„æ¨¡æ¿ ASTã€‚

é¦–å…ˆç”¨æˆ·æ‰€ä¹¦å†™çš„æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

å¯¹äºè§£æå™¨æ¥è®²ä»ç„¶å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²è€Œå·²ï¼Œç±»ä¼¼äºï¼š

```js
'<template><div><h1 :id="someId">Hello</h1></div></template>'
```

é‚£ä¹ˆè§£æå™¨æ˜¯å¦‚ä½•è¿›è¡Œè§£æçš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª <u>æœ‰é™çŠ¶æ€æœº</u> çš„æ¦‚å¿µã€‚

### FSM

FSMï¼Œè‹±è¯­å…¨ç§°ä¸º Finite State Machineï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯æœ‰é™çŠ¶æ€æœºï¼Œå®ƒé¦–å…ˆå®šä¹‰äº†**ä¸€ç»„çŠ¶æ€**ï¼Œç„¶åè¿˜å®šä¹‰äº†çŠ¶æ€ä¹‹é—´çš„è½¬ç§»ä»¥åŠè§¦å‘è¿™äº›è½¬ç§»çš„äº‹ä»¶ã€‚ç„¶åå°±ä¼šå»è§£æå­—ç¬¦ä¸²é‡Œé¢çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œæ ¹æ®å­—ç¬¦åšçŠ¶æ€çš„è½¬æ¢ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦è§£æçš„æ¨¡æ¿å†…å®¹ä¸ºï¼š

```js
'<p>Vue</p>'
```

é‚£ä¹ˆæ•´ä¸ªçŠ¶æ€çš„è¿ç§»è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. çŠ¶æ€æœºä¸€å¼€å§‹å¤„äº **åˆå§‹çŠ¶æ€**ã€‚
2. åœ¨ **åˆå§‹çŠ¶æ€** ä¸‹ï¼Œè¯»å–å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ < ï¼Œç„¶åçŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
3. æ¥ä¸‹æ¥ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼Œç”±äº p æ˜¯å­—æ¯ï¼Œæ‰€ä»¥çŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€**ã€‚
4. æ¥ä¸‹æ¥è¯»å–çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º >ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ä¼šå›åˆ° **åˆå§‹çŠ¶æ€**ï¼Œå¹¶ä¸”ä¼šè®°å½•åœ¨æ ‡ç­¾çŠ¶æ€ä¸‹äº§ç”Ÿçš„æ ‡ç­¾åç§° pã€‚
5. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ Vï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ–‡æœ¬çŠ¶æ€**ã€‚
6. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ uï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
7. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ eï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
8. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ <ï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
9. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ / ï¼ŒçŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾ç»“æŸçŠ¶æ€**ã€‚
10. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼ŒçŠ¶æ€æœºè¿›å…¥ **æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€**ã€‚
11. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ >ï¼ŒçŠ¶æ€æœºè¿›é‡æ–°å›åˆ° **åˆå§‹çŠ¶æ€**ã€‚

å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-060437.png" alt="image-20231113140436969" style="zoom:60%;" />

```js
let x = 10 + 5;
```

```
token:
let(å…³é”®å­—) x(æ ‡è¯†ç¬¦) =(è¿ç®—ç¬¦) 10(æ•°å­—) +(è¿ç®—ç¬¦) 5(æ•°å­—) ;(åˆ†å·)
```

å¯¹åº”ä»£ç ï¼š

```js
const template = '<p>Vue</p>';
// é¦–å…ˆå®šä¹‰ä¸€äº›çŠ¶æ€
const State = {
  initial: 1, // åˆå§‹çŠ¶æ€
  tagOpen: 2, // æ ‡ç­¾å¼€å§‹çŠ¶æ€
  tagName: 3, // æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€
  text: 4, // æ–‡æœ¬çŠ¶æ€
  tagEnd: 5, // æ ‡ç­¾ç»“æŸçŠ¶æ€
  tagEndName: 6 // æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€
}

// åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºå­—æ¯
function isAlpha(char) {
  return (char >= "a" && char <= "z") || (char >= "A" && char <= "Z");
}

// å°†å­—ç¬¦ä¸²è§£æä¸º token
function tokenize(str){
  // åˆå§‹åŒ–å½“å‰çŠ¶æ€
  let currentState = State.initial;
  // ç”¨äºç¼“å­˜å­—ç¬¦
  const chars = [];
  // å­˜å‚¨è§£æå‡ºæ¥çš„ token
  const tokens = [];
  
  while(str){
    const char = str[0]; // è·å–å­—ç¬¦ä¸²é‡Œé¢çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
    
    switch(currentState){
      case State.initial:{
        if(char === '<'){
          currentState = State.tagOpen;
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        } else if(isAlpha(char)){
          // åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯
          currentState = State.text;
          chars.push(char);
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        }
        break;
      }
      case State.tagOpen: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
      case State.tagName: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
    }
  }
  
  return tokens;
}
tokenize(template);
```

æœ€ç»ˆè§£æå‡ºæ¥çš„ token:

```js
[
  {type: 'tag', name: 'p'}, // å¼€å§‹æ ‡ç­¾
  {type: 'text', content: 'Vue'}, // æ–‡æœ¬èŠ‚ç‚¹
  {type: 'tagEnd', name: 'p'}, // ç»“æŸæ ‡ç­¾
]
```



**æ„é€ æ¨¡æ¿AST**

æ ¹æ® token åˆ—è¡¨åˆ›å»ºæ¨¡æ¿ AST çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å¯¹ token åˆ—è¡¨è¿›è¡Œæ‰«æçš„è¿‡ç¨‹ã€‚ä»åˆ—è¡¨çš„ç¬¬ä¸€ä¸ª token å¼€å§‹ï¼ŒæŒ‰ç…§é¡ºåºè¿›è¡Œæ‰«æï¼Œç›´åˆ°åˆ—è¡¨ä¸­æ‰€æœ‰çš„ token å¤„ç†å®Œæ¯•ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€**è¦ç»´æŠ¤ä¸€ä¸ªæ ˆ**ï¼Œè¿™ä¸ªæ ˆå°†ç”¨äºç»´æŠ¤å…ƒç´ é—´çš„çˆ¶å­å…³ç³»ã€‚æ¯é‡åˆ°ä¸€ä¸ªå¼€å§‹æ ‡ç­¾èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹å…¥æ ˆä¸­ã€‚

ç±»ä¼¼çš„ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªç»“æŸæ ‡ç­¾èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°±å°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡ºã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ¨¡æ¿å†…å®¹ï¼š

```vue
'<div><p>Vue</p><p>React</p></div>'
```

ç»è¿‡ä¸Šé¢çš„ tokenize åèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹çš„æ•°ç»„ï¼š

```js
[
  {"type": "tag","name": "div"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "Vue"},
  {"type": "tagEnd","name": "p"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "React"},
  {"type": "tagEnd","name": "p"},
  {"type": "tagEnd","name": "div"}
]
```

é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šéå†è¿™ä¸ªæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯æ‰«æ tokens åˆ—è¡¨ï¼‰

1. ä¸€å¼€å§‹æœ‰ä¸€ä¸ª elementStack æ ˆï¼Œåˆšå¼€å§‹æœ‰ä¸€ä¸ª Root èŠ‚ç‚¹ï¼Œ[ Root ]

2. é¦–å…ˆæ˜¯ä¸€ä¸ª **div tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`ï¼Œdiv ä¼šä½œä¸º Root çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070249.png" alt="image-20231113150248725" style="zoom:50%;" />

3. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼ŒåŒæ ·ä¼šå‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070335.png" alt="image-20231113150335866" style="zoom:50%;" />

4. æ¥ä¸‹æ¥æ˜¯ **Vue text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070356.png" alt="image-20231113150356416" style="zoom:50%;" />

5. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

6. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼ŒåŒæ ·åˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå‹æ ˆåæ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070442.png" alt="image-20231113150442450" style="zoom:50%;" />

7. æ¥ä¸‹æ¥æ˜¯ **React text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070537.png" alt="image-20231113150537351" style="zoom:50%;" />

8. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

9. æœ€åæ˜¯ **div tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œå°†å…¶å¼¹å‡ºï¼Œæ ˆåŒºé‡æ–°ä¸º `[ Root ]`ï¼Œè‡³æ­¤æ•´ä¸ª AST æ„å»ºå®Œæ¯•

è½åœ°åˆ°å…·ä½“çš„ä»£ç ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·çš„ï¼š

```js
// è§£æå™¨
function parse(str){
  const tokens = tokenize(str);
  
  // åˆ›å»ºRootæ ¹ASTèŠ‚ç‚¹
  const root = {
    type: 'Root',
    children: []
  }
  
  // åˆ›å»ºä¸€ä¸ªæ ˆ
  const elementStack = [root]
  
  while(tokens.length){
    // è·å–å½“å‰æ ˆé¡¶ç‚¹ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ ˆæ•°ç»„æœ€åä¸€é¡¹
    const parent = elementStack[elementStack.length - 1];
    // ä» tokens åˆ—è¡¨ä¸­ä¾æ¬¡å–å‡ºç¬¬ä¸€ä¸ª token
    const t = tokens[0];
    
    switch(t.type){
        // æ ¹æ®ä¸åŒçš„typeåšä¸åŒçš„å¤„ç†
      case 'tag':{
        // åˆ›å»ºä¸€ä¸ªElementç±»å‹çš„ASTèŠ‚ç‚¹
        const elementNode = {
          type: 'Element',
          tag: t.name,
          children: []
        }
        // å°†å…¶æ·»åŠ ä¸ºçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
        parent.children.push(elementNode)
        // å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆé‡Œé¢
        elementStack.push(elementNode)
        break;
      }
      case 'text':
        // åˆ›å»ºæ–‡æœ¬ç±»å‹çš„ AST èŠ‚ç‚¹
        const textNode = {
          type: 'Text',
          content: t.content
        }
        // å°†å…¶æ·»åŠ åˆ°çˆ¶çº§èŠ‚ç‚¹çš„ children ä¸­
        parent.children.push(textNode)
        break
      case 'tagEnd':
        // é‡åˆ°ç»“æŸæ ‡ç­¾ï¼Œå°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡º
        elementStack.pop()
        break
    }
    // å°†å¤„ç†è¿‡çš„ token å¼¹å‡ºå»
    tokens.shift();
  }
}
```

æœ€ç»ˆï¼Œç»è¿‡ä¸Šé¢çš„å¤„ç†ï¼Œå°±å¾—åˆ°äº†æ¨¡æ¿çš„æŠ½è±¡è¯­æ³•æ ‘ï¼š

```
{
  "type": "Root",
  "children": [
    {
      "type": "Element",
      "tag": "div",
      "children": [
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "Vue"
              }
          ]
        },
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "React"
              }
          ]
        }
      ]
    }
  ]
}
```



**è½¬æ¢å™¨**

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ¨¡æ¿çš„ ASTï¼Œå›é¡¾ä¸€ä¸‹ Vue ä¸­æ•´ä¸ªæ¨¡æ¿çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

```js
// ç¼–è¯‘å™¨
function compile(template){
  // 1. è§£æå™¨å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œå¾—åˆ°æ¨¡æ¿çš„AST
  const ast = parse(template)
  // 2. è½¬æ¢å™¨ï¼šå°†æ¨¡æ¿ASTè½¬æ¢ä¸ºJS AST
  transform(ast)
  // 3. ç”Ÿæˆå™¨ï¼šåœ¨ JS AST çš„åŸºç¡€ä¸Šç”Ÿæˆ JS ä»£ç 
  const code = genrate(ast)
  
  return code;
}
```

è½¬æ¢å™¨çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯è´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript ASTã€‚

æ•´ä½“æ¥è®²ï¼Œè½¬æ¢å™¨çš„ç¼–å†™åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- æ¨¡æ¿ AST çš„éå†ä¸è½¬æ¢
- ç”Ÿæˆ JavaScript AST



**æ¨¡æ¿ASTçš„éå†ä¸è½¬æ¢**

æ­¥éª¤ä¸€ï¼šå…ˆä¹¦å†™ä¸€ä¸ªç®€å•çš„å·¥å…·æ–¹æ³•ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸€ä¸ªæ¨¡æ¿ AST ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚

```js
function dump(node, indent = 0) {
    // è·å–å½“å‰èŠ‚ç‚¹çš„ç±»å‹
    const type = node.type;
    // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ„å»ºæè¿°ä¿¡æ¯
    // å¯¹äºæ ¹èŠ‚ç‚¹ï¼Œæè¿°ä¸ºç©ºï¼›å¯¹äºå…ƒç´ èŠ‚ç‚¹ï¼Œä½¿ç”¨æ ‡ç­¾åï¼›å¯¹äºæ–‡æœ¬èŠ‚ç‚¹ï¼Œä½¿ç”¨å†…å®¹
    const desc =
      node.type === "Root"
        ? ""
        : node.type === "Element"
        ? node.tag
        : node.content;

    // æ‰“å°å½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»å‹å’Œæè¿°
    // ä½¿ç”¨é‡å¤çš„"-"å­—ç¬¦æ¥è¡¨ç¤ºç¼©è¿›ï¼ˆå±‚çº§ï¼‰
    console.log(`${"-".repeat(indent)}${type}: ${desc}`);

    // å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’è°ƒç”¨dumpå‡½æ•°æ‰“å°æ¯ä¸ªå­èŠ‚ç‚¹
    if (node.children) {
      node.children.forEach((n) => dump(n, indent + 2));
    }
}
```

æ­¥éª¤äºŒï¼šæ¥ä¸‹æ¥ä¸‹ä¸€æ­¥å°±æ˜¯éå†æ•´æ£µæ¨¡æ¿ AST æ ‘ï¼Œå¹¶ä¸”èƒ½å¤Ÿåšä¸€äº›æ”¹åŠ¨

```js
function tranverseNode(ast){
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  const currentNode = ast;
  
  // å°†pä¿®æ”¹ä¸ºh1
  if(currentNode.type === 'Element' && currentNode.tag === 'p'){
    currentNode.tag = 'h1';
  }
  
  // æ–°å¢éœ€æ±‚ï¼šå°†æ–‡æœ¬èŠ‚ç‚¹å…¨éƒ¨æ”¹ä¸ºå¤§å†™
  if(currentNode.type === 'Text'){
    currentNode.content = currentNode.content.toUpperCase();
  }
  
  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = currentNode.children;
  if(children){
    for(let i = 0;i< children.length; i++){
      tranverseNode(children[i])
    }
  }
}

function transform(ast){
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast);
  
  console.log(dump(ast));
}
```

ç›®å‰tranverseNodeè™½ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å†…éƒ¨æœ‰ä¸¤ä¸ªèŒè´£ï¼šéå†ã€è½¬æ¢ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†è¿™ä¸¤ä¸ªèŒè´£è¿›è¡Œè§£è€¦ã€‚

æ­¥éª¤ä¸‰ï¼šåœ¨ transform é‡Œé¢ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆç¯å¢ƒï¼šåŒ…å«æ‰§è¡Œä»£ç æ—¶ç”¨åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼‰

```js
// éœ€è¦å°†ä¹‹å‰çš„è½¬æ¢æ–¹æ³•å…¨éƒ¨æå‡ºæ¥ï¼Œæ¯ä¸€ç§è½¬æ¢æå–æˆä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•
function transformElement(node){
  if(node.type === 'Element' && node.tag === 'p'){
    node.tag = 'h1';
  }
}

function transformText(node){
  if(node.type === 'Text'){
    node.content = node.content.toUpperCase();
  }
}

// è¯¥æ–¹æ³•åªè´Ÿè´£éå†ï¼Œè½¬æ¢çš„å·¥ä½œäº¤ç»™è½¬æ¢å‡½æ•°
// è½¬æ¢å‡½æ•°æ˜¯å­˜æ”¾äºä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢çš„
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode);
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}


function transform(ast){
  // ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šåŒ…å«ä¸€äº›é‡è¦ä¿¡æ¯
  const context = {
    currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
    childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
    parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
    nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
  }
  
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast, context);
  
  
}
```

æ­¥éª¤å››ï¼šå®Œå–„ context ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ·»åŠ 2ä¸ªæ–¹æ³•

1. æ›¿æ¢èŠ‚ç‚¹æ–¹æ³•
2. åˆ é™¤èŠ‚ç‚¹æ–¹æ³•

```js
const context = {
  currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
  childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
  parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
  // æ›¿æ¢èŠ‚ç‚¹
  replaceNode(node){
    context.parent.children[context.childIndex] = node;
    context.currentNode = node;
  },
  // åˆ é™¤èŠ‚ç‚¹
  removeNode(){
    if(context.parent){
      context.parent.children.splice(context.childIndex, 1);
      context.currentNode = null;
    }
  },
  nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
}
```

æ³¨æ„å› ä¸ºå­˜åœ¨åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨tranverseNodeæ–¹æ³•é‡Œé¢æ‰§è¡Œè½¬æ¢å‡½æ•°ä¹‹åï¼Œéœ€è¦è¿›è¡Œéç©ºçš„åˆ¤æ–­ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode, context);
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}
```

æ­¥éª¤äº”ï¼šè§£å†³èŠ‚ç‚¹å¤„ç†çš„æ¬¡æ•°é—®é¢˜

ç›®å‰æ¥è®²ï¼Œéå†çš„é¡ºåºæ˜¯æ·±åº¦éå†ï¼Œä»çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹ã€‚ä½†æ˜¯æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šå­èŠ‚ç‚¹å¤„ç†å®Œä¹‹åï¼Œé‡æ–°å›åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¯¹çˆ¶èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚

é¦–å…ˆéœ€è¦å¯¹è½¬æ¢å‡½æ•°è¿›è¡Œæ”¹é€ ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°

```js
function transformText(node, context) {
  // çœç•¥ç¬¬ä¸€æ¬¡å¤„ç†....
  
  return ()=>{
    // å¯¹èŠ‚ç‚¹å†æ¬¡è¿›è¡Œå¤„ç†
  }
}
```

tranverseNodeéœ€è¦æ‹¿ä¸€ä¸ªæ•°ç»„å­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;
  
  // 1. å¢åŠ ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°
  const exitFns = []

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    // æ‰§è¡Œè½¬æ¢å‡½æ•°çš„æ—¶å€™ï¼Œæ¥æ”¶å…¶è¿”å›å€¼
    const onExit = transforms[i](context.currentNode, context);
    if(onExit){
      exitFns.push(onExit)
    }
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
  
  // åœ¨èŠ‚ç‚¹å¤„ç†å®Œæˆä¹‹åï¼Œæ‰§è¡ŒexitFnsé‡Œé¢æ‰€æœ‰çš„å‡½æ•°
  // æ‰§è¡Œçš„é¡ºåºæ˜¯ä»åå¾€å‰ä¾æ¬¡æ‰§è¡Œ
  let i = exitFns.length;
  while(i--){
    exitFns[i]()
  }
}
```

# æ¨¡æ¿ç¼–è¯‘å™¨

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue ä¸­ Compiler çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**Vueä¸­çš„ç¼–è¯‘å™¨**

Vue é‡Œé¢çš„ç¼–è¯‘å™¨ï¼Œä¸»è¦è´Ÿè´£å°†å¼€å‘è€…æ‰€ä¹¦å†™çš„æ¨¡æ¿è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘åçš„ç»“æœä¸ºï¼š

```js
function render(){
  return h('div', [
    h('h1', {id: someId}, 'Hello')
  ])
}
```

è¿™é‡Œæ•´ä¸ªè¿‡ç¨‹å¹¶éä¸€è§¦è€Œå°±çš„ï¼Œè€Œæ˜¯ç»å†ä¸€ä¸ªåˆä¸€ä¸ªæ­¥éª¤ä¸€ç‚¹ä¸€ç‚¹è½¬æ¢è€Œæ¥çš„ã€‚

æ•´ä½“æ¥è®²ï¼Œæ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20231113095532166](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘å™¨çš„å†…éƒ¨ï¼Œå®é™…ä¸Šåˆåˆ†ä¸ºäº†ï¼š

- è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„ AST
- è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript AST
- ç”Ÿæˆå™¨ï¼šæ ¹æ® JavaScript çš„ AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°



**è§£æå™¨**

è§£æå™¨çš„æ ¸å¿ƒä½œç”¨æ˜¯è´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„æ¨¡æ¿ ASTã€‚

é¦–å…ˆç”¨æˆ·æ‰€ä¹¦å†™çš„æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

å¯¹äºè§£æå™¨æ¥è®²ä»ç„¶å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²è€Œå·²ï¼Œç±»ä¼¼äºï¼š

```js
'<template><div><h1 :id="someId">Hello</h1></div></template>'
```

é‚£ä¹ˆè§£æå™¨æ˜¯å¦‚ä½•è¿›è¡Œè§£æçš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª <u>æœ‰é™çŠ¶æ€æœº</u> çš„æ¦‚å¿µã€‚

### FSM

FSMï¼Œè‹±è¯­å…¨ç§°ä¸º Finite State Machineï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯æœ‰é™çŠ¶æ€æœºï¼Œå®ƒé¦–å…ˆå®šä¹‰äº†**ä¸€ç»„çŠ¶æ€**ï¼Œç„¶åè¿˜å®šä¹‰äº†çŠ¶æ€ä¹‹é—´çš„è½¬ç§»ä»¥åŠè§¦å‘è¿™äº›è½¬ç§»çš„äº‹ä»¶ã€‚ç„¶åå°±ä¼šå»è§£æå­—ç¬¦ä¸²é‡Œé¢çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œæ ¹æ®å­—ç¬¦åšçŠ¶æ€çš„è½¬æ¢ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦è§£æçš„æ¨¡æ¿å†…å®¹ä¸ºï¼š

```js
'<p>Vue</p>'
```

é‚£ä¹ˆæ•´ä¸ªçŠ¶æ€çš„è¿ç§»è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. çŠ¶æ€æœºä¸€å¼€å§‹å¤„äº **åˆå§‹çŠ¶æ€**ã€‚
2. åœ¨ **åˆå§‹çŠ¶æ€** ä¸‹ï¼Œè¯»å–å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ < ï¼Œç„¶åçŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
3. æ¥ä¸‹æ¥ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼Œç”±äº p æ˜¯å­—æ¯ï¼Œæ‰€ä»¥çŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€**ã€‚
4. æ¥ä¸‹æ¥è¯»å–çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º >ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ä¼šå›åˆ° **åˆå§‹çŠ¶æ€**ï¼Œå¹¶ä¸”ä¼šè®°å½•åœ¨æ ‡ç­¾çŠ¶æ€ä¸‹äº§ç”Ÿçš„æ ‡ç­¾åç§° pã€‚
5. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ Vï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ–‡æœ¬çŠ¶æ€**ã€‚
6. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ uï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
7. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ eï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
8. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ <ï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
9. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ / ï¼ŒçŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾ç»“æŸçŠ¶æ€**ã€‚
10. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼ŒçŠ¶æ€æœºè¿›å…¥ **æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€**ã€‚
11. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ >ï¼ŒçŠ¶æ€æœºè¿›é‡æ–°å›åˆ° **åˆå§‹çŠ¶æ€**ã€‚

å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-060437.png" alt="image-20231113140436969" style="zoom:60%;" />

```js
let x = 10 + 5;
```

```
token:
let(å…³é”®å­—) x(æ ‡è¯†ç¬¦) =(è¿ç®—ç¬¦) 10(æ•°å­—) +(è¿ç®—ç¬¦) 5(æ•°å­—) ;(åˆ†å·)
```

å¯¹åº”ä»£ç ï¼š

```js
const template = '<p>Vue</p>';
// é¦–å…ˆå®šä¹‰ä¸€äº›çŠ¶æ€
const State = {
  initial: 1, // åˆå§‹çŠ¶æ€
  tagOpen: 2, // æ ‡ç­¾å¼€å§‹çŠ¶æ€
  tagName: 3, // æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€
  text: 4, // æ–‡æœ¬çŠ¶æ€
  tagEnd: 5, // æ ‡ç­¾ç»“æŸçŠ¶æ€
  tagEndName: 6 // æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€
}

// åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºå­—æ¯
function isAlpha(char) {
  return (char >= "a" && char <= "z") || (char >= "A" && char <= "Z");
}

// å°†å­—ç¬¦ä¸²è§£æä¸º token
function tokenize(str){
  // åˆå§‹åŒ–å½“å‰çŠ¶æ€
  let currentState = State.initial;
  // ç”¨äºç¼“å­˜å­—ç¬¦
  const chars = [];
  // å­˜å‚¨è§£æå‡ºæ¥çš„ token
  const tokens = [];
  
  while(str){
    const char = str[0]; // è·å–å­—ç¬¦ä¸²é‡Œé¢çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
    
    switch(currentState){
      case State.initial:{
        if(char === '<'){
          currentState = State.tagOpen;
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        } else if(isAlpha(char)){
          // åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯
          currentState = State.text;
          chars.push(char);
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        }
        break;
      }
      case State.tagOpen: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
      case State.tagName: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
    }
  }
  
  return tokens;
}
tokenize(template);
```

æœ€ç»ˆè§£æå‡ºæ¥çš„ token:

```js
[
  {type: 'tag', name: 'p'}, // å¼€å§‹æ ‡ç­¾
  {type: 'text', content: 'Vue'}, // æ–‡æœ¬èŠ‚ç‚¹
  {type: 'tagEnd', name: 'p'}, // ç»“æŸæ ‡ç­¾
]
```



**æ„é€ æ¨¡æ¿AST**

æ ¹æ® token åˆ—è¡¨åˆ›å»ºæ¨¡æ¿ AST çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å¯¹ token åˆ—è¡¨è¿›è¡Œæ‰«æçš„è¿‡ç¨‹ã€‚ä»åˆ—è¡¨çš„ç¬¬ä¸€ä¸ª token å¼€å§‹ï¼ŒæŒ‰ç…§é¡ºåºè¿›è¡Œæ‰«æï¼Œç›´åˆ°åˆ—è¡¨ä¸­æ‰€æœ‰çš„ token å¤„ç†å®Œæ¯•ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€**è¦ç»´æŠ¤ä¸€ä¸ªæ ˆ**ï¼Œè¿™ä¸ªæ ˆå°†ç”¨äºç»´æŠ¤å…ƒç´ é—´çš„çˆ¶å­å…³ç³»ã€‚æ¯é‡åˆ°ä¸€ä¸ªå¼€å§‹æ ‡ç­¾èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹å…¥æ ˆä¸­ã€‚

ç±»ä¼¼çš„ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªç»“æŸæ ‡ç­¾èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°±å°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡ºã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ¨¡æ¿å†…å®¹ï¼š

```vue
'<div><p>Vue</p><p>React</p></div>'
```

ç»è¿‡ä¸Šé¢çš„ tokenize åèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹çš„æ•°ç»„ï¼š

```js
[
  {"type": "tag","name": "div"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "Vue"},
  {"type": "tagEnd","name": "p"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "React"},
  {"type": "tagEnd","name": "p"},
  {"type": "tagEnd","name": "div"}
]
```

é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šéå†è¿™ä¸ªæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯æ‰«æ tokens åˆ—è¡¨ï¼‰

1. ä¸€å¼€å§‹æœ‰ä¸€ä¸ª elementStack æ ˆï¼Œåˆšå¼€å§‹æœ‰ä¸€ä¸ª Root èŠ‚ç‚¹ï¼Œ[ Root ]

2. é¦–å…ˆæ˜¯ä¸€ä¸ª **div tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`ï¼Œdiv ä¼šä½œä¸º Root çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070249.png" alt="image-20231113150248725" style="zoom:50%;" />

3. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼ŒåŒæ ·ä¼šå‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070335.png" alt="image-20231113150335866" style="zoom:50%;" />

4. æ¥ä¸‹æ¥æ˜¯ **Vue text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070356.png" alt="image-20231113150356416" style="zoom:50%;" />

5. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

6. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼ŒåŒæ ·åˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå‹æ ˆåæ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070442.png" alt="image-20231113150442450" style="zoom:50%;" />

7. æ¥ä¸‹æ¥æ˜¯ **React text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070537.png" alt="image-20231113150537351" style="zoom:50%;" />

8. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

9. æœ€åæ˜¯ **div tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œå°†å…¶å¼¹å‡ºï¼Œæ ˆåŒºé‡æ–°ä¸º `[ Root ]`ï¼Œè‡³æ­¤æ•´ä¸ª AST æ„å»ºå®Œæ¯•

è½åœ°åˆ°å…·ä½“çš„ä»£ç ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·çš„ï¼š

```js
// è§£æå™¨
function parse(str){
  const tokens = tokenize(str);
  
  // åˆ›å»ºRootæ ¹ASTèŠ‚ç‚¹
  const root = {
    type: 'Root',
    children: []
  }
  
  // åˆ›å»ºä¸€ä¸ªæ ˆ
  const elementStack = [root]
  
  while(tokens.length){
    // è·å–å½“å‰æ ˆé¡¶ç‚¹ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ ˆæ•°ç»„æœ€åä¸€é¡¹
    const parent = elementStack[elementStack.length - 1];
    // ä» tokens åˆ—è¡¨ä¸­ä¾æ¬¡å–å‡ºç¬¬ä¸€ä¸ª token
    const t = tokens[0];
    
    switch(t.type){
        // æ ¹æ®ä¸åŒçš„typeåšä¸åŒçš„å¤„ç†
      case 'tag':{
        // åˆ›å»ºä¸€ä¸ªElementç±»å‹çš„ASTèŠ‚ç‚¹
        const elementNode = {
          type: 'Element',
          tag: t.name,
          children: []
        }
        // å°†å…¶æ·»åŠ ä¸ºçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
        parent.children.push(elementNode)
        // å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆé‡Œé¢
        elementStack.push(elementNode)
        break;
      }
      case 'text':
        // åˆ›å»ºæ–‡æœ¬ç±»å‹çš„ AST èŠ‚ç‚¹
        const textNode = {
          type: 'Text',
          content: t.content
        }
        // å°†å…¶æ·»åŠ åˆ°çˆ¶çº§èŠ‚ç‚¹çš„ children ä¸­
        parent.children.push(textNode)
        break
      case 'tagEnd':
        // é‡åˆ°ç»“æŸæ ‡ç­¾ï¼Œå°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡º
        elementStack.pop()
        break
    }
    // å°†å¤„ç†è¿‡çš„ token å¼¹å‡ºå»
    tokens.shift();
  }
}
```

æœ€ç»ˆï¼Œç»è¿‡ä¸Šé¢çš„å¤„ç†ï¼Œå°±å¾—åˆ°äº†æ¨¡æ¿çš„æŠ½è±¡è¯­æ³•æ ‘ï¼š

```
{
  "type": "Root",
  "children": [
    {
      "type": "Element",
      "tag": "div",
      "children": [
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "Vue"
              }
          ]
        },
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "React"
              }
          ]
        }
      ]
    }
  ]
}
```



**è½¬æ¢å™¨**

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ¨¡æ¿çš„ ASTï¼Œå›é¡¾ä¸€ä¸‹ Vue ä¸­æ•´ä¸ªæ¨¡æ¿çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

```js
// ç¼–è¯‘å™¨
function compile(template){
  // 1. è§£æå™¨å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œå¾—åˆ°æ¨¡æ¿çš„AST
  const ast = parse(template)
  // 2. è½¬æ¢å™¨ï¼šå°†æ¨¡æ¿ASTè½¬æ¢ä¸ºJS AST
  transform(ast)
  // 3. ç”Ÿæˆå™¨ï¼šåœ¨ JS AST çš„åŸºç¡€ä¸Šç”Ÿæˆ JS ä»£ç 
  const code = genrate(ast)
  
  return code;
}
```

è½¬æ¢å™¨çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯è´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript ASTã€‚

æ•´ä½“æ¥è®²ï¼Œè½¬æ¢å™¨çš„ç¼–å†™åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- æ¨¡æ¿ AST çš„éå†ä¸è½¬æ¢
- ç”Ÿæˆ JavaScript AST



**æ¨¡æ¿ASTçš„éå†ä¸è½¬æ¢**

æ­¥éª¤ä¸€ï¼šå…ˆä¹¦å†™ä¸€ä¸ªç®€å•çš„å·¥å…·æ–¹æ³•ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸€ä¸ªæ¨¡æ¿ AST ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚

```js
function dump(node, indent = 0) {
    // è·å–å½“å‰èŠ‚ç‚¹çš„ç±»å‹
    const type = node.type;
    // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ„å»ºæè¿°ä¿¡æ¯
    // å¯¹äºæ ¹èŠ‚ç‚¹ï¼Œæè¿°ä¸ºç©ºï¼›å¯¹äºå…ƒç´ èŠ‚ç‚¹ï¼Œä½¿ç”¨æ ‡ç­¾åï¼›å¯¹äºæ–‡æœ¬èŠ‚ç‚¹ï¼Œä½¿ç”¨å†…å®¹
    const desc =
      node.type === "Root"
        ? ""
        : node.type === "Element"
        ? node.tag
        : node.content;

    // æ‰“å°å½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»å‹å’Œæè¿°
    // ä½¿ç”¨é‡å¤çš„"-"å­—ç¬¦æ¥è¡¨ç¤ºç¼©è¿›ï¼ˆå±‚çº§ï¼‰
    console.log(`${"-".repeat(indent)}${type}: ${desc}`);

    // å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’è°ƒç”¨dumpå‡½æ•°æ‰“å°æ¯ä¸ªå­èŠ‚ç‚¹
    if (node.children) {
      node.children.forEach((n) => dump(n, indent + 2));
    }
}
```

æ­¥éª¤äºŒï¼šæ¥ä¸‹æ¥ä¸‹ä¸€æ­¥å°±æ˜¯éå†æ•´æ£µæ¨¡æ¿ AST æ ‘ï¼Œå¹¶ä¸”èƒ½å¤Ÿåšä¸€äº›æ”¹åŠ¨

```js
function tranverseNode(ast){
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  const currentNode = ast;
  
  // å°†pä¿®æ”¹ä¸ºh1
  if(currentNode.type === 'Element' && currentNode.tag === 'p'){
    currentNode.tag = 'h1';
  }
  
  // æ–°å¢éœ€æ±‚ï¼šå°†æ–‡æœ¬èŠ‚ç‚¹å…¨éƒ¨æ”¹ä¸ºå¤§å†™
  if(currentNode.type === 'Text'){
    currentNode.content = currentNode.content.toUpperCase();
  }
  
  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = currentNode.children;
  if(children){
    for(let i = 0;i< children.length; i++){
      tranverseNode(children[i])
    }
  }
}

function transform(ast){
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast);
  
  console.log(dump(ast));
}
```

ç›®å‰tranverseNodeè™½ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å†…éƒ¨æœ‰ä¸¤ä¸ªèŒè´£ï¼šéå†ã€è½¬æ¢ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†è¿™ä¸¤ä¸ªèŒè´£è¿›è¡Œè§£è€¦ã€‚

æ­¥éª¤ä¸‰ï¼šåœ¨ transform é‡Œé¢ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆç¯å¢ƒï¼šåŒ…å«æ‰§è¡Œä»£ç æ—¶ç”¨åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼‰

```js
// éœ€è¦å°†ä¹‹å‰çš„è½¬æ¢æ–¹æ³•å…¨éƒ¨æå‡ºæ¥ï¼Œæ¯ä¸€ç§è½¬æ¢æå–æˆä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•
function transformElement(node){
  if(node.type === 'Element' && node.tag === 'p'){
    node.tag = 'h1';
  }
}

function transformText(node){
  if(node.type === 'Text'){
    node.content = node.content.toUpperCase();
  }
}

// è¯¥æ–¹æ³•åªè´Ÿè´£éå†ï¼Œè½¬æ¢çš„å·¥ä½œäº¤ç»™è½¬æ¢å‡½æ•°
// è½¬æ¢å‡½æ•°æ˜¯å­˜æ”¾äºä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢çš„
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode);
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}


function transform(ast){
  // ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šåŒ…å«ä¸€äº›é‡è¦ä¿¡æ¯
  const context = {
    currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
    childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
    parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
    nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
  }
  
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast, context);
  
  
}
```

æ­¥éª¤å››ï¼šå®Œå–„ context ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ·»åŠ 2ä¸ªæ–¹æ³•

1. æ›¿æ¢èŠ‚ç‚¹æ–¹æ³•
2. åˆ é™¤èŠ‚ç‚¹æ–¹æ³•

```js
const context = {
  currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
  childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
  parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
  // æ›¿æ¢èŠ‚ç‚¹
  replaceNode(node){
    context.parent.children[context.childIndex] = node;
    context.currentNode = node;
  },
  // åˆ é™¤èŠ‚ç‚¹
  removeNode(){
    if(context.parent){
      context.parent.children.splice(context.childIndex, 1);
      context.currentNode = null;
    }
  },
  nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
}
```

æ³¨æ„å› ä¸ºå­˜åœ¨åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨tranverseNodeæ–¹æ³•é‡Œé¢æ‰§è¡Œè½¬æ¢å‡½æ•°ä¹‹åï¼Œéœ€è¦è¿›è¡Œéç©ºçš„åˆ¤æ–­ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode, context);
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}
```

æ­¥éª¤äº”ï¼šè§£å†³èŠ‚ç‚¹å¤„ç†çš„æ¬¡æ•°é—®é¢˜

ç›®å‰æ¥è®²ï¼Œéå†çš„é¡ºåºæ˜¯æ·±åº¦éå†ï¼Œä»çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹ã€‚ä½†æ˜¯æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šå­èŠ‚ç‚¹å¤„ç†å®Œä¹‹åï¼Œé‡æ–°å›åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¯¹çˆ¶èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚

é¦–å…ˆéœ€è¦å¯¹è½¬æ¢å‡½æ•°è¿›è¡Œæ”¹é€ ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°

```js
function transformText(node, context) {
  // çœç•¥ç¬¬ä¸€æ¬¡å¤„ç†....
  
  return ()=>{
    // å¯¹èŠ‚ç‚¹å†æ¬¡è¿›è¡Œå¤„ç†
  }
}
```

tranverseNodeéœ€è¦æ‹¿ä¸€ä¸ªæ•°ç»„å­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;
  
  // 1. å¢åŠ ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°
  const exitFns = []

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    // æ‰§è¡Œè½¬æ¢å‡½æ•°çš„æ—¶å€™ï¼Œæ¥æ”¶å…¶è¿”å›å€¼
    const onExit = transforms[i](context.currentNode, context);
    if(onExit){
      exitFns.push(onExit)
    }
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
  
  // åœ¨èŠ‚ç‚¹å¤„ç†å®Œæˆä¹‹åï¼Œæ‰§è¡ŒexitFnsé‡Œé¢æ‰€æœ‰çš„å‡½æ•°
  // æ‰§è¡Œçš„é¡ºåºæ˜¯ä»åå¾€å‰ä¾æ¬¡æ‰§è¡Œ
  let i = exitFns.length;
  while(i--){
    exitFns[i]()
  }
}
```



**ç”ŸæˆJS AST**

è¦ç”Ÿæˆ JavaScript çš„ ASTï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“ JavaScript çš„ AST æ˜¯å¦‚ä½•æè¿°ä»£ç çš„ã€‚

å‡è®¾æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

```js
function render(){
  return null
}
```

é‚£ä¹ˆæ‰€å¯¹åº”çš„ JS AST ä¸ºï¼š

![image-20231120143716229](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-20-063716.png)

è¿™é‡Œæœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„éƒ¨åˆ†ï¼š

- idï¼šå¯¹åº”å‡½æ•°çš„åç§°ï¼Œç±»å‹ä¸º Identifier
- paramsï¼šå¯¹åº”çš„æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„
- bodyï¼šå¯¹åº”çš„æ˜¯å‡½æ•°ä½“ï¼Œç”±äºå‡½æ•°ä½“å¯ä»¥æœ‰å¤šæ¡è¯­å¥ï¼Œå› æ­¤æ˜¯ä¸€ä¸ªæ•°ç»„

è¦æŸ¥çœ‹ä¸€æ®µ JS ä»£ç æ‰€å¯¹åº”çš„ AST ç»“æ„ï¼Œå¯ä»¥åœ¨ [è¿™é‡Œ](https://astexplorer.net/) è¿›è¡ŒæŸ¥çœ‹ã€‚

äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»¿é€ ä¸Šé¢çš„æ ·å­ï¼Œ**è‡ªå·±è®¾è®¡ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®ç»“æ„**æ¥æè¿°å‡½æ•°å£°æ˜è¯­å¥ï¼Œä¾‹å¦‚ï¼š

```js
const FunctionDeclNode = {
  type: 'FunctionDecl', // ä»£è¡¨è¯¥èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°å£°æ˜
  id: {
    type: 'Identifier'
    name: 'render' // name ç”¨æ¥å­˜å‚¨å‡½æ•°åç§°
  },
  params: [], // å‡½æ•°å‚æ•°
  body: [
    {
      type: 'ReturnStatement',
      return: null
    }
  ]
}
```

> å¯¹æ¯”çœŸå®çš„ ASTï¼Œè¿™é‡Œå»é™¤äº†ç®­å¤´å‡½æ•°ã€ç”Ÿæˆå™¨å‡½æ•°ã€async å‡½æ•°ç­‰æƒ…å†µã€‚

æ¥ä¸‹æ¥å›åˆ°æˆ‘ä»¬ä¸Šé¢çš„æ¨¡æ¿ï¼Œå‡è®¾æ¨¡æ¿å†…å®¹ä»ç„¶ä¸ºï¼š

```html
<div><p>Vue</p><p>React</p></div>
```

é‚£ä¹ˆè½¬æ¢å‡ºæ¥çš„æ¸²æŸ“å‡½æ•°åº”è¯¥æ˜¯ï¼š

```js
function render(){
  return h('div', [
    h('p', 'Vue'),
    h('p', 'React'),
  ])
}
```

è¿™é‡Œå‡ºç°äº† h å‡½æ•°çš„è°ƒç”¨ä»¥åŠæ•°ç»„è¡¨è¾¾å¼è¿˜æœ‰å­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼Œä»ç„¶å¯ä»¥å»å‚é˜…è¿™æ®µä»£ç çœŸå®çš„ ASTã€‚

è¿™é‡Œ h å‡½æ•°å¯¹åº”çš„åº”è¯¥æ˜¯ï¼š

```js
// æˆ‘ä»¬è‡ªå·±è®¾è®¡ä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤º h å‡½æ•°çš„è°ƒç”¨
const callExp = {
  type: 'CallExpression',
  callee: {
    type: 'Identifier',
    name: 'h'
  }
}
```

å­—ç¬¦ä¸²å¯¹åº”çš„æ˜¯ï¼š

```js
// æˆ‘ä»¬è‡ªå·±è®¾è®¡å­—ç¬¦ä¸²å¯¹åº”çš„èŠ‚ç‚¹
const Str = {
  type: 'StringLiteral',
  value: 'div'
}
```

> è¿™é‡Œä»¥æœ€å¤–å±‚çš„ div å­—ç¬¦ä¸²ä¸ºä¾‹

æ•°ç»„å¯¹åº”çš„æ˜¯ï¼š

```js
const Arr = {
  type: 'ArrayExpression',
  // æ•°ç»„ä¸­çš„å…ƒç´ 
  elements: []
}
```

å› æ­¤æŒ‰ç…§æˆ‘ä»¬æ‰€è®¾è®¡çš„ AST æ•°æ®ç»“æ„ï¼Œä¸Šé¢çš„æ¨¡æ¿æœ€ç»ˆè½¬æ¢å‡ºæ¥çš„ JavaScript AST åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```js
{
  "type": "FunctionDecl",
  "id": {
      "type": "Identifier",
      "name": "render"
  },
  "params": [],
  "body": [
      {
          "type": "ReturnStatement",
          "return": {
              "type": "CallExpression",
              "callee": {"type": "Identifier", "name": "h"},
              "arguments": [
                  {"type": "StringLiteral", "value": "div"},
                  {"type": "ArrayExpression","elements": [
                        {
                            "type": "CallExpression",
                            "callee": {"type": "Identifier", "name": "h"},
                            "arguments": [
                                {"type": "StringLiteral", "value": "p"},
                                {"type": "StringLiteral", "value": "Vue"}
                            ]
                        },
                        {
                            "type": "CallExpression",
                            "callee": {"type": "Identifier", "name": "h"},
                            "arguments": [
                                {"type": "StringLiteral", "value": "p"},
                                {"type": "StringLiteral", "value": "React"}
                            ]
                        }
                    ]
                  }
              ]
          }
      }
  ]
}
```

æˆ‘ä»¬éœ€è¦ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè¿™äº›è¾…åŠ©å‡½æ•°éƒ½å¾ˆç®€å•ï¼Œä¸€å¹¶ç»™å‡ºå¦‚ä¸‹ï¼š

```js
function createStringLiteral(value) {
  return {
    type: 'StringLiteral',
    value
  }
}

function createIdentifier(name) {
  return {
    type: 'Identifier',
    name
  }
}

function createArrayExpression(elements) {
  return {
    type: 'ArrayExpression',
    elements
  }
}

function createCallExpression(callee, arguments) {
  return {
    type: 'CallExpression',
    callee: createIdentifier(callee),
    arguments
  }
}
```

æœ‰äº†è¿™äº›è¾…åŠ©å‡½æ•°åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¿®æ”¹è½¬æ¢å‡½æ•°ã€‚

é¦–å…ˆæ˜¯æ–‡æœ¬è½¬æ¢

```js
function transformText(node, context){
  if(node.type !== 'Text'){
    return
  }
  // åˆ›å»ºæ–‡æœ¬æ‰€å¯¹åº”çš„ JS AST èŠ‚ç‚¹
  // å°†åˆ›å»ºå¥½çš„ AST èŠ‚ç‚¹æŒ‚åˆ°èŠ‚ç‚¹çš„ jsNode å±æ€§ä¸Šé¢
  node.jsNode = createStringLiteral(node.content);
}
```

Elementå…ƒç´ è½¬æ¢

```js
function transformElement(node, context){
  // è¿™é‡Œåº”è¯¥æ˜¯æ‰€æœ‰çš„å­èŠ‚ç‚¹å¤„ç†å®Œæ¯•åï¼Œå†è¿›è¡Œå¤„ç†
  return ()=>{
    if(node.type !== 'Element'){
      return;
    }
    
    // åˆ›å»ºå‡½æ•°è°ƒç”¨çš„ASTèŠ‚ç‚¹
    const callExp = createCallExpression('h', [
      createStringLiteral(node.tag),
    ])
    
    // å¤„ç†å‡½æ•°è°ƒç”¨çš„å‚æ•°
    node.children.length === 1
    ? // å¦‚æœé•¿åº¦ä¸º1è¯´æ˜åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œç›´æ¥å°†å­èŠ‚ç‚¹çš„ jsNode ä½œä¸ºå‚æ•°
      callExp.arguments.push(node.children[0].jsNode)
    : // è¯´æ˜æœ‰å¤šä¸ªå­èŠ‚ç‚¹
    callExp.arguments.push(
    	createArrayExpression(node.children.map(c=>c.jsNode))
    )
    
    node.jsNode = callExp
  }
}
```

transformRootè½¬æ¢ï¼š

```js
function transformRoot(node, context){
  // åœ¨é€€å‡ºçš„å›è°ƒå‡½æ•°ä¸­ä¹¦å†™å¤„ç†é€»è¾‘
  // å› ä¸ºè¦ä¿è¯æ‰€æœ‰çš„å­èŠ‚ç‚¹å·²ç»å¤„ç†å®Œæ¯•
  return ()=>{
    if(node.type !== 'Root'){
      return;
    }
    
    const vnodeJSAST = node.children[0].jsNode;
    
    node.jsNode = {
      type: 'FunctionDecl',
      id: {type: 'Identifier', name: 'render'},
      params: [],
      body: [{
        type: 'ReturnStatement',
        return: vnodeJSAST
      }]
    }
  }
}
```

æœ€åä¿®æ”¹ nodeTransformsï¼Œå°†è¿™å‡ ä¸ªè½¬æ¢å‡½æ•°æ”¾è¿›å»ï¼š

```js
nodeTransforms: [
  transformRoot,
  transformElement,
  transformText
]
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆæ¨¡æ¿ AST è½¬æ¢ä¸º JS AST çš„å·¥ä½œã€‚

é€šè¿‡ ast.jsNode èƒ½å¤Ÿæ‹¿åˆ°è½¬æ¢å‡ºæ¥çš„ç»“æœã€‚

# æ¨¡æ¿ç¼–è¯‘å™¨

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue ä¸­ Compiler çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**Vueä¸­çš„ç¼–è¯‘å™¨**

Vue é‡Œé¢çš„ç¼–è¯‘å™¨ï¼Œä¸»è¦è´Ÿè´£å°†å¼€å‘è€…æ‰€ä¹¦å†™çš„æ¨¡æ¿è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘åçš„ç»“æœä¸ºï¼š

```js
function render(){
  return h('div', [
    h('h1', {id: someId}, 'Hello')
  ])
}
```

è¿™é‡Œæ•´ä¸ªè¿‡ç¨‹å¹¶éä¸€è§¦è€Œå°±çš„ï¼Œè€Œæ˜¯ç»å†ä¸€ä¸ªåˆä¸€ä¸ªæ­¥éª¤ä¸€ç‚¹ä¸€ç‚¹è½¬æ¢è€Œæ¥çš„ã€‚

æ•´ä½“æ¥è®²ï¼Œæ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20231113095532166](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¼–è¯‘å™¨çš„å†…éƒ¨ï¼Œå®é™…ä¸Šåˆåˆ†ä¸ºäº†ï¼š

- è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„ AST
- è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript AST
- ç”Ÿæˆå™¨ï¼šæ ¹æ® JavaScript çš„ AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°



**è§£æå™¨**

è§£æå™¨çš„æ ¸å¿ƒä½œç”¨æ˜¯è´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºæ‰€å¯¹åº”çš„æ¨¡æ¿ ASTã€‚

é¦–å…ˆç”¨æˆ·æ‰€ä¹¦å†™çš„æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

```vue
<template>
	<div>
  	<h1 :id="someId">Hello</h1>
  </div>
</template>
```

å¯¹äºè§£æå™¨æ¥è®²ä»ç„¶å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²è€Œå·²ï¼Œç±»ä¼¼äºï¼š

```js
'<template><div><h1 :id="someId">Hello</h1></div></template>'
```

é‚£ä¹ˆè§£æå™¨æ˜¯å¦‚ä½•è¿›è¡Œè§£æçš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª <u>æœ‰é™çŠ¶æ€æœº</u> çš„æ¦‚å¿µã€‚

### FSM

FSMï¼Œè‹±è¯­å…¨ç§°ä¸º Finite State Machineï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯æœ‰é™çŠ¶æ€æœºï¼Œå®ƒé¦–å…ˆå®šä¹‰äº†**ä¸€ç»„çŠ¶æ€**ï¼Œç„¶åè¿˜å®šä¹‰äº†çŠ¶æ€ä¹‹é—´çš„è½¬ç§»ä»¥åŠè§¦å‘è¿™äº›è½¬ç§»çš„äº‹ä»¶ã€‚ç„¶åå°±ä¼šå»è§£æå­—ç¬¦ä¸²é‡Œé¢çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œæ ¹æ®å­—ç¬¦åšçŠ¶æ€çš„è½¬æ¢ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦è§£æçš„æ¨¡æ¿å†…å®¹ä¸ºï¼š

```js
'<p>Vue</p>'
```

é‚£ä¹ˆæ•´ä¸ªçŠ¶æ€çš„è¿ç§»è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. çŠ¶æ€æœºä¸€å¼€å§‹å¤„äº **åˆå§‹çŠ¶æ€**ã€‚
2. åœ¨ **åˆå§‹çŠ¶æ€** ä¸‹ï¼Œè¯»å–å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ < ï¼Œç„¶åçŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
3. æ¥ä¸‹æ¥ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼Œç”±äº p æ˜¯å­—æ¯ï¼Œæ‰€ä»¥çŠ¶æ€æœºçš„çŠ¶æ€ä¼šæ›´æ–°ä¸º **æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€**ã€‚
4. æ¥ä¸‹æ¥è¯»å–çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º >ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ä¼šå›åˆ° **åˆå§‹çŠ¶æ€**ï¼Œå¹¶ä¸”ä¼šè®°å½•åœ¨æ ‡ç­¾çŠ¶æ€ä¸‹äº§ç”Ÿçš„æ ‡ç­¾åç§° pã€‚
5. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ Vï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ–‡æœ¬çŠ¶æ€**ã€‚
6. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ uï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
7. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ eï¼ŒçŠ¶æ€æœºä»ç„¶æ˜¯ **æ–‡æœ¬çŠ¶æ€**ã€‚
8. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ <ï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾å¼€å§‹çŠ¶æ€**ã€‚
9. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ / ï¼ŒçŠ¶æ€æœºä¼šè¿›å…¥åˆ° **æ ‡ç­¾ç»“æŸçŠ¶æ€**ã€‚
10. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ pï¼ŒçŠ¶æ€æœºè¿›å…¥ **æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€**ã€‚
11. è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ >ï¼ŒçŠ¶æ€æœºè¿›é‡æ–°å›åˆ° **åˆå§‹çŠ¶æ€**ã€‚

å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-060437.png" alt="image-20231113140436969" style="zoom:60%;" />

```js
let x = 10 + 5;
```

```
token:
let(å…³é”®å­—) x(æ ‡è¯†ç¬¦) =(è¿ç®—ç¬¦) 10(æ•°å­—) +(è¿ç®—ç¬¦) 5(æ•°å­—) ;(åˆ†å·)
```

å¯¹åº”ä»£ç ï¼š

```js
const template = '<p>Vue</p>';
// é¦–å…ˆå®šä¹‰ä¸€äº›çŠ¶æ€
const State = {
  initial: 1, // åˆå§‹çŠ¶æ€
  tagOpen: 2, // æ ‡ç­¾å¼€å§‹çŠ¶æ€
  tagName: 3, // æ ‡ç­¾åç§°å¼€å§‹çŠ¶æ€
  text: 4, // æ–‡æœ¬çŠ¶æ€
  tagEnd: 5, // æ ‡ç­¾ç»“æŸçŠ¶æ€
  tagEndName: 6 // æ ‡ç­¾åç§°ç»“æŸçŠ¶æ€
}

// åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºå­—æ¯
function isAlpha(char) {
  return (char >= "a" && char <= "z") || (char >= "A" && char <= "Z");
}

// å°†å­—ç¬¦ä¸²è§£æä¸º token
function tokenize(str){
  // åˆå§‹åŒ–å½“å‰çŠ¶æ€
  let currentState = State.initial;
  // ç”¨äºç¼“å­˜å­—ç¬¦
  const chars = [];
  // å­˜å‚¨è§£æå‡ºæ¥çš„ token
  const tokens = [];
  
  while(str){
    const char = str[0]; // è·å–å­—ç¬¦ä¸²é‡Œé¢çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
    
    switch(currentState){
      case State.initial:{
        if(char === '<'){
          currentState = State.tagOpen;
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        } else if(isAlpha(char)){
          // åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯
          currentState = State.text;
          chars.push(char);
          // æ¶ˆè´¹ä¸€ä¸ªå­—ç¬¦
          str = str.slice(1);
        }
        break;
      }
      case State.tagOpen: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
      case State.tagName: {
        // ç›¸åº”çš„çŠ¶æ€å¤„ç†
      }
    }
  }
  
  return tokens;
}
tokenize(template);
```

æœ€ç»ˆè§£æå‡ºæ¥çš„ token:

```js
[
  {type: 'tag', name: 'p'}, // å¼€å§‹æ ‡ç­¾
  {type: 'text', content: 'Vue'}, // æ–‡æœ¬èŠ‚ç‚¹
  {type: 'tagEnd', name: 'p'}, // ç»“æŸæ ‡ç­¾
]
```



**æ„é€ æ¨¡æ¿AST**

æ ¹æ® token åˆ—è¡¨åˆ›å»ºæ¨¡æ¿ AST çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å¯¹ token åˆ—è¡¨è¿›è¡Œæ‰«æçš„è¿‡ç¨‹ã€‚ä»åˆ—è¡¨çš„ç¬¬ä¸€ä¸ª token å¼€å§‹ï¼ŒæŒ‰ç…§é¡ºåºè¿›è¡Œæ‰«æï¼Œç›´åˆ°åˆ—è¡¨ä¸­æ‰€æœ‰çš„ token å¤„ç†å®Œæ¯•ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€**è¦ç»´æŠ¤ä¸€ä¸ªæ ˆ**ï¼Œè¿™ä¸ªæ ˆå°†ç”¨äºç»´æŠ¤å…ƒç´ é—´çš„çˆ¶å­å…³ç³»ã€‚æ¯é‡åˆ°ä¸€ä¸ªå¼€å§‹æ ‡ç­¾èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹å…¥æ ˆä¸­ã€‚

ç±»ä¼¼çš„ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªç»“æŸæ ‡ç­¾èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°±å°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡ºã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ¨¡æ¿å†…å®¹ï¼š

```vue
'<div><p>Vue</p><p>React</p></div>'
```

ç»è¿‡ä¸Šé¢çš„ tokenize åèƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹çš„æ•°ç»„ï¼š

```js
[
  {"type": "tag","name": "div"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "Vue"},
  {"type": "tagEnd","name": "p"},
  {"type": "tag","name": "p"},
  {"type": "text","content": "React"},
  {"type": "tagEnd","name": "p"},
  {"type": "tagEnd","name": "div"}
]
```

é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šéå†è¿™ä¸ªæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯æ‰«æ tokens åˆ—è¡¨ï¼‰

1. ä¸€å¼€å§‹æœ‰ä¸€ä¸ª elementStack æ ˆï¼Œåˆšå¼€å§‹æœ‰ä¸€ä¸ª Root èŠ‚ç‚¹ï¼Œ[ Root ]

2. é¦–å…ˆæ˜¯ä¸€ä¸ª **div tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶å‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`ï¼Œdiv ä¼šä½œä¸º Root çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070249.png" alt="image-20231113150248725" style="zoom:50%;" />

3. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼Œåˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼ŒåŒæ ·ä¼šå‹æ ˆåˆ° elementStackï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070335.png" alt="image-20231113150335866" style="zoom:50%;" />

4. æ¥ä¸‹æ¥æ˜¯ **Vue text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070356.png" alt="image-20231113150356416" style="zoom:50%;" />

5. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

6. æ¥ä¸‹æ¥æ˜¯ **p tag**ï¼ŒåŒæ ·åˆ›å»ºä¸€ä¸ª Element ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œå‹æ ˆåæ ˆä¸º `[ Root, div, p ]`ï¼Œp ä¼šä½œä¸º div çš„å­èŠ‚ç‚¹

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070442.png" alt="image-20231113150442450" style="zoom:50%;" />

7. æ¥ä¸‹æ¥æ˜¯ **React text**ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Text ç±»å‹çš„ AST èŠ‚ç‚¹ï¼Œä½œä¸º p çš„å­èŠ‚ç‚¹ã€‚

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-070537.png" alt="image-20231113150537351" style="zoom:50%;" />

8. æ¥ä¸‹æ¥æ˜¯ **p tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œæ‰€ä»¥ä¼šå°† p è¿™ä¸ª AST èŠ‚ç‚¹å¼¹å‡ºæ ˆï¼Œå½“å‰çš„æ ˆä¸º `[ Root, div ]`

9. æœ€åæ˜¯ **div tagEnd**ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œå°†å…¶å¼¹å‡ºï¼Œæ ˆåŒºé‡æ–°ä¸º `[ Root ]`ï¼Œè‡³æ­¤æ•´ä¸ª AST æ„å»ºå®Œæ¯•

è½åœ°åˆ°å…·ä½“çš„ä»£ç ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·çš„ï¼š

```js
// è§£æå™¨
function parse(str){
  const tokens = tokenize(str);
  
  // åˆ›å»ºRootæ ¹ASTèŠ‚ç‚¹
  const root = {
    type: 'Root',
    children: []
  }
  
  // åˆ›å»ºä¸€ä¸ªæ ˆ
  const elementStack = [root]
  
  while(tokens.length){
    // è·å–å½“å‰æ ˆé¡¶ç‚¹ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ ˆæ•°ç»„æœ€åä¸€é¡¹
    const parent = elementStack[elementStack.length - 1];
    // ä» tokens åˆ—è¡¨ä¸­ä¾æ¬¡å–å‡ºç¬¬ä¸€ä¸ª token
    const t = tokens[0];
    
    switch(t.type){
        // æ ¹æ®ä¸åŒçš„typeåšä¸åŒçš„å¤„ç†
      case 'tag':{
        // åˆ›å»ºä¸€ä¸ªElementç±»å‹çš„ASTèŠ‚ç‚¹
        const elementNode = {
          type: 'Element',
          tag: t.name,
          children: []
        }
        // å°†å…¶æ·»åŠ ä¸ºçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
        parent.children.push(elementNode)
        // å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆé‡Œé¢
        elementStack.push(elementNode)
        break;
      }
      case 'text':
        // åˆ›å»ºæ–‡æœ¬ç±»å‹çš„ AST èŠ‚ç‚¹
        const textNode = {
          type: 'Text',
          content: t.content
        }
        // å°†å…¶æ·»åŠ åˆ°çˆ¶çº§èŠ‚ç‚¹çš„ children ä¸­
        parent.children.push(textNode)
        break
      case 'tagEnd':
        // é‡åˆ°ç»“æŸæ ‡ç­¾ï¼Œå°†å½“å‰æ ˆé¡¶çš„èŠ‚ç‚¹å¼¹å‡º
        elementStack.pop()
        break
    }
    // å°†å¤„ç†è¿‡çš„ token å¼¹å‡ºå»
    tokens.shift();
  }
}
```

æœ€ç»ˆï¼Œç»è¿‡ä¸Šé¢çš„å¤„ç†ï¼Œå°±å¾—åˆ°äº†æ¨¡æ¿çš„æŠ½è±¡è¯­æ³•æ ‘ï¼š

```
{
  "type": "Root",
  "children": [
    {
      "type": "Element",
      "tag": "div",
      "children": [
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "Vue"
              }
          ]
        },
        {
          "type": "Element",
          "tag": "p",
          "children": [
              {
                "type": "Text",
                "content": "React"
              }
          ]
        }
      ]
    }
  ]
}
```



**è½¬æ¢å™¨**

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ¨¡æ¿çš„ ASTï¼Œå›é¡¾ä¸€ä¸‹ Vue ä¸­æ•´ä¸ªæ¨¡æ¿çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

```js
// ç¼–è¯‘å™¨
function compile(template){
  // 1. è§£æå™¨å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œå¾—åˆ°æ¨¡æ¿çš„AST
  const ast = parse(template)
  // 2. è½¬æ¢å™¨ï¼šå°†æ¨¡æ¿ASTè½¬æ¢ä¸ºJS AST
  transform(ast)
  // 3. ç”Ÿæˆå™¨ï¼šåœ¨ JS AST çš„åŸºç¡€ä¸Šç”Ÿæˆ JS ä»£ç 
  const code = genrate(ast)
  
  return code;
}
```

è½¬æ¢å™¨çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯è´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JavaScript ASTã€‚

æ•´ä½“æ¥è®²ï¼Œè½¬æ¢å™¨çš„ç¼–å†™åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- æ¨¡æ¿ AST çš„éå†ä¸è½¬æ¢
- ç”Ÿæˆ JavaScript AST



**æ¨¡æ¿ASTçš„éå†ä¸è½¬æ¢**

æ­¥éª¤ä¸€ï¼šå…ˆä¹¦å†™ä¸€ä¸ªç®€å•çš„å·¥å…·æ–¹æ³•ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸€ä¸ªæ¨¡æ¿ AST ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚

```js
function dump(node, indent = 0) {
    // è·å–å½“å‰èŠ‚ç‚¹çš„ç±»å‹
    const type = node.type;
    // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ„å»ºæè¿°ä¿¡æ¯
    // å¯¹äºæ ¹èŠ‚ç‚¹ï¼Œæè¿°ä¸ºç©ºï¼›å¯¹äºå…ƒç´ èŠ‚ç‚¹ï¼Œä½¿ç”¨æ ‡ç­¾åï¼›å¯¹äºæ–‡æœ¬èŠ‚ç‚¹ï¼Œä½¿ç”¨å†…å®¹
    const desc =
      node.type === "Root"
        ? ""
        : node.type === "Element"
        ? node.tag
        : node.content;

    // æ‰“å°å½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»å‹å’Œæè¿°
    // ä½¿ç”¨é‡å¤çš„"-"å­—ç¬¦æ¥è¡¨ç¤ºç¼©è¿›ï¼ˆå±‚çº§ï¼‰
    console.log(`${"-".repeat(indent)}${type}: ${desc}`);

    // å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’è°ƒç”¨dumpå‡½æ•°æ‰“å°æ¯ä¸ªå­èŠ‚ç‚¹
    if (node.children) {
      node.children.forEach((n) => dump(n, indent + 2));
    }
}
```

æ­¥éª¤äºŒï¼šæ¥ä¸‹æ¥ä¸‹ä¸€æ­¥å°±æ˜¯éå†æ•´æ£µæ¨¡æ¿ AST æ ‘ï¼Œå¹¶ä¸”èƒ½å¤Ÿåšä¸€äº›æ”¹åŠ¨

```js
function tranverseNode(ast){
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  const currentNode = ast;
  
  // å°†pä¿®æ”¹ä¸ºh1
  if(currentNode.type === 'Element' && currentNode.tag === 'p'){
    currentNode.tag = 'h1';
  }
  
  // æ–°å¢éœ€æ±‚ï¼šå°†æ–‡æœ¬èŠ‚ç‚¹å…¨éƒ¨æ”¹ä¸ºå¤§å†™
  if(currentNode.type === 'Text'){
    currentNode.content = currentNode.content.toUpperCase();
  }
  
  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = currentNode.children;
  if(children){
    for(let i = 0;i< children.length; i++){
      tranverseNode(children[i])
    }
  }
}

function transform(ast){
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast);
  
  console.log(dump(ast));
}
```

ç›®å‰tranverseNodeè™½ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å†…éƒ¨æœ‰ä¸¤ä¸ªèŒè´£ï¼šéå†ã€è½¬æ¢ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†è¿™ä¸¤ä¸ªèŒè´£è¿›è¡Œè§£è€¦ã€‚

æ­¥éª¤ä¸‰ï¼šåœ¨ transform é‡Œé¢ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆç¯å¢ƒï¼šåŒ…å«æ‰§è¡Œä»£ç æ—¶ç”¨åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼‰

```js
// éœ€è¦å°†ä¹‹å‰çš„è½¬æ¢æ–¹æ³•å…¨éƒ¨æå‡ºæ¥ï¼Œæ¯ä¸€ç§è½¬æ¢æå–æˆä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•
function transformElement(node){
  if(node.type === 'Element' && node.tag === 'p'){
    node.tag = 'h1';
  }
}

function transformText(node){
  if(node.type === 'Text'){
    node.content = node.content.toUpperCase();
  }
}

// è¯¥æ–¹æ³•åªè´Ÿè´£éå†ï¼Œè½¬æ¢çš„å·¥ä½œäº¤ç»™è½¬æ¢å‡½æ•°
// è½¬æ¢å‡½æ•°æ˜¯å­˜æ”¾äºä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢çš„
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode);
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}


function transform(ast){
  // ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šåŒ…å«ä¸€äº›é‡è¦ä¿¡æ¯
  const context = {
    currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
    childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
    parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
    nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
  }
  
  // åœ¨éå†æ¨¡æ¿ASTæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹éƒ¨åˆ†èŠ‚ç‚¹ä½œå‡ºä¸€äº›ä¿®æ”¹
  tranverseNode(ast, context);
  
  
}
```

æ­¥éª¤å››ï¼šå®Œå–„ context ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ·»åŠ 2ä¸ªæ–¹æ³•

1. æ›¿æ¢èŠ‚ç‚¹æ–¹æ³•
2. åˆ é™¤èŠ‚ç‚¹æ–¹æ³•

```js
const context = {
  currentNode: null, // å­˜å‚¨å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
  childIndex: 0, // å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
  parent: null, // å­˜å‚¨çˆ¶èŠ‚ç‚¹
  // æ›¿æ¢èŠ‚ç‚¹
  replaceNode(node){
    context.parent.children[context.childIndex] = node;
    context.currentNode = node;
  },
  // åˆ é™¤èŠ‚ç‚¹
  removeNode(){
    if(context.parent){
      context.parent.children.splice(context.childIndex, 1);
      context.currentNode = null;
    }
  },
  nodeTransforms: [transformElement, transformText], // å­˜å‚¨å…·ä½“çš„è½¬æ¢æ–¹æ³•
}
```

æ³¨æ„å› ä¸ºå­˜åœ¨åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨tranverseNodeæ–¹æ³•é‡Œé¢æ‰§è¡Œè½¬æ¢å‡½æ•°ä¹‹åï¼Œéœ€è¦è¿›è¡Œéç©ºçš„åˆ¤æ–­ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    transforms[i](context.currentNode, context);
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
}
```

æ­¥éª¤äº”ï¼šè§£å†³èŠ‚ç‚¹å¤„ç†çš„æ¬¡æ•°é—®é¢˜

ç›®å‰æ¥è®²ï¼Œéå†çš„é¡ºåºæ˜¯æ·±åº¦éå†ï¼Œä»çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹ã€‚ä½†æ˜¯æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šå­èŠ‚ç‚¹å¤„ç†å®Œä¹‹åï¼Œé‡æ–°å›åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¯¹çˆ¶èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚

é¦–å…ˆéœ€è¦å¯¹è½¬æ¢å‡½æ•°è¿›è¡Œæ”¹é€ ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°

```js
function transformText(node, context) {
  // çœç•¥ç¬¬ä¸€æ¬¡å¤„ç†....
  
  return ()=>{
    // å¯¹èŠ‚ç‚¹å†æ¬¡è¿›è¡Œå¤„ç†
  }
}
```

tranverseNodeéœ€è¦æ‹¿ä¸€ä¸ªæ•°ç»„å­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°ï¼š

```js
function tranverseNode(ast, context) {
  // è·å–åˆ°å½“å‰çš„èŠ‚ç‚¹
  context.currentNode = ast;
  
  // 1. å¢åŠ ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨è½¬æ¢å‡½æ•°è¿”å›çš„å‡½æ•°
  const exitFns = []

  // ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œé¢æ‹¿åˆ°æ‰€æœ‰çš„è½¬æ¢æ–¹æ³•
  const transforms = context.nodeTransforms;

  for (let i = 0; i < transforms.length; i++) {
    // æ‰§è¡Œè½¬æ¢å‡½æ•°çš„æ—¶å€™ï¼Œæ¥æ”¶å…¶è¿”å›å€¼
    const onExit = transforms[i](context.currentNode, context);
    if(onExit){
      exitFns.push(onExit)
    }
    // ç”±äºåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹ä¼šè¢«ç½®ä¸ºnullï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­
    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è¿”å›
    if(!context.currentNode) return;
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  const children = context.currentNode.children;
  if (children) {
    for (let i = 0; i < children.length; i++) {
      // æ›´æ–°ä¸Šä¸‹æ–‡é‡Œé¢çš„ä¿¡æ¯
      context.parent = context.currentNode;
      context.childIndex = i;
      tranverseNode(children[i], context);
    }
  }
  
  // åœ¨èŠ‚ç‚¹å¤„ç†å®Œæˆä¹‹åï¼Œæ‰§è¡ŒexitFnsé‡Œé¢æ‰€æœ‰çš„å‡½æ•°
  // æ‰§è¡Œçš„é¡ºåºæ˜¯ä»åå¾€å‰ä¾æ¬¡æ‰§è¡Œ
  let i = exitFns.length;
  while(i--){
    exitFns[i]()
  }
}
```



**ç”ŸæˆJS AST**

è¦ç”Ÿæˆ JavaScript çš„ ASTï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“ JavaScript çš„ AST æ˜¯å¦‚ä½•æè¿°ä»£ç çš„ã€‚

å‡è®¾æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

```js
function render(){
  return null
}
```

é‚£ä¹ˆæ‰€å¯¹åº”çš„ JS AST ä¸ºï¼š

![image-20231120143716229](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-20-063716.png)

è¿™é‡Œæœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„éƒ¨åˆ†ï¼š

- idï¼šå¯¹åº”å‡½æ•°çš„åç§°ï¼Œç±»å‹ä¸º Identifier
- paramsï¼šå¯¹åº”çš„æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„
- bodyï¼šå¯¹åº”çš„æ˜¯å‡½æ•°ä½“ï¼Œç”±äºå‡½æ•°ä½“å¯ä»¥æœ‰å¤šæ¡è¯­å¥ï¼Œå› æ­¤æ˜¯ä¸€ä¸ªæ•°ç»„

è¦æŸ¥çœ‹ä¸€æ®µ JS ä»£ç æ‰€å¯¹åº”çš„ AST ç»“æ„ï¼Œå¯ä»¥åœ¨ [è¿™é‡Œ](https://astexplorer.net/) è¿›è¡ŒæŸ¥çœ‹ã€‚

äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»¿é€ ä¸Šé¢çš„æ ·å­ï¼Œ**è‡ªå·±è®¾è®¡ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®ç»“æ„**æ¥æè¿°å‡½æ•°å£°æ˜è¯­å¥ï¼Œä¾‹å¦‚ï¼š

```js
const FunctionDeclNode = {
  type: 'FunctionDecl', // ä»£è¡¨è¯¥èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°å£°æ˜
  id: {
    type: 'Identifier'
    name: 'render' // name ç”¨æ¥å­˜å‚¨å‡½æ•°åç§°
  },
  params: [], // å‡½æ•°å‚æ•°
  body: [
    {
      type: 'ReturnStatement',
      return: null
    }
  ]
}
```

> å¯¹æ¯”çœŸå®çš„ ASTï¼Œè¿™é‡Œå»é™¤äº†ç®­å¤´å‡½æ•°ã€ç”Ÿæˆå™¨å‡½æ•°ã€async å‡½æ•°ç­‰æƒ…å†µã€‚

æ¥ä¸‹æ¥å›åˆ°æˆ‘ä»¬ä¸Šé¢çš„æ¨¡æ¿ï¼Œå‡è®¾æ¨¡æ¿å†…å®¹ä»ç„¶ä¸ºï¼š

```html
<div><p>Vue</p><p>React</p></div>
```

é‚£ä¹ˆè½¬æ¢å‡ºæ¥çš„æ¸²æŸ“å‡½æ•°åº”è¯¥æ˜¯ï¼š

```js
function render(){
  return h('div', [
    h('p', 'Vue'),
    h('p', 'React'),
  ])
}
```

è¿™é‡Œå‡ºç°äº† h å‡½æ•°çš„è°ƒç”¨ä»¥åŠæ•°ç»„è¡¨è¾¾å¼è¿˜æœ‰å­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼Œä»ç„¶å¯ä»¥å»å‚é˜…è¿™æ®µä»£ç çœŸå®çš„ ASTã€‚

è¿™é‡Œ h å‡½æ•°å¯¹åº”çš„åº”è¯¥æ˜¯ï¼š

```js
// æˆ‘ä»¬è‡ªå·±è®¾è®¡ä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤º h å‡½æ•°çš„è°ƒç”¨
const callExp = {
  type: 'CallExpression',
  callee: {
    type: 'Identifier',
    name: 'h'
  }
}
```

å­—ç¬¦ä¸²å¯¹åº”çš„æ˜¯ï¼š

```js
// æˆ‘ä»¬è‡ªå·±è®¾è®¡å­—ç¬¦ä¸²å¯¹åº”çš„èŠ‚ç‚¹
const Str = {
  type: 'StringLiteral',
  value: 'div'
}
```

> è¿™é‡Œä»¥æœ€å¤–å±‚çš„ div å­—ç¬¦ä¸²ä¸ºä¾‹

æ•°ç»„å¯¹åº”çš„æ˜¯ï¼š

```js
const Arr = {
  type: 'ArrayExpression',
  // æ•°ç»„ä¸­çš„å…ƒç´ 
  elements: []
}
```

å› æ­¤æŒ‰ç…§æˆ‘ä»¬æ‰€è®¾è®¡çš„ AST æ•°æ®ç»“æ„ï¼Œä¸Šé¢çš„æ¨¡æ¿æœ€ç»ˆè½¬æ¢å‡ºæ¥çš„ JavaScript AST åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```js
{
  "type": "FunctionDecl",
  "id": {
      "type": "Identifier",
      "name": "render"
  },
  "params": [],
  "body": [
      {
          "type": "ReturnStatement",
          "return": {
              "type": "CallExpression",
              "callee": {"type": "Identifier", "name": "h"},
              "arguments": [
                  {"type": "StringLiteral", "value": "div"},
                  {"type": "ArrayExpression","elements": [
                        {
                            "type": "CallExpression",
                            "callee": {"type": "Identifier", "name": "h"},
                            "arguments": [
                                {"type": "StringLiteral", "value": "p"},
                                {"type": "StringLiteral", "value": "Vue"}
                            ]
                        },
                        {
                            "type": "CallExpression",
                            "callee": {"type": "Identifier", "name": "h"},
                            "arguments": [
                                {"type": "StringLiteral", "value": "p"},
                                {"type": "StringLiteral", "value": "React"}
                            ]
                        }
                    ]
                  }
              ]
          }
      }
  ]
}
```

æˆ‘ä»¬éœ€è¦ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè¿™äº›è¾…åŠ©å‡½æ•°éƒ½å¾ˆç®€å•ï¼Œä¸€å¹¶ç»™å‡ºå¦‚ä¸‹ï¼š

```js
function createStringLiteral(value) {
  return {
    type: 'StringLiteral',
    value
  }
}

function createIdentifier(name) {
  return {
    type: 'Identifier',
    name
  }
}

function createArrayExpression(elements) {
  return {
    type: 'ArrayExpression',
    elements
  }
}

function createCallExpression(callee, arguments) {
  return {
    type: 'CallExpression',
    callee: createIdentifier(callee),
    arguments
  }
}
```

æœ‰äº†è¿™äº›è¾…åŠ©å‡½æ•°åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¿®æ”¹è½¬æ¢å‡½æ•°ã€‚

é¦–å…ˆæ˜¯æ–‡æœ¬è½¬æ¢

```js
function transformText(node, context){
  if(node.type !== 'Text'){
    return
  }
  // åˆ›å»ºæ–‡æœ¬æ‰€å¯¹åº”çš„ JS AST èŠ‚ç‚¹
  // å°†åˆ›å»ºå¥½çš„ AST èŠ‚ç‚¹æŒ‚åˆ°èŠ‚ç‚¹çš„ jsNode å±æ€§ä¸Šé¢
  node.jsNode = createStringLiteral(node.content);
}
```

Elementå…ƒç´ è½¬æ¢

```js
function transformElement(node, context){
  // è¿™é‡Œåº”è¯¥æ˜¯æ‰€æœ‰çš„å­èŠ‚ç‚¹å¤„ç†å®Œæ¯•åï¼Œå†è¿›è¡Œå¤„ç†
  return ()=>{
    if(node.type !== 'Element'){
      return;
    }
    
    // åˆ›å»ºå‡½æ•°è°ƒç”¨çš„ASTèŠ‚ç‚¹
    const callExp = createCallExpression('h', [
      createStringLiteral(node.tag),
    ])
    
    // å¤„ç†å‡½æ•°è°ƒç”¨çš„å‚æ•°
    node.children.length === 1
    ? // å¦‚æœé•¿åº¦ä¸º1è¯´æ˜åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œç›´æ¥å°†å­èŠ‚ç‚¹çš„ jsNode ä½œä¸ºå‚æ•°
      callExp.arguments.push(node.children[0].jsNode)
    : // è¯´æ˜æœ‰å¤šä¸ªå­èŠ‚ç‚¹
    callExp.arguments.push(
    	createArrayExpression(node.children.map(c=>c.jsNode))
    )
    
    node.jsNode = callExp
  }
}
```

transformRootè½¬æ¢ï¼š

```js
function transformRoot(node, context){
  // åœ¨é€€å‡ºçš„å›è°ƒå‡½æ•°ä¸­ä¹¦å†™å¤„ç†é€»è¾‘
  // å› ä¸ºè¦ä¿è¯æ‰€æœ‰çš„å­èŠ‚ç‚¹å·²ç»å¤„ç†å®Œæ¯•
  return ()=>{
    if(node.type !== 'Root'){
      return;
    }
    
    const vnodeJSAST = node.children[0].jsNode;
    
    node.jsNode = {
      type: 'FunctionDecl',
      id: {type: 'Identifier', name: 'render'},
      params: [],
      body: [{
        type: 'ReturnStatement',
        return: vnodeJSAST
      }]
    }
  }
}
```

æœ€åä¿®æ”¹ nodeTransformsï¼Œå°†è¿™å‡ ä¸ªè½¬æ¢å‡½æ•°æ”¾è¿›å»ï¼š

```js
nodeTransforms: [
  transformRoot,
  transformElement,
  transformText
]
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆæ¨¡æ¿ AST è½¬æ¢ä¸º JS AST çš„å·¥ä½œã€‚

é€šè¿‡ ast.jsNode èƒ½å¤Ÿæ‹¿åˆ°è½¬æ¢å‡ºæ¥çš„ç»“æœã€‚



**ç”Ÿæˆå™¨**

ç›®å‰ç¼–è¯‘å™¨çš„æ•´ä½“æµç¨‹ï¼š

```js
// ç¼–è¯‘å™¨
function compile(template){
  // 1. è§£æå™¨å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œå¾—åˆ°æ¨¡æ¿çš„AST
  const ast = parse(template)
  // 2. è½¬æ¢å™¨ï¼šå°†æ¨¡æ¿ASTè½¬æ¢ä¸ºJS AST
  transform(ast)
  // 3. ç”Ÿæˆå™¨ï¼šåœ¨ JS AST çš„åŸºç¡€ä¸Šç”Ÿæˆ JS ä»£ç 
  const code = genrate(ast)
  
  return code;
}
```

åœ¨ç”Ÿæˆå™¨é‡Œé¢éœ€è¦ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ä¸€äº›é‡è¦çš„çŠ¶æ€ä¿¡æ¯ã€‚

```js
function generate(ast){
  const context = {
    code: "", // å­˜å‚¨æœ€ç»ˆç”Ÿæˆçš„ä»£ç 
    // ç”Ÿæˆä»£ç æœ¬è´¨ä¸Šå°±æ˜¯å­—ç¬¦ä¸²çš„æ‹¼æ¥
    push(code){
      context.code += code;
    },
    // å½“å‰ç¼©è¿›çš„çº§åˆ«ï¼Œåˆå§‹å€¼ä¸º0ï¼Œæ²¡æœ‰ç¼©è¿›
    currentIndent: 0,
    // ç”¨äºæ¢è¡Œçš„ï¼Œå¹¶ä¸”ä¼šæ ¹æ®ç¼©è¿›çš„çº§åˆ«æ·»åŠ å¯¹åº”çš„ç¼©è¿›
    newLine(){
      context.code += "\n" + `  `.repeat(context.currentIndent);
    },
    // å¢åŠ ç¼©è¿›çº§åˆ«
    indent(){
      context.currentIndent++;
      context.newLine();
    },
    // é™ä½ç¼©è¿›çº§åˆ«
    deIndent(){
      context.currentIndent--;
      context.newLine();
    }
  }
  
  genNode(ast, context);
  
  return context.code;
}
```

genNode æ–¹æ³•ï¼šæ ¹æ®ä¸åŒçš„èŠ‚ç‚¹ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼š

```js
function genNode(node, context){
  switch(node.type){
    case 'FunctionDecl':
      genFunctionDecl(node, context)
      break
    case 'ReturnStatement':
      genReturnStatement(node, context)
      break
   	case 'CallExpression':
      genCallExpression(node, context)
      break
    case 'StringLiteral':
      genStringLiteral(node, context)
      break
    case 'ArrayExpression':
      genArrayExpression(node, context)
      break
  }
}
```

æœ€åå°±æ˜¯å„ç§ç”Ÿæˆæ–¹æ³•ï¼šæœ¬è´¨ä¸Šå°±æ˜¯æ ¹æ®ä¸åŒçš„èŠ‚ç‚¹ç±»å‹ï¼Œåšä¸åŒçš„å­—ç¬¦ä¸²æ‹¼æ¥

```js
// ç”Ÿæˆå­—ç¬¦ä¸²å­—é¢é‡
function genStringLiteral(node, context){
  const { push } = context;
  push(`'${node.value}'`)
}
// ç”Ÿæˆè¿”å›è¯­å¥
function genReturnStatement(node, context){
  const { push } = context;
  push(`return `)
  genNode(node.return, context);
}
// ç”Ÿæˆå‡½æ•°å£°æ˜
function genFunctionDecl(node, context) {
  // ä»ä¸Šä¸‹æ–‡ä¸­è·å–ä¸€äº›å®ç”¨å‡½æ•°
  const { push, indent, deIndent } = context;
  // å‘è¾“å‡ºä¸­æ·»åŠ  "function å‡½æ•°å"
  push(`function ${node.id.name} `);
  // æ·»åŠ å·¦æ‹¬å·å¼€å§‹å‚æ•°åˆ—è¡¨
  push(`(`);
  // ç”Ÿæˆå‚æ•°åˆ—è¡¨
  genNodeList(node.params, context);
  // æ·»åŠ å³æ‹¬å·ç»“æŸå‚æ•°åˆ—è¡¨
  push(`) `);
  // æ·»åŠ å·¦èŠ±æ‹¬å·å¼€å§‹å‡½æ•°ä½“
  push(`{`);
  // ç¼©è¿›ï¼Œä¸ºå‡½æ•°ä½“çš„ä»£ç ç”Ÿæˆåšå‡†å¤‡
  indent();
  // éå†å‡½æ•°ä½“ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œç”Ÿæˆç›¸åº”çš„ä»£ç 
  node.body.forEach((n) => genNode(n, context));
  // å‡å°‘ç¼©è¿›
  deIndent();
  // æ·»åŠ å³èŠ±æ‹¬å·ç»“æŸå‡½æ•°ä½“
  push(`}`);
}

// ç”ŸæˆèŠ‚ç‚¹åˆ—è¡¨
function genNodeList(nodes, context) {
  const { push } = context;
  for (let i = 0; i < nodes.length; i++) {
    const node = nodes[i];

    // ç”Ÿæˆå½“å‰èŠ‚ç‚¹çš„ä»£ç 
    genNode(node, context);

    // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ·»åŠ é€—å·åˆ†éš”
    if (i < nodes.length - 1) {
      push(", ");
    }
  }
}

// ç”Ÿæˆå‡½æ•°è°ƒç”¨è¡¨è¾¾å¼
function genCallExpression(node, context) {
  const { push } = context;
  const { callee, arguments: args } = node;

  // æ·»åŠ  "å‡½æ•°å("
  push(`${callee.name}(`);
  // ç”Ÿæˆå‚æ•°åˆ—è¡¨
  genNodeList(args, context);
  // æ·»åŠ  ")"
  push(`)`);
}

// ç”Ÿæˆæ•°ç»„è¡¨è¾¾å¼
function genArrayExpression(node, context) {
  const { push } = context;
  // æ·»åŠ  "["
  push("[");
  // ç”Ÿæˆæ•°ç»„å…ƒç´ 
  genNodeList(node.elements, context);
  // æ·»åŠ  "]"
  push("]");
}
```



> é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue ä¸­ Compiler çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
>
> å‚è€ƒç­”æ¡ˆï¼š
>
> åœ¨ Vue ä¸­ï¼ŒCompiler ä¸»è¦ç”¨äºå°†å¼€å‘è€…çš„æ¨¡æ¿ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œå†…éƒ¨å¯ä»¥åˆ†ä¸º 3 ä¸ªå¤§çš„ç»„ä»¶ï¼š
>
> 1. è§£æå™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿è§£æä¸ºå¯¹åº”çš„æ¨¡æ¿ AST
>
>    - å†…éƒ¨ç”¨åˆ°äº†æœ‰é™çŠ¶æ€æœºæ¥è¿›è¡Œè§£æï¼Œè¿™æ˜¯è§£ææ ‡è®°è¯­è¨€çš„å¸¸ç”¨æ–¹å¼ï¼Œæµè§ˆå™¨å†…éƒ¨è§£æ HTML ä¹Ÿæ˜¯é€šè¿‡æœ‰é™çŠ¶æ€æœºçš„æ–¹å¼è¿›è¡Œè§£æçš„ã€‚
>
>    - è§£æçš„ç»“æœèƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ª token çš„æ•°ç»„
>
>    - ç´§æ¥ç€æ‰«æ token åˆ—è¡¨ï¼Œé€šè¿‡æ ˆçš„æ–¹å¼å°† token å‹å…¥å’Œå¼¹å‡ºæ ˆï¼Œå‘ç°æ˜¯èµ·å§‹æ ‡è®°æ—¶å°±å…¥æ ˆï¼Œå‘ç°æ˜¯ç»“æŸæ ‡è®°æ—¶å°±å‡ºæ ˆï¼Œæœ€ç»ˆèƒ½å¤Ÿå¾—åˆ°æ¨¡æ¿ AST æ ‘ç»“æ„
>
> 2. è½¬æ¢å™¨ï¼šè´Ÿè´£å°†æ¨¡æ¿ AST è½¬æ¢ä¸º JS AST
>
>    - å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ä¸€äº›å…³é”®çš„ä¿¡æ¯
>
>      - å½“å‰æ­£åœ¨è½¬æ¢çš„èŠ‚ç‚¹
>      - å½“å‰æ­£åœ¨è½¬æ¢çš„å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„ä¸­çš„ç´¢å¼•
>      - å½“å‰æ­£åœ¨è½¬æ¢çš„çˆ¶èŠ‚ç‚¹
>      - å…·ä½“çš„è½¬æ¢å‡½æ•°
>
>        - å¯¹èŠ‚ç‚¹çš„å¤„ç†åˆ†ä¸ºè¿›å…¥é˜¶æ®µå¤„ç†ä¸€æ¬¡å’Œé€€å‡ºé˜¶æ®µå¤„ç†ä¸€æ¬¡
>          - è¿™ç§æ€æƒ³åœ¨å„ä¸ªåœ°æ–¹éƒ½éå¸¸å¸¸è§ï¼Œä¾‹å¦‚ï¼š
>
>            - React ä¸­çš„ beginWorkã€completeWork
>            - Koa ä¸­é—´ä»¶æ‰€é‡‡ç”¨çš„æ´‹è‘±æ¨¡å‹
>
>    - ç”Ÿæˆ JS AST
>      - ä¸åŒçš„èŠ‚ç‚¹å¯¹åº”ä¸åŒçš„èŠ‚ç‚¹å¯¹è±¡ï¼Œå¯¹è±¡é‡Œé¢ä¼šåŒ…å«èŠ‚ç‚¹çš„ typeã€nameã€value ä¸€ç±»çš„ä¿¡æ¯
>        - ä¸»è¦å°±æ˜¯éå†æ¨¡æ¿çš„ ASTï¼Œæ ¹æ®ä¸åŒçš„èŠ‚ç‚¹ï¼Œè¿”å›å¯¹åº”çš„å¯¹è±¡
>
> 3. ç”Ÿæˆå™¨ï¼šæ ¹æ® JS AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°
>    - ä¸»è¦å°±æ˜¯éå† JS ASTï¼Œæ ¹æ®ä¸åŒçš„èŠ‚ç‚¹å¯¹è±¡ï¼Œæ‹¼æ¥ä¸åŒçš„å­—ç¬¦
>
>
> å½“ç„¶ï¼Œæ•´ä¸ª Compiler å†…éƒ¨è¿˜ä¼šåšå¾ˆå¤šçš„ä¼˜åŒ–ï¼Œä»è€Œå¸¦æ¥æ€§èƒ½ä¸Šçš„æå‡ã€‚ä¸çŸ¥é“è¿™ä¸€å—å„¿éœ€ä¸éœ€è¦æˆ‘å±•å¼€è®²ä¸€ä¸‹ï¼Ÿ

---

-EOF-

# æ¨¡æ¿ç¼–è¯‘æå‡

>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue3 åœ¨è¿›è¡Œæ¨¡æ¿ç¼–è¯‘æ—¶åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ

1. é™æ€æå‡
2. é¢„å­—ç¬¦ä¸²åŒ–
3. ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
4. Block Tree
5. PatchFlag

## é™æ€æå‡

é™æ€æå‡ Static Hoistingï¼Œåœ¨æ¨¡æ¿ç¼–è¯‘é˜¶æ®µè¯†åˆ«å¹¶æå‡ä¸å˜çš„é™æ€èŠ‚ç‚¹åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨ï¼Œä»è€Œå‡å°‘æ¯æ¬¡æ¸²æŸ“æ—¶çš„è®¡ç®—é‡ã€‚è¢«æå‡çš„èŠ‚ç‚¹æ— éœ€é‡å¤åˆ›å»ºã€‚

**å“ªäº›èŠ‚ç‚¹ä¼šè¢«æå‡**

1. å…ƒç´ èŠ‚ç‚¹
2. æ²¡æœ‰ç»‘å®šåŠ¨æ€å†…å®¹çš„èŠ‚ç‚¹

**ä¸€ä¸ªæå‡çš„ç¤ºä¾‹**

```vue
<template>
  <div>
    <p>è¿™æ˜¯ä¸€ä¸ªé™æ€çš„æ®µè½ã€‚</p>
    <p>{{ dynamicMessage }}</p>
  </div>
</template>
```

åœ¨ Vue2 æ—¶æœŸä¸ç®¡æ˜¯é™æ€èŠ‚ç‚¹è¿˜æ˜¯åŠ¨æ€èŠ‚ç‚¹ï¼Œéƒ½ä¼šç¼–è¯‘ä¸º **åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹å‡½æ•°** çš„è°ƒç”¨ã€‚

```js
with(this) {
  return createElement('div', [
    createElement('p', [createTextVNode("è¿™æ˜¯ä¸€ä¸ªé™æ€çš„æ®µè½ã€‚")]),
    createElement('p', [createTextVNode(toString(dynamicMessage))])
  ])
}
```

Vue3 ä¸­ï¼Œç¼–è¯‘å™¨ä¼šå¯¹**é™æ€å†…å®¹çš„ç¼–è¯‘ç»“æœè¿›è¡Œæå‡**ï¼š

```js
const _hoisted_1 = /*#__PURE__*/createStaticVNode("<p>è¿™æ˜¯ä¸€ä¸ªé™æ€çš„æ®µè½ã€‚</p>", 1);

export function render(_ctx, _cache) {
  return (openBlock(), createElementBlock("div", null, [
    _hoisted_1,
    createElementVNode("p", null, toDisplayString(_ctx.dynamicMessage), 1 /* TEXT */)
  ]))
}
```



é™¤äº†é™æ€èŠ‚ç‚¹ï¼Œé™æ€å±æ€§ä¹Ÿæ˜¯èƒ½å¤Ÿæå‡çš„ï¼Œä¾‹å¦‚ï¼š

```vue
<template>
  <button class="btn btn-primary">{{ buttonText }}</button>
</template>
```

åœ¨è¿™ä¸ªæ¨¡æ¿ä¸­ï¼Œè™½ç„¶ button æ˜¯ä¸€ä¸ªåŠ¨æ€èŠ‚ç‚¹ï¼Œä½†æ˜¯å±æ€§æ˜¯å›ºå®šçš„ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼š

```js
// é™æ€å±æ€§æå‡
const _hoisted_1 = { class: "btn btn-primary" };

export function render(_ctx, _cache) {
  return (openBlock(), createElementBlock("button", _hoisted_1, toDisplayString(_ctx.buttonText), 1 /* TEXT */))
}
```



## é¢„å­—ç¬¦ä¸²åŒ–

å½“ç¼–è¯‘å™¨é‡åˆ°**å¤§é‡è¿ç»­çš„é™æ€å†…å®¹**æ—¶ï¼Œä¼šç›´æ¥å°†å…¶**ç¼–è¯‘ä¸ºä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ä¸²èŠ‚ç‚¹**ã€‚ä¾‹å¦‚ï¼š

```vue
<template>
  <div class="menu-bar-container">
    <div class="logo">
      <h1>logo</h1>
    </div>
    <ul class="nav">
      <li><a href="">menu</a></li>
      <li><a href="">menu</a></li>
      <li><a href="">menu</a></li>
      <li><a href="">menu</a></li>
      <li><a href="">menu</a></li>
    </ul>
    <div class="user">
      <span>{{ user.name }}</span>
    </div>
  </div>
</template>

<script setup>
import { ref } from "vue";
const user = ref({
  name: "zhangsan",
});
</script>
```

ç¼–è¯‘ç»“æœä¸­å’Œé™æ€æå‡ç›¸å…³çš„éƒ¨åˆ†ï¼š

```js
const _hoisted_1 = { class: "menu-bar-container" }
const _hoisted_2 = /*#__PURE__*/_createStaticVNode("<div class=\"logo\"><h1>logo</h1></div><ul class=\"nav\"><li><a href=\"\">menu</a></li><li><a href=\"\">menu</a></li><li><a href=\"\">menu</a></li><li><a href=\"\">menu</a></li><li><a href=\"\">menu</a></li></ul>", 2)
const _hoisted_4 = { class: "user" }
```

å…¶ä¸­çš„ _hoisted_2 å°±æ˜¯å°†è¿ç»­çš„é™æ€èŠ‚ç‚¹ç¼–è¯‘ä¸ºäº†å­—ç¬¦ä¸²ã€‚

æ€è€ƒğŸ¤”ï¼šè¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ

ç­”æ¡ˆï¼šå½“å¤§é‡çš„è¿ç»­çš„é™æ€èŠ‚ç‚¹è¢«ç¼–è¯‘ä¸ºå­—ç¬¦ä¸²èŠ‚ç‚¹åï¼Œæ•´ä½“çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹æ•°é‡å°±å°‘äº†ï¼Œè‡ªç„¶è€Œç„¶ diff çš„é€Ÿåº¦å°±æ›´å¿«äº†ã€‚

Vue2:

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-27-034042.png" alt="vue2" style="zoom:50%;" />

Vue3:

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-27-034043.png" alt="vue3" style="zoom:50%;" />

ç¬¬äºŒä¸ªå¥½å¤„å°±æ˜¯åœ¨ SSR çš„æ—¶å€™ï¼Œæ— éœ€é‡å¤è®¡ç®—å’Œè½¬æ¢ï¼Œå‡å°‘äº†æœåŠ¡å™¨ç«¯çš„è®¡ç®—é‡å’Œå¤„ç†æ—¶é—´ã€‚

æ€è€ƒğŸ¤”ï¼šå¤§é‡è¿ç»­çš„é™æ€å†…å®¹æ—¶ï¼Œä¼šå¯ç”¨é¢„å­—ç¬¦ä¸²åŒ–å¤„ç†ï¼Œå¤§é‡è¿ç»­çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Ÿ

ç­”æ¡ˆï¼šåœ¨ Vue3 ç¼–è¯‘å™¨å†…éƒ¨æœ‰ä¸€ä¸ªé˜€å€¼ï¼Œç›®å‰æ˜¯ 10 ä¸ªèŠ‚ç‚¹å·¦å³ä¼šå¯åŠ¨é¢„å­—ç¬¦ä¸²åŒ–ã€‚

```vue
<template>
  <div class="menu-bar-container">
    <div class="logo">
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
      <h1>logo</h1>
    </div>
    <div class="user">
      <span>{{ user.name }}</span>
    </div>
  </div>
</template>

<script setup>
import { ref } from "vue";
const user = ref({
  name: "zhangsan",
});
</script>
```

## ç¼“å­˜å†…è”äº‹ä»¶å¤„ç†å‡½æ•°

æ¨¡æ¿åœ¨è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šé’ˆå¯¹**å†…è”çš„äº‹ä»¶å¤„ç†å‡½æ•°**åšç¼“å­˜ã€‚ä¾‹å¦‚ï¼š

```vue
<button @click="count++">plus</button>
```

åœ¨ Vue2 ä¸­ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šä¸ºè¿™ä¸ªå†…è”äº‹ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¼šäº§ç”Ÿä¸å¿…è¦çš„å†…å­˜å¼€é”€å’Œæ€§èƒ½æŸè€—ã€‚

```js
render(ctx){
  return createVNode("button", {
    // æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°
    onClick: function($event){
      ctx.count++;
    }
  })
}
```

åœ¨ Vue3 ä¸­ï¼Œä¸ºäº†ä¼˜åŒ–è¿™ç§æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºå†…è”äº‹ä»¶å¤„ç†å‡½æ•°ç”Ÿæˆç¼“å­˜ä»£ç ã€‚

```js
render(ctx, _cache){
  return createVNode("button", {
    // å¦‚æœç¼“å­˜é‡Œé¢æœ‰ï¼Œç›´æ¥ä»ç¼“å­˜é‡Œé¢å–
    // å¦‚æœç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç„¶åå°†å…¶æ”¾å…¥åˆ°ç¼“å­˜é‡Œé¢
    onClick: cache[0] || (cache[0] = ($event) => (ctx.count++))
  })
}
```

æ€è€ƒğŸ¤”ï¼šä¸ºä»€ä¹ˆä»…é’ˆå¯¹å†…è”äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œç¼“å­˜ï¼Ÿ

ç­”æ¡ˆï¼šéå†…è”äº‹ä»¶å¤„ç†å‡½æ•°ä¸éœ€è¦ç¼“å­˜ï¼Œå› ä¸ºéå†…è”äº‹ä»¶å¤„ç†å‡½æ•°åœ¨ç»„ä»¶å®ä¾‹åŒ–çš„æ—¶å€™å°±å­˜åœ¨äº†ï¼Œä¸ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºã€‚ç¼“å­˜æœºåˆ¶ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å†…è”äº‹ä»¶å¤„ç†å‡½æ•°åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™é‡å¤åˆ›å»ºçš„é—®é¢˜ã€‚

## block tree

Vue2 åœ¨å¯¹æ¯”æ–°æ—§æ ‘çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“å“ªäº›èŠ‚ç‚¹æ˜¯é™æ€çš„ï¼Œå“ªäº›æ˜¯åŠ¨æ€çš„ï¼Œå› æ­¤åªèƒ½ä¸€å±‚ä¸€å±‚æ¯”è¾ƒï¼Œè¿™å°±æµªè´¹äº†å¤§éƒ¨åˆ†æ—¶é—´åœ¨æ¯”å¯¹é™æ€èŠ‚ç‚¹ä¸Šï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š

```vue
<form>
  <div>
    <label>è´¦å·ï¼š</label>
    <input v-model="user.loginId" />
  </div>
  <div>
    <label>å¯†ç ï¼š</label>
    <input v-model="user.loginPwd" />
  </div>
</form>
```

![20200929172002](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-27-041058.png)

æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼ŒVue2 éœ€è¦éå†æ•´ä¸ªè™šæ‹Ÿ DOM æ ‘æ¥å¯»æ‰¾å·®å¼‚ã€‚è¿™ç§æ–¹æ³•è™½ç„¶é€šç”¨ï¼Œä½†åœ¨å¤§å‹ç»„ä»¶æˆ–å¤æ‚é¡µé¢ä¸­ï¼Œæ€§èƒ½æŸè€—ä¼šæ¯”è¾ƒæ˜æ˜¾ï¼Œå› ä¸ºå®ƒæµªè´¹äº†å¤§é‡æ—¶é—´åœ¨é™æ€èŠ‚ç‚¹çš„æ¯”è¾ƒä¸Šã€‚

æ€è€ƒğŸ¤”ï¼šå‰é¢ä¸æ˜¯è¯´é™æ€èŠ‚ç‚¹ä¼šæå‡ä¹ˆï¼Ÿ

ç­”æ¡ˆï¼šé™æ€æå‡è§£å†³çš„æ˜¯ä¸å†é‡å¤ç”Ÿæˆé™æ€èŠ‚ç‚¹æ‰€å¯¹åº”çš„è™šæ‹ŸDOMèŠ‚ç‚¹ã€‚ç°åœ¨è¦è§£å†³çš„é—®é¢˜æ˜¯è™šæ‹ŸDOMæ ‘ä¸­é™æ€èŠ‚ç‚¹æ¯”è¾ƒèƒ½å¦è·³è¿‡çš„é—®é¢˜ã€‚



**ä»€ä¹ˆæ˜¯Block**

ä¸€ä¸ª Block æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªè™šæ‹Ÿ DOM èŠ‚ç‚¹ï¼Œä¸è¿‡è¯¥**è™šæ‹Ÿ DOM èŠ‚ç‚¹ä¸Šé¢ä¼šå¤šå‡ºæ¥ä¸€ä¸ª dynamicChildren å±æ€§**ï¼Œè¯¥å±æ€§å¯¹åº”çš„å€¼ä¸ºæ•°ç»„ï¼Œ**æ•°ç»„é‡Œé¢å­˜å‚¨çš„æ˜¯åŠ¨æ€å­èŠ‚ç‚¹**ã€‚ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼Œform å¯¹åº”çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹å°±ä¼šå­˜åœ¨ dynamicChildren å±æ€§ï¼š

![20200929172555](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-27-041226.png)

æœ‰äº† block ä¹‹åï¼Œå°±ä¸éœ€è¦å†åƒ Vue2 é‚£æ ·ä¸€å±‚ä¸€å±‚ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”äº†ï¼Œå¯¹æ¯”çš„ç²’åº¦å˜æˆäº†ç›´æ¥æ‰¾ dynamicChildren æ•°ç»„ï¼Œç„¶åå¯¹æ¯”è¯¥æ•°ç»„é‡Œé¢çš„åŠ¨æ€èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¾ˆå¥½çš„å®ç°äº†è·³è¿‡é™æ€èŠ‚ç‚¹æ¯”è¾ƒã€‚



**å“ªäº›èŠ‚ç‚¹ä¼šæˆä¸º block èŠ‚ç‚¹ï¼Ÿ**

1. æ¨¡æ¿ä¸­çš„æ ¹èŠ‚ç‚¹éƒ½ä¼šæ˜¯ä¸€ä¸ª block èŠ‚ç‚¹ã€‚

   ```vue
   <template>
   	<!-- è¿™æ˜¯ä¸€ä¸ªblockèŠ‚ç‚¹ -->
   	<div>
       <p>{{ bar }}</p>
     </div>
   	<!-- è¿™æ˜¯ä¸€ä¸ªblockèŠ‚ç‚¹ -->
   	<h1>
       <span :id="test"></span>
     </h1>
   </template>
   ```

2. ä»»ä½•å¸¦æœ‰ v-ifã€v-else-ifã€v-elseã€v-for æŒ‡ä»¤çš„èŠ‚ç‚¹ï¼Œä¹Ÿéœ€è¦ä½œä¸º block èŠ‚ç‚¹ã€‚

   ç­”æ¡ˆï¼šå› ä¸ºè¿™äº›æŒ‡ä»¤ä¼šè®©è™šæ‹ŸDOMæ ‘çš„ç»“æ„ä¸ç¨³å®šã€‚

   ```vue
   <div>
     <section v-if="foo">
     	<p>{{ a }}</p>
     </section>
     <div v-else>
       <p>{{ a }}</p>
     </div>
   </div>
   ```

   æŒ‰ç…§ä¹‹å‰çš„è®¾è®¡ï¼Œdivæ˜¯ä¸€ä¸ª block èŠ‚ç‚¹ï¼Œæ”¶é›†åˆ°çš„åŠ¨æ€èŠ‚ç‚¹åªæœ‰ p. è¿™æ„å‘³ç€æ— è®º foo æ˜¯ true è¿˜æ˜¯ falseï¼Œæœ€ç»ˆæ›´æ–°åªä¼šå»çœ‹ p æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œäº§ç”Ÿ bug.

   è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œè®©å¸¦æœ‰è¿™äº›æŒ‡ä»¤çš„èŠ‚ç‚¹æˆä¸ºä¸€ä¸ª block èŠ‚ç‚¹å³å¯

   ```
   block(div)
   	- block(section)
   	- block(div)
   ```

   æ­¤æ—¶è¿™ç§è®¾è®¡ï¼Œçˆ¶çº§blocké™¤äº†æ”¶é›†åŠ¨æ€å­èŠ‚ç‚¹ä»¥å¤–ï¼Œè¿˜ä¼šæ”¶é›†å­blockèŠ‚ç‚¹ã€‚

   å¤šä¸ª block èŠ‚ç‚¹è‡ªç„¶å°±å½¢æˆäº†æ ‘çš„ç»“æ„ï¼Œè¿™å°±æ˜¯ block tree.

## è¡¥ä¸æ ‡è®°

è¡¥ä¸æ ‡è®° PatchFlagsï¼Œè¿™æ˜¯ Vue åœ¨åšèŠ‚ç‚¹å¯¹æ¯”æ—¶çš„è¿‘ä¸€æ­¥ä¼˜åŒ–ã€‚

å³ä¾¿æ˜¯åŠ¨æ€çš„èŠ‚ç‚¹ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šæ˜¯èŠ‚ç‚¹æ‰€æœ‰ä¿¡æ¯ï¼ˆç±»å‹ã€å±æ€§ã€æ–‡æœ¬å†…å®¹ï¼‰éƒ½å‘ç”Ÿäº†æ›´æ”¹ï¼Œè€Œä»…ä»…åªæ˜¯ä¸€éƒ¨åˆ†ä¿¡æ¯å‘ç”Ÿæ›´æ”¹ã€‚

ä¹‹å‰åœ¨ Vue2 æ—¶æœŸå¯¹æ¯”æ¯ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¹¶ä¸çŸ¥é“è¿™ä¸ªèŠ‚ç‚¹å“ªäº›ç›¸å…³ä¿¡æ¯ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤åªèƒ½å°†æ‰€æœ‰ä¿¡æ¯ä¾æ¬¡æ¯”å¯¹ï¼Œä¾‹å¦‚ï¼š

```vue
<div :class="user" data-id="1" title="user name">
  {{user.name}}
</div>
```

åœ¨ Vue2 ä¸­ï¼š

- å…¨é¢å¯¹æ¯”ï¼šä¼šé€ä¸ªå»æ£€æŸ¥èŠ‚ç‚¹çš„æ¯ä¸ªå±æ€§ï¼ˆclassã€data-idã€titleï¼‰ä»¥åŠå­èŠ‚ç‚¹çš„å†…å®¹
- æ€§èƒ½ç“¶é¢ˆï¼šè¿™ç§æ–¹å¼è‡ªç„¶å°±å­˜åœ¨ä¸€å®šçš„æ€§èƒ½ä¼˜åŒ–ç©ºé—´

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2024-08-27-062917.png" alt="20200929172805" style="zoom:60%;" />

åœ¨ Vue3 ä¸­ï¼ŒPatchFlag é€šè¿‡ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆæ ‡è®°ï¼Œæ˜¾è‘—ä¼˜åŒ–äº†å¯¹æ¯”è¿‡ç¨‹ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ¨¡æ¿æ—¶ï¼Œèƒ½å¤Ÿè¯†åˆ«å“ªäº›å±æ€§æˆ–å†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œå¹¶ä¸ºè¿™äº›åŠ¨æ€éƒ¨åˆ†ç”Ÿæˆç‰¹å®šçš„æ ‡è®°ã€‚

Vue3 çš„ PatchFlag åŒ…æ‹¬å¤šç§ç±»å‹ï¼Œæ¯ç§ç±»å‹æ ‡è®°ä¸åŒçš„æ›´æ–°éœ€æ±‚ï¼š

- TEXTï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚
- CLASSï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„ class å±æ€§æ˜¯åŠ¨æ€çš„ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚
- STYLEï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„ style å±æ€§æ˜¯åŠ¨æ€çš„ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚
- PROPSï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§æ˜¯åŠ¨æ€çš„ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚
- FULL_PROPSï¼šè¡¨ç¤ºèŠ‚ç‚¹æœ‰å¤šä¸ªåŠ¨æ€å±æ€§ï¼Œä¸”è¿™äº›å±æ€§ä¸æ˜¯ç®€å•çš„é™æ€å€¼ã€‚
- HYDRATE_EVENTSï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„äº‹ä»¶ç›‘å¬å™¨æ˜¯åŠ¨æ€çš„ï¼Œéœ€è¦åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ°´åˆå¤„ç†ã€‚
- STABLE_FRAGMENTï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„å­èŠ‚ç‚¹é¡ºåºç¨³å®šï¼Œå…è®¸æŒ‰é¡ºåºè¿›è¡Œæ›´æ–°ã€‚
- KEYED_FRAGMENTï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¸¦æœ‰ keyï¼Œå¯ä»¥é€šè¿‡ key è¿›è¡Œé«˜æ•ˆçš„æ›´æ–°ã€‚
- UNKEYED_FRAGMENTï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ—  keyï¼Œä½†å¯ä»¥é€šè¿‡ç®€å•çš„æ¯”è¾ƒè¿›è¡Œæ›´æ–°ã€‚

ä¾‹å¦‚ä¸Šé¢çš„ä»£ç ï¼Œç¼–è¯‘å‡ºæ¥çš„å‡½æ•°ï¼š

```js
function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
  return (_openBlock(), _createElementBlock("div", {
    class: _normalizeClass($setup.user),
    "data-id": "1",
    title: "user name"
  }, _toDisplayString($setup.user.name), 3 /* TEXT, CLASS */))
}
```

é€šè¿‡è¿™äº›æ ‡è®°ï¼ŒVue3 åœ¨æ›´æ–°æ—¶ä¸å†éœ€è¦å¯¹æ¯ä¸ªå±æ€§éƒ½è¿›è¡Œå…¨é¢çš„å¯¹æ¯”ï¼Œè€Œæ˜¯åªæ£€æŸ¥å’Œæ›´æ–°é‚£äº›è¢«æ ‡è®°ä¸ºåŠ¨æ€çš„éƒ¨åˆ†ï¼Œä»è€Œæ˜¾è‘—å‡å°‘äº†ä¸å¿…è¦çš„è®¡ç®—å¼€é”€ã€‚



>é¢è¯•é¢˜ï¼šè¯´ä¸€ä¸‹ Vue3 åœ¨è¿›è¡Œæ¨¡æ¿ç¼–è¯‘æ—¶åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>Vue3 çš„ç¼–è¯‘å™¨åœ¨è¿›è¡Œæ¨¡æ¿ç¼–è¯‘çš„æ—¶å€™ï¼Œä¸»è¦åšäº†è¿™ä¹ˆä¸€äº›ä¼˜åŒ–ï¼š
>
>1. é™æ€æå‡ï¼šè§£å†³çš„æ˜¯é™æ€å†…å®¹ä¸è¦é‡å¤ç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹çš„é—®é¢˜
>2. é¢„å­—ç¬¦ä¸²åŒ–ï¼šè§£å†³çš„æ˜¯å¤§é‡çš„é™æ€å†…å®¹ï¼Œå¹²è„†è™šæ‹Ÿ DOM èŠ‚ç‚¹éƒ½ä¸è¦äº†ï¼Œç›´æ¥ç”Ÿæˆå­—ç¬¦ä¸²ï¼Œè™šæ‹Ÿ DOM èŠ‚ç‚¹å°‘äº†ï¼Œdiff çš„æ—¶é—´èŠ±è´¹ä¹Ÿå°±æ›´å°‘ã€‚
>3. ç¼“å­˜å†…è”äº‹ä»¶å¤„ç†å‡½æ•°ï¼šæ¯æ¬¡è¿è¡Œæ¸²æŸ“å‡½æ•°æ—¶ï¼Œå†…è”çš„äº‹ä»¶å¤„ç†å‡½æ•°æ²¡æœ‰å¿…è¦é‡æ–°ç”Ÿæˆï¼Œè¿™æ ·ä¼šäº§ç”Ÿä¸å¿…è¦çš„å†…å­˜å¼€é”€å’Œæ€§èƒ½æŸè€—ã€‚æ‰€ä»¥å¯ä»¥å°†å†…è”äº‹ä»¶å¤„ç†å‡½æ•°ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œæ¸²æŸ“å‡½æ•°çš„æ—¶å€™ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚
>4. Block Treeï¼šè§£å†³çš„æ˜¯è·³è¿‡é™æ€èŠ‚ç‚¹æ¯”è¾ƒçš„é—®é¢˜ã€‚
>5. è¡¥ä¸æ ‡è®°ï¼šèƒ½å¤Ÿåšåˆ°å³ä¾¿åŠ¨æ€èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œä¹Ÿåªæ¯”è¾ƒæœ‰å˜åŒ–çš„éƒ¨åˆ†çš„æ•ˆæœã€‚

---

-EOF-

# ç»„ä»¶nameä½œç”¨

>é¢è¯•é¢˜ï¼šç»„ä»¶ name æœ‰ä»€ä¹ˆç”¨ï¼Ÿå¯ä¸å¯ä»¥ä¸å†™ nameï¼Ÿ

**å¦‚ä½•å®šä¹‰ç»„ä»¶name**

- Vue2 OptionsAPIï¼šæ·»åŠ  name é…ç½®é¡¹å³å¯

  ```js
  export default {
    name: 'xxxx', // ç»„ä»¶çš„name
  }
  ```

- Vue3 CompositionAPI

  - å¤šä¹¦å†™ä¸€ä¸ªscriptæ ‡ç­¾ï¼Œä»ç„¶å¯¼å‡ºå¯¹è±¡ï¼Œåœ¨å¯¹è±¡ä¸­é…ç½®name

    ```vue
    <script setup>
    // ...
    </script>
    <script>
    export default {
      name: 'xxx'
    }
    </script>
    ```

  - é€šè¿‡ä¸€ä¸ª defineOptions çš„å®æ¥é…ç½®name

    ```vue
    <script setup>
    defineOptions({
      name: 'xxx'
    })
    </script>
    ```


**ç»„ä»¶nameçš„ä½œç”¨**

1. é€šè¿‡åå­—æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶
   - é€’å½’ç»„ä»¶
   - è·¨çº§ç»„ä»¶é€šä¿¡
2. é€šè¿‡ name å±æ€§æŒ‡å®šè¦ç¼“å­˜çš„ç»„ä»¶
3. ä½¿ç”¨ vue-devtools è¿›è¡Œè°ƒè¯•æ—¶ï¼Œç»„ä»¶åç§°ä¹Ÿæ˜¯ç”± name å†³å®šçš„

>é¢è¯•é¢˜ï¼šç»„ä»¶ name æœ‰ä»€ä¹ˆç”¨ï¼Ÿå¯ä¸å¯ä»¥ä¸å†™ nameï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>åœ¨ Vue ä¸­ï¼Œç»„ä»¶çš„ name é€‰é¡¹æœ‰å¤šä¸ªä½œç”¨ï¼Œè™½ç„¶å®ƒä¸æ˜¯å¿…é¡»çš„ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹å®ƒéå¸¸æœ‰ç”¨ã€‚
>
>1. é€šè¿‡åå­—æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶
>
>   - é€’å½’ç»„ä»¶
>   - è·¨çº§ç»„ä»¶é€šä¿¡
>2. é€šè¿‡ name å±æ€§æŒ‡å®šè¦ç¼“å­˜çš„ç»„ä»¶
>3. ä½¿ç”¨ vue-devtools è¿›è¡Œè°ƒè¯•æ—¶ï¼Œç»„ä»¶åç§°ä¹Ÿæ˜¯ç”± name å†³å®šçš„
>
>å³ä½¿åœ¨æ²¡æœ‰ä¸Šè¿°ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ  name ä¹Ÿæœ‰åŠ©äºæé«˜ä»£ç çš„å¯è¯»æ€§ï¼Œå°¤å…¶æ˜¯åœ¨è°ƒè¯•å’Œåˆ†ææ€§èƒ½æ—¶ã€‚ä¸ºç»„ä»¶å‘½åå¯ä»¥ä½¿å¼€å‘è€…æ›´æ¸…æ¥šåœ°äº†è§£æ¯ä¸ªç»„ä»¶çš„ç”¨é€”å’Œè§’è‰²ã€‚

---

-EOF-

# Vueé¡¹ç›®æ€§èƒ½ä¼˜åŒ–

>é¢è¯•é¢˜1ï¼šä½ å¹³æ—¶å¼€å‘ Vue é¡¹ç›®æ—¶ï¼Œåšäº†å“ªäº›æ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Ÿ

1. ä»£ç å±‚é¢ä¼˜åŒ–
2. åœºæ™¯ä¼˜åŒ–
3. é™æ€èµ„æºä¼˜åŒ–
4. æ‰“åŒ…ä¼˜åŒ–
5. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**ä»£ç å±‚é¢ä¼˜åŒ–**

1. ç»„ä»¶æ‹†åˆ†
2. å‡å°‘ä¸å¿…è¦çš„å“åº”å¼æ•°æ®
3. æ­£ç¡®ä½¿ç”¨ v-if å’Œ v-show
4. æ ¹æ®åœºæ™¯å¯ä»¥é€‰æ‹©ä½¿ç”¨ v-once
5. ä½¿ç”¨ key ä¼˜åŒ–åˆ—è¡¨æ¸²æŸ“
6. äº‹ä»¶é˜²æŠ–å’ŒèŠ‚æµ
7. ä½¿ç”¨ KeepAlive ç¼“å­˜ç»„ä»¶
8. åˆç†ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­æ–¹æ³•
9. ä½¿ç”¨å¼‚æ­¥ç»„ä»¶
10. è·¯ç”±æ‡’åŠ è½½

**åœºæ™¯ä¼˜åŒ–**

1. æ‡’åŠ è½½
2. è™šæ‹Ÿæ»šåŠ¨
3. .....

**é™æ€èµ„æºä¼˜åŒ–**

1. å›¾ç‰‡ä¼˜åŒ–
   - å‹ç¼©å›¾ç‰‡
   - ä½¿ç”¨ç°ä»£å›¾ç‰‡æ ¼å¼ï¼šWebPã€AVIF
2. ä½¿ç”¨SVGå›¾æ ‡
   1. ç²¾çµå›¾
   2. å­—ä½“å›¾æ ‡
   3. SVGå›¾æ ‡
3. å‹ç¼© CSS å’Œ JS æ–‡ä»¶
   - Terserã€UglifyJSã€cssnano
4. åˆå¹¶æ–‡ä»¶
5. ä½¿ç”¨CDNåŠ é€Ÿ

**æ‰“åŒ…ä¼˜åŒ–**

1. tree sharking
2. å¤šçº¿ç¨‹æ‰“åŒ…
   - webpack æ’ä»¶ï¼šthread-loader
3. ä»£ç åˆ†å—ï¼šä¸»è¦æ˜¯ä¸ºäº†å®ç°æŒ‰éœ€åŠ è½½
4. ç”Ÿæˆsourcemapæ–‡ä»¶
5. ä¼˜åŒ–ç¬¬ä¸‰æ–¹åº“çš„æ‰“åŒ…ï¼šæŒ‰éœ€æ‰“åŒ…
6. ä½¿ç”¨ç°ä»£æ„å»ºå·¥å…·

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

è®°ä½ï¼Œä¸€åˆ‡çš„ä¼˜åŒ–ï¼Œæœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†ç»™ç”¨æˆ·æä¾›æ›´å¥½çš„ä½¿ç”¨ä½“éªŒã€‚

1. åŠ è½½åŠ¨ç”»
2. éª¨æ¶å±
3. è¿‡æ¸¡åŠ¨ç”»
4. æœåŠ¡ç«¯æ¸²æŸ“



>é¢è¯•é¢˜1ï¼šä½ å¹³æ—¶å¼€å‘ Vue é¡¹ç›®æ—¶ï¼Œåšäº†å“ªäº›æ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>è¿™å–å†³äºæˆ‘å½“å‰å¤„äºå“ªä¸€ä¸ªé˜¶æ®µï¼Œä¸åŒé˜¶æ®µæ‰€åšçš„äº‹æƒ…ä¸å¤ªä¸€æ ·ã€‚å‡è®¾å½“å‰å¤„äºç¼–ç é˜¶æ®µï¼Œé‚£ä¹ˆæœ‰è¿™ä¹ˆä¸€äº›ä¼˜åŒ–çš„åœ°æ–¹ï¼š
>
>- ç»„ä»¶æ‹†åˆ†
>- v-if å’Œ v-show çš„æ­£ç¡®ä½¿ç”¨
>- ä½¿ç”¨ v-once æŒ‡ä»¤
>- ä½¿ç”¨ key ä¼˜åŒ–åˆ—è¡¨æ¸²æŸ“
>- ç¼“å­˜ç»„ä»¶
>- ä½¿ç”¨å¼‚æ­¥ç»„ä»¶
>- è·¯ç”±æ‡’åŠ è½½
>- ....
>
>å¦å¤–çœ‹æˆ‘å…·ä½“å¼€å‘çš„é¡¹ç›®æ˜¯ä»€ä¹ˆï¼Œå¦‚æœé‡åˆ°æœ‰é•¿åˆ—è¡¨çš„åœºæ™¯ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨æ¥æå‡é•¿åˆ—è¡¨æ€§èƒ½ã€‚é™æ€èµ„æºå¾€å¾€å æ®äº†è¾ƒå¤§çš„å¸¦å®½å’ŒåŠ è½½æ—¶é—´ã€‚å› æ­¤ï¼Œå¯¹é™æ€èµ„æºè¿›è¡Œä¼˜åŒ–æ˜¯æé«˜é¡µé¢æ€§èƒ½çš„ä¸€ä¸ªé‡è¦æ–¹é¢ï¼Œä¾‹å¦‚å¯ä»¥åšï¼š
>
>- å›¾ç‰‡çš„å‹ç¼©
>- å›¾æ ‡é‡‡ç”¨ SVG å›¾æ ‡
>- ä¸€äº›æ¯”è¾ƒå¤§çš„ç¬¬ä¸‰æ–¹åº“é€‰æ‹©ä¸æ‰“åŒ…åˆ°æœ€åçš„é¡¹ç›®é‡Œé¢ï¼Œè€Œæ˜¯é‡‡ç”¨ CDN çš„æ–¹å¼åŠ è½½
>
>åˆšæ‰è¯´åˆ°é¡¹ç›®æ‰“åŒ…ï¼Œæ‰“åŒ…æ—¶ä¹Ÿæœ‰å…·ä½“çš„ä¼˜åŒ–æªæ–½ï¼Œä¾‹å¦‚ï¼š
>
>- Tree Sharking
>- å¤šçº¿ç¨‹æ‰“åŒ…
>- ä»£ç åˆ†å—
>- ....
>
>æœ€åæˆ‘æƒ³è¯´ä¸€ä¸‹ï¼Œå…¶å®æ‰€åšçš„ä¸€åˆ‡çš„ä¸€åˆ‡æ€§èƒ½ä¼˜åŒ–ï¼Œæœ€ç»ˆç›®çš„å…¶å®åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ç»™ç”¨æˆ·æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥åœ¨ç”¨æˆ·ä½“éªŒä¸Šé¢æˆ‘ä¹Ÿä¼šé¢å¤–çš„ç”¨å¿ƒï¼Œé‡‡å–ä¸€äº›ä¼˜åŒ–æªæ–½æå‡ç”¨æˆ·çš„ä½¿ç”¨è§‚æ„Ÿï¼Œä¾‹å¦‚ï¼š
>
>- éª¨æ¶å±
>- è¿‡æ¸¡åŠ¨ç”»
>- ....





> é¢è¯•é¢˜2ï¼šåœ¨ä¼˜åŒ–å‰ç«¯æ€§èƒ½æ–¹é¢ï¼Œä½ é€šå¸¸ä¼šé‡‡å–å“ªäº›æªæ–½ï¼Ÿ

1. å‘ç°é—®é¢˜ï¼šéœ€è¦å…·ä½“çš„æ•°æ®æ¥åšæ”¯æ’‘ï¼Œç¡®å®šé—®é¢˜ç¡®å®å­˜åœ¨ã€‚
2. ç¡®å®šé—®é¢˜ï¼šç¡®å®šæ˜¯å“ªä¸€ä¸ªæ–¹é¢çš„é—®é¢˜ï¼Ÿå‰ç«¯ï¼Ÿç½‘è·¯ï¼ŸæœåŠ¡ç«¯é—®é¢˜ï¼Ÿæ•°æ®åº“ï¼Ÿ
3. è§£å†³é—®é¢˜ï¼šç¡®å®šäº†æ˜¯å‰ç«¯çš„é—®é¢˜ä¹‹åï¼Œå†æ ¹æ®å…·ä½“çš„é—®é¢˜ç»™å‡ºå…·ä½“çš„è§£å†³æ–¹æ¡ˆ

>é¢è¯•é¢˜2ï¼šåœ¨ä¼˜åŒ–å‰ç«¯æ€§èƒ½æ–¹é¢ï¼Œä½ é€šå¸¸ä¼šé‡‡å–å“ªäº›æªæ–½ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>é¦–å…ˆæˆ‘ä¸ä¼šç€æ€¥å°±å»åšç›¸å…³çš„æ€§èƒ½ä¼˜åŒ–ï¼Œç¬¬ä¸€æ­¥æˆ‘ä¼šåšçš„æ˜¯ç¡®è®¤é—®é¢˜æ˜¯å¦å­˜åœ¨ï¼Œå› ä¸ºæ¯ä¸ªäººçš„æ„Ÿå®˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€ä¸ªäººæ‹¿ç€ 3G ç½‘ç»œçš„æ‰‹æœºä½¿ç”¨æˆ‘çš„åº”ç”¨ï¼Œå›å¤´ç»™æˆ‘åé¦ˆåº”ç”¨æ‰“å¼€é€Ÿåº¦æ…¢ï¼Œé‚£è¿™ç»å¯¹ä¸æ˜¯æˆ‘ä»¬è¿™è¾¹çš„é—®é¢˜ã€‚å› æ­¤ç¬¬ä¸€æ­¥å°±æ˜¯ç”¨ä¸€äº›æœ‰æ•ˆçš„å·¥å…·å’Œæ•°æ®æ¥ç¡®è®¤æ˜¯å¦çœŸçš„å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚
>
>- æ€§èƒ½ç›‘æ§å·¥å…·ï¼šä½¿ç”¨ Lighthouseã€Chrome DevToolsã€WebPageTest ç­‰å·¥å…·æ¥è¯„ä¼°é¡µé¢æ€§èƒ½ï¼Œè·å–é¡µé¢çš„åŠ è½½æ—¶é—´ã€èµ„æºè¯·æ±‚æ—¶é—´ã€æ¸²æŸ“é€Ÿåº¦ç­‰å…·ä½“æ•°æ®ã€‚
>- ç”¨æˆ·æ•°æ®åŸ‹ç‚¹ï¼šé€šè¿‡åŸ‹ç‚¹ç›‘æ§ç”¨æˆ·çš„å®é™…ä½¿ç”¨æƒ…å†µï¼Œå¦‚é¡µé¢åŠ è½½æ—¶é—´ã€äº¤äº’å“åº”æ—¶é—´ã€é•¿ä»»åŠ¡ï¼ˆLong Tasksï¼‰ç­‰ã€‚åˆ†æè¿™äº›æ•°æ®ï¼Œç¡®å®šç”¨æˆ·ä½“éªŒçš„ç“¶é¢ˆã€‚
>
>é‚£ç¡®å®šç¡®å®å­˜åœ¨æ€§èƒ½é—®é¢˜çš„æ—¶å€™ï¼Œæ¥ä¸‹æ¥ä¸‹ä¸€æ­¥æ˜¯ç¡®å®šé—®é¢˜æ¥æºï¼Œå› ä¸ºä¸€ä¸ª Web åº”ç”¨æ˜¯ç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆçš„ï¼Œè‡ªç„¶æ€§èƒ½é—®é¢˜ä¹Ÿå¯èƒ½æ¥è‡ªäºå¤šä¸ªæ–¹é¢ï¼š
>
>- å‰ç«¯é—®é¢˜ï¼šå¯èƒ½æ˜¯ç”±äºå¤§æ–‡ä»¶åŠ è½½ã€DOM æ“ä½œé¢‘ç¹ã€åŠ¨ç”»æ€§èƒ½å·®ç­‰é€ æˆçš„ã€‚
>- ç½‘ç»œé—®é¢˜ï¼šå¯èƒ½æ˜¯ç”±äºæœåŠ¡å™¨å“åº”æ…¢ã€å¸¦å®½ä¸è¶³ã€DNS æŸ¥è¯¢è€—æ—¶ã€ç½‘ç»œå»¶è¿Ÿé«˜ç­‰ã€‚
>- æœåŠ¡å™¨ç«¯é—®é¢˜ï¼šæœåŠ¡å™¨æ€§èƒ½ç“¶é¢ˆã€æ•°æ®åº“æŸ¥è¯¢ç¼“æ…¢ã€ç¼“å­˜å¤±æ•ˆç­‰é—®é¢˜ã€‚
>- æ•°æ®åº“é—®é¢˜ï¼šæ•°æ®åº“ç´¢å¼•ä¸å½“ã€æŸ¥è¯¢æ€§èƒ½å·®ã€æ•°æ®ä¼ è¾“é‡å¤§ç­‰ã€‚
>
>å‰ç«¯è¿™ä¸€å—å„¿çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æµè§ˆå™¨çš„ Performance é¢æ¿ã€ç½‘ç»œè¯·æ±‚åˆ†æå·¥å…·ï¼Œä»¥åŠæœåŠ¡å™¨ç«¯çš„æ—¥å¿—å’Œç›‘æ§å·¥å…·ï¼Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆçš„å…·ä½“ä½ç½®ã€‚ä¹‹åç¡®å®šäº†æ˜¯å‰ç«¯å­˜åœ¨çš„æ€§èƒ½é—®é¢˜åï¼Œå†è¿›è¡Œé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚è¿™ä¸€æ­¥åº”è¯¥æ ¹æ®å…·ä½“çš„ç“¶é¢ˆé‡‡å–ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ï¼š
>
>- ç½‘ç»œè¯·æ±‚è¿‡å¤šï¼šå‡å°‘ HTTP è¯·æ±‚ï¼Œåˆå¹¶ CSS å’Œ JS æ–‡ä»¶ï¼Œä½¿ç”¨ CSS ç²¾çµå›¾æˆ– SVG å›¾æ ‡ï¼Œæˆ–è€…ä½¿ç”¨ HTTP/2 å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚
>- é™æ€èµ„æºå¤ªå¤§ï¼šåšèµ„æºå‹ç¼©å’Œä¼˜åŒ–ï¼Œå‹ç¼© JSã€CSSã€å›¾ç‰‡ç­‰èµ„æºï¼Œä½¿ç”¨ WebP ç­‰é«˜æ•ˆå›¾ç‰‡æ ¼å¼ã€‚
>- åˆå§‹åŠ è½½èµ„æºè¿‡å¤šï¼šæŒ‰éœ€åŠ è½½ JS å’Œ CSSï¼Œä½¿ç”¨åŠ¨æ€ import åˆ†å‰²ä»£ç ï¼Œä½¿ç”¨å¼‚æ­¥ç»„ä»¶ä»¥åŠè·¯ç”±æ‡’åŠ è½½
>- æ¸²æŸ“æ€§èƒ½ç“¶é¢ˆï¼šå‡å°‘é‡æ’é‡ç»˜æ¬¡æ•°ã€‚
>- ....
>
>è¿™å°±æ˜¯æˆ‘å¹³æ—¶åœ¨è§£å†³æ€§èƒ½é—®é¢˜æ—¶çš„ä¸€ä¸ªæ€è€ƒè·¯å¾„ã€‚

---

-EOF-

# è·¯ç”±ä¼ å‚æ–¹å¼

>é¢è¯•é¢˜ï¼šVue é¡¹ç›®ä¸­å‰ç«¯è·¯ç”±ä¼ å‚æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

1. è·¯å¾„å‚æ•°
2. æŸ¥è¯¢å‚æ•°
3. è·¯ç”±çŠ¶æ€å‚æ•°
4. è·¯ç”±propså‚æ•°



**1. è·¯å¾„å‚æ•°**

é€šè¿‡ params è·å–è·¯å¾„å‚æ•°

```js
const routes = [
  { 
    path: '/users/:userId(\\d+)',
    component: User
  },
]
```

```js
// vue2
this.$route.params.userId;
// vue3
const route = useRoute()
const id = route.params.id
```



**2. æŸ¥è¯¢å‚æ•°**

é€šè¿‡ URL ä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸²ä¼ é€’çš„å‚æ•°ï¼Œä»¥ ?key=value çš„å½¢å¼è¿›è¡Œä¼ é€’ã€‚

ç‰¹ç‚¹ï¼šå¯ä»¥ä¼ é€’å¤šç»„å‚æ•°

```js
// ä½¿ç”¨ this.$router.push ä¼ é€’æŸ¥è¯¢å‚æ•°
this.$router.push({ path: '/user', query: { id: '123' } });

// è·å–å‚æ•°
this.$route.query.id;
```



**3. è·¯ç”±çŠ¶æ€å‚æ•°**

è·¯ç”±çŠ¶æ€å‚æ•°ï¼ˆRoute State Parametersï¼‰æ˜¯ä¸€ç§é€šè¿‡ router.push æˆ– router.replace æ–¹æ³•ä¼ é€’çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°**ä¸ä¼šåœ¨ URL ä¸­æ˜¾ç¤º**ï¼Œè€Œæ˜¯åœ¨åº”ç”¨ç¨‹åºçš„**å†…å­˜ä¸­è¿›è¡Œä¼ é€’**ï¼Œæ­¤æ–¹å¼é€‚åˆä¼ é€’ä¸€äº›ä¸å¸Œæœ›åœ¨ URL ä¸­å…¬å¼€æ˜¾ç¤ºçš„ä¸´æ—¶æ•°æ®æˆ–æ•æ„Ÿä¿¡æ¯ã€‚

```js
// ä¼ é€’çŠ¶æ€å‚æ•°
this.$router.push({ path: '/user', state: { id: '123' } });

// è·å–å‚æ•°
history.state.id;
```



**4. è·¯ç”±propså‚æ•°**

åœ¨è·¯ç”±é…ç½®ä¸­è®¾ç½® props: true æˆ–ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œå°†è·¯ç”±çš„ params æˆ– query ç›´æ¥ä½œä¸ºç»„ä»¶çš„ props ä¼ é€’ç»™å­ç»„ä»¶ã€‚

```js
const routes = [{
  path: '/user/:id',
  component: User,
  props: true
}]
```

```vue
<script setup>
defineProps({
  id: {
    // ....
  }
})
</script>
```

Vue3è¯¾ç¨‹ã€Šç»†èŠ‚è¡¥å…… - è·¯ç”±ç»„ä»¶ä¼ å‚ã€‹



>é¢è¯•é¢˜ï¼šVue é¡¹ç›®ä¸­å‰ç«¯è·¯ç”±ä¼ å‚æ–¹å¼æœ‰å“ªäº›ï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>Vue é¡¹ç›®ä¸­å‰ç«¯è·¯ç”±ä¼ å‚çš„æ–¹å¼ä¸»è¦æœ‰è¿™ä¹ˆå‡ ç§ï¼š
>
>1. è·¯å¾„å‚æ•°ï¼š è¿™ç§æ–¹å¼ç›´è§‚ï¼Œè·¯å¾„ç›´æ¥åæ˜ å‚æ•°çš„ç»“æ„ã€‚é€‚åˆç”¨äºéœ€è¦åœ¨è·¯å¾„ä¸­æ˜ç¡®è¡¨ç¤ºçš„å‚æ•°ï¼Œå¦‚èµ„æº IDã€‚
>2. æŸ¥è¯¢å‚æ•°ï¼šè¯¥æ–¹å¼å¯é€‰å‚æ•°ä½¿ç”¨æ–¹ä¾¿ï¼Œé€‚åˆç”¨äºä¸ç¡®å®šçš„å‚æ•°ä¸ªæ•°ï¼Œæˆ–è€…éœ€è¦åœ¨ç»„ä»¶é—´ä¼ é€’è¾ƒå¤šçš„å‚æ•°ã€‚
>3. è·¯ç”±çŠ¶æ€å‚æ•°ï¼šå‚æ•°ä¸ä¼šå‡ºç°åœ¨ URL ä¸­ï¼Œå®‰å…¨æ€§æ›´é«˜ï¼Œé€‚åˆç”¨äºæ•æ„Ÿä¿¡æ¯çš„ä¼ é€’ã€‚
>4. è·¯ç”±propså‚æ•°ï¼šå‚æ•°ç›´æ¥ä»¥ props å½¢å¼ä¼ å…¥ï¼Œè¿™æ ·èƒ½åˆ é™¤ç»„ä»¶å¯¹ $route çš„ç›´æ¥ä¾èµ–ï¼Œè¾¾åˆ°ä¸ $route è§£è€¦çš„æ•ˆæœã€‚

---

-EOF-


## *Vue2* é¢è¯•é¢˜ç›¸å…³

### 1. **è°ˆä¸€è°ˆå¯¹ *MVVM* çš„ç†è§£ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> -  *MVVM* æ˜¯ *Model-View-ViewModel* çš„ç¼©å†™ã€‚*MVVM* æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚
>    - *Model* å±‚ä»£è¡¨æ•°æ®æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥åœ¨ *Model* ä¸­å®šä¹‰æ•°æ®ä¿®æ”¹å’Œæ“ä½œçš„ä¸šåŠ¡é€»è¾‘; 
>    - *View* ä»£è¡¨ *UI* ç»„ä»¶ï¼Œå®ƒè´Ÿè´£å°†æ•°æ®æ¨¡å‹è½¬åŒ–æˆ *UI* å±•ç°å‡ºæ¥ï¼Œ*View* æ˜¯ä¸€ä¸ªåŒæ­¥ *View* å’Œ *Model* çš„å¯¹è±¡
> -  åœ¨ *MVVM* æ¶æ„ä¸‹ï¼Œ*View* å’Œ *Model* ä¹‹é—´å¹¶æ²¡æœ‰ç›´æ¥çš„è”ç³»ï¼Œè€Œæ˜¯é€šè¿‡ *ViewModel* è¿›è¡Œäº¤äº’ï¼Œ *Model* å’Œ *ViewModel* ä¹‹é—´çš„äº¤äº’æ˜¯åŒå‘çš„ï¼Œ å› æ­¤ *View* æ•°æ®çš„å˜åŒ–ä¼šåŒæ­¥åˆ° *Model* ä¸­ï¼Œè€Œ *Model* æ•°æ®çš„å˜åŒ–ä¹Ÿä¼šç«‹å³ååº”åˆ° *View* ä¸Šã€‚
> -  å¯¹ *ViewModel* é€šè¿‡åŒå‘æ•°æ®ç»‘å®šæŠŠ *View* å±‚å’Œ *Model* å±‚è¿æ¥äº†èµ·æ¥ï¼Œè€Œ *View* å’Œ *Model* ä¹‹é—´çš„ åŒæ­¥å·¥ä½œå®Œå…¨æ˜¯è‡ªåŠ¨çš„ï¼Œæ— éœ€äººä¸ºå¹²æ¶‰ï¼Œå› æ­¤å¼€å‘è€…åªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ *DOM*ï¼Œä¸éœ€è¦å…³æ³¨æ•°æ®çŠ¶æ€çš„åŒæ­¥é—®é¢˜ï¼Œå¤æ‚çš„æ•°æ®çŠ¶æ€ç»´æŠ¤å®Œå…¨ç”± *MVVM* æ¥ç»Ÿä¸€ç®¡ç†ã€‚



### 2. **è¯´ä¸€ä¸‹ *Vue* çš„ä¼˜ç‚¹**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue* æ˜¯ä¸€ä¸ªæ„å»ºæ•°æ®é©±åŠ¨çš„ *Web* ç•Œé¢çš„æ¸è¿›å¼æ¡†æ¶ã€‚
>
> *Vue* çš„ç›®æ ‡æ˜¯é€šè¿‡å°½å¯èƒ½ç®€å•çš„ *API* å®ç°å“åº”çš„æ•°æ®ç»‘å®šå’Œç»„åˆçš„è§†å›¾ç»„ä»¶ã€‚æ ¸å¿ƒæ˜¯ä¸€ä¸ªå“åº”çš„æ•°æ®ç»‘å®šç³»ç»Ÿã€‚
>
> å…³äº *Vue* çš„ä¼˜ç‚¹ï¼Œä¸»è¦æœ‰**å“åº”å¼ç¼–ç¨‹ã€ç»„ä»¶åŒ–å¼€å‘ã€è™šæ‹Ÿ *DOM***
>
> **å“åº”å¼ç¼–ç¨‹**
>
> è¿™é‡Œçš„å“åº”å¼ä¸æ˜¯ *@media* åª’ä½“æŸ¥è¯¢ä¸­çš„å“åº”å¼å¸ƒå±€ï¼Œè€Œæ˜¯æŒ‡ *Vue* ä¼šè‡ªåŠ¨å¯¹é¡µé¢ä¸­æŸäº›æ•°æ®çš„å˜åŒ–åšå‡ºå“åº”ã€‚è¿™ä¹Ÿå°±æ˜¯ *Vue* æœ€å¤§çš„ä¼˜ç‚¹ï¼Œé€šè¿‡ *MVVM* æ€æƒ³å®ç°æ•°æ®çš„åŒå‘ç»‘å®šï¼Œè®©å¼€å‘è€…ä¸ç”¨å†æ“ä½œ *DOM* å¯¹è±¡ï¼Œæœ‰æ›´å¤šçš„æ—¶é—´å»æ€è€ƒä¸šåŠ¡é€»è¾‘ã€‚
>
> **ç»„ä»¶åŒ–å¼€å‘**
>
> *Vue* é€šè¿‡ç»„ä»¶ï¼ŒæŠŠä¸€ä¸ªå•é¡µåº”ç”¨ä¸­çš„å„ç§æ¨¡å—æ‹†åˆ†åˆ°ä¸€ä¸ªä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼ˆ*component*ï¼‰ä¸­ï¼Œæˆ‘ä»¬åªè¦å…ˆåœ¨çˆ¶çº§åº”ç”¨ä¸­å†™å¥½å„ç§ç»„ä»¶æ ‡ç­¾ï¼ˆå å‘ï¼‰ï¼Œå¹¶ä¸”åœ¨ç»„ä»¶æ ‡ç­¾ä¸­å†™å¥½è¦ä¼ å…¥ç»„ä»¶çš„å‚æ•°ï¼ˆå°±åƒç»™å‡½æ•°ä¼ å…¥å‚æ•°ä¸€æ ·ï¼Œè¿™ä¸ªå‚æ•°å«åšç»„ä»¶çš„å±æ€§ï¼‰ï¼Œç„¶åå†åˆ†åˆ«å†™å¥½å„ç§ç»„ä»¶çš„å®ç°ï¼ˆå¡«å‘ï¼‰ï¼Œç„¶åæ•´ä¸ªåº”ç”¨å°±ç®—åšå®Œäº†ã€‚
>
> ç»„ä»¶åŒ–å¼€å‘çš„ä¼˜ç‚¹ï¼šæé«˜å¼€å‘æ•ˆç‡ã€æ–¹ä¾¿é‡å¤ä½¿ç”¨ã€ç®€åŒ–è°ƒè¯•æ­¥éª¤ã€æå‡æ•´ä¸ªé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€ä¾¿äºååŒå¼€å‘ã€‚
>
> **è™šæ‹Ÿ *DOM***
>
> åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œç”¨ *JQuery* æˆ–è€…åŸç”Ÿçš„ *JavaScript DOM* æ“ä½œå‡½æ•°å¯¹ *DOM* è¿›è¡Œé¢‘ç¹æ“ä½œçš„æ—¶å€™ï¼Œæµè§ˆå™¨è¦ä¸åœçš„æ¸²æŸ“æ–°çš„ *DOM* æ ‘ï¼Œå¯¼è‡´åœ¨æ€§èƒ½ä¸Šé¢çš„å¼€é”€ç‰¹åˆ«çš„é«˜ã€‚
>
> è€Œ *Virtual DOM* åˆ™æ˜¯è™šæ‹Ÿ *DOM* çš„è‹±æ–‡ï¼Œç®€å•æ¥è¯´ï¼Œä»–å°±æ˜¯ä¸€ç§å¯ä»¥é¢„å…ˆé€šè¿‡ *JavaScript* è¿›è¡Œå„ç§è®¡ç®—ï¼ŒæŠŠæœ€ç»ˆçš„ *DOM* æ“ä½œè®¡ç®—å‡ºæ¥å¹¶ä¼˜åŒ–ï¼Œç”±äºè¿™ä¸ª *DOM* æ“ä½œå±äºé¢„å¤„ç†æ“ä½œï¼Œå¹¶æ²¡æœ‰çœŸå®çš„æ“ä½œ *DOM*ï¼Œæ‰€ä»¥å«åšè™šæ‹Ÿ *DOM*ã€‚æœ€ååœ¨è®¡ç®—å®Œæ¯•æ‰çœŸæ­£å°† *DOM* æ“ä½œæäº¤ï¼Œå°† *DOM* æ“ä½œå˜åŒ–åæ˜ åˆ° *DOM* æ ‘ä¸Šã€‚



### 3. **è§£é‡Šä¸€ä¸‹å¯¹ *Vue* ç”Ÿå‘½å‘¨æœŸçš„ç†è§£**

- ä»€ä¹ˆæ˜¯ *vue* ç”Ÿå‘½å‘¨æœŸ
- *vue* ç”Ÿå‘½å‘¨æœŸçš„ä½œç”¨æ˜¯ä»€ä¹ˆ
- *vue* ç”Ÿå‘½å‘¨æœŸæœ‰å‡ ä¸ªé˜¶æ®µ
- ç¬¬ä¸€æ¬¡é¡µé¢åŠ è½½ä¼šè§¦å‘å“ªå‡ ä¸ªé’©å­
- *DOM* æ¸²æŸ“åœ¨å“ªä¸ªå‘¨æœŸå°±å·²ç»å®Œæˆ
- å¤šç»„ä»¶ï¼ˆçˆ¶å­ç»„ä»¶ï¼‰ä¸­ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨é¡ºåºè¯´ä¸€ä¸‹

> å‚è€ƒç­”æ¡ˆï¼š
>
> **ä»€ä¹ˆæ˜¯ *vue* ç”Ÿå‘½å‘¨æœŸ**
>
> å¯¹äº *vue* æ¥è®²ï¼Œç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸€ä¸ª *vue* å®ä¾‹ä»åˆ›å»ºåˆ°é”€æ¯çš„è¿‡ç¨‹ã€‚
>
> 
>
> ***vue* ç”Ÿå‘½å‘¨æœŸçš„ä½œç”¨æ˜¯ä»€ä¹ˆ**
>
> åœ¨ç”Ÿå‘½å‘¨æœŸçš„è¿‡ç¨‹ä¸­ä¼šè¿è¡Œç€ä¸€äº›å«åšç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°ï¼Œç»™äºˆäº†å¼€å‘è€…åœ¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µæ·»åŠ ä¸šåŠ¡ä»£ç çš„èƒ½åŠ›ã€‚
>
> å…¶å®å’Œå›è°ƒæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå½“ç³»ç»Ÿæ‰§è¡Œåˆ°æŸå¤„æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ *hook*(é’©å­)ï¼Œæœ‰çš„è¯å°±ä¼šæ‰§è¡Œå›è°ƒã€‚
>
> é€šä¿—çš„è¯´ï¼Œ*hook* å°±æ˜¯åœ¨ç¨‹åºè¿è¡Œä¸­ï¼Œåœ¨æŸä¸ªç‰¹å®šçš„ä½ç½®ï¼Œæ¡†æ¶çš„å¼€å‘è€…è®¾è®¡å¥½äº†ä¸€ä¸ªé’©å­æ¥å‘Šè¯‰æˆ‘ä»¬å½“å‰ç¨‹åºå·²ç»è¿è¡Œåˆ°ç‰¹å®šçš„ä½ç½®äº†ï¼Œä¼šè§¦å‘ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶æä¾›ç»™æˆ‘ä»¬ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸçš„ç‰¹å®šé˜¶æ®µè¿›è¡Œç›¸å…³ä¸šåŠ¡ä»£ç çš„ç¼–å†™ã€‚
>
> 
>
> ***vue* ç”Ÿå‘½å‘¨æœŸæœ‰å‡ ä¸ªé˜¶æ®µ**
>
> å®ƒå¯ä»¥æ€»å…±åˆ†ä¸º *8* ä¸ªé˜¶æ®µï¼šåˆ›å»ºå‰/å, è½½å…¥å‰/å,æ›´æ–°å‰/å,é”€æ¯å‰/é”€æ¯åã€‚
>
> - *beforeCreate*ï¼šæ˜¯ *new Vue( )* ä¹‹åè§¦å‘çš„ç¬¬ä¸€ä¸ªé’©å­ï¼Œåœ¨å½“å‰é˜¶æ®µ *dataã€methodsã€computed* ä»¥åŠ *watch* ä¸Šçš„æ•°æ®å’Œæ–¹æ³•éƒ½ä¸èƒ½è¢«è®¿é—®ã€‚
>
> - *created*ï¼šåœ¨å®ä¾‹åˆ›å»ºå®Œæˆåå‘ç”Ÿï¼Œå½“å‰é˜¶æ®µå·²ç»å®Œæˆäº†æ•°æ®è§‚æµ‹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä½¿ç”¨æ•°æ®ï¼Œæ›´æ”¹æ•°æ®ï¼Œåœ¨è¿™é‡Œæ›´æ”¹æ•°æ®ä¸ä¼šè§¦å‘ *updated* å‡½æ•°ã€‚å¯ä»¥åšä¸€äº›åˆå§‹æ•°æ®çš„è·å–ï¼Œåœ¨å½“å‰é˜¶æ®µæ— æ³•ä¸ *DOM* è¿›è¡Œäº¤äº’ï¼Œå¦‚æœéè¦æƒ³ï¼Œå¯ä»¥é€šè¿‡ *vm.$nextTick* æ¥è®¿é—® *DOM* ã€‚
>
> - *beforeMount*ï¼šå‘ç”Ÿåœ¨æŒ‚è½½ä¹‹å‰ï¼Œåœ¨è¿™ä¹‹å‰ *template* æ¨¡æ¿å·²å¯¼å…¥æ¸²æŸ“å‡½æ•°ç¼–è¯‘ã€‚è€Œå½“å‰é˜¶æ®µè™šæ‹Ÿ *DOM* å·²ç»åˆ›å»ºå®Œæˆï¼Œå³å°†å¼€å§‹æ¸²æŸ“ã€‚åœ¨æ­¤æ—¶ä¹Ÿå¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œä¸ä¼šè§¦å‘ *updated*ã€‚
>
> - *mounted*ï¼šåœ¨æŒ‚è½½å®Œæˆåå‘ç”Ÿï¼Œåœ¨å½“å‰é˜¶æ®µï¼ŒçœŸå®çš„ *DOM* æŒ‚è½½å®Œæ¯•ï¼Œæ•°æ®å®ŒæˆåŒå‘ç»‘å®šï¼Œå¯ä»¥è®¿é—®åˆ° *DOM* èŠ‚ç‚¹ï¼Œä½¿ç”¨ *$refs* å±æ€§å¯¹ *DOM* è¿›è¡Œæ“ä½œã€‚
>
> - *beforeUpdate*ï¼šå‘ç”Ÿåœ¨æ›´æ–°ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯å“åº”å¼æ•°æ®å‘ç”Ÿæ›´æ–°ï¼Œè™šæ‹Ÿ *DOM* é‡æ–°æ¸²æŸ“ä¹‹å‰è¢«è§¦å‘ï¼Œä½ å¯ä»¥åœ¨å½“å‰é˜¶æ®µè¿›è¡Œæ›´æ”¹æ•°æ®ï¼Œä¸ä¼šé€ æˆé‡æ¸²æŸ“ã€‚
>
> - *updated*ï¼šå‘ç”Ÿåœ¨æ›´æ–°å®Œæˆä¹‹åï¼Œå½“å‰é˜¶æ®µç»„ä»¶ *DOM* å·²å®Œæˆæ›´æ–°ã€‚è¦æ³¨æ„çš„æ˜¯é¿å…åœ¨æ­¤æœŸé—´æ›´æ”¹æ•°æ®ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´æ— é™å¾ªç¯çš„æ›´æ–°ã€‚
>
> - *beforeDestroy*ï¼šå‘ç”Ÿåœ¨å®ä¾‹é”€æ¯ä¹‹å‰ï¼Œåœ¨å½“å‰é˜¶æ®µå®ä¾‹å®Œå…¨å¯ä»¥è¢«ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™æ—¶è¿›è¡Œå–„åæ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚æ¸…é™¤è®¡æ—¶å™¨ã€‚
>
> - *destroyed*ï¼šå‘ç”Ÿåœ¨å®ä¾‹é”€æ¯ä¹‹åï¼Œè¿™ä¸ªæ—¶å€™åªå‰©ä¸‹äº† *DOM* ç©ºå£³ã€‚ç»„ä»¶å·²è¢«æ‹†è§£ï¼Œæ•°æ®ç»‘å®šè¢«å¸é™¤ï¼Œç›‘å¬è¢«ç§»å‡ºï¼Œå­å®ä¾‹ä¹Ÿç»Ÿç»Ÿè¢«é”€æ¯ã€‚
>
> 
>
> **ç¬¬ä¸€æ¬¡é¡µé¢åŠ è½½ä¼šè§¦å‘å“ªå‡ ä¸ªé’©å­**
>
> ä¼šè§¦å‘ *4* ä¸ªé’©å­ï¼Œåˆ†åˆ«æ˜¯ï¼š*beforeCreateã€createdã€beforeMountã€mounted*
>
> 
>
> ***DOM* æ¸²æŸ“åœ¨å“ªä¸ªå‘¨æœŸå°±å·²ç»å®Œæˆ**
>
> *DOM* æ¸²æŸ“æ˜¯åœ¨ *mounted* é˜¶æ®µå®Œæˆï¼Œæ­¤é˜¶æ®µçœŸå®çš„ *DOM* æŒ‚è½½å®Œæ¯•ï¼Œæ•°æ®å®ŒæˆåŒå‘ç»‘å®šï¼Œå¯ä»¥è®¿é—®åˆ° *DOM* èŠ‚ç‚¹ã€‚
>
> 
>
> **å¤šç»„ä»¶ï¼ˆçˆ¶å­ç»„ä»¶ï¼‰ä¸­ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨é¡ºåºè¯´ä¸€ä¸‹**
>
> ç»„ä»¶çš„è°ƒç”¨é¡ºåºéƒ½æ˜¯å…ˆçˆ¶åå­ï¼Œæ¸²æŸ“å®Œæˆçš„é¡ºåºæ˜¯å…ˆå­åçˆ¶ã€‚ç»„ä»¶çš„é”€æ¯æ“ä½œæ˜¯å…ˆçˆ¶åå­ï¼Œé”€æ¯å®Œæˆçš„é¡ºåºæ˜¯å…ˆå­åçˆ¶ã€‚
>
> - åŠ è½½æ¸²æŸ“è¿‡ç¨‹ï¼šçˆ¶*beforeCreate*->çˆ¶*created*->çˆ¶*beforeMount*->å­*beforeCreate*->å­*created*->å­*beforeMount*- >å­*mounted*->çˆ¶*mounted*
>
> - å­ç»„ä»¶æ›´æ–°è¿‡ç¨‹ï¼šçˆ¶*beforeUpdate*->å­*beforeUpdate*->å­*updated*->çˆ¶*updated*
>
> - çˆ¶ç»„ä»¶æ›´æ–°è¿‡ç¨‹ï¼šçˆ¶ *beforeUpdate* -> çˆ¶ *updated*
>
> - é”€æ¯è¿‡ç¨‹ï¼šçˆ¶*beforeDestroy*->å­*beforeDestroy*->å­*destroyed*->çˆ¶*destroyed*



### 4. ***Vue* å®ç°åŒå‘æ•°æ®ç»‘å®šåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue2.x* é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ˆ*PubSub* æ¨¡å¼ï¼‰çš„æ–¹å¼ï¼Œé€šè¿‡ *Object.defineProperty* æ¥åŠ«æŒå„ä¸ªå±æ€§çš„ *setterã€getter*ï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚
>
> å½“æŠŠä¸€ä¸ªæ™®é€š *Javascript* å¯¹è±¡ä¼ ç»™ *Vue* å®ä¾‹æ¥ä½œä¸ºå®ƒçš„ *data* é€‰é¡¹æ—¶ï¼Œ*Vue* å°†éå†å®ƒçš„å±æ€§ï¼Œç”¨ *Object.defineProperty* å°†å®ƒä»¬è½¬ä¸º *getter/setter*ã€‚ç”¨æˆ·çœ‹ä¸åˆ° *getter/setter*ï¼Œä½†æ˜¯åœ¨å†…éƒ¨å®ƒä»¬è®© *Vue* è¿½è¸ªä¾èµ–ï¼Œåœ¨å±æ€§è¢«è®¿é—®å’Œä¿®æ”¹æ—¶é€šçŸ¥å˜åŒ–ã€‚
>
> *Vue* çš„æ•°æ®åŒå‘ç»‘å®šæ•´åˆäº† *Observer*ï¼Œ*Compile* å’Œ *Watcher* ä¸‰è€…ï¼Œé€šè¿‡ *Observer* æ¥ç›‘å¬è‡ªå·±çš„ *model* çš„æ•°æ®å˜åŒ–ï¼Œé€šè¿‡ *Compile* æ¥è§£æç¼–è¯‘æ¨¡æ¿æŒ‡ä»¤ï¼Œæœ€ç»ˆåˆ©ç”¨ *Watcher* æ­èµ· *Observer* å’Œ *Compile* ä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ï¼Œè¾¾åˆ°æ•°æ®å˜åŒ–->è§†å›¾æ›´æ–°ï¼Œè§†å›¾äº¤äº’å˜åŒ–ï¼ˆä¾‹å¦‚ input æ“ä½œï¼‰->æ•°æ® *model* å˜æ›´çš„åŒå‘ç»‘å®šæ•ˆæœã€‚
>
> *Vue3.x* æ”¾å¼ƒäº† *Object.defineProperty* ï¼Œä½¿ç”¨ *ES6* åŸç”Ÿçš„ *Proxy*ï¼Œæ¥è§£å†³ä»¥å‰ä½¿ç”¨  *Object.defineProperty* æ‰€å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚



### 5. **è¯´ä¸€ä¸‹å¯¹ *Vue2.x* å“åº”å¼åŸç†çš„ç†è§£**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue* åœ¨åˆå§‹åŒ–æ•°æ®æ—¶ï¼Œä¼šä½¿ç”¨ *Object.defineProperty* é‡æ–°å®šä¹‰ *data* ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œå½“é¡µé¢ä½¿ç”¨å¯¹åº”å±æ€§æ—¶ï¼Œé¦–å…ˆä¼šè¿›è¡Œä¾èµ–æ”¶é›†(æ”¶é›†å½“å‰ç»„ä»¶çš„ *watcher*)ï¼Œå¦‚æœå±æ€§å‘ç”Ÿå˜åŒ–ä¼šé€šçŸ¥ç›¸å…³ä¾èµ–è¿›è¡Œæ›´æ–°æ“ä½œ(å‘å¸ƒè®¢é˜…)ã€‚
>
> ï¼ˆå¯ä»¥å‚é˜…å‰é¢ç¬¬ *4* é¢˜ç­”æ¡ˆï¼‰



### 6. **è¯´ä¸€ä¸‹åœ¨ *Vue2.x* ä¸­å¦‚ä½•æ£€æµ‹æ•°ç»„çš„å˜åŒ–ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue2.x* ä¸­å®ç°æ£€æµ‹æ•°ç»„å˜åŒ–çš„æ–¹æ³•ï¼Œæ˜¯**å°†æ•°ç»„çš„å¸¸ç”¨æ–¹æ³•è¿›è¡Œäº†é‡å†™**ã€‚*Vue* å°† *data* ä¸­çš„æ•°ç»„è¿›è¡Œäº†åŸå‹é“¾é‡å†™ï¼ŒæŒ‡å‘äº†è‡ªå·±å®šä¹‰çš„æ•°ç»„åŸå‹æ–¹æ³•ã€‚è¿™æ ·å½“è°ƒç”¨æ•°ç»„ *api* æ—¶ï¼Œå¯ä»¥é€šçŸ¥ä¾èµ–æ›´æ–°ã€‚å¦‚æœæ•°ç»„ä¸­åŒ…å«ç€å¼•ç”¨ç±»å‹ï¼Œä¼šå¯¹æ•°ç»„ä¸­çš„å¼•ç”¨ç±»å‹å†æ¬¡é€’å½’éå†è¿›è¡Œç›‘æ§ã€‚è¿™æ ·å°±å®ç°äº†ç›‘æµ‹æ•°ç»„å˜åŒ–ã€‚
>
> æµç¨‹:
>
> 1. åˆå§‹åŒ–ä¼ å…¥ data æ•°æ®æ‰§è¡Œ initData
> 2. å°†æ•°æ®è¿›è¡Œè§‚æµ‹ new Observer
> 3. å°†æ•°ç»„åŸå‹æ–¹æ³•æŒ‡å‘é‡å†™çš„åŸå‹
> 4. æ·±åº¦è§‚å¯Ÿæ•°ç»„ä¸­çš„å¼•ç”¨ç±»å‹
>
> æœ‰ä¸¤ç§æƒ…å†µæ— æ³•æ£€æµ‹åˆ°æ•°ç»„çš„å˜åŒ–ã€‚
>
> - å½“åˆ©ç”¨ç´¢å¼•ç›´æ¥è®¾ç½®ä¸€ä¸ªæ•°ç»„é¡¹æ—¶ï¼Œä¾‹å¦‚ *vm.items[indexOfItem] = newValue*
> - å½“ä¿®æ”¹æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œä¾‹å¦‚ *vm.items.length = newLength*
>
> ä¸è¿‡è¿™ä¸¤ç§åœºæ™¯éƒ½æœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚
>
> **åˆ©ç”¨ç´¢å¼•è®¾ç½®æ•°ç»„é¡¹çš„æ›¿ä»£æ–¹æ¡ˆ**
>
> ```js
> //ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œæ›´æ–°è§†å›¾
> // vm.$setï¼ŒVue.setçš„ä¸€ä¸ªåˆ«å
> vm.$set(vm.items, indexOfItem, newValue)
> ```
>
> **ä¿®æ”¹æ•°ç»„çš„é•¿åº¦çš„æ›¿ä»£æ–¹æ¡ˆ**
>
> ```js
> //ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œæ›´æ–°è§†å›¾
> // Array.prototype.splice
> vm.items.splice(indexOfItem, 1, newValue)
> ```



### 7. ***Vue3.x* å“åº”å¼æ•°æ®**

- *Vue3.x* å“åº”å¼æ•°æ®åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
- *Proxy* åªä¼šä»£ç†å¯¹è±¡çš„ç¬¬ä¸€å±‚ï¼Œé‚£ä¹ˆ *Vue3* åˆæ˜¯æ€æ ·å¤„ç†è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ
- ç›‘æµ‹æ•°ç»„çš„æ—¶å€™å¯èƒ½è§¦å‘å¤šæ¬¡ *get/set*ï¼Œé‚£ä¹ˆå¦‚ä½•é˜²æ­¢è§¦å‘å¤šæ¬¡å‘¢ï¼Ÿ

> å‚è€ƒç­”æ¡ˆï¼š
>
> ***Vue3.x* å“åº”å¼æ•°æ®åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> åœ¨ *Vue 2* ä¸­ï¼Œå“åº”å¼åŸç†å°±æ˜¯ä½¿ç”¨çš„ *Object.defineProperty* æ¥å®ç°çš„ã€‚ä½†æ˜¯åœ¨ *Vue 3.0* ä¸­é‡‡ç”¨äº† *Proxy*ï¼ŒæŠ›å¼ƒäº† *Object.defineProperty* æ–¹æ³•ã€‚
>
> ç©¶å…¶åŸå› ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹å‡ ç‚¹ï¼š
>
> - *Object.defineProperty* æ— æ³•ç›‘æ§åˆ°æ•°ç»„ä¸‹æ ‡çš„å˜åŒ–ï¼Œå¯¼è‡´é€šè¿‡æ•°ç»„ä¸‹æ ‡æ·»åŠ å…ƒç´ ï¼Œä¸èƒ½å®æ—¶å“åº”
> - *Object.defineProperty* åªèƒ½åŠ«æŒå¯¹è±¡çš„å±æ€§ï¼Œä»è€Œéœ€è¦å¯¹æ¯ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå±æ€§è¿›è¡Œéå†ï¼Œå¦‚æœï¼Œå±æ€§å€¼æ˜¯å¯¹è±¡ï¼Œè¿˜éœ€è¦æ·±åº¦éå†ã€‚*Proxy* å¯ä»¥åŠ«æŒæ•´ä¸ªå¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚
> - *Proxy* ä¸ä»…å¯ä»¥ä»£ç†å¯¹è±¡ï¼Œè¿˜å¯ä»¥ä»£ç†æ•°ç»„ã€‚è¿˜å¯ä»¥ä»£ç†åŠ¨æ€å¢åŠ çš„å±æ€§ã€‚
> - *Proxy* æœ‰å¤šè¾¾ *13* ç§æ‹¦æˆªæ–¹æ³•
> - *Proxy*ä½œä¸ºæ–°æ ‡å‡†å°†å—åˆ°æµè§ˆå™¨å‚å•†é‡ç‚¹æŒç»­çš„æ€§èƒ½ä¼˜åŒ–
>
> 
>
> ***Proxy* åªä¼šä»£ç†å¯¹è±¡çš„ç¬¬ä¸€å±‚ï¼Œé‚£ä¹ˆ *Vue3* åˆæ˜¯æ€æ ·å¤„ç†è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ**
>
> åˆ¤æ–­å½“å‰ *Reflect.get* çš„è¿”å›å€¼æ˜¯å¦ä¸º *Object*ï¼Œå¦‚æœæ˜¯åˆ™å†é€šè¿‡ *reactive* æ–¹æ³•åšä»£ç†ï¼Œ è¿™æ ·å°±å®ç°äº†æ·±åº¦è§‚æµ‹ã€‚
>
> 
>
> **ç›‘æµ‹æ•°ç»„çš„æ—¶å€™å¯èƒ½è§¦å‘å¤šæ¬¡ *get/set*ï¼Œé‚£ä¹ˆå¦‚ä½•é˜²æ­¢è§¦å‘å¤šæ¬¡å‘¢ï¼Ÿ**
>
> æˆ‘ä»¬å¯ä»¥åˆ¤æ–­ *key* æ˜¯å¦ä¸ºå½“å‰è¢«ä»£ç†å¯¹è±¡ *target* è‡ªèº«å±æ€§ï¼Œä¹Ÿå¯ä»¥åˆ¤æ–­æ—§å€¼ä¸æ–°å€¼æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶ï¼Œæ‰æœ‰å¯èƒ½æ‰§è¡Œ *trigger*ã€‚



### 8. ***v-model* åŒå‘ç»‘å®šçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *v-model* æœ¬è´¨å°±æ˜¯ *:value + input* æ–¹æ³•çš„è¯­æ³•ç³–ã€‚å¯ä»¥é€šè¿‡ *model* å±æ€§çš„ *prop* å’Œ *event* å±æ€§æ¥è¿›è¡Œè‡ªå®šä¹‰ã€‚åŸç”Ÿçš„ *v-model*ï¼Œä¼šæ ¹æ®æ ‡ç­¾çš„ä¸åŒç”Ÿæˆä¸åŒçš„äº‹ä»¶å’Œå±æ€§ã€‚
>
> ä¾‹å¦‚ï¼š
>
> - *text* å’Œ *textarea* å…ƒç´ ä½¿ç”¨ *value* å±æ€§å’Œ *input* äº‹ä»¶
> - *checkbox* å’Œ *radio* ä½¿ç”¨ *checked* å±æ€§å’Œ *change* äº‹ä»¶
> - *select* å­—æ®µå°† *value* ä½œä¸º *prop* å¹¶å°† *change* ä½œä¸ºäº‹ä»¶
>
> ä»¥è¾“å…¥æ¡†ä¸ºä¾‹ï¼Œå½“ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥å†…å®¹æ—¶ï¼Œä¼šè§¦å‘ *input* äº‹ä»¶ï¼Œä»è€Œæ›´æ–° *value*ã€‚è€Œ *value* çš„æ”¹å˜åŒæ ·ä¼šæ›´æ–°è§†å›¾ï¼Œè¿™å°±æ˜¯ *vue* ä¸­çš„åŒå‘ç»‘å®šã€‚åŒå‘ç»‘å®šçš„åŸç†ï¼Œå…¶å®ç°æ€è·¯å¦‚ä¸‹ï¼š
>
> é¦–å…ˆè¦å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒç›‘å¬ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ *Observer*ï¼Œç”¨æ¥ç›‘å¬æ‰€æœ‰å±æ€§ã€‚å¦‚æœå±æ€§å‘ä¸Šå˜åŒ–äº†ï¼Œå°±éœ€è¦å‘Šè¯‰è®¢é˜…è€… *Watcher* çœ‹æ˜¯å¦éœ€è¦æ›´æ–°ã€‚
>
> å› ä¸ºè®¢é˜…è€…æ˜¯æœ‰å¾ˆå¤šä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…å™¨ *Dep* æ¥ä¸“é—¨æ”¶é›†è¿™äº›è®¢é˜…è€…ï¼Œç„¶ååœ¨ç›‘å¬å™¨ *Observer* å’Œè®¢é˜…è€… *Watcher* ä¹‹é—´è¿›è¡Œç»Ÿä¸€ç®¡ç†çš„ã€‚
>
> æ¥ç€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰ä¸€ä¸ªæŒ‡ä»¤è§£æå™¨ *Compile*ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹å…ƒç´ è¿›è¡Œæ‰«æå’Œè§£æï¼Œå°†ç›¸å…³æŒ‡ä»¤å¯¹åº”åˆå§‹åŒ–æˆä¸€ä¸ªè®¢é˜…è€… *Watcher*ï¼Œå¹¶æ›¿æ¢æ¨¡æ¿æ•°æ®æˆ–è€…ç»‘å®šç›¸åº”çš„å‡½æ•°ï¼Œæ­¤æ—¶å½“è®¢é˜…è€… *Watcher* æ¥æ”¶åˆ°ç›¸åº”å±æ€§çš„å˜åŒ–ï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„æ›´æ–°å‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ã€‚
>
> å› æ­¤æ¥ä¸‹å»æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ *3* ä¸ªæ­¥éª¤ï¼Œå®ç°æ•°æ®çš„åŒå‘ç»‘å®šï¼š
>
> 1. å®ç°ä¸€ä¸ªç›‘å¬å™¨ *Observer*ï¼Œç”¨æ¥åŠ«æŒå¹¶ç›‘å¬æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæœ‰å˜åŠ¨çš„ï¼Œå°±é€šçŸ¥è®¢é˜…è€…ã€‚
>
> 2. å®ç°ä¸€ä¸ªè®¢é˜…è€… *Watcher*ï¼Œå¯ä»¥æ”¶åˆ°å±æ€§çš„å˜åŒ–é€šçŸ¥å¹¶æ‰§è¡Œç›¸åº”çš„å‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ã€‚
>
> 3. å®ç°ä¸€ä¸ªè§£æå™¨ *Compile*ï¼Œå¯ä»¥æ‰«æå’Œè§£ææ¯ä¸ªèŠ‚ç‚¹çš„ç›¸å…³æŒ‡ä»¤ï¼Œå¹¶æ ¹æ®åˆå§‹åŒ–æ¨¡æ¿æ•°æ®ä»¥åŠåˆå§‹åŒ–ç›¸åº”çš„è®¢é˜…å™¨ã€‚
>
> æµç¨‹å›¾å¦‚ä¸‹ï¼š
>
> <img src="https://img-blog.csdnimg.cn/img_convert/717034f25ee385b09e9dee53b2988cae.png" alt="img"  />



### 9. ***vue2.x* å’Œ *vuex3.x* æ¸²æŸ“å™¨çš„ *diff* ç®—æ³•åˆ†åˆ«è¯´ä¸€ä¸‹ï¼Ÿ**

> ç›´æ’­è®²è§£

> å‚è€ƒç­”æ¡ˆï¼š
>
> ç®€å•æ¥è¯´ï¼Œ*diff* ç®—æ³•æœ‰ä»¥ä¸‹è¿‡ç¨‹
>
> - åŒçº§æ¯”è¾ƒï¼Œå†æ¯”è¾ƒå­èŠ‚ç‚¹
> - å…ˆåˆ¤æ–­ä¸€æ–¹æœ‰å­èŠ‚ç‚¹ä¸€æ–¹æ²¡æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µ(å¦‚æœæ–°çš„ *children* æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå°†æ—§çš„å­èŠ‚ç‚¹ç§»é™¤)
> - æ¯”è¾ƒéƒ½æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µ(æ ¸å¿ƒ *diff*)
> - é€’å½’æ¯”è¾ƒå­èŠ‚ç‚¹
>
> æ­£å¸¸ *Diff* ä¸¤ä¸ªæ ‘çš„æ—¶é—´å¤æ‚åº¦æ˜¯ *O(n^3)*ï¼Œä½†å®é™…æƒ…å†µä¸‹æˆ‘ä»¬å¾ˆå°‘ä¼šè¿›è¡Œè·¨å±‚çº§çš„ç§»åŠ¨ *DOM*ï¼Œæ‰€ä»¥ *Vue* å°† *Diff* è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»*O(n^3) -> O(n)*ï¼Œåªæœ‰å½“æ–°æ—§ *children* éƒ½ä¸ºå¤šä¸ªå­èŠ‚ç‚¹æ—¶æ‰éœ€è¦ç”¨æ ¸å¿ƒçš„ *Diff* ç®—æ³•è¿›è¡ŒåŒå±‚çº§æ¯”è¾ƒã€‚
>
> *Vue2* çš„æ ¸å¿ƒ *Diff* ç®—æ³•é‡‡ç”¨äº†åŒç«¯æ¯”è¾ƒçš„ç®—æ³•ï¼ŒåŒæ—¶ä»æ–°æ—§ *children* çš„ä¸¤ç«¯å¼€å§‹è¿›è¡Œæ¯”è¾ƒï¼Œå€ŸåŠ© *key* å€¼æ‰¾åˆ°å¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œå†è¿›è¡Œç›¸å…³æ“ä½œã€‚ç›¸æ¯” *React* çš„ *Diff* ç®—æ³•ï¼ŒåŒæ ·æƒ…å†µä¸‹å¯ä»¥å‡å°‘ç§»åŠ¨èŠ‚ç‚¹æ¬¡æ•°ï¼Œå‡å°‘ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ï¼Œæ›´åŠ çš„ä¼˜é›…ã€‚
>
> *Vue3.x* å€Ÿé‰´äº† *ivi* ç®—æ³•å’Œ *inferno* ç®—æ³•
>
> åœ¨åˆ›å»º *VNode* æ—¶å°±ç¡®å®šå…¶ç±»å‹ï¼Œä»¥åŠåœ¨ *mount/patch* çš„è¿‡ç¨‹ä¸­é‡‡ç”¨ä½è¿ç®—æ¥åˆ¤æ–­ä¸€ä¸ª *VNode* çš„ç±»å‹ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šå†é…åˆæ ¸å¿ƒçš„ *Diff* ç®—æ³•ï¼Œä½¿å¾—æ€§èƒ½ä¸Šè¾ƒ *Vue2.x* æœ‰äº†æå‡ã€‚è¯¥ç®—æ³•ä¸­è¿˜è¿ç”¨äº†åŠ¨æ€è§„åˆ’çš„æ€æƒ³æ±‚è§£æœ€é•¿é€’å½’å­åºåˆ—ã€‚



### 10. ***vue* ç»„ä»¶çš„å‚æ•°ä¼ é€’**

- è§£é‡Šä¸€ä¸‹çˆ¶ç»„ä»¶ä¸å­ç»„ä»¶ä¼ å€¼å®ç°è¿‡ç¨‹
- éçˆ¶å­ç»„ä»¶çš„æ•°æ®ä¼ é€’ï¼Œå…„å¼Ÿç»„ä»¶ä¼ å€¼æ˜¯å¦‚ä½•å®ç°çš„

> å‚è€ƒç­”æ¡ˆï¼š
>
> **è§£é‡Šä¸€ä¸‹çˆ¶ç»„ä»¶ä¸å­ç»„ä»¶ä¼ å€¼å®ç°è¿‡ç¨‹**
>
> - çˆ¶ç»„ä»¶ä¼ ç»™å­ç»„ä»¶ï¼šå­ç»„ä»¶é€šè¿‡ *props* æ–¹æ³•æ¥å—æ•°æ®
>
> - å­ç»„ä»¶ä¼ ç»™çˆ¶ç»„ä»¶ï¼šä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶ï¼Œè‡ªç»„ä»¶é€šè¿‡ *$emit* æ–¹æ³•è§¦å‘çˆ¶ç»„ä»¶çš„æ–¹æ³•æ¥ä¼ é€’å‚æ•°
>
> 
>
> **éçˆ¶å­ç»„ä»¶çš„æ•°æ®ä¼ é€’ï¼Œå…„å¼Ÿç»„ä»¶ä¼ å€¼æ˜¯å¦‚ä½•å®ç°çš„**
>
> *eventBus*ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªäº‹ä»¶ä¸­å¿ƒï¼Œç›¸å½“äºä¸­è½¬ç«™ï¼Œå¯ä»¥ç”¨å®ƒæ¥ä¼ é€’äº‹ä»¶å’Œæ¥æ”¶äº‹ä»¶ã€‚é¡¹ç›®æ¯”è¾ƒå°æ—¶ï¼Œç”¨è¿™ä¸ªæ¯”è¾ƒåˆé€‚ã€‚
>
> 
>
> æ­¤å¤–ï¼Œæ€»ç»“ *vue* ä¸­çš„ç»„ä»¶é€šä¿¡æ–¹å¼ï¼Œå¸¸è§ä½¿ç”¨åœºæ™¯å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š
>
> - çˆ¶å­é€šä¿¡ï¼š
>   - çˆ¶å‘å­ä¼ é€’æ•°æ®æ˜¯é€šè¿‡ *props* ï¼Œå­å‘çˆ¶æ˜¯é€šè¿‡ *$emit / $on*
>   - *$emit / $bus*
>   - *vuex*
>   - é€šè¿‡çˆ¶é“¾ / å­é“¾ä¹Ÿå¯ä»¥é€šä¿¡ï¼ˆ *$parent / $children* ï¼‰
>   - *ref* ä¹Ÿå¯ä»¥è®¿é—®ç»„ä»¶å®ä¾‹
>   - *v-model*
>   - .*sync* ä¿®é¥°ç¬¦
> - å…„å¼Ÿé€šä¿¡ï¼š
>   - *$emit / $bus*
>   - *vuex*
> - è·¨çº§é€šä¿¡ï¼š
>   - *$emit / $bus* 
>   - *vuex* 
>   - *provide / inject API*
>   - *$attrs/$listeners*



### 11. ***Vue* çš„è·¯ç”±å®ç°**

- è§£é‡Š *hash* æ¨¡å¼å’Œ *history* æ¨¡å¼çš„å®ç°åŸç†
- è¯´ä¸€ä¸‹ *$router* ä¸ *$route* çš„åŒºåˆ«
- *vueRouter* æœ‰å“ªå‡ ç§å¯¼èˆªå®ˆå«ï¼Ÿ
- è§£é‡Šä¸€ä¸‹ *vueRouter* çš„å®Œæ•´çš„å¯¼èˆªè§£ææµç¨‹æ˜¯ä»€ä¹ˆ

> å‚è€ƒç­”æ¡ˆï¼š
>
> **è§£é‡Š *hash* æ¨¡å¼å’Œ *history* æ¨¡å¼çš„å®ç°åŸç†**
>
> `#` åé¢ *hash* å€¼çš„å˜åŒ–ï¼Œä¸ä¼šå¯¼è‡´æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œæµè§ˆå™¨ä¸å‘å‡ºè¯·æ±‚ï¼Œå°±ä¸ä¼šåˆ·æ–°é¡µé¢ï¼›é€šè¿‡ç›‘å¬ *hashchange* äº‹ä»¶å¯ä»¥çŸ¥é“ *hash* å‘ç”Ÿäº†å“ªäº›å˜åŒ–ï¼Œç„¶åæ ¹æ® *hash* å˜åŒ–æ¥å®ç°æ›´æ–°é¡µé¢éƒ¨åˆ†å†…å®¹çš„æ“ä½œã€‚
>
> *history* æ¨¡å¼çš„å®ç°ï¼Œä¸»è¦æ˜¯ *HTML5* æ ‡å‡†å‘å¸ƒçš„ä¸¤ä¸ª *API*ï¼Œ*pushState* å’Œ *replaceState*ï¼Œè¿™ä¸¤ä¸ª *API* å¯ä»¥åœ¨æ”¹å˜ *URL*ï¼Œä½†æ˜¯ä¸ä¼šå‘é€è¯·æ±‚ã€‚è¿™æ ·å°±å¯ä»¥ç›‘å¬ *url* å˜åŒ–æ¥å®ç°æ›´æ–°é¡µé¢éƒ¨åˆ†å†…å®¹çš„æ“ä½œã€‚ 
>
> ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«ï¼š
>
> - é¦–å…ˆæ˜¯åœ¨ *URL* çš„å±•ç¤ºä¸Šï¼Œ*hash* æ¨¡å¼æœ‰â€œ#â€ï¼Œ*history* æ¨¡å¼æ²¡æœ‰
>
> - åˆ·æ–°é¡µé¢æ—¶ï¼Œ*hash* æ¨¡å¼å¯ä»¥æ­£å¸¸åŠ è½½åˆ° *hash* å€¼å¯¹åº”çš„é¡µé¢ï¼Œè€Œ *history* æ²¡æœ‰å¤„ç†çš„è¯ï¼Œä¼šè¿”å› *404*ï¼Œä¸€èˆ¬éœ€è¦åç«¯å°†æ‰€æœ‰é¡µé¢éƒ½é…ç½®é‡å®šå‘åˆ°é¦–é¡µè·¯ç”±
>
> - åœ¨å…¼å®¹æ€§ä¸Šï¼Œ*hash* å¯ä»¥æ”¯æŒä½ç‰ˆæœ¬æµè§ˆå™¨å’Œ *IE*
>
> 
>
> **è¯´ä¸€ä¸‹ *$router* ä¸ *$route* çš„åŒºåˆ«**
>
> *$route* å¯¹è±¡è¡¨ç¤ºå½“å‰çš„è·¯ç”±ä¿¡æ¯ï¼ŒåŒ…å«äº†å½“å‰ *URL* è§£æå¾—åˆ°çš„ä¿¡æ¯ã€‚åŒ…å«å½“å‰çš„è·¯å¾„ï¼Œå‚æ•°ï¼Œ*query* å¯¹è±¡ç­‰ã€‚
>
> - *$route.path*ï¼šå­—ç¬¦ä¸²ï¼Œå¯¹åº”å½“å‰è·¯ç”±çš„è·¯å¾„ï¼Œæ€»æ˜¯è§£æä¸ºç»å¯¹è·¯å¾„ï¼Œå¦‚ "/foo/bar"ã€‚ 
> - *$route.params*ï¼š ä¸€ä¸ª key/value å¯¹è±¡ï¼ŒåŒ…å«äº† åŠ¨æ€ç‰‡æ®µ å’Œ å…¨åŒ¹é…ç‰‡æ®µï¼Œå¦‚æœæ²¡æœ‰è·¯ç”±å‚æ•°ï¼Œå°±æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ã€‚ 
> - *$route.query*ï¼šä¸€ä¸ª key/value å¯¹è±¡ï¼Œè¡¨ç¤º URL æŸ¥è¯¢å‚æ•°ã€‚ä¾‹å¦‚å¯¹äºè·¯å¾„ */foo?user=1*ï¼Œåˆ™æœ‰ *$route.query.user == 1*ï¼Œå¦‚æœæ²¡æœ‰æŸ¥è¯¢å‚æ•°ï¼Œåˆ™æ˜¯ä¸ªç©ºå¯¹è±¡ã€‚ 
> - *$route.hash*ï¼šå½“å‰è·¯ç”±çš„ hash å€¼ (ä¸å¸¦ #) ï¼Œå¦‚æœæ²¡æœ‰ *hash* å€¼ï¼Œåˆ™ä¸ºç©ºå­—ç¬¦ä¸²ã€‚
> - *$route.fullPath*ï¼šå®Œæˆè§£æåçš„ *URL*ï¼ŒåŒ…å«æŸ¥è¯¢å‚æ•°å’Œ *hash* çš„å®Œæ•´è·¯å¾„ã€‚ 
> - *$route.matched*ï¼šæ•°ç»„ï¼ŒåŒ…å«å½“å‰åŒ¹é…çš„è·¯å¾„ä¸­æ‰€åŒ…å«çš„æ‰€æœ‰ç‰‡æ®µæ‰€å¯¹åº”çš„é…ç½®å‚æ•°å¯¹è±¡ã€‚ 
> - *$route.name*ï¼šå½“å‰è·¯å¾„åå­— 
> - *$route.meta*ï¼šè·¯ç”±å…ƒä¿¡æ¯  
>
> *$route* å¯¹è±¡å‡ºç°åœ¨å¤šä¸ªåœ°æ–¹:
>
> - ç»„ä»¶å†…çš„ *this.$route* å’Œ *route watcher* å›è°ƒï¼ˆç›‘æµ‹å˜åŒ–å¤„ç†ï¼‰
> - *router.match(location)* çš„è¿”å›å€¼
> - *scrollBehavior* æ–¹æ³•çš„å‚æ•°
> - å¯¼èˆªé’©å­çš„å‚æ•°ï¼Œä¾‹å¦‚ *router.beforeEach* å¯¼èˆªå®ˆå«çš„é’©å­å‡½æ•°ä¸­ï¼Œ*to* å’Œ *from* éƒ½æ˜¯è¿™ä¸ªè·¯ç”±ä¿¡æ¯å¯¹è±¡ã€‚
>
> *$router* å¯¹è±¡æ˜¯å…¨å±€è·¯ç”±çš„å®ä¾‹ï¼Œæ˜¯ *router* æ„é€ æ–¹æ³•çš„å®ä¾‹ã€‚
>
> *$router* å¯¹è±¡å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š
>
> - *push*ï¼šå‘ *history* æ ˆæ·»åŠ ä¸€ä¸ªæ–°çš„è®°å½•
> - *go*ï¼šé¡µé¢è·¯ç”±è·³è½¬å‰è¿›æˆ–è€…åé€€
> - *replace*ï¼šæ›¿æ¢å½“å‰çš„é¡µé¢ï¼Œä¸ä¼šå‘ *history* æ ˆæ·»åŠ ä¸€ä¸ªæ–°çš„è®°å½•
>
> 
>
> ***vueRouter* æœ‰å“ªå‡ ç§å¯¼èˆªå®ˆå«ï¼Ÿ**
>
> - å…¨å±€å‰ç½®/é’©å­ï¼š*beforeEachã€beforeR-esolveã€afterEach*
>
> - è·¯ç”±ç‹¬äº«çš„å®ˆå«ï¼š*beforeEnter*
> - ç»„ä»¶å†…çš„å®ˆå«ï¼š*beforeRouteEnterã€beforeRouteUpdateã€beforeRouteLeave* 
>
> 
>
> **è§£é‡Šä¸€ä¸‹ *vueRouter* çš„å®Œæ•´çš„å¯¼èˆªè§£ææµç¨‹æ˜¯ä»€ä¹ˆ**
>
> ä¸€æ¬¡å®Œæ•´çš„å¯¼èˆªè§£ææµç¨‹å¦‚ä¸‹ï¼š
>
> 1. å¯¼èˆªè¢«è§¦å‘ã€‚
> 2. åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ç¦»å¼€å®ˆå«ã€‚
> 3. è°ƒç”¨å…¨å±€çš„ *beforeEach* å®ˆå«ã€‚
> 4. åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨ *beforeRouteUpdate* å®ˆå«ï¼ˆ*2.2+*ï¼‰ã€‚
> 5. åœ¨è·¯ç”±é…ç½®é‡Œè°ƒç”¨ *beforeEnter*ã€‚
> 6. è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚
> 7. åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ *beforeRouteEnter*ã€‚
> 8. è°ƒç”¨å…¨å±€çš„ *beforeResolve* å®ˆå«ï¼ˆ*2.5+*ï¼‰ã€‚
> 9. å¯¼èˆªè¢«ç¡®è®¤ã€‚
> 10. è°ƒç”¨å…¨å±€çš„ *afterEach* é’©å­ã€‚
> 11. è§¦å‘ *DOM* æ›´æ–°ã€‚
> 12. ç”¨åˆ›å»ºå¥½çš„å®ä¾‹è°ƒç”¨ *beforeRouteEnter* å®ˆå«ä¸­ä¼ ç»™ *next* çš„å›è°ƒå‡½æ•°ã€‚



### 12. ***vuex* æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆä½¿ç”¨å®ƒï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨åˆ° *vuex***

> å‚è€ƒç­”æ¡ˆï¼š
>
> ***vuex* æ˜¯ä»€ä¹ˆ**
>
> *vuex* æ˜¯ä¸€ä¸ªä¸“ä¸º *Vue* åº”ç”¨ç¨‹åºå¼€å‘çš„çŠ¶æ€ç®¡ç†å™¨ï¼Œé‡‡ç”¨é›†ä¸­å¼å­˜å‚¨ç®¡ç†åº”ç”¨çš„æ‰€æœ‰ç»„ä»¶çš„çŠ¶æ€ã€‚æ¯ä¸€ä¸ª *vuex* åº”ç”¨çš„æ ¸å¿ƒå°±æ˜¯ *store*ï¼ˆä»“åº“ï¼‰ã€‚â€œ*store*â€ åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒåŒ…å«ç€åº”ç”¨ä¸­å¤§éƒ¨åˆ†çš„çŠ¶æ€ (*state*)ã€‚
>
> **ä¸ºä»€ä¹ˆéœ€è¦ *vuex***
>
> ç”±äºç»„ä»¶åªç»´æŠ¤è‡ªèº«çš„çŠ¶æ€(*data*)ï¼Œç»„ä»¶åˆ›å»ºæ—¶æˆ–è€…è·¯ç”±åˆ‡æ¢æ—¶ï¼Œç»„ä»¶ä¼šè¢«åˆå§‹åŒ–ï¼Œä»è€Œå¯¼è‡´ *data* ä¹Ÿéšä¹‹é”€æ¯ã€‚
>
> **ä½¿ç”¨æ–¹æ³•**
>
> åœ¨ *main.js* å¼•å…¥ *store*ï¼Œæ³¨å…¥ã€‚åªç”¨æ¥è¯»å–çš„çŠ¶æ€é›†ä¸­æ”¾åœ¨ *store* ä¸­ï¼Œ æ”¹å˜çŠ¶æ€çš„æ–¹å¼æ˜¯æäº¤ *mutations*ï¼Œè¿™æ˜¯ä¸ªåŒæ­¥çš„äº‹ç‰©ï¼Œå¼‚æ­¥é€»è¾‘åº”è¯¥å°è£…åœ¨ *action* ä¸­ã€‚
>
> **ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šä½¿ç”¨åˆ° *vuex***
>
> å¦‚æœæ˜¯ *vue* çš„å°å‹åº”ç”¨ï¼Œé‚£ä¹ˆæ²¡æœ‰å¿…è¦ä½¿ç”¨ *vuex*ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ *vuex* åè€Œä¼šå¸¦æ¥è´Ÿæ‹…ã€‚ç»„ä»¶ä¹‹é—´çš„çŠ¶æ€ä¼ é€’ä½¿ç”¨ *props*ã€è‡ªå®šä¹‰äº‹ä»¶æ¥ä¼ é€’å³å¯ã€‚
>
> ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ° *vue* çš„å¤§å‹åº”ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ç±»ä¼¼äº *vuex* è¿™æ ·çš„é›†ä¸­ç®¡ç†çŠ¶æ€çš„çŠ¶æ€æœºæ¥ç®¡ç†æ‰€æœ‰ç»„ä»¶çš„çŠ¶æ€ã€‚ä¾‹å¦‚ç™»å½•çŠ¶æ€ã€åŠ å…¥è´­ç‰©è½¦ã€éŸ³ä¹æ’­æ”¾ç­‰ï¼Œæ€»ä¹‹åªè¦æ˜¯å¼€å‘ *vue* çš„å¤§å‹åº”ç”¨ï¼Œéƒ½æ¨èä½¿ç”¨ *vuex* æ¥ç®¡ç†æ‰€æœ‰ç»„ä»¶çŠ¶æ€ã€‚



### 13. **è¯´ä¸€ä¸‹ *v-if* ä¸ *v-show* çš„åŒºåˆ«**

> å‚è€ƒç­”æ¡ˆï¼š
>
> - å…±åŒç‚¹ï¼šéƒ½æ˜¯åŠ¨æ€æ˜¾ç¤º *DOM* å…ƒç´  
>
> - åŒºåˆ«ç‚¹:
>
>   - æ‰‹æ®µ
>
>     *v-if* æ˜¯åŠ¨æ€çš„å‘ *DOM* æ ‘å†…æ·»åŠ æˆ–è€…åˆ é™¤ *DOM* å…ƒç´ 
>
>     *v-show* æ˜¯é€šè¿‡è®¾ç½® *DOM* å…ƒç´ çš„ *display* æ ·å¼å±æ€§æ§åˆ¶æ˜¾éš
>
>   - ç¼–è¯‘è¿‡ç¨‹
>
>     *v-if*  åˆ‡æ¢æœ‰ä¸€ä¸ªå±€éƒ¨ç¼–è¯‘/å¸è½½çš„è¿‡ç¨‹ï¼Œåˆ‡æ¢è¿‡ç¨‹ä¸­åˆé€‚åœ°é”€æ¯å’Œé‡å»ºå†…éƒ¨çš„äº‹ä»¶ç›‘å¬å’Œå­ç»„ä»¶
>
>     *v-show* åªæ˜¯ç®€å•çš„åŸºäº *css* åˆ‡æ¢
>
>   - ç¼–è¯‘æ¡ä»¶
>
>     *v-if*  æ˜¯æƒ°æ€§çš„ï¼Œå¦‚æœåˆå§‹æ¡ä»¶ä¸ºå‡ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚åªæœ‰åœ¨æ¡ä»¶ç¬¬ä¸€æ¬¡å˜ä¸ºçœŸæ—¶æ‰å¼€å§‹å±€éƒ¨ç¼–è¯‘
>
>     *v-show* æ˜¯åœ¨ä»»ä½•æ¡ä»¶ä¸‹(é¦–æ¬¡æ¡ä»¶æ˜¯å¦ä¸ºçœŸ)éƒ½è¢«ç¼–è¯‘ï¼Œç„¶åè¢«ç¼“å­˜ï¼Œè€Œä¸” *DOM* å…ƒç´ ä¿ç•™
>
>   - æ€§èƒ½æ¶ˆè€—
>
>     *v-if*  æœ‰æ›´é«˜çš„åˆ‡æ¢æ¶ˆè€—
>
>     *v-show* æœ‰æ›´é«˜çš„åˆå§‹æ¸²æŸ“æ¶ˆè€—
>
>   - ä½¿ç”¨åœºæ™¯
>
>     *v-if*  é€‚åˆè¿è¥æ¡ä»¶ä¸å¤§å¯èƒ½æ”¹å˜ 
>
>     *v-show* é€‚åˆé¢‘ç¹åˆ‡æ¢



### 14. **å¦‚ä½•è®© *CSS* å€¼åœ¨å½“å‰çš„ç»„ä»¶ä¸­èµ·ä½œç”¨**

> å‚è€ƒç­”æ¡ˆï¼š
>
> åœ¨ *vue* æ–‡ä»¶ä¸­çš„ *style* æ ‡ç­¾ä¸Šï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š*scoped*ã€‚å½“ä¸€ä¸ª style æ ‡ç­¾æ‹¥æœ‰ *scoped* å±æ€§æ—¶ï¼Œå®ƒçš„ *CSS* æ ·å¼å°±åªèƒ½ä½œç”¨äºå½“å‰çš„ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æ ·å¼åªèƒ½é€‚ç”¨äºå½“å‰ç»„ä»¶å…ƒç´ ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œå¯ä»¥ä½¿å¾—ç»„ä»¶ä¹‹é—´çš„æ ·å¼ä¸äº’ç›¸æ±¡æŸ“ã€‚å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸­çš„æ‰€æœ‰ *style* æ ‡ç­¾å…¨éƒ¨åŠ ä¸Šäº† *scoped*ï¼Œç›¸å½“äºå®ç°äº†æ ·å¼çš„æ¨¡å—åŒ–ã€‚
>
> ***scoped* çš„å®ç°åŸç†**
>
> *vue* ä¸­çš„ *scoped* å±æ€§çš„æ•ˆæœä¸»è¦é€šè¿‡ *PostCSS* è½¬è¯‘å®ç°çš„ã€‚*PostCSS* ç»™ä¸€ä¸ªç»„ä»¶ä¸­çš„æ‰€æœ‰ *DOM* æ·»åŠ äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åŠ¨æ€å±æ€§ï¼Œç„¶åï¼Œç»™ *CSS* é€‰æ‹©å™¨é¢å¤–æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„å±æ€§é€‰æ‹©å™¨æ¥é€‰æ‹©è¯¥ç»„ä»¶ä¸­ *DOM*ï¼Œè¿™ç§åšæ³•ä½¿å¾—æ ·å¼åªä½œç”¨äºå«æœ‰è¯¥å±æ€§çš„ *DOM*ï¼Œå³ç»„ä»¶å†…éƒ¨ *DOM*ã€‚
>
> ä¾‹å¦‚ï¼š
>
> è½¬è¯‘å‰
>
> ```js
> <template>
> <div class="example">hi</div>
> </template>
> 
> <style scoped>
> .example {
> color: red;
> }
> </style>
> ```
>
> è½¬è¯‘åï¼š
>
> ```js
> <template>
> <div class="example" data-v-5558831a>hi</div>
> </template>
> 
> <style>
> .example[data-v-5558831a] {
> color: red;
> }
> </style>
> ```



### 15. ***keep-alive* ç›¸å…³**

- keep-aliveçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ
- ä¸keep-aliveç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°æ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šè¿›è¡Œä½¿ç”¨
- keep-aliveçš„å¸¸ç”¨å±æ€§æœ‰å“ªäº›

> å‚è€ƒç­”æ¡ˆï¼š
>
> keep-alive ç»„ä»¶æ˜¯ vue çš„å†…ç½®ç»„ä»¶ï¼Œç”¨äºç¼“å­˜å†…éƒ¨ç»„ä»¶å®ä¾‹ã€‚è¿™æ ·åšçš„ç›®çš„åœ¨äºï¼Œkeep-alive å†…éƒ¨çš„ç»„ä»¶åˆ‡å›æ—¶ï¼Œä¸ç”¨é‡æ–°åˆ›å»ºç»„ä»¶å®ä¾‹ï¼Œè€Œç›´æ¥ä½¿ç”¨ç¼“å­˜ä¸­çš„å®ä¾‹ï¼Œä¸€æ–¹é¢èƒ½å¤Ÿé¿å…åˆ›å»ºç»„ä»¶å¸¦æ¥çš„å¼€é”€ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥ä¿ç•™ç»„ä»¶çš„çŠ¶æ€ã€‚
>
> keep-alive å…·æœ‰ include å’Œ exclude å±æ€§ï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥æ§åˆ¶å“ªäº›ç»„ä»¶è¿›å…¥ç¼“å­˜ã€‚å¦å¤–å®ƒè¿˜æä¾›äº† max å±æ€§ï¼Œé€šè¿‡å®ƒå¯ä»¥è®¾ç½®æœ€å¤§ç¼“å­˜æ•°ï¼Œå½“ç¼“å­˜çš„å®ä¾‹è¶…è¿‡è¯¥æ•°æ—¶ï¼Œvue ä¼šç§»é™¤æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„ç»„ä»¶ç¼“å­˜ã€‚
>
> å—keep-aliveçš„å½±å“ï¼Œå…¶å†…éƒ¨æ‰€æœ‰åµŒå¥—çš„ç»„ä»¶éƒ½å…·æœ‰ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ activated å’Œ deactivatedï¼Œå®ƒä»¬åˆ†åˆ«åœ¨ç»„ä»¶æ¿€æ´»å’Œå¤±æ´»æ—¶è§¦å‘ã€‚ç¬¬ä¸€æ¬¡ activated è§¦å‘æ˜¯åœ¨ mounted ä¹‹å
>
> åœ¨å…·ä½“çš„å®ç°ä¸Šï¼Œkeep-alive åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª key æ•°ç»„å’Œä¸€ä¸ªç¼“å­˜å¯¹è±¡
>
> ```js
> // keep-alive å†…éƒ¨çš„å£°æ˜å‘¨æœŸå‡½æ•°
> created () {
>  this.cache = Object.create(null)
>  this.keys = []
> }
> ```
>
> key æ•°ç»„è®°å½•ç›®å‰ç¼“å­˜çš„ç»„ä»¶ key å€¼ï¼Œå¦‚æœç»„ä»¶æ²¡æœ‰æŒ‡å®š key å€¼ï¼Œåˆ™ä¼šä¸ºå…¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ key å€¼
>
> cache å¯¹è±¡ä»¥ key å€¼ä¸ºé”®ï¼Œvnode ä¸ºå€¼ï¼Œç”¨äºç¼“å­˜ç»„ä»¶å¯¹åº”çš„è™šæ‹Ÿ DOM
>
> åœ¨ keep-alive çš„æ¸²æŸ“å‡½æ•°ä¸­ï¼Œå…¶åŸºæœ¬é€»è¾‘æ˜¯åˆ¤æ–­å½“å‰æ¸²æŸ“çš„ vnode æ˜¯å¦æœ‰å¯¹åº”çš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œä»ç¼“å­˜ä¸­è¯»å–åˆ°å¯¹åº”çš„ç»„ä»¶å®ä¾‹ï¼›å¦‚æœæ²¡æœ‰åˆ™å°†å…¶ç¼“å­˜ã€‚
>
> å½“ç¼“å­˜æ•°é‡è¶…è¿‡ max æ•°å€¼æ—¶ï¼Œkeep-alive ä¼šç§»é™¤æ‰ key æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚



### 16. ***Vue* ä¸­å¦‚ä½•è¿›è¡Œç»„ä»¶çš„ä½¿ç”¨ï¼Ÿ*Vue* å¦‚ä½•å®ç°å…¨å±€ç»„ä»¶çš„æ³¨å†Œï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> è¦ä½¿ç”¨ç»„ä»¶ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨ *import* æ¥å¼•å…¥ç»„ä»¶ï¼Œç„¶ååœ¨ *components* å±æ€§ä¸­æ³¨å†Œç»„ä»¶ï¼Œä¹‹åå°±å¯ä»¥åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ç»„ä»¶äº†ã€‚
>
> å¯ä»¥ä½¿ç”¨ *Vue.component* æ–¹æ³•æ¥å®ç°å…¨å±€ç»„ä»¶çš„æ³¨å†Œã€‚



### 17. ***vue-cli* å·¥ç¨‹ç›¸å…³**

- æ„å»º *vue-cli* å·¥ç¨‹éƒ½ç”¨åˆ°äº†å“ªäº›æŠ€æœ¯ï¼Ÿä»–ä»¬çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
- *vue-cli* å·¥ç¨‹å¸¸ç”¨çš„ *npm* å‘½ä»¤æœ‰å“ªäº›ï¼Ÿ

> å‚è€ƒç­”æ¡ˆï¼š
>
> **æ„å»º *vue-cli* å·¥ç¨‹éƒ½ç”¨åˆ°äº†å“ªäº›æŠ€æœ¯ï¼Ÿä»–ä»¬çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> 1. vue.jsï¼švue-cli å·¥ç¨‹çš„æ ¸å¿ƒï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯åŒå‘æ•°æ®ç»‘å®šå’Œç»„ä»¶ç³»ç»Ÿã€‚
> 2. vue-routerï¼švue å®˜æ–¹æ¨èä½¿ç”¨çš„è·¯ç”±æ¡†æ¶ã€‚
> 3. vuexï¼šä¸“ä¸º Vue.js åº”ç”¨é¡¹ç›®å¼€å‘çš„çŠ¶æ€ç®¡ç†å™¨ï¼Œä¸»è¦ç”¨äºç»´æŠ¤ vue ç»„ä»¶é—´å…±ç”¨çš„ä¸€äº› å˜é‡ å’Œ æ–¹æ³•ã€‚
> 4. axiosï¼ˆæˆ–è€… fetchã€ajaxï¼‰ï¼šç”¨äºå‘èµ· GET ã€æˆ– POST ç­‰ httpè¯·æ±‚ï¼ŒåŸºäº Promise è®¾è®¡ã€‚
> 5. vuxç­‰ï¼šä¸€ä¸ªä¸“ä¸ºvueè®¾è®¡çš„ç§»åŠ¨ç«¯UIç»„ä»¶åº“ã€‚
> 6. webpackï¼šæ¨¡å—åŠ è½½å’Œvue-cliå·¥ç¨‹æ‰“åŒ…å™¨ã€‚
> 7. eslintï¼šä»£ç è§„èŒƒå·¥å…·
>
> 
>
> ***vue-cli* å·¥ç¨‹å¸¸ç”¨çš„ *npm* å‘½ä»¤æœ‰å“ªäº›ï¼Ÿ**
>
> ä¸‹è½½ node_modules èµ„æºåŒ…çš„å‘½ä»¤ï¼šnpm install
>
> å¯åŠ¨ vue-cli å¼€å‘ç¯å¢ƒçš„ npmå‘½ä»¤ï¼šnpm run dev
>
> vue-cli ç”Ÿæˆ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²èµ„æº çš„ npmå‘½ä»¤ï¼šnpm run build
>
> ç”¨äºæŸ¥çœ‹ vue-cli ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²èµ„æºæ–‡ä»¶å¤§å°çš„ npmå‘½ä»¤ï¼šnpm run build --report



### 18. ***nextTick* çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä»–çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ä½œç”¨ï¼š*vue* æ›´æ–° *DOM* æ˜¯å¼‚æ­¥æ›´æ–°çš„ï¼Œæ•°æ®å˜åŒ–ï¼Œ*DOM* çš„æ›´æ–°ä¸ä¼šé©¬ä¸Šå®Œæˆï¼Œ*nextTick* çš„å›è°ƒæ˜¯åœ¨ä¸‹æ¬¡ *DOM* æ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œçš„å»¶è¿Ÿå›è°ƒã€‚
>
> å®ç°åŸç†ï¼š*nextTick* ä¸»è¦ä½¿ç”¨äº†å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚æ ¹æ®æ‰§è¡Œç¯å¢ƒåˆ†åˆ«å°è¯•é‡‡ç”¨
>
> - *Promise*ï¼šå¯ä»¥å°†å‡½æ•°å»¶è¿Ÿåˆ°å½“å‰å‡½æ•°è°ƒç”¨æ ˆæœ€æœ«ç«¯
> - *MutationObserver* ï¼šæ˜¯ *H5* æ–°åŠ çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…¶åŠŸèƒ½æ˜¯ç›‘å¬ *DOM* èŠ‚ç‚¹çš„å˜åŠ¨ï¼Œåœ¨æ‰€æœ‰ *DOM* å˜åŠ¨å®Œæˆåï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°
> - *setImmediate*ï¼šç”¨äºä¸­æ–­é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œå¹¶åœ¨æµè§ˆå™¨å®Œæˆå…¶ä»–æ“ä½œï¼ˆå¦‚äº‹ä»¶å’Œæ˜¾ç¤ºæ›´æ–°ï¼‰åç«‹å³è¿è¡Œå›è°ƒå‡½æ•°
> - å¦‚æœä»¥ä¸Šéƒ½ä¸è¡Œåˆ™é‡‡ç”¨ *setTimeout* æŠŠå‡½æ•°å»¶è¿Ÿåˆ° DOM æ›´æ–°ä¹‹åå†ä½¿ç”¨
>
> åŸå› æ˜¯å®ä»»åŠ¡æ¶ˆè€—å¤§äºå¾®ä»»åŠ¡ï¼Œä¼˜å…ˆä½¿ç”¨å¾®ä»»åŠ¡ï¼Œæœ€åä½¿ç”¨æ¶ˆè€—æœ€å¤§çš„å®ä»»åŠ¡ã€‚



### 19. **è¯´ä¸€ä¸‹ *Vue SSR* çš„å®ç°åŸç†**

> å‚è€ƒç­”æ¡ˆï¼š
>
> - *app.js* ä½œä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å…¬ç”¨å…¥å£ï¼Œå¯¼å‡º *Vue* æ ¹å®ä¾‹ï¼Œä¾›å®¢æˆ·ç«¯ *entry* ä¸æœåŠ¡ç«¯ *entry* ä½¿ç”¨ã€‚å®¢æˆ·ç«¯ *entry* ä¸»è¦ä½œç”¨æŒ‚è½½åˆ° *DOM* ä¸Šï¼ŒæœåŠ¡ç«¯ *entry* é™¤äº†åˆ›å»ºå’Œè¿”å›å®ä¾‹ï¼Œè¿˜éœ€è¦è¿›è¡Œè·¯ç”±åŒ¹é…ä¸æ•°æ®é¢„è·å–ã€‚
> - *webpack* ä¸ºå®¢æœç«¯æ‰“åŒ…ä¸€ä¸ª *ClientBundle*ï¼Œä¸ºæœåŠ¡ç«¯æ‰“åŒ…ä¸€ä¸ª *ServerBundle*ã€‚
> - æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ® *url*ï¼ŒåŠ è½½ç›¸åº”ç»„ä»¶ï¼Œè·å–å’Œè§£æå¼‚æ­¥æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªè¯»å– *Server Bundle* çš„ *BundleRenderer*ï¼Œç„¶åç”Ÿæˆ *html* å‘é€ç»™å®¢æˆ·ç«¯ã€‚
> - å®¢æˆ·ç«¯æ··åˆï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ä»æœåŠ¡ç«¯ä¼ æ¥çš„ *DOM* ä¸è‡ªå·±çš„ç”Ÿæˆçš„ *DOM* è¿›è¡Œå¯¹æ¯”ï¼ŒæŠŠä¸ç›¸åŒçš„ *DOM* æ¿€æ´»ï¼Œä½¿å…¶å¯ä»¥èƒ½å¤Ÿå“åº”åç»­å˜åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå®¢æˆ·ç«¯æ¿€æ´»ï¼ˆä¹Ÿå°±æ˜¯è½¬æ¢ä¸ºå•é¡µåº”ç”¨ï¼‰ã€‚ä¸ºç¡®ä¿æ··åˆæˆåŠŸï¼Œå®¢æˆ· ç«¯ä¸æœåŠ¡å™¨ç«¯éœ€è¦å…±äº«åŒä¸€å¥—æ•°æ®ã€‚åœ¨æœåŠ¡ç«¯ï¼Œå¯ä»¥åœ¨æ¸²æŸ“ä¹‹å‰è·å–æ•°æ®ï¼Œå¡«å……åˆ° *store* é‡Œï¼Œè¿™æ ·ï¼Œåœ¨å®¢æˆ·ç«¯æŒ‚è½½åˆ° *DOM* ä¹‹å‰ï¼Œå¯ä»¥ç›´æ¥ä» *store* é‡Œå–æ•°æ®ã€‚é¦–å±çš„åŠ¨æ€æ•°æ®é€šè¿‡ *window.\__INITIAL_STATE__* å‘é€åˆ°å®¢æˆ·ç«¯
> - *VueSSR* çš„åŸç†ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡ *vue-server-renderer* æŠŠ *Vue* çš„ç»„ä»¶è¾“å‡ºæˆä¸€ä¸ªå®Œæ•´ *HTML*ï¼Œè¾“å‡ºåˆ°å®¢æˆ·ç«¯ï¼Œåˆ°è¾¾å®¢æˆ·ç«¯åé‡æ–°å±•å¼€ä¸ºä¸€ä¸ªå•é¡µåº”ç”¨ã€‚



### 20. ***Vue* ç»„ä»¶çš„ *data* ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯å‡½æ•°**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ç»„ä»¶ä¸­çš„ *data* å†™æˆä¸€ä¸ªå‡½æ•°ï¼Œæ•°æ®ä»¥å‡½æ•°è¿”å›å€¼å½¢å¼å®šä¹‰ã€‚è¿™æ ·æ¯å¤ç”¨ä¸€æ¬¡ç»„ä»¶ï¼Œå°±ä¼šè¿”å›ä¸€ä»½æ–°çš„ *data*ï¼Œç±»ä¼¼äºç»™æ¯ä¸ªç»„ä»¶å®ä¾‹åˆ›å»ºä¸€ä¸ªç§æœ‰çš„æ•°æ®ç©ºé—´ï¼Œè®©å„ä¸ªç»„ä»¶å®ä¾‹ç»´æŠ¤å„è‡ªçš„æ•°æ®ã€‚è€Œå•çº¯çš„å†™æˆå¯¹è±¡å½¢å¼ï¼Œå°±ä½¿å¾—æ‰€æœ‰ç»„ä»¶å®ä¾‹å…±ç”¨äº†ä¸€ä»½ *data*ï¼Œå°±ä¼šé€ æˆä¸€ä¸ªå˜äº†å…¨éƒ½ä¼šå˜çš„ç»“æœã€‚



### 21. **è¯´ä¸€ä¸‹ *Vue* çš„ *computed* çš„å®ç°åŸç†**

> å‚è€ƒç­”æ¡ˆï¼š
>
> å½“ç»„ä»¶å®ä¾‹è§¦å‘ç”Ÿå‘½å‘¨æœŸå‡½æ•° *beforeCreate* åï¼Œå®ƒä¼šåšä¸€ç³»åˆ—äº‹æƒ…ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å¯¹ *computed* çš„å¤„ç†ã€‚
>
> å®ƒä¼šéå† *computed* é…ç½®ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œä¸ºæ¯ä¸€ä¸ªå±æ€§åˆ›å»ºä¸€ä¸ª *Watcher* å¯¹è±¡ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„æœ¬è´¨å…¶å®å°±æ˜¯ *computed* é…ç½®ä¸­çš„ *getter*ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ*getter* è¿è¡Œè¿‡ç¨‹ä¸­å°±ä¼šæ”¶é›†ä¾èµ–
>
> ä½†æ˜¯å’Œæ¸²æŸ“å‡½æ•°ä¸åŒï¼Œä¸ºè®¡ç®—å±æ€§åˆ›å»ºçš„ *Watcher* ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œå› ä¸ºè¦è€ƒè™‘åˆ°è¯¥è®¡ç®—å±æ€§æ˜¯å¦ä¼šè¢«æ¸²æŸ“å‡½æ•°ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ï¼Œå°±ä¸ä¼šå¾—åˆ°æ‰§è¡Œã€‚å› æ­¤ï¼Œåœ¨åˆ›å»º *Watcher* çš„æ—¶å€™ï¼Œå®ƒä½¿ç”¨äº† *lazy* é…ç½®ï¼Œ*lazy* é…ç½®å¯ä»¥è®© *Watcher* ä¸ä¼šç«‹å³æ‰§è¡Œã€‚
>
> æ”¶åˆ° *lazy* çš„å½±å“ï¼Œ*Watcher* å†…éƒ¨ä¼šä¿å­˜ä¸¤ä¸ªå…³é”®å±æ€§æ¥å®ç°ç¼“å­˜ï¼Œä¸€ä¸ªæ˜¯ *value*ï¼Œä¸€ä¸ªæ˜¯ *dirty*
>
> *value* å±æ€§ç”¨äºä¿å­˜ *Watcher* è¿è¡Œçš„ç»“æœï¼Œå— *lazy* çš„å½±å“ï¼Œè¯¥å€¼åœ¨æœ€å¼€å§‹æ˜¯ *undefined*
>
> *dirty* å±æ€§ç”¨äºæŒ‡ç¤ºå½“å‰çš„ *value* æ˜¯å¦å·²ç»è¿‡æ—¶äº†ï¼Œå³æ˜¯å¦ä¸ºè„å€¼ï¼Œå— *lazy* çš„å½±å“ï¼Œè¯¥å€¼åœ¨æœ€å¼€å§‹æ˜¯ *true*
>
> Watcher åˆ›å»ºå¥½åï¼Œvue ä¼šä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œå°†è®¡ç®—å±æ€§æŒ‚è½½åˆ°ç»„ä»¶å®ä¾‹ä¸­
>
> å½“è¯»å–è®¡ç®—å±æ€§æ—¶ï¼Œ*vue* æ£€æŸ¥å…¶å¯¹åº”çš„ *Watcher* æ˜¯å¦æ˜¯è„å€¼ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿è¡Œå‡½æ•°ï¼Œè®¡ç®—ä¾èµ–ï¼Œå¹¶å¾—åˆ°å¯¹åº”çš„å€¼ï¼Œä¿å­˜åœ¨ *Watcher* çš„ *value* ä¸­ï¼Œç„¶åè®¾ç½® *dirty* ä¸º *false*ï¼Œç„¶åè¿”å›ã€‚
>
> å¦‚æœ *dirty* ä¸º *false*ï¼Œåˆ™ç›´æ¥è¿”å› *watcher* çš„ *value*
>
> å·§å¦™çš„æ˜¯ï¼Œåœ¨ä¾èµ–æ”¶é›†æ—¶ï¼Œè¢«ä¾èµ–çš„æ•°æ®ä¸ä»…ä¼šæ”¶é›†åˆ°è®¡ç®—å±æ€§çš„ *Watcher*ï¼Œè¿˜ä¼šæ”¶é›†åˆ°ç»„ä»¶çš„ *Watcher*
>
> å½“è®¡ç®—å±æ€§çš„ä¾èµ–å˜åŒ–æ—¶ï¼Œä¼šå…ˆè§¦å‘è®¡ç®—å±æ€§çš„ *Watcher* æ‰§è¡Œï¼Œæ­¤æ—¶ï¼Œå®ƒåªéœ€è®¾ç½® *dirty* ä¸º *true* å³å¯ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚
>
> ç”±äºä¾èµ–åŒæ—¶ä¼šæ”¶é›†åˆ°ç»„ä»¶çš„ *Watcher*ï¼Œå› æ­¤ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œè€Œé‡æ–°æ¸²æŸ“æ—¶åˆè¯»å–åˆ°äº†è®¡ç®—å±æ€§ï¼Œç”±äºè®¡ç®—å±æ€§ç›®å‰å·²ä¸º dirtyï¼Œå› æ­¤ä¼šé‡æ–°è¿è¡Œ *getter* è¿›è¡Œè¿ç®—
>
> è€Œå¯¹äºè®¡ç®—å±æ€§çš„ *setter*ï¼Œåˆ™æå…¶ç®€å•ï¼Œå½“è®¾ç½®è®¡ç®—å±æ€§æ—¶ï¼Œç›´æ¥è¿è¡Œ *setter* å³å¯ã€‚



### 22. **è¯´ä¸€ä¸‹ *Vue complier* çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> åœ¨ä½¿ç”¨ vue çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºæˆ‘ä»¬çš„ HTML é¡µé¢ï¼Œç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿæ˜¯å¤§å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨æ¨¡æ¿ template çš„æ–¹å¼ï¼Œå› ä¸ºè¿™æ›´æ˜“è¯»æ˜“æ‡‚ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„æ–¹æ³•ï¼›ç¬¬äºŒç§æƒ…å†µæ˜¯ä½¿ç”¨ render å‡½æ•°æ¥ç”Ÿæˆ HTMLï¼Œå®ƒæ¯” template æ›´æ¥è¿‘æœ€ç»ˆç»“æœã€‚
>
> complier çš„ä¸»è¦ä½œç”¨æ˜¯è§£ææ¨¡æ¿ï¼Œç”Ÿæˆæ¸²æŸ“æ¨¡æ¿çš„ *render*ï¼Œ è€Œ *render* çš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿæˆ *VNode*
>
> complier ä¸»è¦åˆ†ä¸º 3 å¤§å—ï¼š
>
> - parseï¼šæ¥å— template åŸå§‹æ¨¡æ¿ï¼ŒæŒ‰ç€æ¨¡æ¿çš„èŠ‚ç‚¹å’Œæ•°æ®ç”Ÿæˆå¯¹åº”çš„ ast
> - optimizeï¼šéå† ast çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ‡è®°é™æ€èŠ‚ç‚¹ï¼Œè¿™æ ·å°±çŸ¥é“å“ªéƒ¨åˆ†ä¸ä¼šå˜åŒ–ï¼Œäºæ˜¯åœ¨é¡µé¢éœ€è¦æ›´æ–°æ—¶ï¼Œé€šè¿‡ diff å‡å°‘å»å¯¹æ¯”è¿™éƒ¨åˆ†DOMï¼Œæå‡æ€§èƒ½
> - generate æŠŠå‰ä¸¤æ­¥ç”Ÿæˆå®Œå–„çš„ astï¼Œç»„æˆ render å­—ç¬¦ä¸²ï¼Œç„¶åå°† render å­—ç¬¦ä¸²é€šè¿‡ new Function çš„æ–¹å¼è½¬æ¢æˆæ¸²æŸ“å‡½æ•°



### 23. ***vue* å¦‚ä½•å¿«é€Ÿå®šä½é‚£ä¸ªç»„ä»¶å‡ºç°æ€§èƒ½é—®é¢˜çš„**

> å‚è€ƒç­”æ¡ˆï¼š
>
> â½¤ *timeline* â¼¯å…·ã€‚ é€šè¿‡ *timeline* æ¥æŸ¥çœ‹æ¯ä¸ªå‡½æ•°çš„è°ƒâ½¤æ—¶å¸¸ï¼Œå®šä½å‡ºå“ªä¸ªå‡½æ•°çš„é—®é¢˜ï¼Œä»â½½èƒ½åˆ¤æ–­å“ªä¸ªç»„ä»¶å‡ºäº†é—®é¢˜ã€‚



### 24. ***Proxy* ç›¸æ¯” *defineProperty* çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue3.x* æ”¹ç”¨ *Proxy* æ›¿ä»£ *Object.defineProperty*
>
> åŸå› åœ¨äº *Object.defineProperty* æœ¬èº«å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼š
>
> - *Object.defineProperty* åªèƒ½åŠ«æŒå¯¹è±¡å±æ€§çš„ *getter* å’Œ *setter* æ–¹æ³•ã€‚
> - *Object.definedProperty* ä¸æ”¯æŒæ•°ç»„(å¯ä»¥ç›‘å¬æ•°ç»„,ä¸è¿‡æ•°ç»„æ–¹æ³•æ— æ³•ç›‘å¬è‡ªå·±é‡å†™)ï¼Œæ›´å‡†ç¡®çš„è¯´æ˜¯ä¸æ”¯æŒæ•°ç»„çš„å„ç§ *API*(æ‰€ä»¥ *Vue* é‡å†™äº†æ•°ç»„æ–¹æ³•ã€‚
>
> è€Œç›¸æ¯”  *Object.defineProperty*ï¼Œ*Proxy* çš„ä¼˜ç‚¹åœ¨äºï¼š
>
> - *Proxy* æ˜¯ç›´æ¥ä»£ç†åŠ«æŒæ•´ä¸ªå¯¹è±¡ã€‚
> - *Proxy* å¯ä»¥ç›´æ¥ç›‘å¬å¯¹è±¡å’Œæ•°ç»„çš„å˜åŒ–ï¼Œå¹¶ä¸”æœ‰å¤šè¾¾ *13* ç§æ‹¦æˆªæ–¹æ³•ã€‚
>
> ç›®å‰ï¼Œ*Object.definedProperty* å”¯ä¸€æ¯” *Proxy* å¥½çš„ä¸€ç‚¹å°±æ˜¯å…¼å®¹æ€§ï¼Œä¸è¿‡ *Proxy* æ–°æ ‡å‡†ä¹Ÿå—åˆ°æµè§ˆå™¨å‚å•†é‡ç‚¹æŒç»­çš„æ€§èƒ½ä¼˜åŒ–å½“ä¸­ã€‚



### 25. ***Vue* ä¸ *Angular* ä»¥åŠ *React* çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> è¿™ç§é¢˜ç›®æ˜¯å¼€æ”¾æ€§é¢˜ç›®ï¼Œä¸€èˆ¬æ˜¯é¢è¯•è¿‡ç¨‹ä¸­é¢è¯•å®˜å£å¤´æ¥æé—®ï¼Œä¸å¤ªå¯èƒ½å‡ºç°åœ¨ç¬”è¯•è¯•å·é‡Œé¢ã€‚
>
> å…³äº *Vue* å’Œå…¶ä»–æ¡†æ¶çš„ä¸åŒï¼Œå®˜æ–¹ä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡æ¡£ï¼Œä»æ€§èƒ½ã€ä½“ç§¯ã€çµæ´»æ€§ç­‰å¤šä¸ªæ–¹é¢æ¥è¿›è¡Œäº†è¯´æ˜ã€‚
>
> è¯¦ç»†å¯ä»¥å‚é˜…ï¼š*https://cn.vuejs.org/v2/guide/comparison.html*
>
> å»ºè®®é¢è¯•å‰é€šè¯»ä¸€éè¯¥ç¯‡æ–‡æ¡£ï¼Œç„¶åè¿›è¡Œé€‚å½“çš„æ€»ç»“ã€‚



### 26. **è¯´ä¸€ä¸‹ *watch* ä¸ *computed* çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠä»–ä»¬çš„ä½¿ç”¨åœºæ™¯åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> åŒºåˆ«ï¼š
>
> 1. éƒ½æ˜¯è§‚å¯Ÿæ•°æ®å˜åŒ–çš„ï¼ˆç›¸åŒï¼‰
> 2. è®¡ç®—å±æ€§å°†ä¼šæ··å…¥åˆ° vue çš„å®ä¾‹ä¸­ï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬è‡ªå®šä¹‰å˜é‡ï¼›watch ç›‘å¬ data ã€props é‡Œé¢æ•°æ®çš„å˜åŒ–ï¼›
> 3. computed æœ‰ç¼“å­˜ï¼Œå®ƒä¾èµ–çš„å€¼å˜äº†æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œwatch æ²¡æœ‰ï¼›
> 4. watch æ”¯æŒå¼‚æ­¥ï¼Œcomputed ä¸æ”¯æŒï¼›
> 5. watch æ˜¯ä¸€å¯¹å¤šï¼ˆç›‘å¬æŸä¸€ä¸ªå€¼å˜åŒ–ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œï¼‰ï¼›computed æ˜¯å¤šå¯¹ä¸€ï¼ˆç›‘å¬å±æ€§ä¾èµ–äºå…¶ä»–å±æ€§ï¼‰
> 6. watch ç›‘å¬å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æœ€æ–°å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯è¾“å…¥ä¹‹å‰çš„å€¼ï¼›
> 7. computed å±æ€§æ˜¯å‡½æ•°æ—¶ï¼Œéƒ½æœ‰ get å’Œ set æ–¹æ³•ï¼Œé»˜è®¤èµ° get æ–¹æ³•ï¼Œget å¿…é¡»æœ‰è¿”å›å€¼ï¼ˆreturnï¼‰
>
> watch çš„ å‚æ•°ï¼š
>
> - deepï¼šæ·±åº¦ç›‘å¬
> - immediate ï¼šç»„ä»¶åŠ è½½ç«‹å³è§¦å‘å›è°ƒå‡½æ•°æ‰§è¡Œ
>
> computed ç¼“å­˜åŸç†ï¼š
>
> conputedæœ¬è´¨æ˜¯ä¸€ä¸ªæƒ°æ€§çš„è§‚å¯Ÿè€…ï¼›å½“è®¡ç®—æ•°æ®å­˜åœ¨äº data æˆ–è€… propsé‡Œæ—¶ä¼šè¢«è­¦å‘Šï¼›
>
> vue åˆæ¬¡è¿è¡Œä¼šå¯¹ computed å±æ€§åšåˆå§‹åŒ–å¤„ç†ï¼ˆinitComputedï¼‰ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ä¼šå¯¹æ¯ä¸€ä¸ª computed å±æ€§ç”¨ watcher åŒ…è£…èµ·æ¥ ï¼Œè¿™é‡Œé¢ä¼šç”Ÿæˆä¸€ä¸ª dirty å±æ€§å€¼ä¸º trueï¼›ç„¶åæ‰§è¡Œ defineComputed å‡½æ•°æ¥è®¡ç®—ï¼Œè®¡ç®—ä¹‹åä¼šå°† dirty å€¼å˜ä¸º falseï¼Œè¿™é‡Œä¼šæ ¹æ® dirty å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—ï¼›å¦‚æœå±æ€§ä¾èµ–çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œcomputed çš„ watcher ä¼šæŠŠ dirty å˜ä¸º trueï¼Œè¿™æ ·å°±ä¼šé‡æ–°è®¡ç®— computed å±æ€§çš„å€¼ã€‚



### 27. ***scoped* æ˜¯å¦‚ä½•å®ç°æ ·å¼ç©¿é€çš„ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> é¦–å…ˆè¯´ä¸€ä¸‹ä»€ä¹ˆåœºæ™¯ä¸‹éœ€è¦ *scoped* æ ·å¼ç©¿é€ã€‚
>
> åœ¨å¾ˆå¤šé¡¹ç›®ä¸­ï¼Œä¼šå‡ºç°è¿™ä¹ˆä¸€ç§æƒ…å†µï¼Œå³ï¼šå¼•ç”¨äº†ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œéœ€è¦åœ¨ç»„ä»¶ä¸­å±€éƒ¨ä¿®æ”¹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„æ ·å¼ï¼Œè€Œåˆä¸æƒ³å»é™¤ *scoped* å±æ€§é€ æˆç»„ä»¶ä¹‹é—´çš„æ ·å¼æ±¡æŸ“ã€‚æ­¤æ—¶åªèƒ½é€šè¿‡ç‰¹æ®Šçš„æ–¹å¼ï¼Œç©¿é€ *scoped*ã€‚
>
> æœ‰ä¸‰ç§å¸¸ç”¨çš„æ–¹æ³•æ¥å®ç°æ ·å¼ç©¿é€ã€‚
>
> **æ–¹æ³•ä¸€**
>
> ä½¿ç”¨ *::v-deep* æ“ä½œç¬¦( >>> çš„åˆ«å)
>
> å¦‚æœå¸Œæœ› *scoped* æ ·å¼ä¸­çš„ä¸€ä¸ªé€‰æ‹©å™¨èƒ½å¤Ÿä½œç”¨å¾—â€œæ›´æ·±â€ï¼Œä¾‹å¦‚å½±å“å­ç»„ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ >>> æ“ä½œç¬¦ï¼š
>
> ```js
> <style scoped>
>  .a >>> .b { /* ... */ }
> </style>
> ```
>
> ä¸Šè¿°ä»£ç å°†ä¼šç¼–è¯‘æˆï¼š
>
> ```js
> .a[data-v-f3f3eg9] .b { /* ... */ }
> ```
>
> åé¢çš„ç±»åæ²¡æœ‰ *data* å±æ€§ï¼Œæ‰€ä»¥èƒ½é€‰åˆ°å­ç»„ä»¶é‡Œé¢çš„ç±»åã€‚
>
> æœ‰äº›åƒ *Sass* ä¹‹ç±»çš„é¢„å¤„ç†å™¨æ— æ³•æ­£ç¡®è§£æ >>>ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ *::v-deep* æ“ä½œç¬¦æ¥ä»£æ›¿ã€‚
>
> **æ–¹æ³•äºŒ**
>
> å®šä¹‰ä¸€ä¸ªå«æœ‰ *scoped* å±æ€§çš„ *style* æ ‡ç­¾ä¹‹å¤–ï¼Œå†å®šä¹‰ä¸€ä¸ªä¸å«æœ‰ *scoped* å±æ€§çš„ *style* æ ‡ç­¾ï¼Œå³åœ¨ä¸€ä¸ª *vue* ç»„ä»¶ä¸­å®šä¹‰ä¸€ä¸ªå…¨å±€çš„ *style* æ ‡ç­¾ï¼Œä¸€ä¸ªå«æœ‰ä½œç”¨åŸŸçš„ *style* æ ‡ç­¾ï¼š
>
> ```js
> <style>
> /* global styles */
> </style>
> 
> <style scoped>
> /* local styles */
> </style>
> ```
>
> æ­¤æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä¿®æ”¹ç¬¬ä¸‰æ–¹æ ·å¼çš„ *css* å†™åœ¨ç¬¬ä¸€ä¸ª *style* ä¸­å³å¯ã€‚
>
> **æ–¹æ³•ä¸‰**
>
> ä¸Šé¢çš„æ–¹æ³•ä¸€éœ€è¦å•ç‹¬ä¹¦å†™ä¸€ä¸ªä¸å«æœ‰ *scoped* å±æ€§çš„ *style* æ ‡ç­¾ï¼Œå¯èƒ½ä¼šé€ æˆå…¨å±€æ ·å¼çš„æ±¡æŸ“ã€‚
>
> æ›´æ¨èçš„æ–¹å¼æ˜¯åœ¨ç»„ä»¶çš„å¤–å±‚ *DOM* ä¸Šæ·»åŠ å”¯ä¸€çš„ *class* æ¥åŒºåˆ†ä¸åŒç»„ä»¶ï¼Œåœ¨ä¹¦å†™æ ·å¼æ—¶å°±å¯ä»¥æ­£å¸¸é’ˆå¯¹é’ˆå¯¹è¿™éƒ¨åˆ† *DOM* ä¹¦å†™æ ·å¼ã€‚



### 28. **è¯´ä¸€ä¸‹ *ref* çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *ref* çš„ä½œç”¨æ˜¯è¢«ç”¨æ¥ç»™å…ƒç´ æˆ–å­ç»„ä»¶æ³¨å†Œå¼•ç”¨ä¿¡æ¯ã€‚å¼•ç”¨ä¿¡æ¯å°†ä¼šæ³¨å†Œåœ¨çˆ¶ç»„ä»¶çš„ *$refs* å¯¹è±¡ä¸Šã€‚å…¶ç‰¹ç‚¹æ˜¯ï¼š
>
> - å¦‚æœåœ¨æ™®é€šçš„ *DOM* å…ƒç´ ä¸Šä½¿ç”¨ï¼Œå¼•ç”¨æŒ‡å‘çš„å°±æ˜¯ *DOM* å…ƒç´ 
> - å¦‚æœç”¨åœ¨å­ç»„ä»¶ä¸Šï¼Œå¼•ç”¨å°±æŒ‡å‘ç»„ä»¶å®ä¾‹
>
> æ‰€ä»¥å¸¸è§çš„ä½¿ç”¨åœºæ™¯æœ‰ï¼š
>
> 1. åŸºæœ¬ç”¨æ³•ï¼Œæœ¬é¡µé¢è·å– *DOM* å…ƒç´ 
> 2. è·å–å­ç»„ä»¶ä¸­çš„ *data*
> 3. è°ƒç”¨å­ç»„ä»¶ä¸­çš„æ–¹æ³•



### 29. **è¯´ä¸€ä¸‹ä½ çŸ¥é“çš„ *vue* ä¿®é¥°ç¬¦éƒ½æœ‰å“ªäº›ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> åœ¨ *vue* ä¸­ä¿®é¥°ç¬¦å¯ä»¥åˆ†ä¸º *3* ç±»ï¼š
>
> - äº‹ä»¶ä¿®é¥°ç¬¦
> - æŒ‰é”®ä¿®é¥°ç¬¦
> - è¡¨å•ä¿®é¥°ç¬¦
>
> **äº‹ä»¶ä¿®é¥°ç¬¦**
>
> åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­è°ƒç”¨ *event.preventDefault* æˆ– *event.stopPropagation* æ–¹æ³•æ˜¯éå¸¸å¸¸è§çš„éœ€æ±‚ã€‚å°½ç®¡å¯ä»¥åœ¨ *methods* ä¸­è½»æ¾å®ç°è¿™ç‚¹ï¼Œä½†æ›´å¥½çš„æ–¹å¼æ˜¯ï¼š*methods* åªæœ‰çº¯ç²¹çš„æ•°æ®é€»è¾‘ï¼Œè€Œä¸æ˜¯å»å¤„ç† *DOM* äº‹ä»¶ç»†èŠ‚ã€‚
>
> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ*vue* ä¸º *v-on* æä¾›äº†äº‹ä»¶ä¿®é¥°ç¬¦ã€‚é€šè¿‡ç”±ç‚¹ *.* è¡¨ç¤ºçš„æŒ‡ä»¤åç¼€æ¥è°ƒç”¨ä¿®é¥°ç¬¦ã€‚
>
> å¸¸è§çš„äº‹ä»¶ä¿®é¥°ç¬¦å¦‚ä¸‹ï¼š
>
> - *.stop*ï¼šé˜»æ­¢å†’æ³¡ã€‚
> - *.prevent*ï¼šé˜»æ­¢é»˜è®¤äº‹ä»¶ã€‚
> - *.capture*ï¼šä½¿ç”¨äº‹ä»¶æ•è·æ¨¡å¼ã€‚
> - *.self*ï¼šåªåœ¨å½“å‰å…ƒç´ æœ¬èº«è§¦å‘ã€‚
> - *.once*ï¼šåªè§¦å‘ä¸€æ¬¡ã€‚
> - *.passive*ï¼šé»˜è®¤è¡Œä¸ºå°†ä¼šç«‹å³è§¦å‘ã€‚
>
> **æŒ‰é”®ä¿®é¥°ç¬¦**
>
> é™¤äº†äº‹ä»¶ä¿®é¥°ç¬¦ä»¥å¤–ï¼Œåœ¨ *vue* ä¸­è¿˜æä¾›äº†æœ‰é¼ æ ‡ä¿®é¥°ç¬¦ï¼Œé”®å€¼ä¿®é¥°ç¬¦ï¼Œç³»ç»Ÿä¿®é¥°ç¬¦ç­‰åŠŸèƒ½ã€‚
>
> - .*left*ï¼šå·¦é”®
> - .*right*ï¼šå³é”®
> - .*middle*ï¼šæ»šè½®
> - .*enter*ï¼šå›è½¦
> - .*tab*ï¼šåˆ¶è¡¨é”®
> - .*delete*ï¼šæ•è· â€œåˆ é™¤â€ å’Œ â€œé€€æ ¼â€ é”®
> - .*esc*ï¼šè¿”å›
> - .*space*ï¼šç©ºæ ¼
> - .*up*ï¼šä¸Š
> - .*down*ï¼šä¸‹
> - .*left*ï¼šå·¦
> - .*right*ï¼šå³
> - .*ctrl*ï¼š*ctrl* é”®
> - .*alt*ï¼š*alt* é”®
> - .*shift*ï¼š*shift* é”®
> - .*meta*ï¼š*meta* é”®
>
> **è¡¨å•ä¿®é¥°ç¬¦**
>
> *vue* åŒæ ·ä¹Ÿä¸ºè¡¨å•æ§ä»¶ä¹Ÿæä¾›äº†ä¿®é¥°ç¬¦ï¼Œå¸¸è§çš„æœ‰ *.lazy*ã€*.number* å’Œ *.trim*ã€‚
>
> - .*lazy*ï¼šåœ¨æ–‡æœ¬æ¡†å¤±å»ç„¦ç‚¹æ—¶æ‰ä¼šæ¸²æŸ“
> - .*number*ï¼šå°†æ–‡æœ¬æ¡†ä¸­æ‰€è¾“å…¥çš„å†…å®¹è½¬æ¢ä¸ºnumberç±»å‹
> - .*trim*ï¼šå¯ä»¥è‡ªåŠ¨è¿‡æ»¤è¾“å…¥é¦–å°¾çš„ç©ºæ ¼



### 30. **å¦‚ä½•å®ç° *vue* é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–ï¼Ÿ**

> ç›´æ’­è¯¾è®²è§£

> å‚è€ƒç­”æ¡ˆï¼š
>
> **ç¼–ç é˜¶æ®µ**
>
> - å°½é‡å‡å°‘ *data* ä¸­çš„æ•°æ®ï¼Œ*data* ä¸­çš„æ•°æ®éƒ½ä¼šå¢åŠ  *getter* å’Œ *setter*ï¼Œä¼šæ”¶é›†å¯¹åº”çš„ *watcher*
> - *v-if* å’Œ *v-for* ä¸èƒ½è¿ç”¨
> - å¦‚æœéœ€è¦ä½¿ç”¨ *v-for* ç»™æ¯é¡¹å…ƒç´ ç»‘å®šäº‹ä»¶æ—¶ä½¿ç”¨äº‹ä»¶ä»£ç†
> - *SPA* é¡µé¢é‡‡ç”¨ *keep-alive* ç¼“å­˜ç»„ä»¶
> - åœ¨æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ *v-if* æ›¿ä»£ *v-show*
> - *key* ä¿è¯å”¯ä¸€
> - ä½¿ç”¨è·¯ç”±æ‡’åŠ è½½ã€å¼‚æ­¥ç»„ä»¶
> - é˜²æŠ–ã€èŠ‚æµ
> - ç¬¬ä¸‰æ–¹æ¨¡å—æŒ‰éœ€å¯¼å…¥
> - é•¿åˆ—è¡¨æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸåŠ¨æ€åŠ è½½
> - å›¾ç‰‡æ‡’åŠ è½½
>
> ***SEO* ä¼˜åŒ–**
>
> - é¢„æ¸²æŸ“
> - æœåŠ¡ç«¯æ¸²æŸ“ *SSR*
>
> **æ‰“åŒ…ä¼˜åŒ–**
>
> - å‹ç¼©ä»£ç 
> - *Tree Shaking/Scope Hoisting*
> - ä½¿ç”¨ *cdn* åŠ è½½ç¬¬ä¸‰æ–¹æ¨¡å—
> - å¤šçº¿ç¨‹æ‰“åŒ… *happypack*
> - *splitChunks* æŠ½ç¦»å…¬å…±æ–‡ä»¶
> - *sourceMap* ä¼˜åŒ–
>
> **ç”¨æˆ·ä½“éªŒ**
>
> - éª¨æ¶å±
> - *PWA*
>
> è¿˜å¯ä»¥ä½¿ç”¨ç¼“å­˜(å®¢æˆ·ç«¯ç¼“å­˜ã€æœåŠ¡ç«¯ç¼“å­˜)ä¼˜åŒ–ã€æœåŠ¡ç«¯å¼€å¯ *gzip* å‹ç¼©ç­‰ã€‚



### 31. ***Vue.extend* å’Œ *Vue.component* çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Vue.extend* ç”¨äºåˆ›å»ºä¸€ä¸ªåŸºäº *Vue* æ„é€ å‡½æ•°çš„â€œå­ç±»â€ï¼Œå…¶å‚æ•°åº”ä¸ºä¸€ä¸ªåŒ…å«ç»„ä»¶é€‰é¡¹çš„å¯¹è±¡ã€‚
>
> *Vue.component* ç”¨æ¥æ³¨å†Œå…¨å±€ç»„ä»¶ã€‚



### 32. ***vue* ä¸­çš„ *spa* åº”ç”¨å¦‚ä½•ä¼˜åŒ–é¦–å±åŠ è½½é€Ÿåº¦?**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ä¼˜åŒ–é¦–å±åŠ è½½å¯ä»¥ä»è¿™å‡ ä¸ªæ–¹é¢å¼€å§‹ï¼š
>
> - è¯·æ±‚ä¼˜åŒ–ï¼šCDN å°†ç¬¬ä¸‰æ–¹çš„ç±»åº“æ”¾åˆ° CDN ä¸Šï¼Œèƒ½å¤Ÿå¤§å¹…åº¦å‡å°‘ç”Ÿäº§ç¯å¢ƒä¸­çš„é¡¹ç›®ä½“ç§¯ï¼Œå¦å¤– CDN èƒ½å¤Ÿå®æ—¶åœ°æ ¹æ®ç½‘ç»œæµé‡å’Œå„èŠ‚ç‚¹çš„è¿æ¥ã€è´Ÿè½½çŠ¶å†µä»¥åŠåˆ°ç”¨æˆ·çš„è·ç¦»å’Œå“åº”æ—¶é—´ç­‰ç»¼åˆä¿¡æ¯å°†ç”¨æˆ·çš„è¯·æ±‚é‡æ–°å¯¼å‘ç¦»ç”¨æˆ·æœ€è¿‘çš„æœåŠ¡èŠ‚ç‚¹ä¸Šã€‚
> - ç¼“å­˜ï¼šå°†é•¿æ—¶é—´ä¸ä¼šæ”¹å˜çš„ç¬¬ä¸‰æ–¹ç±»åº“æˆ–è€…é™æ€èµ„æºè®¾ç½®ä¸ºå¼ºç¼“å­˜ï¼Œå°† max-age è®¾ç½®ä¸ºä¸€ä¸ªéå¸¸é•¿çš„æ—¶é—´ï¼Œå†å°†è®¿é—®è·¯å¾„åŠ ä¸Šå“ˆå¸Œè¾¾åˆ°å“ˆå¸Œå€¼å˜äº†ä»¥åä¿è¯è·å–åˆ°æœ€æ–°èµ„æºï¼Œå¥½çš„ç¼“å­˜ç­–ç•¥æœ‰åŠ©äºå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶ä¸”æ˜¾è‘—çš„æå‡ç”¨æˆ·çš„ä½“éªŒ
> - gzipï¼šå¼€å¯ gzip å‹ç¼©ï¼Œé€šå¸¸å¼€å¯ gzip å‹ç¼©èƒ½å¤Ÿæœ‰æ•ˆçš„ç¼©å°ä¼ è¾“èµ„æºçš„å¤§å°ã€‚
> - http2ï¼šå¦‚æœç³»ç»Ÿé¦–å±åŒä¸€æ—¶é—´éœ€è¦åŠ è½½çš„é™æ€èµ„æºéå¸¸å¤šï¼Œä½†æ˜¯æµè§ˆå™¨å¯¹åŒåŸŸåçš„ tcp è¿æ¥æ•°é‡æ˜¯æœ‰é™åˆ¶çš„(chrome ä¸º 6 ä¸ª)è¶…è¿‡è§„å®šæ•°é‡çš„ tcp è¿æ¥ï¼Œåˆ™å¿…é¡»è¦ç­‰åˆ°ä¹‹å‰çš„è¯·æ±‚æ”¶åˆ°å“åº”åæ‰èƒ½ç»§ç»­å‘é€ï¼Œè€Œ http2 åˆ™å¯ä»¥åœ¨å¤šä¸ª tcp è¿æ¥ä¸­å¹¶å‘å¤šä¸ªè¯·æ±‚æ²¡æœ‰é™åˆ¶ï¼Œåœ¨ä¸€äº›ç½‘ç»œè¾ƒå·®çš„ç¯å¢ƒå¼€å¯ http2 æ€§èƒ½æå‡å°¤ä¸ºæ˜æ˜¾ã€‚
> - æ‡’åŠ è½½ï¼šå½“ url åŒ¹é…åˆ°ç›¸åº”çš„è·¯å¾„æ—¶ï¼Œé€šè¿‡ import åŠ¨æ€åŠ è½½é¡µé¢ç»„ä»¶ï¼Œè¿™æ ·é¦–å±çš„ä»£ç é‡ä¼šå¤§å¹…å‡å°‘ï¼Œwebpack ä¼šæŠŠåŠ¨æ€åŠ è½½çš„é¡µé¢ç»„ä»¶åˆ†ç¦»æˆå•ç‹¬çš„ä¸€ä¸ª chunk.js æ–‡ä»¶
> - é¢„æ¸²æŸ“ï¼šç”±äºæµè§ˆå™¨åœ¨æ¸²æŸ“å‡ºé¡µé¢ä¹‹å‰ï¼Œéœ€è¦å…ˆåŠ è½½å’Œè§£æç›¸åº”çš„ htmlã€css å’Œ js æ–‡ä»¶ï¼Œä¸ºæ­¤ä¼šæœ‰ä¸€æ®µç™½å±çš„æ—¶é—´ï¼Œå¯ä»¥æ·»åŠ loadingï¼Œæˆ–è€…éª¨æ¶å±å¹•å°½å¯èƒ½çš„å‡å°‘ç™½å±å¯¹ç”¨æˆ·çš„å½±å“ä½“ç§¯ä¼˜åŒ–
> - åˆç†ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼šå¯¹äºä¸€äº›ç¬¬ä¸‰æ–¹ ui æ¡†æ¶ã€ç±»åº“ï¼Œå°½é‡ä½¿ç”¨æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘æ‰“åŒ…ä½“ç§¯
> - ä½¿ç”¨å¯è§†åŒ–å·¥å…·åˆ†ææ‰“åŒ…åçš„æ¨¡å—ä½“ç§¯ï¼šwebpack-bundle- analyzer è¿™ä¸ªæ’ä»¶åœ¨æ¯æ¬¡æ‰“åŒ…åèƒ½å¤Ÿæ›´åŠ ç›´è§‚çš„åˆ†ææ‰“åŒ…åæ¨¡å—çš„ä½“ç§¯ï¼Œå†å¯¹å…¶ä¸­æ¯”è¾ƒå¤§çš„æ¨¡å—è¿›è¡Œä¼˜åŒ–
> - æé«˜ä»£ç ä½¿ç”¨ç‡ï¼šåˆ©ç”¨ä»£ç åˆ†å‰²ï¼Œå°†è„šæœ¬ä¸­æ— éœ€ç«‹å³è°ƒç”¨çš„ä»£ç åœ¨ä»£ç æ„å»ºæ—¶è½¬å˜ä¸ºå¼‚æ­¥åŠ è½½çš„è¿‡ç¨‹
> - å°è£…ï¼šæ„å»ºè‰¯å¥½çš„é¡¹ç›®æ¶æ„ï¼ŒæŒ‰ç…§é¡¹ç›®éœ€æ±‚å°±è¡Œå…¨å±€ç»„ä»¶ï¼Œæ’ä»¶ï¼Œè¿‡æ»¤å™¨ï¼ŒæŒ‡ä»¤ï¼Œutils ç­‰åšä¸€ äº›å…¬å…±å°è£…ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘æˆ‘ä»¬çš„ä»£ç é‡ï¼Œè€Œä¸”æ›´å®¹æ˜“ç»´æŠ¤èµ„æºä¼˜åŒ–
> - å›¾ç‰‡æ‡’åŠ è½½ï¼šä½¿ç”¨å›¾ç‰‡æ‡’åŠ è½½å¯ä»¥ä¼˜åŒ–åŒä¸€æ—¶é—´å‡å°‘ http è¯·æ±‚å¼€é”€ï¼Œé¿å…æ˜¾ç¤ºå›¾ç‰‡å¯¼è‡´çš„ç”»é¢æŠ–åŠ¨ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ
> - ä½¿ç”¨ svg å›¾æ ‡ï¼šç›¸å¯¹äºç”¨ä¸€å¼ å›¾ç‰‡æ¥è¡¨ç¤ºå›¾æ ‡ï¼Œsvg æ‹¥æœ‰æ›´å¥½çš„å›¾ç‰‡è´¨é‡ï¼Œä½“ç§¯æ›´å°ï¼Œå¹¶ä¸”ä¸éœ€è¦å¼€å¯é¢å¤–çš„ http è¯·æ±‚
> - å‹ç¼©å›¾ç‰‡ï¼šå¯ä»¥ä½¿ç”¨ image-webpack-loaderï¼Œåœ¨ç”¨æˆ·è‚‰çœ¼åˆ†è¾¨ä¸æ¸…çš„æƒ…å†µä¸‹ä¸€å®šç¨‹åº¦ä¸Šå‹ç¼©å›¾ç‰‡



### 33. **ç§»åŠ¨ç«¯å¦‚ä½•å®ç°ä¸€ä¸ªæ¯”è¾ƒå‹å¥½çš„ *header* ç»„ä»¶**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *Header* ä¸€èˆ¬åˆ†ä¸ºå·¦ã€ä¸­ã€å³ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸæ¥è®¾è®¡ï¼Œä¸­é—´ä¸ºä¸»æ ‡é¢˜ï¼Œæ¯ä¸ªé¡µé¢çš„æ ‡é¢˜è‚¯å®šä¸åŒï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ *vue props*çš„æ–¹å¼åšæˆå¯é…ç½®å¯¹å¤–è¿›è¡Œæš´éœ²ï¼Œå·¦ä¾§å¤§éƒ¨åˆ†é¡µé¢å¯èƒ½éƒ½æ˜¯å›é€€æŒ‰é’®ï¼Œä½†æ˜¯æ ·å¼å’Œå†…å®¹ä¸å°½ç›¸åŒï¼Œå³ä¾§ä¸€èˆ¬éƒ½æ˜¯å…·æœ‰åŠŸèƒ½æ€§çš„æ“ä½œæŒ‰é’®ï¼Œæ‰€ä»¥å·¦å³ä¸¤ä¾§å¯ä»¥é€šè¿‡ *vue slot* æ’æ§½çš„æ–¹å¼å¯¹å¤–æš´éœ²ä»¥å®ç°å¤šæ ·åŒ–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æä¾› *default slot* é»˜è®¤æ’æ§½æ¥ç»Ÿä¸€é¡µé¢é£æ ¼ã€‚



### 34. **æ—¢ç„¶ *Vue* é€šè¿‡æ•°æ®åŠ«æŒå¯ä»¥ç²¾å‡†æ¢æµ‹æ•°æ®å˜åŒ–ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è™šæ‹Ÿ *DOM* è¿›è¡Œ *diff* ç›‘æµ‹å·®å¼‚ ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ç°ä»£å‰ç«¯æ¡†æ¶æœ‰ä¸¤ç§æ–¹å¼ä¾¦æµ‹å˜åŒ–ï¼Œä¸€ç§æ˜¯ *pull*ï¼Œä¸€ç§æ˜¯ *push*ã€‚
>
> ***pull***
>
> å…¶ä»£è¡¨ä¸º *React*ï¼Œæˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ *React* æ˜¯å¦‚ä½•ä¾¦æµ‹åˆ°å˜åŒ–çš„ã€‚
>
> æˆ‘ä»¬é€šå¸¸ä¼šç”¨ *setState API* æ˜¾å¼æ›´æ–°,ç„¶å *React* ä¼šè¿›è¡Œä¸€å±‚å±‚çš„ *Virtual Dom Diff* æ“ä½œæ‰¾å‡ºå·®å¼‚ï¼Œç„¶å *Patch* åˆ° *DOM* ä¸Šï¼Œ*React* ä»ä¸€å¼€å§‹å°±ä¸çŸ¥é“åˆ°åº•æ˜¯å“ªå‘ç”Ÿäº†å˜åŒ–,åªæ˜¯çŸ¥é“ã€Œæœ‰å˜åŒ–äº†ã€,ç„¶åå†è¿›è¡Œæ¯”è¾ƒæš´åŠ›çš„ *Diff* æ“ä½œæŸ¥æ‰¾ã€Œå“ªå‘ç”Ÿå˜åŒ–äº†ã€ï¼Œå¦å¤–ä¸€ä¸ªä»£è¡¨å°±æ˜¯ *Angular* çš„è„æ£€æŸ¥æ“ä½œã€‚
>
> ***push***
>
> *Vue* çš„å“åº”å¼ç³»ç»Ÿåˆ™æ˜¯ *push* çš„ä»£è¡¨ï¼Œå½“ *Vue* ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šå¯¹æ•°æ® *data* è¿›è¡Œä¾èµ–çš„æ”¶é›†ï¼Œä¸€ä½†æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå“åº”å¼ç³»ç»Ÿå°±ä¼šç«‹åˆ»å¾—çŸ¥ï¼Œå› æ­¤ *Vue* æ˜¯ä¸€å¼€å§‹å°±çŸ¥é“æ˜¯ã€Œåœ¨å“ªå‘ç”Ÿå˜åŒ–äº†ã€
>
> ä½†æ˜¯è¿™åˆä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œé€šå¸¸ç»‘å®šä¸€ä¸ªæ•°æ®å°±éœ€è¦ä¸€ä¸ª *Watcher*ï¼Œä¸€ä½†æˆ‘ä»¬çš„ç»‘å®šç»†ç²’åº¦è¿‡é«˜å°±ä¼šäº§ç”Ÿå¤§é‡çš„ *Watcher*ï¼Œè¿™ä¼šå¸¦æ¥å†…å­˜ä»¥åŠä¾èµ–è¿½è¸ªçš„å¼€é”€ï¼Œè€Œç»†ç²’åº¦è¿‡ä½ä¼šæ— æ³•ç²¾å‡†ä¾¦æµ‹å˜åŒ–ï¼Œå› æ­¤ *Vue* çš„è®¾è®¡æ˜¯é€‰æ‹©ä¸­ç­‰ç»†ç²’åº¦çš„æ–¹æ¡ˆï¼Œåœ¨ç»„ä»¶çº§åˆ«è¿›è¡Œ *push* ä¾¦æµ‹çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯é‚£å¥—å“åº”å¼ç³»ç»Ÿã€‚
>
> é€šå¸¸æˆ‘ä»¬ä¼šç¬¬ä¸€æ—¶é—´ä¾¦æµ‹åˆ°å‘ç”Ÿå˜åŒ–çš„ç»„ä»¶,ç„¶ååœ¨ç»„ä»¶å†…éƒ¨è¿›è¡Œ *Virtual Dom Diff* è·å–æ›´åŠ å…·ä½“çš„å·®å¼‚ï¼Œè€Œ *Virtual Dom Diff* åˆ™æ˜¯ *pull* æ“ä½œï¼Œ*Vue* æ˜¯ *push + pull* ç»“åˆçš„æ–¹å¼è¿›è¡Œå˜åŒ–ä¾¦æµ‹çš„ã€‚



### 35. ***Vue* ä¸ºä»€ä¹ˆæ²¡æœ‰ç±»ä¼¼äº *React* ä¸­ *shouldComponentUpdate* çš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> æ ¹æœ¬åŸå› æ˜¯ *Vue* ä¸ *React* çš„å˜åŒ–ä¾¦æµ‹æ–¹å¼æœ‰æ‰€ä¸åŒ
>
> *React* æ˜¯ *pull* çš„æ–¹å¼ä¾¦æµ‹å˜åŒ–ï¼Œå½“ *React* çŸ¥é“å‘ç”Ÿå˜åŒ–åï¼Œä¼šä½¿ç”¨ *Virtual Dom Diff* è¿›è¡Œå·®å¼‚æ£€æµ‹,ä½†æ˜¯å¾ˆå¤šç»„ä»¶å®é™…ä¸Šæ˜¯è‚¯å®šä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ç”¨ *shouldComponentUpdate* è¿›è¡Œæ‰‹åŠ¨æ“ä½œæ¥å‡å°‘ *diff*ï¼Œä»è€Œæé«˜ç¨‹åºæ•´ä½“çš„æ€§èƒ½ã€‚
>
> *Vue* æ˜¯ *pull+push* çš„æ–¹å¼ä¾¦æµ‹å˜åŒ–çš„ï¼Œåœ¨ä¸€å¼€å§‹å°±çŸ¥é“é‚£ä¸ªç»„ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œå› æ­¤åœ¨ *push* çš„é˜¶æ®µå¹¶ä¸éœ€è¦æ‰‹åŠ¨æ§åˆ¶ *diff*ï¼Œè€Œç»„ä»¶å†…éƒ¨é‡‡ç”¨çš„ *diff* æ–¹å¼å®é™…ä¸Šæ˜¯å¯ä»¥å¼•å…¥ç±»ä¼¼äº *shouldComponentUpdate* ç›¸å…³ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä½†æ˜¯é€šå¸¸åˆç†å¤§å°çš„ç»„ä»¶ä¸ä¼šæœ‰è¿‡é‡çš„ *diff*ï¼Œæ‰‹åŠ¨ä¼˜åŒ–çš„ä»·å€¼æœ‰é™ï¼Œå› æ­¤ç›®å‰ *Vue* å¹¶æ²¡æœ‰è€ƒè™‘å¼•å…¥ *shouldComponentUpdate* è¿™ç§æ‰‹åŠ¨ä¼˜åŒ–çš„ç”Ÿå‘½å‘¨æœŸã€‚



### 36. ***Vue* ä¸­çš„ *Key* çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ***key* çš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†é«˜æ•ˆçš„æ›´æ–°è™šæ‹Ÿ *DOM***ã€‚å¦å¤– *vue* ä¸­åœ¨ä½¿ç”¨ç›¸åŒæ ‡ç­¾åå…ƒç´ çš„è¿‡æ¸¡åˆ‡æ¢æ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨åˆ° *key* å±æ€§ï¼Œå…¶ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†è®© *vue* å¯ä»¥åŒºåˆ†å®ƒä»¬ï¼Œå¦åˆ™ *vue* åªä¼šæ›¿æ¢å…¶å†…éƒ¨å±æ€§è€Œä¸ä¼šè§¦å‘è¿‡æ¸¡æ•ˆæœã€‚

> è§£æï¼š
>
> å…¶å®ä¸åªæ˜¯ *vue*ï¼Œ*react* ä¸­åœ¨æ‰§è¡Œåˆ—è¡¨æ¸²æŸ“æ—¶ä¹Ÿä¼šè¦æ±‚ç»™æ¯ä¸ªç»„ä»¶æ·»åŠ ä¸Š *key* è¿™ä¸ªå±æ€§ã€‚
>
> è¦è§£é‡Š *key* çš„ä½œç”¨ï¼Œä¸å¾—ä¸å…ˆä»‹ç»ä¸€ä¸‹è™šæ‹Ÿ *DOM* çš„ *Diff* ç®—æ³•äº†ã€‚
>
> æˆ‘ä»¬çŸ¥é“ï¼Œ*vue* å’Œ *react* éƒ½å®ç°äº†ä¸€å¥—è™šæ‹Ÿ *DOM*ï¼Œä½¿æˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥æ“ä½œ *DOM* å…ƒç´ ï¼Œåªæ“ä½œæ•°æ®ä¾¿å¯ä»¥é‡æ–°æ¸²æŸ“é¡µé¢ã€‚è€Œéšè—åœ¨èƒŒåçš„åŸç†ä¾¿æ˜¯å…¶é«˜æ•ˆçš„ *Diff* ç®—æ³•ã€‚
>
> *vue* å’Œ *react* çš„è™šæ‹Ÿ *DOM* çš„ *Diff* ç®—æ³•å¤§è‡´ç›¸åŒï¼Œå…¶æ ¸å¿ƒæœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š
>
> - ä¸¤ä¸ªç›¸åŒçš„ç»„ä»¶äº§ç”Ÿç±»ä¼¼çš„ *DOM* ç»“æ„ï¼Œä¸åŒçš„ç»„ä»¶äº§ç”Ÿä¸åŒçš„ *DOM* ç»“æ„ã€‚
>
> - åŒä¸€å±‚çº§çš„ä¸€ç»„èŠ‚ç‚¹ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡å”¯ä¸€çš„ *id* è¿›è¡ŒåŒºåˆ†ã€‚
>
> åŸºäºä»¥ä¸Šè¿™ä¸¤ç‚¹ï¼Œä½¿å¾—è™šæ‹Ÿ *DOM* çš„ *Diff* ç®—æ³•çš„å¤æ‚åº¦ä» *O(n^3)* é™åˆ°äº† *O(n)*ã€‚
>
> <img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-21-062058.png" alt="image-20210821142057777" style="zoom:50%;" />
>
> å½“é¡µé¢çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ*Diff* ç®—æ³•åªä¼šæ¯”è¾ƒåŒä¸€å±‚çº§çš„èŠ‚ç‚¹ï¼š
>
> - å¦‚æœèŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œç›´æ¥å¹²æ‰å‰é¢çš„èŠ‚ç‚¹ï¼Œå†åˆ›å»ºå¹¶æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œä¸ä¼šå†æ¯”è¾ƒè¿™ä¸ªèŠ‚ç‚¹ä»¥åçš„å­èŠ‚ç‚¹äº†ã€‚
> - å¦‚æœèŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œåˆ™ä¼šé‡æ–°è®¾ç½®è¯¥èŠ‚ç‚¹çš„å±æ€§ï¼Œä»è€Œå®ç°èŠ‚ç‚¹çš„æ›´æ–°ã€‚
>
> å½“æŸä¸€å±‚æœ‰å¾ˆå¤šç›¸åŒçš„èŠ‚ç‚¹æ—¶ï¼Œä¹Ÿå°±æ˜¯åˆ—è¡¨èŠ‚ç‚¹æ—¶ï¼Œ*Diff* ç®—æ³•çš„æ›´æ–°è¿‡ç¨‹é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éµå¾ªä»¥ä¸ŠåŸåˆ™ã€‚
>
> æ¯”å¦‚ä¸€ä¸‹è¿™ä¸ªæƒ…å†µï¼š
>
> ![img](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-21-062225.jpg)
>
> æˆ‘ä»¬å¸Œæœ›å¯ä»¥åœ¨ *B* å’Œ *C* ä¹‹é—´åŠ ä¸€ä¸ª *F*ï¼Œ*Diff* ç®—æ³•é»˜è®¤æ‰§è¡Œèµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
>
> ![img](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-21-062244.jpg)
>
> å³æŠŠ *C* æ›´æ–°æˆ *F*ï¼Œ*D* æ›´æ–°æˆ *C*ï¼Œ*E* æ›´æ–°æˆ *D*ï¼Œæœ€åå†æ’å…¥ *E*
>
> æ˜¯ä¸æ˜¯å¾ˆæ²¡æœ‰æ•ˆç‡ï¼Ÿ
>
> æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ *key* æ¥ç»™æ¯ä¸ªèŠ‚ç‚¹åšä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œ*Diff* ç®—æ³•å°±å¯ä»¥æ­£ç¡®çš„è¯†åˆ«æ­¤èŠ‚ç‚¹ï¼Œæ‰¾åˆ°æ­£ç¡®çš„ä½ç½®åŒºæ’å…¥æ–°çš„èŠ‚ç‚¹ã€‚
>
> ![img](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-21-062321.jpg)



### 37. **ä½ çš„æ¥å£è¯·æ±‚ä¸€èˆ¬æ”¾åœ¨å“ªä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> æ¥å£è¯·æ±‚å¯ä»¥æ”¾åœ¨é’©å­å‡½æ•° *createdã€beforeMountã€mounted* ä¸­è¿›è¡Œè°ƒç”¨ï¼Œå› ä¸ºåœ¨è¿™ä¸‰ä¸ªé’©å­å‡½æ•°ä¸­ï¼Œ*data* å·²ç»åˆ›å»ºï¼Œå¯ä»¥å°†æœåŠ¡ç«¯ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œèµ‹å€¼ã€‚
>
> ä½†æ˜¯æ¨èåœ¨ *created* é’©å­å‡½æ•°ä¸­è°ƒç”¨å¼‚æ­¥è¯·æ±‚ï¼Œå› ä¸ºåœ¨ *created* é’©å­å‡½æ•°ä¸­è°ƒç”¨å¼‚æ­¥è¯·æ±‚æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š
>
> - èƒ½æ›´å¿«è·å–åˆ°æœåŠ¡ç«¯æ•°æ®ï¼Œå‡å°‘é¡µé¢ *loading* æ—¶é—´
> - *SSR* ä¸æ”¯æŒ *beforeMount ã€mounted* é’©å­å‡½æ•°ï¼Œæ‰€ä»¥æ”¾åœ¨ *created* ä¸­æœ‰åŠ©äºä»£ç çš„ä¸€è‡´æ€§
> - *created* æ˜¯åœ¨æ¨¡æ¿æ¸²æŸ“æˆ *html* å‰è°ƒç”¨ï¼Œå³é€šå¸¸åˆå§‹åŒ–æŸäº›å±æ€§å€¼ï¼Œç„¶åå†æ¸²æŸ“æˆè§†å›¾ã€‚å¦‚æœåœ¨ *mounted* é’©å­å‡½æ•°ä¸­è¯·æ±‚æ•°æ®å¯èƒ½å¯¼è‡´é¡µé¢é—ªå±é—®é¢˜ 



### 38. **è¯´ä¸€ä¸‹ä½ å¯¹ *vue* äº‹ä»¶ç»‘å®šåŸç†çš„ç†è§£ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *vue* ä¸­çš„äº‹ä»¶ç»‘å®šæ˜¯æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åŸç”Ÿçš„äº‹ä»¶ç»‘å®šï¼Œå¦ä¸€ç§æ˜¯ç»„ä»¶çš„äº‹ä»¶ç»‘å®šã€‚
>
> åŸç”Ÿçš„äº‹ä»¶ç»‘å®šåœ¨æ™®é€šå…ƒç´ ä¸Šæ˜¯é€šè¿‡ *@click* è¿›è¡Œç»‘å®šï¼Œåœ¨ç»„ä»¶ä¸Šæ˜¯é€šè¿‡ *@click.native* è¿›è¡Œç»‘å®šï¼Œç»„ä»¶ä¸­çš„ *nativeOn* æ˜¯ç­‰ä»·äº on çš„ã€‚ç»„ä»¶çš„äº‹ä»¶ç»‘å®šçš„ @click æ˜¯ vue ä¸­è‡ªå®šä¹‰çš„ $on æ–¹æ³•æ¥å®ç°çš„ï¼Œå¿…é¡»æœ‰ $emit æ‰å¯ä»¥è§¦å‘ã€‚
>
> **åŸç”Ÿäº‹ä»¶ç»‘å®šåŸç†**
>
> åœ¨ runtimeä¸‹çš„patch.jsä¸­createPatchFunctionæ‰§è¡Œäº†ä¹‹åå†èµ‹å€¼ç»™patchã€‚
>
> createPatchFunctionæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯nodeOpså­˜æ”¾æ“ä½œdomèŠ‚ç‚¹çš„æ–¹æ³•å’Œmodulesï¼Œmodulesæ˜¯æœ‰ä¸¤ä¸ªæ•°ç»„æ‹¼æ¥èµ·æ¥çš„ï¼Œmodulesæ‹¼æ¥å®Œçš„æ•°ç»„ä¸­æœ‰ä¸€ä¸ªå…ƒç´ å°±æ˜¯eventsï¼Œäº‹ä»¶æ·»åŠ å°±å‘ç”Ÿåœ¨è¿™é‡Œã€‚
>
> eventså…ƒç´ å…³è”çš„å°±æ˜¯events.jsæ–‡ä»¶ï¼Œåœ¨eventsä¸­æœ‰ä¸€ä¸ªupdateDOMListenersæ–¹æ³•ï¼Œåœ¨eventsæ–‡ä»¶çš„ç»“å°¾å¯¼å‡ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§å«åšcreateï¼Œè¿™ä¸ªå±æ€§å…³è”çš„å°±æ˜¯updateDOMListenersæ–¹æ³•ã€‚
>
> åœ¨æ‰§è¡ŒcreatePatchFunctionæ–¹æ³•æ—¶ï¼Œå°±ä¼šå°†è¿™ä¸¤ä¸ªå‚æ•°ä¼ å…¥ï¼Œåœ¨createPatchFunctionæ–¹æ³•ä¸­æ¥æ”¶äº†ä¸€ä¸ªå‚æ•°backendï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¸€å¼€å§‹è¿›è¡Œbackendçš„è§£æ„ï¼Œå°±æ˜¯ä¸Šé¢çš„nodeOpså’Œmoduleså‚æ•°ï¼Œè§£æ„å®Œä¹‹åè¿›å…¥forå¾ªç¯ã€‚
>
> åœ¨createPatchFunctionå¼€å¤´å®šä¹‰äº†ä¸€ä¸ªcbså¯¹è±¡ã€‚forå¾ªç¯éå†ä¸€ä¸ªå«hooksçš„æ•°ç»„ã€‚hooksæ˜¯æ–‡ä»¶ä¸€å¼€å¤´å®šä¹‰çš„ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…æ‹¬æœ‰createï¼Œforå¾ªç¯å°±æ˜¯åœ¨cbsä¸Šå®šä¹‰ä¸€ç³»åˆ—å’Œhookså…ƒç´ ç›¸åŒçš„å±æ€§ï¼Œç„¶åé”®å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åæ•°ç»„å†…å®¹æ˜¯modulesé‡Œé¢çš„ä¸€äº›å†…å®¹ã€‚è¿™æ—¶å°±æŠŠeventsæ–‡ä»¶ä¸­å¯¼å‡ºæ¥çš„createå±æ€§æ”¾åœ¨äº†cbsä¸Šã€‚
>
> å½“æˆ‘ä»¬è¿›å…¥é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåˆ°patchå‡½æ•°é‡Œé¢çš„createElmæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­å°±ä¼šè°ƒç”¨invokeCreateHookså‡½æ•°ï¼Œç”¨æ¥å¤„ç†äº‹ä»¶ç³»ç»Ÿï¼Œè¿™é‡Œå°±æ˜¯çœŸæ­£å‡†å¤‡è¿›è¡ŒåŸç”Ÿäº‹ä»¶ç»‘å®šçš„å…¥å£ã€‚invokeCreateHooksæ–¹æ³•ä¸­ï¼Œéå†äº†cbs.createæ•°ç»„é‡Œé¢çš„å†…å®¹ã€‚ç„¶åæŠŠcbs.createé‡Œé¢çš„å‡½æ•°å…¨éƒ¨éƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨cbs.createå…¶ä¸­ä¸€ä¸ªå‡½æ•°å°±æ˜¯updateDOMListenersã€‚
>
> updateDOMListenerså°±æ˜¯ç”¨æ¥æ·»åŠ äº‹ä»¶çš„æ–¹æ³•ï¼Œåœ¨è¿™æ–¹æ³•ä¸­ä¼šæ ¹æ®vnodeåˆ¤æ–­æ˜¯å¦æœ‰å®šä¹‰ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ã€‚å¦‚æœæ²¡æœ‰ç‚¹å‡»äº‹ä»¶å°±returnã€‚æœ‰çš„è¯å°±ç»§ç»­æ‰§è¡Œï¼Œç»™onè¿›è¡Œèµ‹å€¼ï¼Œç„¶åè¿›è¡Œä¸€äº›èµ‹å€¼æ“ä½œï¼Œå°†vnode.elmèµ‹å€¼ç»™targetï¼Œelmè¿™ä¸ªå±æ€§å°±æ˜¯æŒ‡å‘vnodeæ‰€å¯¹åº”çš„çœŸå®domèŠ‚ç‚¹ï¼Œè¿™é‡Œå°±æ˜¯æŠŠæˆ‘ä»¬è¦ç»‘å®šäº‹ä»¶çš„domç»“ç‚¹è¿›è¡Œç¼“å­˜ï¼Œæ¥ä¸‹æ¥æ‰§è¡ŒupdateListenersæ–¹æ³•ã€‚åœ¨æ¥ä¸‹æ¥æ‰§è¡ŒupdateListenersæ–¹æ³•ä¸­è°ƒç”¨äº†ä¸€ä¸ªaddçš„æ–¹æ³•ï¼Œç„¶ååœ¨appæ–¹æ³•ä¸­é€šè¿‡åŸç”ŸaddEventListeneræŠŠäº‹ä»¶ç»‘å®šåˆ°domä¸Šã€‚
>
> **ç»„ä»¶äº‹ä»¶ç»‘å®šåŸç†**
>
> åœ¨ç»„ä»¶å®ä¾‹åˆå§‹åŒ–ä¼šè°ƒç”¨initMixinæ–¹æ³•ä¸­çš„Vue.prototype._initï¼Œåœ¨initå‡½æ•°ä¸­ï¼Œä¼šé€šè¿‡initInternalComponentæ–¹æ³•åˆå§‹åŒ–ç»„ä»¶ä¿¡æ¯ï¼Œå°†è‡ªå®šä¹‰çš„ç»„ä»¶äº‹ä»¶æ”¾åˆ°_parentListenersä¸Šï¼Œä¸‹æ¥å°±ä¼šè°ƒç”¨initEventsæ¥åˆå§‹åŒ–ç»„ä»¶äº‹ä»¶ï¼Œåœ¨initEventsä¸­ä¼šå®ä¾‹ä¸Šæ·»åŠ ä¸€ä¸ª _eventå¯¹è±¡ï¼Œç”¨äºä¿å­˜è‡ªå®šä¹‰äº‹ä»¶ï¼Œç„¶åè·å–åˆ° çˆ¶ç»„ä»¶ç»™ å­ç»„ä»¶ç»‘å®šçš„è‡ªå®šä¹‰äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯åˆšæ‰åœ¨åˆå§‹åŒ–ç»„ä»¶ä¿¡æ¯çš„æ—¶å€™å°†è‡ªå®šä¹‰çš„ç»„ä»¶äº‹ä»¶æ”¾åœ¨äº†_parentListenersä¸Šï¼Œè¿™æ—¶å€™vm.$options._parentListenerså°±æ˜¯è‡ªå®šä¹‰çš„äº‹ä»¶ã€‚
>
> æœ€åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæœ‰è‡ªå®šä¹‰çš„ç»„ä»¶äº‹ä»¶å°±æ‰§è¡ŒupdateComponentListenersæ–¹æ³•è¿›è¡Œäº‹ä»¶ç»‘å®šï¼Œåœ¨updateComponentListenersæ–¹æ³•ä¸­ä¼šè°ƒç”¨updateListenersæ–¹æ³•ï¼Œå¹¶ä¼ ä¼ ä¸€ä¸ªaddæ–¹æ³•è¿›è¡Œæ‰§è¡Œï¼Œè¿™ä¸ªaddæ–¹æ³•é‡Œå°±æ˜¯$onæ–¹æ³•ã€‚



### 39. **è¯´ä¸€ä¸‹ *vue* æ¨¡ç‰ˆç¼–è¯‘çš„åŸç†æ˜¯ä»€ä¹ˆ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> ç®€å•è¯´ï¼Œ*Vue* çš„ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯å°† *template* è½¬åŒ–ä¸º *render* å‡½æ•°çš„è¿‡ç¨‹ã€‚ä¼šç»å†ä»¥ä¸‹é˜¶æ®µï¼š
>
> - ç”Ÿæˆ *AST* æ ‘
> - ä¼˜åŒ–
> - *codegen*
>
> é¦–å…ˆè§£ææ¨¡ç‰ˆï¼Œç”Ÿæˆ *AST* è¯­æ³•æ ‘(ä¸€ç§ç”¨ *JavaScript* å¯¹è±¡çš„å½¢å¼æ¥æè¿°æ•´ä¸ªæ¨¡æ¿)ã€‚ ä½¿ç”¨å¤§é‡çš„æ­£åˆ™è¡¨è¾¾å¼å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œé‡åˆ°æ ‡ç­¾ã€æ–‡æœ¬çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œå¯¹åº”çš„é’©å­è¿›è¡Œç›¸å…³å¤„ç†ã€‚
>
> *Vue* çš„æ•°æ®æ˜¯å“åº”å¼çš„ï¼Œä½†å…¶å®æ¨¡æ¿ä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å“åº”å¼çš„ã€‚æœ‰ä¸€äº›æ•°æ®é¦–æ¬¡æ¸²æŸ“åå°±ä¸ä¼šå†å˜åŒ–ï¼Œå¯¹åº”çš„ *DOM* ä¹Ÿä¸ä¼šå˜åŒ–ã€‚é‚£ä¹ˆä¼˜åŒ–è¿‡ç¨‹å°±æ˜¯æ·±åº¦éå† *AST* æ ‘ï¼ŒæŒ‰ç…§ç›¸å…³æ¡ä»¶å¯¹æ ‘èŠ‚ç‚¹è¿›è¡Œæ ‡è®°ã€‚è¿™äº›è¢«æ ‡è®°çš„èŠ‚ç‚¹(é™æ€èŠ‚ç‚¹)æˆ‘ä»¬å°±å¯ä»¥è·³è¿‡å¯¹å®ƒä»¬çš„æ¯”å¯¹ï¼Œå¯¹è¿è¡Œæ—¶çš„æ¨¡æ¿èµ·åˆ°å¾ˆå¤§çš„ä¼˜åŒ–ä½œç”¨ã€‚
>
> ç¼–è¯‘çš„æœ€åä¸€æ­¥æ˜¯å°†ä¼˜åŒ–åçš„ *AST* æ ‘è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ä»£ç ã€‚

> å¯ä»¥å‚é˜…å‰é¢ç¬¬ *22* é¢˜ã€‚



### 40. ***delete* å’Œ *Vue.delete* åˆ é™¤æ•°ç»„çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> *delete* åªæ˜¯è¢«åˆ é™¤çš„å…ƒç´ å˜æˆäº† *empty/undefined* å…¶ä»–çš„å…ƒç´ çš„é”®å€¼è¿˜æ˜¯ä¸å˜ã€‚
> *Vue.delete* æ˜¯ç›´æ¥å°†å…ƒç´ ä»æ•°ç»„ä¸­å®Œå…¨åˆ é™¤ï¼Œæ”¹å˜äº†æ•°ç»„å…¶ä»–å…ƒç´ çš„é”®å€¼ã€‚



### 41. ***v-on* å¯ä»¥å®ç°ç›‘å¬å¤šä¸ªæ–¹æ³•ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> å¯ä»¥ç›‘å¬å¤šä¸ªæ–¹æ³•ã€‚å…³äºç›‘å¬å¤šä¸ªæ–¹æ³•æä¾›äº†å‡ ç§ä¸åŒçš„å†™æ³•ï¼š
>
> ```html
> å†™æ³•ä¸€ï¼š<div v-on="{ äº‹ä»¶ç±»å‹: äº‹ä»¶å¤„ç†å‡½æ•°, äº‹ä»¶ç±»å‹: äº‹ä»¶å¤„ç†å‡½æ•° }"></div>
> å†™æ³•äºŒï¼š<div @äº‹ä»¶ç±»å‹=â€œäº‹ä»¶å¤„ç†å‡½æ•°â€ @äº‹ä»¶ç±»å‹=â€œäº‹ä»¶å¤„ç†å‡½æ•°â€></div>
> å†™æ³•ä¸‰ï¼šåœ¨ä¸€ä¸ªäº‹ä»¶é‡Œé¢ä¹¦å†™å¤šä¸ªäº‹ä»¶å¤„ç†å‡½æ•°
> <div @äº‹ä»¶ç±»å‹=â€œäº‹ä»¶å¤„ç†å‡½æ•°1ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°2â€></div>
> å†™æ³•å››ï¼šåœ¨äº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨è°ƒç”¨å…¶ä»–çš„å‡½æ•°
> ```
>
> ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š
>
> ```html
> <template>
> <div>
>  <!-- v-onåœ¨vue2.xä¸­æµ‹è¯•,ä»¥ä¸‹ä¸¤ç§å‡å¯-->
>  <button v-on="{ mouseenter: onEnter, mouseleave: onLeave }">
>    é¼ æ ‡è¿›æ¥1
>  </button>
>  <button @mouseenter="onEnter" @mouseleave="onLeave">é¼ æ ‡è¿›æ¥2</button>
> 
>  <!-- ä¸€ä¸ªäº‹ä»¶ç»‘å®šå¤šä¸ªå‡½æ•°ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œï¼Œè¿™é‡Œåˆ†éš”å‡½æ•°å¯ä»¥ç”¨é€—å·ä¹Ÿå¯ä»¥ç”¨åˆ†å·-->
>  <button @click="a(), b()">ç‚¹æˆ‘ab</button>
>  <button @click="one()">ç‚¹æˆ‘onetwothree</button>
> </div>
> </template>
> <script>
> export default {
> methods: {
>  //è¿™é‡Œæ˜¯es6å¯¹è±¡é‡Œå‡½æ•°å†™æ³•
>  a() {
>    console.log("a");
>  },
>  b() {
>    console.log("b");
>  },
>  one() {
>    console.log("one");
>    this.two();
>    this.three();
>  },
>  two() {
>    console.log("two");
>  },
>  three() {
>    console.log("three");
>  },
>  onEnter() {
>    console.log("mouse enter");
>  },
>  onLeave() {
>    console.log("mouse leave");
>  },
> },
> };
> </script>
> ```



### 42. ***vue* çš„æ•°æ®ä¸ºä»€ä¹ˆé¢‘ç¹å˜åŒ–ä½†åªä¼šæ›´æ–°ä¸€æ¬¡ï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> è¿™æ˜¯å› ä¸º *vue* çš„ *DOM* æ›´æ–°æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œåœ¨æ•°æ®æ›´æ–°åä¼šé¦–å…ˆè¢« *set* é’©å­ç›‘å¬åˆ°ï¼Œä½†æ˜¯ä¸ä¼šé©¬ä¸Šæ‰§è¡Œ *DOM* æ›´æ–°ï¼Œè€Œæ˜¯åœ¨ä¸‹ä¸€è½®å¾ªç¯ä¸­æ‰§è¡Œæ›´æ–°ã€‚
>
> å…·ä½“å®ç°æ˜¯ *vue* ä¸­å®ç°äº†ä¸€ä¸ª *queue* é˜Ÿåˆ—ç”¨äºå­˜æ”¾æœ¬æ¬¡äº‹ä»¶å¾ªç¯ä¸­çš„æ‰€æœ‰ *watcher* æ›´æ–°ï¼Œå¹¶ä¸”åŒä¸€ä¸ª *watcher* çš„æ›´æ–°åªä¼šè¢«æ¨å…¥é˜Ÿåˆ—ä¸€æ¬¡ï¼Œå¹¶åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„å¾®ä»»åŠ¡æ‰§è¡Œç»“æŸåæ‰§è¡Œæ­¤æ›´æ–°(*UI Render* é˜¶æ®µ)ï¼Œè¿™å°±æ˜¯ *DOM* åªä¼šæ›´æ–°ä¸€æ¬¡çš„åŸå› ã€‚
>
> è¿™ç§åœ¨ç¼“å†²æ—¶å»é™¤é‡å¤æ•°æ®å¯¹äºé¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œ *DOM* æ“ä½œæ˜¯éå¸¸é‡è¦çš„ã€‚ç„¶åï¼Œåœ¨ä¸‹ä¸€ä¸ªçš„äº‹ä»¶å¾ªç¯â€œ*tick*â€ä¸­ï¼Œ*vue* åˆ·æ–°é˜Ÿåˆ—å¹¶æ‰§è¡Œå®é™… (å·²å»é‡çš„) å·¥ä½œã€‚*vue* åœ¨å†…éƒ¨å¯¹å¼‚æ­¥é˜Ÿåˆ—å°è¯•ä½¿ç”¨åŸç”Ÿçš„ *Promise.thenã€MutationObserver*  å’Œ *setImmediate*ï¼Œå¦‚æœæ‰§è¡Œç¯å¢ƒä¸æ”¯æŒï¼Œåˆ™ä¼šé‡‡ç”¨ *setTimeout(fn, 0)* ä»£æ›¿ã€‚



### 43. **è¯´ä¸€ä¸‹ *vue* ä¸­ *computed* å’Œ *methods* çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

> å‚è€ƒç­”æ¡ˆï¼š
>
> é¦–å…ˆä»è¡¨ç°å½¢å¼ä¸Šé¢æ¥çœ‹ï¼Œ *computed* å’Œ *methods* çš„åŒºåˆ«å¤§è‡´æœ‰ä¸‹é¢ *4* ç‚¹ï¼š
>
> 1. åœ¨ä½¿ç”¨æ—¶ï¼Œ*computed* å½“åšå±æ€§ä½¿ç”¨ï¼Œè€Œ *methods* åˆ™å½“åšæ–¹æ³•è°ƒç”¨
> 2. *computed* å¯ä»¥å…·æœ‰ *getter* å’Œ *setter*ï¼Œå› æ­¤å¯ä»¥èµ‹å€¼ï¼Œè€Œ *methods* ä¸è¡Œ
> 3. *computed* æ— æ³•æ¥æ”¶å¤šä¸ªå‚æ•°ï¼Œè€Œ *methods* å¯ä»¥
> 4. *computed* å…·æœ‰ç¼“å­˜ï¼Œè€Œ *methods* æ²¡æœ‰
>
> è€Œå¦‚æœä»åº•å±‚æ¥çœ‹çš„è¯ï¼Œ *computed* å’Œ *methods* åœ¨åº•å±‚å®ç°ä¸Šé¢è¿˜æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚
>
> *vue* å¯¹ *methods* çš„å¤„ç†æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦éå† *methods* é…ç½®ä¸­çš„æ¯ä¸ªå±æ€§ï¼Œå°†å…¶å¯¹åº”çš„å‡½æ•°ä½¿ç”¨ *bind* ç»‘å®šå½“å‰ç»„ä»¶å®ä¾‹åå¤åˆ¶å…¶å¼•ç”¨åˆ°ç»„ä»¶å®ä¾‹ä¸­å³å¯
>
> è€Œ *vue* å¯¹ *computed* çš„å¤„ç†ä¼šç¨å¾®å¤æ‚ä¸€äº›ã€‚
>
> å…·ä½“å¯ä»¥å‚é˜…å‰é¢ç¬¬ *21* é¢˜ã€‚



### 44. **åœ¨ *Vue* ä¸­è¦è·å–å½“å‰æ—¶é—´ä½ ä¼šæ”¾åˆ° *computed* è¿˜æ˜¯ *methods* é‡Œï¼Ÿ(æŠ–éŸ³ç›´æ’­)**

> å‚è€ƒç­”æ¡ˆï¼š
>
> æ”¾åœ¨ *computed* é‡Œé¢ã€‚å› ä¸º *computed* åªæœ‰åœ¨å®ƒçš„ç›¸å…³ä¾èµ–å‘ç”Ÿæ”¹å˜æ—¶æ‰ä¼šé‡æ–°æ±‚å€¼ã€‚ç›¸æ¯”è€Œè¨€ï¼Œæ–¹æ³•åªè¦å‘ç”Ÿé‡æ–°æ¸²æŸ“ï¼Œ*methods* è°ƒç”¨æ€»ä¼šæ‰§è¡Œæ‰€æœ‰å‡½æ•°ã€‚ 



### 45. **åœ¨ç»™ *vue* ä¸­çš„å…ƒç´ è®¾ç½® *key* å€¼æ—¶å¯ä»¥ä½¿ç”¨ *Math* çš„ *random* æ–¹æ³•ä¹ˆï¼Ÿ**

>å‚è€ƒç­”æ¡ˆï¼š
>
>*random* æ˜¯ç”Ÿæˆéšæœºæ•°ï¼Œæœ‰ä¸€å®šæ¦‚ç‡å¤šä¸ª *item* ä¼šç”Ÿæˆç›¸åŒçš„å€¼ï¼Œä¸èƒ½ä¿è¯å”¯ä¸€ã€‚
>
>å¦‚æœæ˜¯æ ¹æ®æ•°æ®æ¥ç”Ÿæˆ *item*ï¼Œæ•°æ®å…·æœ‰ *id* å±æ€§ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ *id* æ¥ä½œä¸º *key*ã€‚
>
>å¦‚æœä¸æ˜¯æ ¹æ®æ•°æ®ç”Ÿæˆ *item*ï¼Œé‚£ä¹ˆæœ€å¥½çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨æ—¶é—´æˆ³æ¥ä½œä¸º *key*ã€‚æˆ–è€…ä½¿ç”¨è¯¸å¦‚ *uuid* ä¹‹ç±»çš„åº“æ¥ç”Ÿæˆå”¯ä¸€çš„ *id*ã€‚



### 46. **æ’æ§½ä¸ä½œç”¨åŸŸæ’æ§½çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

>å‚è€ƒç­”æ¡ˆï¼š
>
>æ’æ§½çš„ä½œç”¨æ˜¯å­ç»„ä»¶æä¾›äº†å¯æ›¿æ¢æ¨¡æ¿ï¼Œçˆ¶ç»„ä»¶å¯ä»¥æ›´æ¢æ¨¡æ¿çš„å†…å®¹ã€‚
>
>ä½œç”¨åŸŸæ’æ§½ç»™äº†å­ç»„ä»¶å°†æ•°æ®è¿”ç»™çˆ¶ç»„ä»¶çš„èƒ½åŠ›ï¼Œå­ç»„ä»¶ä¸€æ ·å¯ä»¥å¤ç”¨ï¼ŒåŒæ—¶çˆ¶ç»„ä»¶ä¹Ÿå¯ä»¥é‡æ–°ç»„ç»‡å†…å®¹å’Œæ ·å¼ã€‚



### 47. ***vue* ä¸­ç›¸åŒé€»è¾‘å¦‚ä½•è¿›è¡ŒæŠ½ç¦»ï¼Ÿ**

>å‚è€ƒç­”æ¡ˆï¼š
>
>å¯ä»¥ä½¿ç”¨ *vue* é‡Œé¢çš„æ··å…¥ï¼ˆ*mixin*ï¼‰æŠ€æœ¯ã€‚æ··å…¥ï¼ˆ*mixin*ï¼‰æä¾›äº†ä¸€ç§éå¸¸çµæ´»çš„æ–¹å¼ï¼Œæ¥å°† *vue* ä¸­ç›¸åŒçš„ä¸šåŠ¡é€»è¾‘è¿›è¡ŒæŠ½ç¦»ã€‚
>
>ä¾‹å¦‚ï¼š
>
>- åœ¨ *data* ä¸­æœ‰å¾ˆå¤šæ˜¯å…¬ç”¨æ•°æ®
>- å¼•ç”¨å°è£…å¥½çš„ç»„ä»¶ä¹Ÿéƒ½æ˜¯ä¸€æ ·çš„
>- *methodsã€watchã€computed* ä¸­ä¹Ÿéƒ½æœ‰å¤§é‡çš„é‡å¤ä»£ç 
>
>å½“ç„¶è¿™ä¸ªæ—¶å€™å¯ä»¥å°†æ‰€æœ‰çš„ä»£ç é‡å¤å»å†™æ¥å®ç°åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæ— è®ºæ˜¯å·¥ä½œé‡ã€å·¥ä½œæ•ˆç‡å’ŒåæœŸç»´æŠ¤æ¥è¯´éƒ½æ˜¯ä¸å»ºè®®çš„ï¼Œè¿™ä¸ªæ—¶å€™ *mixin* å°±å¯ä»¥å¤§å±•èº«æ‰‹äº†ã€‚
>
>ä¸€ä¸ªæ··å…¥å¯¹è±¡å¯ä»¥åŒ…å«ä»»æ„ç»„ä»¶é€‰é¡¹ã€‚å½“ç»„ä»¶ä½¿ç”¨æ··å…¥å¯¹è±¡æ—¶ï¼Œæ‰€æœ‰æ··å…¥å¯¹è±¡çš„é€‰é¡¹å°†è¢«â€œæ··åˆâ€è¿›å…¥è¯¥ç»„ä»¶æœ¬èº«çš„é€‰é¡¹ã€‚è¯´ç™½äº†å°±æ˜¯ç»™æ¯ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå‡½æ•°ç­‰ç­‰ä¸­é—´åŠ å…¥ä¸€äº›å…¬å…±é€»è¾‘ã€‚
>
>**æ··å…¥æŠ€æœ¯ç‰¹ç‚¹**
>
>- å½“ç»„ä»¶å’Œæ··å…¥å¯¹è±¡å«æœ‰åŒåé€‰é¡¹æ—¶ï¼Œè¿™äº›é€‰é¡¹å°†ä»¥æ°å½“çš„æ–¹å¼è¿›è¡Œâ€œåˆå¹¶â€ã€‚æ¯”å¦‚ï¼Œæ•°æ®å¯¹è±¡åœ¨å†…éƒ¨ä¼šè¿›è¡Œé€’å½’åˆå¹¶ï¼Œå¹¶åœ¨å‘ç”Ÿå†²çªæ—¶ä»¥ç»„ä»¶æ•°æ®ä¼˜å…ˆã€‚
>- åŒåé’©å­å‡½æ•°å°†åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤éƒ½å°†è¢«è°ƒç”¨ã€‚å¦å¤–ï¼Œæ··å…¥å¯¹è±¡çš„é’©å­å°†åœ¨ç»„ä»¶è‡ªèº«é’©å­ä¹‹å‰è°ƒç”¨ã€‚
>- å€¼ä¸ºå¯¹è±¡çš„é€‰é¡¹ï¼Œä¾‹å¦‚ *methodsã€components* å’Œ *directives*ï¼Œå°†è¢«åˆå¹¶ä¸ºåŒä¸€ä¸ªå¯¹è±¡ã€‚ä¸¤ä¸ªå¯¹è±¡é”®åå†²çªæ—¶ï¼Œå–ç»„ä»¶å¯¹è±¡çš„é”®å€¼å¯¹ã€‚



### 48. **å¦‚ä½•ç›‘å¬ *pushstate* å’Œ *replacestate* çš„å˜åŒ–å‘¢ï¼Ÿ**

>å‚è€ƒç­”æ¡ˆï¼š
>
>*History.replaceState* å’Œ *pushState* ä¸ä¼šè§¦å‘ *popstate* äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å…¨å±€äº‹ä»¶æ¥å®ç°  *pushstate* å’Œ *replacestate* å˜åŒ–çš„ç›‘å¬ã€‚
>
>å…·ä½“åšæ³•ä¸ºï¼š
>
>```js
>var _wr = function(type) {
>var orig = history[type];
>return function() {
>  var rv = orig.apply(this, arguments);
> var e = new Event(type);
>  e.arguments = arguments;
>  window.dispatchEvent(e);
>  return rv;
>};
>};
>history.pushState = _wr('pushState');
>history.replaceState = _wr('replaceState');
>```
>
>è¿™æ ·å°±åˆ›å»ºäº† *2* ä¸ªå…¨æ–°çš„äº‹ä»¶ï¼Œäº‹ä»¶åä¸º *pushState* å’Œ *replaceState*ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å…¨å±€ç›‘å¬ï¼š
>
>```js
>window.addEventListener('replaceState', function(e) {
>console.log('THEY DID IT AGAIN! replaceState 111111');
>});
>window.addEventListener('pushState', function(e) {
>console.log('THEY DID IT AGAIN! pushState 2222222');
>});
>```
>
>è¿™æ ·å°±å¯ä»¥ç›‘å¬åˆ° *pushState* å’Œ *replaceState* è¡Œä¸ºã€‚



### 49. **è¯´ä¸€ä¸‹ *vue3.0* æ˜¯å¦‚ä½•å˜å¾—æ›´å¿«çš„ï¼Ÿ**

>å‚è€ƒç­”æ¡ˆï¼š
>
>**ä¼˜åŒ– *Diff* ç®—æ³•**
>
>ç›¸æ¯” *Vue 2*ï¼Œ*Vue 3* é‡‡ç”¨äº†æ›´åŠ ä¼˜åŒ–çš„æ¸²æŸ“ç­–ç•¥ã€‚å»æ‰ä¸å¿…è¦çš„è™šæ‹Ÿ *DOM* æ ‘éå†å’Œå±æ€§æ¯”è¾ƒï¼Œå› ä¸ºè¿™åœ¨æ›´æ–°æœŸé—´å¾€å¾€ä¼šäº§ç”Ÿæœ€å¤§çš„æ€§èƒ½å¼€é”€ã€‚
>
>è¿™é‡Œæœ‰ä¸‰ä¸ªä¸»è¦çš„ä¼˜åŒ–ï¼š
>
>- é¦–å…ˆï¼Œåœ¨ *DOM* æ ‘çº§åˆ«ã€‚
>
> åœ¨æ²¡æœ‰åŠ¨æ€æ”¹å˜èŠ‚ç‚¹ç»“æ„çš„æ¨¡æ¿æŒ‡ä»¤ï¼ˆä¾‹å¦‚ *v-if* å’Œ *v-for*ï¼‰çš„æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹ç»“æ„ä¿æŒå®Œå…¨é™æ€ã€‚
>
> å½“æ›´æ–°èŠ‚ç‚¹æ—¶ï¼Œä¸å†éœ€è¦é€’å½’éå† *DOM* æ ‘ã€‚æ‰€æœ‰çš„åŠ¨æ€ç»‘å®šéƒ¨åˆ†å°†åœ¨ä¸€ä¸ªå¹³é¢æ•°ç»„ä¸­è·Ÿè¸ªã€‚è¿™ç§ä¼˜åŒ–é€šè¿‡å°†éœ€è¦æ‰§è¡Œçš„æ ‘éå†é‡å‡å°‘ä¸€ä¸ªæ•°é‡çº§æ¥è§„é¿è™šæ‹Ÿ *DOM* çš„å¤§éƒ¨åˆ†å¼€é”€ã€‚
>
>- å…¶æ¬¡ï¼Œç¼–è¯‘å™¨ç§¯æåœ°æ£€æµ‹æ¨¡æ¿ä¸­çš„é™æ€èŠ‚ç‚¹ã€å­æ ‘ç”šè‡³æ•°æ®å¯¹è±¡ï¼Œå¹¶åœ¨ç”Ÿæˆçš„ä»£ç ä¸­å°†å®ƒä»¬æå‡åˆ°æ¸²æŸ“å‡½æ•°ä¹‹å¤–ã€‚è¿™æ ·å¯ä»¥é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œä»è€Œå¤§å¤§æé«˜å†…å­˜ä½¿ç”¨ç‡å¹¶å‡å°‘åƒåœ¾å›æ”¶çš„é¢‘ç‡ã€‚
>
>- ç¬¬ä¸‰ï¼Œåœ¨å…ƒç´ çº§åˆ«ã€‚
>
> ç¼–è¯‘å™¨è¿˜æ ¹æ®éœ€è¦æ‰§è¡Œçš„æ›´æ–°ç±»å‹ï¼Œä¸ºæ¯ä¸ªå…·æœ‰åŠ¨æ€ç»‘å®šçš„å…ƒç´ ç”Ÿæˆä¸€ä¸ªä¼˜åŒ–æ ‡å¿—ã€‚
>
> ä¾‹å¦‚ï¼Œå…·æœ‰åŠ¨æ€ç±»ç»‘å®šå’Œè®¸å¤šé™æ€å±æ€§çš„å…ƒç´ å°†æ”¶åˆ°ä¸€ä¸ªæ ‡å¿—ï¼Œæç¤ºåªéœ€è¦è¿›è¡Œç±»æ£€æŸ¥ã€‚è¿è¡Œæ—¶å°†è·å–è¿™äº›æç¤ºå¹¶é‡‡ç”¨ä¸“ç”¨çš„å¿«é€Ÿè·¯å¾„ã€‚
>
>ç»¼åˆèµ·æ¥ï¼Œè¿™äº›æŠ€æœ¯å¤§å¤§æ”¹è¿›äº†æ¸²æŸ“æ›´æ–°åŸºå‡†ï¼Œ*Vue 3.0* æœ‰æ—¶å ç”¨çš„ *CPU* æ—¶é—´ä¸åˆ° *Vue 2* çš„ååˆ†ä¹‹ä¸€ã€‚
>
>**ä½“ç§¯å˜å°**
>
>é‡å†™åçš„ *Vue* æ”¯æŒäº† *tree-shaking*ï¼Œåƒä¿®å‰ªæ ‘å¶ä¸€æ ·æŠŠä¸éœ€è¦çš„ä¸œè¥¿ç»™ä¿®å‰ªæ‰ï¼Œä½¿ *Vue 3.0* çš„ä½“ç§¯æ›´å°ã€‚
>
>éœ€è¦çš„æ¨¡å—æ‰ä¼šæ‰“å…¥åˆ°åŒ…é‡Œï¼Œä¼˜åŒ–åçš„ *Vue 3.0* çš„æ‰“åŒ…ä½“ç§¯åªæœ‰åŸæ¥çš„ä¸€åŠï¼ˆ*13kb*ï¼‰ã€‚å“ªæ€•æŠŠæ‰€æœ‰çš„åŠŸèƒ½éƒ½å¼•å…¥è¿›æ¥ä¹Ÿåªæœ‰ *23kb*ï¼Œä¾ç„¶æ¯” *Vue 2.x* æ›´å°ã€‚åƒ *keep-aliveã€transition* ç”šè‡³ *v-for* ç­‰åŠŸèƒ½éƒ½å¯ä»¥æŒ‰éœ€å¼•å…¥ã€‚
>
>å¹¶ä¸” *Vue 3.0* ä¼˜åŒ–äº†æ‰“åŒ…æ–¹æ³•ï¼Œä½¿å¾—æ‰“åŒ…åçš„ *bundle* çš„ä½“ç§¯ä¹Ÿæ›´å°ã€‚
>
>å®˜æ–¹æ‰€ç»™å‡ºçš„ä¸€ä»½æƒŠè‰³çš„æ•°æ®ï¼šæ‰“åŒ…å¤§å°å‡å°‘ *41%*ï¼Œåˆæ¬¡æ¸²æŸ“å¿« *55%*ï¼Œæ›´æ–°å¿« *133%*ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘ *54%*ã€‚



### 50. è¯´ä¸€è¯´è‡ªå®šä¹‰æŒ‡ä»¤æœ‰å“ªäº›ç”Ÿå‘½å‘¨æœŸï¼Ÿ

> å‚è€ƒç­”æ¡ˆï¼š
>
> è‡ªå®šä¹‰æŒ‡ä»¤çš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ‰ 5 ä¸ªäº‹ä»¶é’©å­ï¼Œå¯ä»¥è®¾ç½®æŒ‡ä»¤åœ¨æŸä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶çš„å…·ä½“è¡Œä¸ºï¼š
>
> - bind: åªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ç¬¬ä¸€æ¬¡ç»‘å®šåˆ°å…ƒç´ æ—¶è°ƒç”¨ï¼Œç”¨è¿™ä¸ªé’©å­å‡½æ•°å¯ä»¥å®šä¹‰ä¸€ä¸ªåœ¨ç»‘å®šæ—¶æ‰§è¡Œä¸€æ¬¡çš„åˆå§‹åŒ–åŠ¨ä½œã€‚
> - inserted: è¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹æ—¶è°ƒç”¨ï¼ˆçˆ¶èŠ‚ç‚¹å­˜åœ¨å³å¯è°ƒç”¨ï¼Œä¸å¿…å­˜åœ¨äº document ä¸­ï¼‰ã€‚
> - update: è¢«ç»‘å®šå…ƒç´ æ‰€åœ¨çš„æ¨¡æ¿æ›´æ–°æ—¶è°ƒç”¨ï¼Œè€Œä¸è®ºç»‘å®šå€¼æ˜¯å¦å˜åŒ–ã€‚é€šè¿‡æ¯”è¾ƒæ›´æ–°å‰åçš„ç»‘å®šå€¼ï¼Œå¯ä»¥å¿½ç•¥ä¸å¿…è¦çš„æ¨¡æ¿æ›´æ–°ï¼ˆè¯¦ç»†çš„é’©å­å‡½æ•°å‚æ•°è§ä¸‹ï¼‰ã€‚
> - componentUpdated: è¢«ç»‘å®šå…ƒç´ æ‰€åœ¨æ¨¡æ¿å®Œæˆä¸€æ¬¡æ›´æ–°å‘¨æœŸæ—¶è°ƒç”¨ã€‚
> - unbind: åªè°ƒç”¨ä¸€æ¬¡ï¼Œ æŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶è°ƒç”¨ã€‚
>
> é’©å­å‡½æ•°çš„å‚æ•° (åŒ…æ‹¬ elï¼Œbindingï¼Œvnodeï¼ŒoldVnode)
>
> - el: æŒ‡ä»¤æ‰€ç»‘å®šçš„å…ƒç´ ï¼Œå¯ä»¥ç”¨æ¥ç›´æ¥æ“ä½œ DOM ã€‚
> - binding: ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼šname: æŒ‡ä»¤åã€value: æŒ‡ä»¤çš„ç»‘å®šå€¼ã€oldValue: æŒ‡ä»¤ç»‘å®šçš„å‰ä¸€ä¸ªå€¼ã€expression: ç»‘å®šå€¼çš„å­—ç¬¦ä¸²å½¢å¼ã€arg: ä¼ ç»™æŒ‡ä»¤çš„å‚æ•°ã€modifiers: ä¸€ä¸ªåŒ…å«ä¿®é¥°ç¬¦çš„å¯¹è±¡ã€‚
> - vnode: Vue ç¼–è¯‘ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹ã€‚
> - oldVnode: ä¸Šä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œä»…åœ¨ update å’Œ componentUpdated é’©å­ä¸­å¯ç”¨ã€‚



### 51. è¯´ä¸€è¯´ç›¸æ¯” *vue3.x* å¯¹æ¯” *vue2.x* å˜åŒ–

> å‚è€ƒç­”æ¡ˆï¼š
>
> 1. æºç ç»„ç»‡æ–¹å¼å˜åŒ–ï¼šä½¿ç”¨ TS é‡å†™
> 2. æ”¯æŒ Composition APIï¼šåŸºäºå‡½æ•°çš„APIï¼Œæ›´åŠ çµæ´»ç»„ç»‡ç»„ä»¶é€»è¾‘ï¼ˆvue2ç”¨çš„æ˜¯options apiï¼‰
> 3. å“åº”å¼ç³»ç»Ÿæå‡ï¼šVue3ä¸­å“åº”å¼æ•°æ®åŸç†æ”¹æˆproxyï¼Œå¯ç›‘å¬åŠ¨æ€æ–°å¢åˆ é™¤å±æ€§ï¼Œä»¥åŠæ•°ç»„å˜åŒ–
> 4. ç¼–è¯‘ä¼˜åŒ–ï¼švue2é€šè¿‡æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹ä¼˜åŒ–diffï¼ŒVue3 æ ‡è®°å’Œæå‡æ‰€æœ‰é™æ€æ ¹èŠ‚ç‚¹ï¼Œdiffçš„æ—¶å€™åªéœ€è¦å¯¹æ¯”åŠ¨æ€èŠ‚ç‚¹å†…å®¹
> 5. æ‰“åŒ…ä½“ç§¯ä¼˜åŒ–ï¼šç§»é™¤äº†ä¸€äº›ä¸å¸¸ç”¨çš„apiï¼ˆinline-templateã€filterï¼‰
> 6. ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼šä½¿ç”¨setupä»£æ›¿äº†ä¹‹å‰çš„beforeCreateå’Œcreated
> 7. Vue3 çš„ template æ¨¡æ¿æ”¯æŒå¤šä¸ªæ ¹æ ‡ç­¾
> 8. VuexçŠ¶æ€ç®¡ç†ï¼šåˆ›å»ºå®ä¾‹çš„æ–¹å¼æ”¹å˜,Vue2ä¸ºnew Store , Vue3ä¸ºcreateStore
> 9. Route è·å–é¡µé¢å®ä¾‹ä¸è·¯ç”±ä¿¡æ¯ï¼švue2é€šè¿‡thisè·å–routerå®ä¾‹ï¼Œvue3é€šè¿‡ä½¿ç”¨ getCurrentInstance/ userRouteå’ŒuserRouteræ–¹æ³•è·å–å½“å‰ç»„ä»¶å®ä¾‹
> 10. Props çš„ä½¿ç”¨å˜åŒ–ï¼švue2 é€šè¿‡ this è·å– props é‡Œé¢çš„å†…å®¹ï¼Œvue3 ç›´æ¥é€šè¿‡ props
> 11. çˆ¶å­ç»„ä»¶ä¼ å€¼ï¼švue3 åœ¨å‘çˆ¶ç»„ä»¶ä¼ å›æ•°æ®æ—¶ï¼Œå¦‚ä½¿ç”¨çš„è‡ªå®šä¹‰åç§°ï¼Œå¦‚ backDataï¼Œåˆ™éœ€è¦åœ¨ emits ä¸­å®šä¹‰ä¸€ä¸‹



### 52. *vue* ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥æ¸²æŸ“

> å‚è€ƒç­”æ¡ˆï¼š
>
> å› ä¸ºå¦‚æœä¸é‡‡ç”¨å¼‚æ­¥æ›´æ–°ï¼Œé‚£ä¹ˆæ¯æ¬¡æ›´æ–°æ•°æ®éƒ½ä¼šå¯¹å½“å‰ç»„ä»¶è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼›æ‰€ä»¥ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œ*Vue* ä¼šåœ¨æœ¬è½®æ•°æ®æ›´æ–°åï¼Œå†å»å¼‚æ­¥æ›´æ–°è§†å›¾ã€‚
>
> å¼‚æ­¥æ¸²æŸ“çš„åŸç†ï¼š
>
> 1. è°ƒç”¨ *notify( )* æ–¹æ³•ï¼Œé€šçŸ¥ *watcher* è¿›è¡Œæ›´æ–°æ“ä½œ
> 2. ä¾æ¬¡è°ƒç”¨ watcher çš„ update æ–¹æ³•
> 3. å¯¹ watcher è¿›è¡Œå»é‡æ“ä½œï¼ˆé€šè¿‡idï¼‰æ”¾åˆ°é˜Ÿåˆ—é‡Œ
> 4. æ‰§è¡Œå®Œåå¼‚æ­¥æ¸…ç©ºè¿™ä¸ªé˜Ÿåˆ—ï¼ŒnextTickï¼ˆflushSchedulerQueueï¼‰è¿›è¡Œæ‰¹é‡æ›´æ–°æ“ä½œ



### 53. ç»„ä»¶ä¸­å†™ *name* é€‰é¡¹æœ‰å“ªäº›å¥½å¤„

> å‚è€ƒç­”æ¡ˆï¼š
>
> 1. å¯ä»¥é€šè¿‡åå­—æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶ï¼ˆ é€’å½’ç»„ä»¶ï¼šç»„ä»¶è‡ªèº«è°ƒç”¨è‡ªèº« ï¼‰
> 2. å¯ä»¥é€šè¿‡ *name* å±æ€§å®ç°ç¼“å­˜åŠŸèƒ½ï¼ˆ*keep-alive*ï¼‰
> 3. å¯ä»¥é€šè¿‡ *name* æ¥è¯†åˆ«ç»„ä»¶ï¼ˆè·¨çº§ç»„ä»¶é€šä¿¡æ—¶éå¸¸é‡è¦ï¼‰
> 4. ä½¿ç”¨ *vue-devtools* è°ƒè¯•å·¥å…·é‡Œæ˜¾ç¤ºçš„ç»„è§åç§°æ˜¯ç”± *vue* ä¸­ç»„ä»¶ *name* å†³å®šçš„

